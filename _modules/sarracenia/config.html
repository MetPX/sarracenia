<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sarracenia.config &mdash; Sarracenia 3.00.55rc2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="../../_static/sarra_horror_culture_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=bcc5ee3f"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Sarracenia
              <img src="../../_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.00.55rc2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../How2Guides/index.html">HOWTOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fr/index.html">En fran√ßais</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../sarracenia.html">sarracenia</a></li>
      <li class="breadcrumb-item active">sarracenia.config</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sarracenia.config</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Sarracenia.</span>
<span class="c1"># The sarracenia suite is Free and is proudly provided by the Government of Canada</span>
<span class="c1"># Copyright (C) Her Majesty The Queen in Right of Canada, Shared Services Canada, 2019</span>
<span class="c1">#</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Second version configuration parser</span>

<span class="sd">FIXME: pas 2023/02/05...  missing options from v2: max_queue_size, outlet, pipe</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">humanfriendly</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span><span class="o">,</span> <span class="nn">urllib.parse</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &#39;extend&#39; action not included in argparse prior to python 3.8</span>
<span class="sd">        https://stackoverflow.com/questions/41152799/argparse-flatten-the-result-of-action-append</span>
<span class="sd">    &quot;&quot;&quot;</span>
 
    <span class="k">class</span> <span class="nc">ExtendAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>




<span class="kn">import</span> <span class="nn">sarracenia</span>
<span class="kn">from</span> <span class="nn">sarracenia</span> <span class="kn">import</span> <span class="n">durationToSeconds</span><span class="p">,</span> <span class="n">site_config_dir</span><span class="p">,</span> <span class="n">user_config_dir</span><span class="p">,</span> <span class="n">user_cache_dir</span>
<span class="kn">from</span> <span class="nn">sarracenia.featuredetection</span> <span class="kn">import</span> <span class="n">features</span>
<span class="kn">import</span> <span class="nn">sarracenia.credentials</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow</span>
<span class="kn">import</span> <span class="nn">sarracenia.flowcb</span>

<span class="kn">from</span> <span class="nn">sarracenia.flow.sarra</span> <span class="kn">import</span> <span class="n">default_options</span> <span class="k">as</span> <span class="n">sarradefopts</span>

<span class="kn">import</span> <span class="nn">sarracenia.identity.arbitrary</span>

<span class="kn">import</span> <span class="nn">sarracenia.moth</span>
<span class="kn">import</span> <span class="nn">sarracenia.identity</span>
<span class="kn">import</span> <span class="nn">sarracenia.instance</span>


<div class="viewcode-block" id="octal_number">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.octal_number">[docs]</a>
<span class="k">class</span> <span class="nc">octal_number</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>

<div class="viewcode-block" id="octal_number.__new__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.octal_number.__new__">[docs]</a>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="octal_number.__str__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.octal_number.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;0o</span><span class="si">{</span><span class="bp">self</span><span class="si">:</span><span class="s2">o</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="octal_number.__repr__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.octal_number.__repr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;0o</span><span class="si">{</span><span class="bp">self</span><span class="si">:</span><span class="s2">o</span><span class="si">}</span><span class="s2">&quot;</span></div>
</div>



<span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;acceptSizeWrong&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;acceptUnmatched&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;amqp_consumer&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;attempts&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;batch&#39;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;baseDir&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;baseUrl_relPath&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;documentRoot&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;download&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;flowMain&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;inflight&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;inline&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;inlineOnly&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;identity_method&#39;</span><span class="p">:</span> <span class="s1">&#39;sha512&#39;</span><span class="p">,</span>
    <span class="s1">&#39;logFormat&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(funcName)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;logMetrics&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;logStdout&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;metrics_writeInterval&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;nodupe_driver&#39;</span><span class="p">:</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;permDefault&#39;</span> <span class="p">:</span> <span class="n">octal_number</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;permDirDefault&#39;</span> <span class="p">:</span> <span class="n">octal_number</span><span class="p">(</span><span class="mo">0o775</span><span class="p">),</span>
    <span class="s1">&#39;permLog&#39;</span><span class="p">:</span> <span class="n">octal_number</span><span class="p">(</span><span class="mo">0o600</span><span class="p">),</span>
    <span class="s1">&#39;post_documentRoot&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;post_baseDir&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;post_baseUrl&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;post_format&#39;</span><span class="p">:</span> <span class="s1">&#39;v03&#39;</span><span class="p">,</span>
    <span class="s1">&#39;realpathPost&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;recursive&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_reject&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s1">&#39;report&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;retryEmptyBeforeExit&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;retry_refilter&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_cpuSlow&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_hung&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_idle&#39;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_lag&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_retry&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="s1">&#39;runStateThreshold_slow&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;sourceFromExchange&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;sourceFromMessage&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;sundew_compat_regex_first_match_is_zero&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;topicCopy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;v2compatRenameDoublePost&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;varTimeOffset&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;wololo&#39;</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span>

<span class="n">count_options</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;exchangeSplit&#39;</span><span class="p">,</span> <span class="s1">&#39;instances&#39;</span><span class="p">,</span> <span class="s1">&#39;logRotateCount&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;post_exchangeSplit&#39;</span><span class="p">,</span> <span class="s1">&#39;prefetch&#39;</span><span class="p">,</span> <span class="s1">&#39;messageCountMax&#39;</span><span class="p">,</span> <span class="s1">&#39;runStateThreshold_cpuSlow&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;runStateThreshold_reject&#39;</span><span class="p">,</span> <span class="s1">&#39;runStateThreshold_retry&#39;</span><span class="p">,</span> <span class="s1">&#39;runStateThreshold_slow&#39;</span><span class="p">,</span> 
<span class="p">]</span>


<span class="c1"># all the boolean settings.</span>
<span class="n">flag_options</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;acceptSizeWrong&#39;</span><span class="p">,</span> <span class="s1">&#39;acceptUnmatched&#39;</span><span class="p">,</span> <span class="s1">&#39;amqp_consumer&#39;</span><span class="p">,</span> <span class="s1">&#39;baseUrl_relPath&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s1">&#39;dry_run&#39;</span><span class="p">,</span> <span class="s1">&#39;durable&#39;</span><span class="p">,</span> <span class="s1">&#39;exchangeDeclare&#39;</span><span class="p">,</span> <span class="s1">&#39;exchangeSplit&#39;</span><span class="p">,</span> <span class="s1">&#39;logReject&#39;</span><span class="p">,</span> <span class="s1">&#39;realpathFilter&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;follow_symlinks&#39;</span><span class="p">,</span> <span class="s1">&#39;force_polling&#39;</span><span class="p">,</span> <span class="s1">&#39;inline&#39;</span><span class="p">,</span> <span class="s1">&#39;inlineOnly&#39;</span><span class="p">,</span> <span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="s1">&#39;logMetrics&#39;</span><span class="p">,</span> <span class="s1">&#39;logStdout&#39;</span><span class="p">,</span> <span class="s1">&#39;logReject&#39;</span><span class="p">,</span> <span class="s1">&#39;restore&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;messageDebugDump&#39;</span><span class="p">,</span> <span class="s1">&#39;mirror&#39;</span><span class="p">,</span> <span class="s1">&#39;timeCopy&#39;</span><span class="p">,</span> <span class="s1">&#39;notify_only&#39;</span><span class="p">,</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">,</span> <span class="s1">&#39;post_on_start&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;permCopy&#39;</span><span class="p">,</span> <span class="s1">&#39;persistent&#39;</span><span class="p">,</span> <span class="s1">&#39;queueBind&#39;</span><span class="p">,</span> <span class="s1">&#39;queueDeclare&#39;</span><span class="p">,</span> <span class="s1">&#39;randomize&#39;</span><span class="p">,</span> <span class="s1">&#39;recursive&#39;</span><span class="p">,</span> <span class="s1">&#39;realpathPost&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;reconnect&#39;</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="s1">&#39;retry_refilter&#39;</span><span class="p">,</span> <span class="s1">&#39;retryEmptyBeforeExit&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;sundew_compat_regex_first_match_is_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;sourceFromExchange&#39;</span><span class="p">,</span> <span class="s1">&#39;sourceFromMessage&#39;</span><span class="p">,</span> <span class="s1">&#39;topicCopy&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;statehost&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;v2compatRenameDoublePost&#39;</span><span class="p">,</span> <span class="s1">&#39;wololo&#39;</span>
                <span class="p">]</span>

<span class="n">float_options</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;messageRateMax&#39;</span><span class="p">,</span> <span class="s1">&#39;messageRateMin&#39;</span> <span class="p">]</span>

<span class="n">duration_options</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;expire&#39;</span><span class="p">,</span> <span class="s1">&#39;housekeeping&#39;</span><span class="p">,</span> <span class="s1">&#39;logRotateInterval&#39;</span><span class="p">,</span> <span class="s1">&#39;fileAgeMax&#39;</span><span class="p">,</span> <span class="s1">&#39;fileAgeMin&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;messageAgeMax&#39;</span><span class="p">,</span> <span class="s1">&#39;post_messageAgeMax&#39;</span><span class="p">,</span> <span class="s1">&#39;metrics_writeInterval&#39;</span><span class="p">,</span> \
    <span class="s1">&#39;runStateThreshold_idle&#39;</span><span class="p">,</span> <span class="s1">&#39;runStateThreshold_lag&#39;</span><span class="p">,</span> <span class="s1">&#39;retry_ttl&#39;</span><span class="p">,</span> <span class="s1">&#39;runStateThreshold_hung&#39;</span><span class="p">,</span> <span class="s1">&#39;sleep&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;varTimeOffset&#39;</span>
<span class="p">]</span>

<span class="n">list_options</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;vip&#39;</span> <span class="p">]</span>

<span class="c1"># set, valid values of the set.</span>
<span class="n">set_options</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;logEvents&#39;</span><span class="p">,</span> <span class="s1">&#39;fileEvents&#39;</span> <span class="p">]</span>

<span class="n">set_choices</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s1">&#39;logEvents&#39;</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">entry_points</span> <span class="o">+</span> <span class="p">[</span> <span class="s1">&#39;reject&#39;</span> <span class="p">]),</span>
    <span class="s1">&#39;fileEvents&#39;</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="s1">&#39;modify&#39;</span><span class="p">,</span> <span class="s1">&#39;rmdir&#39;</span> <span class="p">]</span> <span class="p">)</span>
 <span class="p">}</span>
<span class="c1"># FIXME: doesn&#39;t work... wonder why?</span>
<span class="c1">#    &#39;fileEvents&#39;: sarracenia.flow.allFileEvents</span>
 
<span class="n">perm_options</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;permDefault&#39;</span><span class="p">,</span> <span class="s1">&#39;permDirDefault&#39;</span><span class="p">,</span><span class="s1">&#39;permLog&#39;</span><span class="p">]</span>

<span class="n">size_options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accelThreshold&#39;</span><span class="p">,</span> <span class="s1">&#39;blockSize&#39;</span><span class="p">,</span> <span class="s1">&#39;bufSize&#39;</span><span class="p">,</span> <span class="s1">&#39;byteRateMax&#39;</span><span class="p">,</span> <span class="s1">&#39;fileSizeMax&#39;</span><span class="p">,</span> <span class="s1">&#39;inlineByteMax&#39;</span><span class="p">]</span>

<span class="n">str_options</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;baseDir&#39;</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span>
    <span class="s1">&#39;exchange_suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;feeder&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;flatten&#39;</span><span class="p">,</span> <span class="s1">&#39;flowMain&#39;</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;inlineEncoding&#39;</span><span class="p">,</span> <span class="s1">&#39;logFormat&#39;</span><span class="p">,</span> <span class="s1">&#39;logLevel&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;pollUrl&#39;</span><span class="p">,</span> <span class="s1">&#39;post_baseUrl&#39;</span><span class="p">,</span> <span class="s1">&#39;post_baseDir&#39;</span><span class="p">,</span> <span class="s1">&#39;post_broker&#39;</span><span class="p">,</span> <span class="s1">&#39;post_exchange&#39;</span><span class="p">,</span>
    <span class="s1">&#39;post_exchangeSuffix&#39;</span><span class="p">,</span> <span class="s1">&#39;post_format&#39;</span><span class="p">,</span> <span class="s1">&#39;post_topic&#39;</span><span class="p">,</span> <span class="s1">&#39;queueName&#39;</span><span class="p">,</span> <span class="s1">&#39;queueShare&#39;</span><span class="p">,</span> <span class="s1">&#39;sendTo&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">,</span>
    <span class="s1">&#39;report_exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;strip&#39;</span><span class="p">,</span> <span class="s1">&#39;timezone&#39;</span><span class="p">,</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span> <span class="s1">&#39;nodupe_driver&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;nodupe_basis&#39;</span><span class="p">,</span> <span class="s1">&#39;tlsRigour&#39;</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span>
<span class="p">]</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   for backward compatibility, </span>

<span class="sd">   convert some old plugins that are hard to get working with</span>
<span class="sd">   v2wrapper, into v3 plugin.</span>

<span class="sd">   the fdelay ones makes in depth use of sr_replay function, and</span>
<span class="sd">   that has changed in v3 too much.</span>

<span class="sd">   accelerators and rate limiting are now built-in, no plugin required.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">convert_to_v3</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;cache_stat&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    <span class="s1">&#39;cluster_aliases&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;discard&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;delete_destination&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span> <span class="p">],</span> 
    <span class="s1">&#39;from_cluster&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;to_clusters&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;identity&#39;</span> <span class="p">:</span> <span class="p">{</span>
       <span class="s1">&#39;n&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;s&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;sha512&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;d&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;md5&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;a&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;arbitrary&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;r&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;z,d&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;cod,md5&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;z,s&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;cod,sha512&#39;</span> <span class="p">],</span>
       <span class="s1">&#39;z,n&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span> <span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;ls_file_index&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;plugin&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;msg_fdelay&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;filter.fdelay&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_pclean_f90&#39;</span><span class="p">:</span>
        <span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;filter.pclean_f90.PClean_F90&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_pclean_f92&#39;</span><span class="p">:</span>
        <span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;filter.pclean_f92.PClean_F92&#39;</span><span class="p">],</span>
        <span class="s1">&#39;accel_wget&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;accel_scp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;accel_cp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_total_save&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;post_total_save&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;post_total_interval&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;destfn_script&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;do_get&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;do_poll&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;do_put&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;do_download&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;do_put&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;do_send&#39;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s1">&#39;file_email&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;send.email&#39;</span> <span class="p">],</span>
    <span class="p">},</span>
    <span class="s1">&#39;do_task&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;no_download&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;notify_only&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;do_data&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_file&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;file_age&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;work.age&#39;</span> <span class="p">],</span>
    <span class="p">},</span>
    <span class="s1">&#39;on_heartbeat&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_html_page&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_part&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_line&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_message&#39;</span><span class="p">:</span> <span class="p">{</span>
    	<span class="s1">&#39;msg_by_source&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_by_user&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_delete&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;filter.deleteflowfiles.DeleteFlowFiles&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_download&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_dump&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_log&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;logEvents&#39;</span><span class="p">,</span> <span class="s1">&#39;+after_accept&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_print_lag&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.printlag.PrintLag&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_rawlog&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;logEvents&#39;</span><span class="p">,</span> <span class="s1">&#39;+after_accept&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_total&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_replace_new_dir&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.pathreplace&#39;</span> <span class="p">],</span>
        <span class="s1">&#39;msg_skip_old&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.skipold.SkipOld&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_test_retry&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.testretry.TestRetry&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_to_clusters&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.toclusters.ToClusters&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_save&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.save&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_2localfile&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.tolocalfile.ToLocalFile&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_rename_whatfn&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.renamewhatfn.RenameWhatFn&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_rename_dmf&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.renamedmf.RenameDMF&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_hour_tree&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.hourtree.HourTree&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_renamer&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.renamer.Renamer&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_http_to_https&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.httptohttps.HttpToHttps&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_speedo&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.speedo.Speedo&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_WMO_type_suffix&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.wmotypesuffix.WmoTypeSuffix&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_sundew_pxroute&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.sundewpxroute.SundewPxRoute&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_rename4jicc&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;flow_callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.rename4jicc.Rename4Jicc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_delay&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.messagedelay.MessageDelay&#39;</span><span class="p">],</span>
        <span class="s1">&#39;msg_download_baseurl&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.downloadbaseurl.DownloadBaseUrl&#39;</span><span class="p">],</span>
	    <span class="s1">&#39;msg_from_cluster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_stdfiles&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_fdelay&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;filter.fdelay&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_stopper&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_overwrite_sum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    	<span class="s1">&#39;msg_gts2wistopic&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="s1">&#39;on_report&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_stop&#39;</span><span class="p">:</span>   <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_start&#39;</span><span class="p">:</span>  <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_watch&#39;</span><span class="p">:</span>  <span class="p">{</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span> <span class="p">},</span>
    <span class="s1">&#39;on_post&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;post_log&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;logEvents&#39;</span><span class="p">,</span> <span class="s1">&#39;+after_work&#39;</span><span class="p">],</span>
	    <span class="s1">&#39;post_total&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;wmo2msc&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;filter.wmo2msc.Wmo2Msc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;post_hour_tree&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.posthourtree.PostHourTree&#39;</span><span class="p">],</span>
        <span class="s1">&#39;post_long_flow&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.longflow.LongFLow&#39;</span><span class="p">],</span>
        <span class="s1">&#39;post_override&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;accept.postoverride.PostOverride&#39;</span><span class="p">],</span>
	    <span class="s1">&#39;post_rate_limit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
        <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;parts&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;poll_without_vip&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;manual_conversion_required&#39;</span> <span class="p">],</span> 
    <span class="s1">&#39;pump&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;pump_flag&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;reconnect&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    <span class="s1">&#39;report_daemons&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    <span class="s1">&#39;restore&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;retry_mode&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    <span class="s1">&#39;save&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;set_passwords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue&#39;</span><span class="p">],</span>
    <span class="s1">&#39;windows_run&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">],</span>
    <span class="s1">&#39;xattr_disable&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;continue&#39;</span> <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># question: why don&#39;t these have matching closing braces? </span>
<span class="c1"># answer: there might be an offset (-1h, -5m, etc...) and covering those cases is hard with simple substitution.</span>

<span class="n">convert_patterns_to_v3</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">&#39;${YYYYMMDD-1D&#39;</span> <span class="p">:</span> <span class="s1">&#39;${</span><span class="si">%o</span><span class="s1">-1d%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${YYYYMMDD-2D&#39;</span> <span class="p">:</span> <span class="s1">&#39;${</span><span class="si">%o</span><span class="s1">-2d%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${YYYYMMDD&#39;</span> <span class="p">:</span> <span class="s1">&#39;${%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${YYYY&#39;</span><span class="p">:</span> <span class="s1">&#39;${%Y&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${JJJ&#39;</span><span class="p">:</span> <span class="s1">&#39;${%j&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${HH&#39;</span><span class="p">:</span> <span class="s1">&#39;${%H&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${DD&#39;</span><span class="p">:</span> <span class="s1">&#39;${</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${MM&#39;</span><span class="p">:</span> <span class="s1">&#39;${%m&#39;</span><span class="p">,</span>
   <span class="s1">&#39;${SS&#39;</span><span class="p">:</span> <span class="s1">&#39;${%S&#39;</span><span class="p">,</span>

<span class="p">}</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   FIXME: respect appdir stuff using an environment variable.</span>
<span class="sd">   for not just hard coded as a class variable appdir_stuff</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">isTrue</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="parse_count">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.parse_count">[docs]</a>
<span class="k">def</span> <span class="nf">parse_count</span><span class="p">(</span><span class="n">cstr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        number argument accepts k,m,g suffix with i and b to use base 2 ) and +- </span>
<span class="sd">        return value is integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">offset</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">count</span><span class="o">=</span><span class="n">humanfriendly</span><span class="o">.</span><span class="n">parse_size</span><span class="p">(</span><span class="n">cstr</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="n">binary</span><span class="o">=</span><span class="n">cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">count</span> <span class="k">if</span> <span class="n">offset</span> <span class="k">else</span> <span class="n">count</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">Ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;failed to parse:  </span><span class="si">{</span><span class="n">cstr</span><span class="si">}</span><span class="s2"> as a count value&quot;</span> <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="parse_float">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.parse_float">[docs]</a>
<span class="k">def</span> <span class="nf">parse_float</span><span class="p">(</span><span class="n">cstr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        like parse_count, numeric argument accepts k,m,g suffix and +-.</span>
<span class="sd">        below 1000, return a decimal number with 3 digits max.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cstr</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fa</span> <span class="o">=</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span> <span class="p">]:</span>
                <span class="k">if</span> <span class="n">cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;k&#39;</span> <span class="p">]:</span>
                    <span class="n">fa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">1024</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;k&#39;</span> <span class="p">]:</span>
                    <span class="n">fa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">1000</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span>

            <span class="c1"># apply 3 sig figs.</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">fa</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">fa</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">fa</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fa</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fa</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">Ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;failed to parse:  </span><span class="si">{</span><span class="n">cstr</span><span class="si">}</span><span class="s2"> as a float value&quot;</span> <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>


<span class="k">def</span> <span class="nf">get_package_lib_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">Config</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_site_config_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">site_config_dir</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appname&#39;</span><span class="p">],</span>
                                   <span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appauthor&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="get_user_cache_dir">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.get_user_cache_dir">[docs]</a>
<span class="k">def</span> <span class="nf">get_user_cache_dir</span><span class="p">(</span><span class="n">hostdir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      hostdir = None if statehost is false, </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ucd</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">user_cache_dir</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appname&#39;</span><span class="p">],</span>
                                 <span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appauthor&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">hostdir</span><span class="p">:</span>
        <span class="n">ucd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ucd</span><span class="p">,</span> <span class="n">hostdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ucd</span></div>



<span class="k">def</span> <span class="nf">get_user_config_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">user_config_dir</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appname&#39;</span><span class="p">],</span>
                                   <span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appauthor&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="get_pid_filename">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.get_pid_filename">[docs]</a>
<span class="k">def</span> <span class="nf">get_pid_filename</span><span class="p">(</span><span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">no</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     return the file name for the pid file for the specified instance.</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="n">piddir</span> <span class="o">=</span> <span class="n">get_user_cache_dir</span><span class="p">(</span><span class="n">hostdir</span><span class="p">)</span>
    <span class="n">piddir</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

    <span class="k">if</span> <span class="n">configuration</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.conf&#39;</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">piddir</span> <span class="o">+=</span> <span class="n">configuration</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

    <span class="k">return</span> <span class="n">piddir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">configuration</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">no</span> <span class="o">+</span> <span class="s1">&#39;.pid&#39;</span></div>



<div class="viewcode-block" id="get_log_filename">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.get_log_filename">[docs]</a>
<span class="k">def</span> <span class="nf">get_log_filename</span><span class="p">(</span><span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">no</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      return the name of a single logfile for a single instance.</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="n">logdir</span> <span class="o">=</span> <span class="n">get_user_cache_dir</span><span class="p">(</span><span class="n">hostdir</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;log&#39;</span>

    <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">configuration</span>

    <span class="k">if</span> <span class="n">configuration</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.conf&#39;</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">logdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="n">configuration</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">no</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span></div>


<div class="viewcode-block" id="get_metrics_filename">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.get_metrics_filename">[docs]</a>
<span class="k">def</span> <span class="nf">get_metrics_filename</span><span class="p">(</span><span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">no</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      return the name of a single logfile for a single instance.</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="n">metricsdir</span> <span class="o">=</span> <span class="n">get_user_cache_dir</span><span class="p">(</span><span class="n">hostdir</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;metrics&#39;</span>

    <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">configuration</span>

    <span class="k">if</span> <span class="n">configuration</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.conf&#39;</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">metricsdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="n">configuration</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">no</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span></div>


<span class="k">def</span> <span class="nf">wget_config</span><span class="p">(</span><span class="n">urlstr</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">remote_config_url</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;wget_config </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">urlstr</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">urlstr</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">),</span>
                                   <span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S %Z&quot;</span><span class="p">)</span>
                <span class="n">last_mod_remote</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">last_mod_local</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="k">if</span> <span class="n">last_mod_remote</span> <span class="o">&lt;=</span> <span class="n">last_mod_local</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> is up to date (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;could not compare modification dates... downloading&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.downloading&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>

        <span class="c1"># top program config only needs to keep the url</span>
        <span class="c1"># we set option remote_config_url with the urlstr</span>
        <span class="c1"># at the first line of the config...</span>
        <span class="c1"># includes/plugins  etc... may be left as url in the config...</span>
        <span class="c1"># as the urlstr is kept in the config this option would be useless</span>
        <span class="c1"># (and damagable for plugins)</span>

        <span class="k">if</span> <span class="n">remote_config_url</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;remote_config_url </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">urlstr</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.downloading&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> downloaded (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;file </span><span class="si">%s</span><span class="s1"> could not be processed1 (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;resume with the one on the server&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Download failed 0: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">urlstr</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Server couldn</span><span class="se">\&#39;</span><span class="s1">t fulfill the request&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error code: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;file </span><span class="si">%s</span><span class="s1"> could not be processed2 (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;resume with the one on the server&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Download failed 1: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">urlstr</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to reach server. Reason: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;file </span><span class="si">%s</span><span class="s1"> could not be processed3 (</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;resume with the one on the server&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Download failed 2: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">urlstr</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.downloading&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;continue using existing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="config_path">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.config_path">[docs]</a>
<span class="k">def</span> <span class="nf">config_path</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;conf&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a subdir/config look for file in configish places.</span>

<span class="sd">    return Tuple:   Found (True/False), path_of_file_found|config_that_was_not_found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;config_path = </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># remote config</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http:&#39;</span><span class="p">):</span>
        <span class="n">urlstr</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ctype</span><span class="p">):</span> <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ctype</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">get_user_config_dir</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">subdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;http url </span><span class="si">%s</span><span class="s2"> path </span><span class="si">%s</span><span class="s2"> name </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">urlstr</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="c1"># do not allow plugin (Peter&#39;s mandatory decision)</span>
        <span class="c1"># because plugins may need system or python packages</span>
        <span class="c1"># that may not be installed on the current server.</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;plugins&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;it is not allowed to download plugins&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">wget_config</span><span class="p">(</span><span class="n">urlstr</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># priority 1 : config given is a valid path</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;config_path </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">config</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">config_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\.inc|\.conf|\.py)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">config_file</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">config_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">config_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ctype</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">config_name</span> <span class="o">+</span> <span class="n">ext</span>

    <span class="c1"># priority 1.5: config file given without extenion...</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">config_path</span>

    <span class="c1"># priority 2 : config given is a user one</span>

    <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_user_config_dir</span><span class="p">(),</span> <span class="n">subdir</span><span class="p">,</span>
                               <span class="n">config_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;config_path </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">config_path</span>

    <span class="c1"># priority 3 : config given to site config</span>

    <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_site_config_dir</span><span class="p">(),</span> <span class="n">subdir</span><span class="p">,</span>
                               <span class="n">config_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;config_path </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">config_path</span>

    <span class="c1"># priority 4 : plugins</span>

    <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;plugins&#39;</span><span class="p">:</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">get_package_lib_dir</span><span class="p">(</span>
        <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;plugins&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">config_name</span> <span class="o">+</span> <span class="n">ext</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;config_path </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">config_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">config_path</span>

    <span class="c1"># return bad file ...</span>
    <span class="k">if</span> <span class="n">mandatory</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s1">&#39;plugins&#39;</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;script not found </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config_name</span> <span class="o">!=</span> <span class="s1">&#39;plugins&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;file not found </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">config</span></div>



<div class="viewcode-block" id="Config">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config">[docs]</a>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       The option parser to produce a single configuration.</span>

<span class="sd">       it can be instantiated with one of:</span>

<span class="sd">       * one_config(component, config, action, isPost=False) -- read the options  for</span>
<span class="sd">         a given component an configuration,  (all in one call.)</span>

<span class="sd">       On the other hand, a configu can be built up from the following constructors:</span>

<span class="sd">       * default_config() -- returns an empty configuration, given a config file tree.</span>
<span class="sd">       * no_file_config() -- returns an empty config without any config file tree. </span>

<span class="sd">       Then just add settings manually::</span>

<span class="sd">         cfg = no_file_config()</span>

<span class="sd">         cfg.broker = sarracenia.credentials.Credential(&#39;amqps://anonymous:anonymous@hpfx.collab.science.gc.ca&#39;)</span>
<span class="sd">         cfg.topicPrefix = [ &#39;v02&#39;, &#39;post&#39;]</span>
<span class="sd">         cfg.component = &#39;subscribe&#39;</span>
<span class="sd">         cfg.config = &#39;flow_demo&#39;</span>
<span class="sd">         cfg.action = &#39;start&#39;</span>
<span class="sd">         cfg.bindings = [ (&#39;xpublic&#39;, [&#39;v02&#39;, &#39;post&#39;], [&#39;*&#39;, &#39;WXO-DD&#39;, &#39;observations&#39;, &#39;swob-ml&#39;, &#39;#&#39; ]) ]</span>
<span class="sd">         cfg.queueName=&#39;q_anonymous.subscriber_test2&#39;</span>
<span class="sd">         cfg.download=True</span>
<span class="sd">         cfg.batch=1</span>
<span class="sd">         cfg.messageCountMax=5</span>
<span class="sd">       </span>
<span class="sd">         # set the instance number for the flow class.</span>
<span class="sd">         cfg.no=0</span>
<span class="sd">       </span>
<span class="sd">       # and at the end call finalize</span>

<span class="sd">       cfg.finalize()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">port_required</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;on_line&#39;</span><span class="p">,</span> <span class="s1">&#39;on_html_page&#39;</span> <span class="p">]</span>

    <span class="n">v2entry_points</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;do_download&#39;</span><span class="p">,</span> <span class="s1">&#39;do_get&#39;</span><span class="p">,</span> <span class="s1">&#39;do_poll&#39;</span><span class="p">,</span> <span class="s1">&#39;do_put&#39;</span><span class="p">,</span> <span class="s1">&#39;do_send&#39;</span><span class="p">,</span> <span class="s1">&#39;on_message&#39;</span><span class="p">,</span>
        <span class="s1">&#39;on_file&#39;</span><span class="p">,</span> <span class="s1">&#39;on_heartbeat&#39;</span><span class="p">,</span> <span class="s1">&#39;on_housekeeping&#39;</span><span class="p">,</span>
        <span class="s1">&#39;on_html_page&#39;</span><span class="p">,</span> <span class="s1">&#39;on_part&#39;</span><span class="p">,</span> <span class="s1">&#39;on_post&#39;</span><span class="p">,</span> <span class="s1">&#39;on_report&#39;</span><span class="p">,</span>
        <span class="s1">&#39;on_start&#39;</span><span class="p">,</span> <span class="s1">&#39;on_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;on_watch&#39;</span><span class="p">,</span> <span class="s1">&#39;plugin&#39;</span>
    <span class="p">]</span>
    <span class="n">components</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;cpost&#39;</span><span class="p">,</span> <span class="s1">&#39;cpump&#39;</span><span class="p">,</span> <span class="s1">&#39;flow&#39;</span><span class="p">,</span> <span class="s1">&#39;poll&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;sarra&#39;</span><span class="p">,</span> <span class="s1">&#39;sender&#39;</span><span class="p">,</span> <span class="s1">&#39;shovel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;subscribe&#39;</span><span class="p">,</span> <span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="s1">&#39;winnow&#39;</span>
    <span class="p">]</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">,</span> <span class="s1">&#39;convert&#39;</span><span class="p">,</span> <span class="s1">&#39;devsnap&#39;</span><span class="p">,</span> <span class="s1">&#39;declare&#39;</span><span class="p">,</span> <span class="s1">&#39;disable&#39;</span><span class="p">,</span> <span class="s1">&#39;dump&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;sanity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;overview&#39;</span>
    <span class="p">]</span>

    <span class="c1"># lookup in dictionary, respond with canonical version.</span>
    <span class="n">appdir_stuff</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;appauthor&#39;</span><span class="p">:</span> <span class="s1">&#39;MetPX&#39;</span><span class="p">,</span> <span class="s1">&#39;appname&#39;</span><span class="p">:</span> <span class="s1">&#39;sr3&#39;</span><span class="p">}</span>

    <span class="c1"># Correct name on the right, old name on the left.</span>
    <span class="n">synonyms</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span>
        <span class="s1">&#39;accel_cp_threshold&#39;</span><span class="p">:</span> <span class="s1">&#39;accelThreshold&#39;</span><span class="p">,</span>
        <span class="s1">&#39;accel_scp_threshold&#39;</span><span class="p">:</span> <span class="s1">&#39;accelThreshold&#39;</span><span class="p">,</span>
        <span class="s1">&#39;accel_wget_threshold&#39;</span><span class="p">:</span> <span class="s1">&#39;accelThreshold&#39;</span><span class="p">,</span>
        <span class="s1">&#39;accept_unmatch&#39;</span><span class="p">:</span> <span class="s1">&#39;acceptUnmatched&#39;</span><span class="p">,</span>
        <span class="s1">&#39;accept_unmatched&#39;</span><span class="p">:</span> <span class="s1">&#39;acceptUnmatched&#39;</span><span class="p">,</span>
        <span class="s1">&#39;at&#39;</span><span class="p">:</span> <span class="s1">&#39;attempts&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;broker&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bd&#39;</span><span class="p">:</span> <span class="s1">&#39;baseDir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;basedir&#39;</span><span class="p">:</span> <span class="s1">&#39;baseDir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;base_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;baseDir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;baseurl&#39;</span><span class="p">:</span> <span class="s1">&#39;baseUrl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bind_queue&#39;</span><span class="p">:</span> <span class="s1">&#39;queueBind&#39;</span><span class="p">,</span>
        <span class="s1">&#39;blocksize&#39;</span><span class="p">:</span> <span class="s1">&#39;blockSize&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;bufsize&#39;</span><span class="p">:</span> <span class="s1">&#39;bufSize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cache&#39;</span><span class="p">:</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cb&#39;</span><span class="p">:</span> <span class="s1">&#39;nodupe_basis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cache_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;nodupe_basis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;caching&#39;</span><span class="p">:</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chmod&#39;</span><span class="p">:</span> <span class="s1">&#39;permDefault&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chmod_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;permDirDefault&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chmod_log&#39;</span><span class="p">:</span> <span class="s1">&#39;permLog&#39;</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span> <span class="p">:</span> <span class="s1">&#39;inline&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;content_encoding&#39;</span><span class="p">:</span>  <span class="s1">&#39;inlineEncoding&#39;</span><span class="p">,</span>
        <span class="s1">&#39;content_max&#39;</span><span class="p">:</span> <span class="s1">&#39;inlineByteMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span>
        <span class="s1">&#39;declare_exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;exchangeDeclare&#39;</span><span class="p">,</span>
        <span class="s1">&#39;declare_queue&#39;</span><span class="p">:</span> <span class="s1">&#39;queueDeclare&#39;</span><span class="p">,</span>
        <span class="s1">&#39;default_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;permDefault&#39;</span><span class="p">,</span>
        <span class="s1">&#39;default_dir_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;permDirDefault&#39;</span><span class="p">,</span>
        <span class="s1">&#39;default_log_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;permLog&#39;</span><span class="p">,</span>
        <span class="s1">&#39;destination_timezone&#39;</span><span class="p">:</span> <span class="s1">&#39;timezone&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;document_root&#39;</span><span class="p">:</span> <span class="s1">&#39;documentRoot&#39;</span><span class="p">,</span>
        <span class="s1">&#39;download-and-discard&#39;</span><span class="p">:</span> <span class="s1">&#39;discard&#39;</span><span class="p">,</span>
        <span class="s1">&#39;e&#39;</span> <span class="p">:</span> <span class="s1">&#39;fileEvents&#39;</span><span class="p">,</span>
        <span class="s1">&#39;events&#39;</span> <span class="p">:</span> <span class="s1">&#39;fileEvents&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ex&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span>
        <span class="s1">&#39;exchange_split&#39;</span><span class="p">:</span> <span class="s1">&#39;exchangeSplit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;exchange_suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;exchangeSuffix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="s1">&#39;expire&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;file_time_limit&#39;</span> <span class="p">:</span> <span class="s1">&#39;fileAgeMax&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;nodupe_fileAgeMax&#39;</span> <span class="p">:</span> <span class="s1">&#39;fileAgeMax&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;nodupe_fileAgeMin&#39;</span> <span class="p">:</span> <span class="s1">&#39;fileAgeMin&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;fp&#39;</span> <span class="p">:</span> <span class="s1">&#39;force_polling&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fs&#39;</span> <span class="p">:</span> <span class="s1">&#39;follow_symlinks&#39;</span><span class="p">,</span>
        <span class="s1">&#39;h&#39;</span> <span class="p">:</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span>
        <span class="s1">&#39;heartbeat&#39;</span><span class="p">:</span> <span class="s1">&#39;housekeeping&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hb_memory_baseline_file&#39;</span> <span class="p">:</span> <span class="s1">&#39;MemoryBaseLineFile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hb_memory_max&#39;</span> <span class="p">:</span> <span class="s1">&#39;MemoryMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hb_memory_multiplier&#39;</span> <span class="p">:</span> <span class="s1">&#39;MemoryMultiplier&#39;</span><span class="p">,</span>
        <span class="s1">&#39;imx&#39;</span><span class="p">:</span> <span class="s1">&#39;inlineByteMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inl&#39;</span> <span class="p">:</span> <span class="s1">&#39;inline&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;inline_encoding&#39;</span><span class="p">:</span>  <span class="s1">&#39;inlineEncoding&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inline_max&#39;</span><span class="p">:</span> <span class="s1">&#39;inlineByteMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="s1">&#39;instances&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lock&#39;</span><span class="p">:</span> <span class="s1">&#39;inflight&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;log_format&#39;</span><span class="p">:</span> <span class="s1">&#39;logFormat&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ll&#39;</span><span class="p">:</span> <span class="s1">&#39;logLevel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;loglevel&#39;</span><span class="p">:</span> <span class="s1">&#39;logLevel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;log_reject&#39;</span><span class="p">:</span> <span class="s1">&#39;logReject&#39;</span><span class="p">,</span>
        <span class="s1">&#39;logdays&#39;</span><span class="p">:</span> <span class="s1">&#39;logRotateCount&#39;</span><span class="p">,</span>
        <span class="s1">&#39;log_rotate&#39;</span><span class="p">:</span> <span class="s1">&#39;logRotateCount&#39;</span><span class="p">,</span>
        <span class="s1">&#39;logRotate&#39;</span><span class="p">:</span> <span class="s1">&#39;logRotateCount&#39;</span><span class="p">,</span>
        <span class="s1">&#39;logRotate&#39;</span><span class="p">:</span> <span class="s1">&#39;logRotateCount&#39;</span><span class="p">,</span>
        <span class="s1">&#39;logRotate_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;logRotateInterval&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message-ttl&#39;</span><span class="p">:</span> <span class="s1">&#39;post_messageAgeMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message_ttl&#39;</span><span class="p">:</span> <span class="s1">&#39;post_messageAgeMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_replace_new_dir&#39;</span> <span class="p">:</span> <span class="s1">&#39;pathReplace&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_filter_wmo2msc_replace_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;filter_wmo2msc_replace_dir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_filter_wmo2msc_uniquify&#39;</span><span class="p">:</span> <span class="s1">&#39;filter_wmo2msc_uniquify&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_filter_wmo2msc_tree&#39;</span><span class="p">:</span> <span class="s1">&#39;filter_wmo2msc_treeify&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_filter_wmo2msc_convert&#39;</span><span class="p">:</span> <span class="s1">&#39;filter_wmo2msc_convert&#39;</span><span class="p">,</span>
        <span class="s1">&#39;msg_fdelay&#39;</span> <span class="p">:</span> <span class="s1">&#39;fdelay&#39;</span><span class="p">,</span>
        <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;no_download&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;nd&#39;</span><span class="p">:</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;no_duplicates&#39;</span><span class="p">:</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;o&#39;</span> <span class="p">:</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;on_msg&#39;</span><span class="p">:</span> <span class="s1">&#39;on_message&#39;</span><span class="p">,</span>
        <span class="s1">&#39;p&#39;</span> <span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pm&#39;</span> <span class="p">:</span> <span class="s1">&#39;permCopy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_base_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;post_baseDir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_basedir&#39;</span><span class="p">:</span> <span class="s1">&#39;post_baseDir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_base_url&#39;</span><span class="p">:</span> <span class="s1">&#39;post_baseUrl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_baseurl&#39;</span><span class="p">:</span> <span class="s1">&#39;post_baseUrl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_document_root&#39;</span><span class="p">:</span> <span class="s1">&#39;post_documentRoot&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_exchange_split&#39;</span><span class="p">:</span> <span class="s1">&#39;post_exchangeSplit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_exchange_suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;post_exchangeSuffix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;messageRateMax&#39;</span><span class="p">,</span>
        <span class="s1">&#39;post_topic_prefix&#39;</span> <span class="p">:</span> <span class="s1">&#39;post_topicPrefix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;preserve_mode&#39;</span> <span class="p">:</span> <span class="s1">&#39;permCopy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;preserve_time&#39;</span> <span class="p">:</span> <span class="s1">&#39;timeCopy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pt&#39;</span> <span class="p">:</span> <span class="s1">&#39;timeCopy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;qn&#39;</span><span class="p">:</span> <span class="s1">&#39;queueName&#39;</span><span class="p">,</span>
        <span class="s1">&#39;queue&#39;</span> <span class="p">:</span> <span class="s1">&#39;queueName&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;queue_name&#39;</span> <span class="p">:</span> <span class="s1">&#39;queueName&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;realpath&#39;</span> <span class="p">:</span> <span class="s1">&#39;realpathPost&#39;</span><span class="p">,</span>
        <span class="s1">&#39;realpath_filter&#39;</span> <span class="p">:</span> <span class="s1">&#39;realpathFilter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;realpath_post&#39;</span> <span class="p">:</span> <span class="s1">&#39;realpathPost&#39;</span><span class="p">,</span>
        <span class="s1">&#39;remoteUrl&#39;</span> <span class="p">:</span> <span class="s1">&#39;sendTo&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;report_back&#39;</span><span class="p">:</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sanity_log_dead&#39;</span><span class="p">:</span> <span class="s1">&#39;runStateThreshold_hung&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sd&#39;</span> <span class="p">:</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sdb&#39;</span> <span class="p">:</span> <span class="s1">&#39;nodupe_basis&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;simulate&#39;</span><span class="p">:</span> <span class="s1">&#39;dry_run&#39;</span><span class="p">,</span>
        <span class="s1">&#39;simulation&#39;</span><span class="p">:</span> <span class="s1">&#39;dry_run&#39;</span><span class="p">,</span>
        <span class="s1">&#39;source_from_exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;sourceFromExchange&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;sum&#39;</span> <span class="p">:</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span>  
        <span class="s1">&#39;suppress_duplicates&#39;</span> <span class="p">:</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;suppress_duplicates_basis&#39;</span> <span class="p">:</span> <span class="s1">&#39;nodupe_basis&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;tls_rigour&#39;</span> <span class="p">:</span> <span class="s1">&#39;tlsRigour&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;topic_prefix&#39;</span> <span class="p">:</span> <span class="s1">&#39;topicPrefix&#39;</span>
    <span class="p">}</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Config.__init__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Config&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          instantiate an empty Configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__admin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__post_broker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">credentials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">CredentialDB</span><span class="p">()</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_user_config_dir</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span>
                                    <span class="s2">&quot;credentials.conf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">egdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">))</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;examples&#39;</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">config_search_path</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;.&quot;</span> <span class="p">,</span> <span class="n">get_user_config_dir</span><span class="p">(),</span> <span class="n">egdir</span><span class="p">,</span> <span class="n">egdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;flow&#39;</span>  <span class="p">]</span>


        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_options</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">default_options</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">parent</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bufSize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">byteRateMax</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fileAgeMax</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># disabled.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileAgeMin</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># disabled.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_exchanges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayFull</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_declared</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of variable that are &quot;declared env&quot;&#39;d </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2plugins</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2plugin_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logEvents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;after_accept&#39;</span><span class="p">,</span> <span class="s1">&#39;after_post&#39;</span><span class="p">,</span> <span class="s1">&#39;after_work&#39;</span><span class="p">,</span> <span class="s1">&#39;on_housekeeping&#39;</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destfn_scripts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileSizeMax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>

        <span class="c1"># oddness where final period is included in hostname...seems wrong. happens on windows a lot.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostdir</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_flowcb_needed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">housekeeping</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inline</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inlineByteMax</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inlineEncoding</span> <span class="o">=</span> <span class="s1">&#39;guess&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity_arbitrary_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logReject</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logRotateCount</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logRotateInterval</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messageAgeMax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_exchanges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_messageAgeMax</span> <span class="o">=</span> <span class="mi">0</span>
	    <span class="c1">#self.post_topicPrefix = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstrip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queueShare</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{USER}</span><span class="s2">_$</span><span class="si">{HOSTNAME}</span><span class="s2">_$</span><span class="si">{RAND8}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%04x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">65536</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statehost</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlsRigour</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;v03&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vip</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Config.__deepcopy__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config.__deepcopy__">[docs]</a>
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Configuration&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            code for this from here: https://stackoverflow.com/questions/1500718/how-to-override-the-copy-deepcopy-operations-for-a-python-object</span>
<span class="sd">            Needed for python &lt; 3.7ish? (ubuntu 18) found this bug: https://bugs.python.org/issue10076</span>
<span class="sd">            deepcopy fails for objects with re&#39;s in them?</span>
<span class="sd">            ok on ubuntu 20.04</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;masks&#39;</span><span class="p">:</span>
                <span class="n">v2</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span><span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">4</span><span class="p">:]))))</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Config._validate_urlstr">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._validate_urlstr">[docs]</a>
    <span class="k">def</span> <span class="nf">_validate_urlstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           returns a tuple ( bool, expanded_url ) </span>
<span class="sd">           the bool is whether the expansion worked, and the expanded_url is one with</span>
<span class="sd">           the added necessary authentication details from sarracenia.Credentials.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check url and add credentials if needed from credential file</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">cred_details</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urlstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cred_details</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;bad credential </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">urlstr</span><span class="p">)</span>
            <span class="c1"># Callers expect that a Credential object will be returned</span>
            <span class="n">cred_details</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">Credential</span><span class="p">()</span>
            <span class="n">cred_details</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">urlstr</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cred_details</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cred_details</span></div>


<div class="viewcode-block" id="Config.applyComponentDefaults">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.applyComponentDefaults">[docs]</a>
    <span class="k">def</span> <span class="nf">applyComponentDefaults</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">component</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          overlay defaults options for the given component to the given configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;poll&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sarra&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarradefopts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sender&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subscribe&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">subscribe</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;watch&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">watch</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__admin</span>

    <span class="nd">@admin</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">,</span> <span class="n">cred_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_urlstr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__admin</span> <span class="o">=</span> <span class="n">cred_details</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__admin</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">broker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span>

    <span class="nd">@broker</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">broker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">,</span> <span class="n">cred_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_urlstr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">cred_details</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">post_broker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__post_broker</span>

    <span class="nd">@post_broker</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">post_broker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">,</span> <span class="n">cred_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_urlstr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__post_broker</span> <span class="o">=</span> <span class="n">cred_details</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__post_broker</span> <span class="o">=</span> <span class="n">v</span>

<div class="viewcode-block" id="Config._varsub">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._varsub">[docs]</a>
    <span class="k">def</span> <span class="nf">_varsub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; substitute variable values from options</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">word</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">word</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">octal_number</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">word</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">word</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">word</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;$</span><span class="si">{BROKER_USER}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{BROKER_USER}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="c1"># FIXME: would this work also automagically if BROKER.USERNAME ?</span>

        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;$</span><span class="si">{POST_BROKER_USER}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_broker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{POST_BROKER_USER}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;$</span><span class="si">{RAND8}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">word</span> <span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{RAND8}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000000</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">elst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plst</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">plst</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span> <span class="n">elst</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parts</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="n">elst</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">E</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PROGRAM&#39;</span><span class="p">]:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="s1">&#39;component&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                <span class="n">repval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">repval</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">repval</span> <span class="o">=</span> <span class="n">repval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;${&#39;</span> <span class="o">+</span> <span class="n">E</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="n">repval</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">E</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;${&#39;</span> <span class="o">+</span> <span class="n">E</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">E</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Config._build_mask">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._build_mask">[docs]</a>
    <span class="k">def</span> <span class="nf">_build_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; return new entry to be appended to list of masks</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> invalid regular expression: </span><span class="si">{</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, ignored.&quot;</span> <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;DESTFNSCRIPT=.*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">script</span><span class="o">=</span><span class="n">fn</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destfn_scripts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
           <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span>
                <span class="n">option</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accept&#39;</span> <span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstrip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">)</span></div>


<div class="viewcode-block" id="Config.mask_ppstr">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.mask_ppstr">[docs]</a>
    <span class="k">def</span> <span class="nf">mask_ppstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           return a pretty print string version of the given mask, easier for humans to read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span><span class="p">,</span> <span class="n">maskDir</span><span class="p">,</span> <span class="n">maskFileOption</span><span class="p">,</span> <span class="n">mask_regexp</span><span class="p">,</span> <span class="n">accepting</span><span class="p">,</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">pstrip</span><span class="p">,</span> <span class="n">flatten</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;accept&#39;</span> <span class="k">if</span> <span class="n">accepting</span> <span class="k">else</span> <span class="s1">&#39;reject&#39;</span>
        <span class="k">if</span> <span class="n">pstrip</span> <span class="p">:</span> <span class="n">strip</span><span class="o">=</span><span class="n">pstrip</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; strip:</span><span class="si">{</span><span class="n">strip</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">maskFileOption</span> <span class="o">==</span> <span class="s1">&#39;WHATFN&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; filename:</span><span class="si">{</span><span class="n">maskFileOption</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">flatten</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">flatten</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; flatten:</span><span class="si">{</span><span class="n">flatten</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="s1">&#39;with &#39;</span> <span class="k">if</span> <span class="n">fn</span> <span class="ow">or</span> <span class="n">flatten</span> <span class="ow">or</span> <span class="n">strip</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1"> into </span><span class="si">{</span><span class="n">maskDir</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">mirror:</span><span class="si">{</span><span class="n">mirror</span><span class="si">}{</span><span class="n">strip</span><span class="si">}{</span><span class="n">flatten</span><span class="si">}{</span><span class="n">fn</span><span class="si">}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="Config._parse_set_string">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._parse_set_string">[docs]</a>
    <span class="k">def</span> <span class="nf">_parse_set_string</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">old_value</span><span class="p">:</span> <span class="nb">set</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           given a set string, return a python set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sv</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">sv</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
            <span class="n">sv</span><span class="o">=</span><span class="n">v</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span> 
                <span class="n">sv</span><span class="o">=</span><span class="nb">set</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>
                <span class="k">while</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
                    <span class="n">op</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span> 
                    <span class="n">sv</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">sv</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">sv</span><span class="o">=</span> <span class="n">old_value</span> <span class="o">|</span> <span class="n">sv</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="p">:</span>
                    <span class="n">sv</span><span class="o">=</span> <span class="n">old_value</span> <span class="o">-</span> <span class="n">sv</span>

        <span class="k">return</span> <span class="n">sv</span></div>


<div class="viewcode-block" id="Config.add_option">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.add_option">[docs]</a>
    <span class="k">def</span> <span class="nf">add_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_values</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           options can be declared in any plugin. There are various *kind* of options, where the declared type modifies the parsing.</span>
<span class="sd">           </span>
<span class="sd">           * &#39;count&#39;      integer count type. </span>

<span class="sd">           * &#39;octal&#39;      base-8 (octal) integer type.</span>
<span class="sd">           * &#39;duration&#39;   a floating point number indicating a quantity of seconds (0.001 is 1 milisecond)</span>
<span class="sd">                          modified by a unit suffix ( m-minute, h-hour, w-week ) </span>

<span class="sd">           * &#39;flag&#39;       boolean (True/False) option.</span>

<span class="sd">           * &#39;float&#39;      a simple floating point number.</span>

<span class="sd">           * &#39;list&#39;       a list of string values, each succeeding occurrence catenates to the total.</span>
<span class="sd">                          all v2 plugin options are declared of type list.</span>

<span class="sd">           * &#39;set&#39;        a set of string values, each succeeding occurrence is unioned to the total.</span>
<span class="sd">                          if all_values is provided, then constrain set to that.</span>

<span class="sd">           * &#39;size&#39;       integer size. Suffixes k, m, and g for kilo, mega, and giga (base 2) multipliers.</span>

<span class="sd">           * &#39;str&#39;        an arbitrary string value, as will all of the above types, each </span>
<span class="sd">                          succeeding occurrence overrides the previous one.</span>
<span class="sd">    </span>
<span class="sd">           If a value is set to None, that could mean that it has not been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Blindly add the option to the list if it doesn&#39;t already exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

        <span class="c1"># Retreive the &#39;new&#39; option &amp; enforce the correct type.</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span> <span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> multiple declarations of </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">option</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">option</span><span class="p">)</span><span class="si">}</span><span class="s2"> choosing last one: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>


        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
            <span class="n">count_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span>
            <span class="n">duration_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">float</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">default_value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;flag&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">flag_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">isTrue</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="nb">float</span> <span class="p">:</span>
            <span class="n">float_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">float</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">parse_float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>  
            <span class="n">list_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">option</span> <span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="c1">#subtlety... None means: has not been set, </span>
                <span class="c1"># where an empty list to be an explicit setting.</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;octal&#39;</span><span class="p">:</span>
            <span class="n">perm_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">octal_number</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">octal_number</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>  
            <span class="n">set_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="n">sv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_set_string</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">set</span><span class="p">())</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">sv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_values</span><span class="p">:</span>
                <span class="n">set_choices</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_values</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">size_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">str_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> invalid kind: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> for option: </span><span class="si">{</span><span class="n">option</span><span class="si">}</span><span class="s2"> ignored&quot;</span> <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">option</span><span class="si">}</span><span class="s2"> declared as type:</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">option</span><span class="p">))</span><span class="si">}</span><span class="s2"> value:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Config.dump">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.dump">[docs]</a>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; print out what the configuration looks like.</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="n">term</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">((</span><span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

        <span class="c1"># for python &gt; 3.7</span>
        <span class="c1">#c = copy.deepcopy(self.dictify())</span>
        <span class="c1"># but older python needs:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictify</span><span class="p">()</span>
        <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;masks&#39;</span><span class="p">:</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">]):</span>
                   <span class="n">d</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_ppstr</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span>
                   <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">omit</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;env&#39;</span> <span class="p">]</span> <span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">omit</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">Credential</span> <span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span> <span class="n">d</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">term</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Config.dictify">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.dictify">[docs]</a>
    <span class="k">def</span> <span class="nf">dictify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      return a dict version of the cfg... </span>
<span class="sd">      &quot;&quot;&quot;</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">):</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">):</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;broker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_broker&#39;</span><span class="p">):</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;post_broker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span>

        <span class="k">return</span> <span class="n">cd</span></div>


    
    <span class="k">def</span> <span class="nf">get_source_from_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exchange</span><span class="p">):</span>
        <span class="c1">#self.logger.debug(&quot;%s get_source_from_exchange %s&quot; % (self.program_name,exchange))</span>

        <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exchange</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;xs_&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="n">source</span>

        <span class="c1"># check if source is a valid declared source user</span>

        <span class="n">len_u</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="c1"># look for user with role source</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_users</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_users</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;source&#39;</span> <span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">exchange</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len_u</span> <span class="p">:</span>
                       <span class="n">source</span> <span class="o">=</span> <span class="n">u</span>
                       <span class="n">len_u</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

        <span class="k">return</span> <span class="n">source</span>

 

    <span class="k">def</span> <span class="nf">_merge_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;masks&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Config.merge">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.merge">[docs]</a>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">       merge to lists of options.</span>

<span class="sd">       merge two lists of options if one is cumulative then merge, </span>
<span class="sd">       otherwise if not None, then take value from oth</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">oth</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">oth</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_field</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="n">oth</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">oth</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_field</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">oth</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span></div>


    <span class="k">def</span> <span class="nf">_override_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;masks&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Config.override">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.override">[docs]</a>
    <span class="k">def</span> <span class="nf">override</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       override a value in a set of options.</span>

<span class="sd">       why override() method and not just assign values to the dictionary?</span>
<span class="sd">       in the configuration file, there are various ways to have variable substituion.</span>
<span class="sd">       override invokes those, so that they are properly interpreted.  Otherwise,</span>
<span class="sd">       you just end up with a literal value.</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">oth</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">oth</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_override_field</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="n">oth</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">oth</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_override_field</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">oth</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Config._resolve_exchange">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._resolve_exchange">[docs]</a>
    <span class="k">def</span> <span class="nf">_resolve_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           based on the given configuration, fill in with defaults or guesses.</span>
<span class="sd">           sets self.exchange.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#if hasattr(self, &#39;post_broker&#39;) and self.post_broker is not None and self.post_broker.url is not None:</span>
            <span class="c1">#    self.exchange = &#39;xs_%s&#39; % self.post_broker.url.username</span>
            <span class="c1">#else:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;anonymous&#39;</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="s1">&#39;xpublic&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="s1">&#39;xs_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exchangeSuffix&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchangeSuffix</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exchangeSplit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span></div>


<div class="viewcode-block" id="Config._parse_binding">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._parse_binding">[docs]</a>
    <span class="k">def</span> <span class="nf">_parse_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtopic_string</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         FIXME: see original parse, with substitions for url encoding.</span>
<span class="sd">                also should sqwawk about error if no exchange or topicPrefix defined.</span>
<span class="sd">                also None to reset to empty, not done.</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_exchange</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">subtopic_string</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> broker needed before subtopic&quot;</span> <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;amq&#39;</span> <span class="p">:</span>
                <span class="n">subtopic</span> <span class="o">=</span> <span class="n">subtopic_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subtopic</span> <span class="o">=</span> <span class="n">subtopic_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;topicPrefix&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span><span class="p">,</span> <span class="n">subtopic</span><span class="p">))</span></div>


<div class="viewcode-block" id="Config._parse_v2plugin">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._parse_v2plugin">[docs]</a>
    <span class="k">def</span> <span class="nf">_parse_v2plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entryPoint</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       config file parsing for a v2 plugin.</span>

<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entryPoint</span> <span class="ow">in</span> <span class="n">Config</span><span class="o">.</span><span class="n">v2entry_points</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;undefined entry point: </span><span class="si">{}</span><span class="s2"> skipped&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entryPoint</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entryPoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2plugins</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v2plugins</span><span class="p">[</span><span class="n">entryPoint</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v2plugins</span><span class="p">[</span><span class="n">entryPoint</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_parse_declare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="s1">&#39;envvar&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env_declared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_option</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;subscriber&#39;</span><span class="p">,</span> <span class="s1">&#39;subscribe&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declared_users</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declared_exchanges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="Config._parse_setting">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._parse_setting">[docs]</a>
    <span class="k">def</span> <span class="nf">_parse_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          v3 plugin accept options for specific modules.</span>
<span class="sd">    </span>
<span class="sd">          parsed from:</span>
<span class="sd">          set sarracenia.flowcb.log.filter.Log.level debug</span>

<span class="sd">          example:   </span>
<span class="sd">          opt= sarracenia.flowcb.log.filter.Log.level  value = debug</span>

<span class="sd">          results in:</span>
<span class="sd">          self.settings[ sarracenia.flowcb.log.filter.Log ][level] = debug</span>

<span class="sd">          options should be fed to plugin class on instantiation.</span>
<span class="sd">          stripped of class... </span>
<span class="sd">          * options = { &#39;level&#39; : &#39;debug&#39; }</span>
<span class="sd">    </span>

<span class="sd">       &quot;&quot;&quot;</span>
        <span class="n">opt_class</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">opt_var</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">opt_class</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">opt_class</span><span class="p">][</span><span class="n">opt_var</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_parse_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1">#logger.error(&#39;FIXME! input value: %s&#39; % value)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span><span class="p">:</span>
               <span class="k">return</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">known_methods</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cod,&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c1">#logger.error(&#39;returning 1: %s&#39; % value)</span>
            <span class="k">return</span>

        <span class="c1">#logger.error( f&#39;1 value: {value} self.identity_method={self.identity_method}&#39; )</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;z,&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="s1">&#39;cod,&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a,&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="s1">&#39;arbitrary&#39;</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">identity_arbitrary_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1">#logger.error( f&#39;2 value: {value} self.identity_method={self.identity_method}&#39; )</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span> <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1">#logger.error(&#39;returning 1.1: %s&#39; % &#39;none&#39;)</span>
            <span class="k">return</span> 
        <span class="c1">#logger.error( f&#39;3 value: {value} self.identity_method={self.identity_method}&#39; )</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">Identity</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
            <span class="c1">#logger.error(&#39;against 1.8: %s&#39; % sc.__name__.lower() )</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">sc</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c1">#logger.error(&#39;returning 2: %s&#39; % value )</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">==</span> <span class="s1">&#39;cod,&#39;</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="s1">&#39;registered_as&#39;</span><span class="p">):</span>
                <span class="c1">#logger.error(&#39;against 3: %s&#39; % sc.registered_as() )</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">registered_as</span><span class="p">()</span> <span class="o">==</span> <span class="n">value</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">==</span> <span class="s1">&#39;cod,&#39;</span><span class="p">:</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">+=</span> <span class="n">sc</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1">#logger.error(&#39;returning 3: %s&#39; % self.identity_method)</span>
                    <span class="k">return</span>
        <span class="c1"># FIXME this is an error return case, how to designate an invalid checksum?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span> <span class="o">=</span> <span class="s1">&#39;invalid&#39;</span>
        <span class="c1">#logger.error(&#39;returning 4: invalid&#39; )</span>




<div class="viewcode-block" id="Config.parse_file">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.parse_file">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; add settings from a given config file to self </span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">component</span><span class="p">:</span>
            <span class="n">cfname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">cfg</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfname</span> <span class="o">=</span> <span class="n">cfg</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;looking for </span><span class="si">{</span><span class="n">cfg</span><span class="si">}</span><span class="s1"> (in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">cfg</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
            <span class="n">cfgfilepath</span><span class="o">=</span><span class="n">cfg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfgfilepath</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_search_path</span><span class="p">:</span>
                 <span class="n">cfgfilepath</span><span class="o">=</span><span class="n">d</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">cfg</span>
                 <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">cfgfilepath</span> <span class="p">):</span>
                     <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cfgfilepath</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;failed to find </span><span class="si">{</span><span class="n">cfg</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                 <span class="k">return</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;found </span><span class="si">{</span><span class="n">cfgfilepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">lineno</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">saved_lineno</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfgfilepath</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfgfilepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">lineno</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">saved_lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_line</span><span class="p">(</span> <span class="n">component</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">saved_lineno</span></div>



    <span class="k">def</span> <span class="nf">parse_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">l</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">lineno</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1">#print(&#39;FIXME parsing %s:%d %s&#39; % (cfg, lineno, line ))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Config</span><span class="o">.</span><span class="n">synonyms</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">synonyms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;destination&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;poll&#39;</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;pollUrl&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;sendTo&#39;</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;broker&#39;</span> <span class="ow">and</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;poll&#39;</span> <span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;post_broker&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">convert_to_v3</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">log_flowcb_needed</span> <span class="o">|=</span> <span class="s1">&#39;_log&#39;</span> <span class="ow">in</span> <span class="n">k</span>
                   
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">convert_to_v3</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">convert_to_v3</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;continue&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cfname</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1"> obsolete v2: </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1"> ignored&#39;</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cfname</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1"> obsolete v2:</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1"> converted to sr3:</span><span class="se">\&quot;</span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">convert_to_v3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">k</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;continue&#39;</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">line</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># FIXME... I think synonym check should happen here, but no time to check right now.</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">flag_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">isTrue</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;logReject&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logReject</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logEvents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logEvents</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;reject&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> missing argument(s)&quot;</span> <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;reject&#39;</span> <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_mask</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="s1">&#39;cb&#39;</span> <span class="p">]:</span>
            <span class="c1">#vv = v.split(&#39;.&#39;)</span>
            <span class="c1">#v = &#39;sarracenia.flowcb.&#39; + v + &#39;.&#39; + vv[-1].capitalize()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;callback_prepend&#39;</span><span class="p">,</span> <span class="s1">&#39;cbp&#39;</span> <span class="p">]:</span>
            <span class="c1">#vv = v.split(&#39;.&#39;)</span>
            <span class="c1">#v = &#39;sarracenia.flowcb.&#39; + v + &#39;.&#39; + vv[-1].capitalize()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;declare&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_declare</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;feeder&#39;</span><span class="p">,</span> <span class="s1">&#39;manager&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feeder</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declared_users</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;feeder&#39;</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_headers</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;include&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> file </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> failed to parse:  </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subtopic&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_binding</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;topicPrefix&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;post_topicPrefix&#39;</span><span class="p">]:</span>
            <span class="c1">#if (not self.post_broker.url) or self.post_broker.url.scheme[0:3] == &#39;amq&#39;:</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_topicPrefix</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_topicPrefix</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;import&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flow_callback&#39;</span><span class="p">,</span> <span class="s1">&#39;flowcb&#39;</span><span class="p">,</span> <span class="s1">&#39;fcb&#39;</span><span class="p">,</span> <span class="s1">&#39;flowCallback&#39;</span> <span class="p">]:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flow_callback_prepend&#39;</span><span class="p">,</span> <span class="s1">&#39;flowcb_prepend&#39;</span><span class="p">,</span> <span class="s1">&#39;fcbp&#39;</span><span class="p">,</span> <span class="s1">&#39;flowCallbackPrepend&#39;</span> <span class="p">]:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;setting&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_setting</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;integrity&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Config</span><span class="o">.</span><span class="n">port_required</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">cfname</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> not supported in v3, consult porting guide. Option ignored.&#39;</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39; porting guide: https://github.com/MetPX/sarracenia/blob/v03_wip/docs/How2Guides/v2ToSr3.rst &#39;</span> <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Config</span><span class="o">.</span><span class="n">v2entry_points</span><span class="p">:</span>
            <span class="c1">#if k in self.plugins:</span>
            <span class="c1">#    self.plugins.remove(v)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_v2plugin</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;no-import&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_v3unplugin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inflight&#39;</span><span class="p">,</span> <span class="s1">&#39;lock&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileAgeMin</span> <span class="o">=</span> <span class="n">vv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">]:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           2020/08/26 - PAS</span>
<span class="sd">           strip in config file gets translated into two separate attributes: strip and pstrip.</span>
<span class="sd">             strip is the numeric variety (0-n) and if the supplied option in a regex pattern, </span>
<span class="sd">             then instead pstrip is set, and strip is set to 0.</span>

<span class="sd">           I don&#39;t know why it is done this way... just documenting/conforming to existing state.</span>
<span class="sd">           &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">strip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pstrip</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pstrip</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pstrip</span> <span class="o">=</span> <span class="n">v</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">strip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">duration_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> 
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">  </span><span class="si">%s</span><span class="s1"> is a duration option requiring a decimal number of seconds value&#39;</span>
                    <span class="o">%</span> <span class="p">(</span> <span class="n">cfname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
                <span class="k">return</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">float_options</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">parse_float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> Ignored &#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">perm_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">octal_number</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> setting to </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> ignored: only numberic modes supported&#39;</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">size_options</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">count_options</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">set_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">set</span><span class="p">([]))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;all&#39;</span> <span class="p">,</span> <span class="s1">&#39;+all&#39;</span> <span class="p">]:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">set_choices</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">set_choices</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">return</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_set_string</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">set_choices</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_choices</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1"> invalid entry </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. Must be one of: </span><span class="si">{</span><span class="n">set_choices</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">str_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2"> if download is false, directory has no effect&quot;</span> <span class="p">)</span>

            <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">v</span><span class="o">=</span><span class="kc">None</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#FIXME: with _options lists for all types and addition of declare, this is probably now dead code.</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s1"> possibly undeclared option: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">parse_float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="c1"># the only integers that have units are durations.</span>
                    <span class="c1"># integers without units will come out unchanged.</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">newv</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">newv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">newv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># FIXME:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">cfname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolveQueueName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">component</span><span class="p">,</span><span class="n">cfg</span><span class="p">):</span>

        <span class="n">queuefile</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">user_cache_dir</span><span class="p">(</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appname&#39;</span><span class="p">],</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">appdir_stuff</span><span class="p">[</span><span class="s1">&#39;appauthor&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statehost</span><span class="p">:</span>
            <span class="n">queuefile</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostdir</span>

        <span class="n">queuefile</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">cfg</span>
        <span class="n">queuefile</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">component</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">cfg</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exchangeSplit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">queuefile</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span>
        <span class="n">queuefile</span> <span class="o">+=</span> <span class="s1">&#39;.qname&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queue_filename</span> <span class="o">=</span> <span class="n">queuefile</span>

        <span class="c1">#while (not hasattr(self, &#39;queueName&#39;)) or (self.queueName is None):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">          normal:</span>
<span class="sd">              if not the lead instance, wait a bit for the queuefile to be written.</span>
<span class="sd">              look for a queuefile in the state directory, if it is there, read it.</span>
<span class="sd">              if you can&#39;t read the file</span>

<span class="sd">          if you are instance 1, or 0 (foreground) and the queuefile is missing, then need</span>
<span class="sd">          to write it.  if queueName is set, use that, if not</span>

<span class="sd">          if you set the queuename, it might have variable values that when evaluated repeatedly (such as randomized settings)</span>
<span class="sd">          will come out differently every time. So even in the case of a fixed queue name, need to write </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># worker instances need give lead instance time to write the queuefile</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>

            <span class="n">queue_file_read</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">config_read_try</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">queue_file_read</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">queuefile</span><span class="p">):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">queuefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="n">config_read_try</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;instance read try </span><span class="si">{</span><span class="n">config_read_try</span><span class="si">}</span><span class="s1"> queueName </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span><span class="si">}</span><span class="s1"> from queue state file </span><span class="si">{</span><span class="n">queuefile</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                      <span class="n">nap</span><span class="o">=</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;queue name corrupt take a short </span><span class="si">{</span><span class="n">nap</span><span class="si">}</span><span class="s1"> second nap, then try again&#39;</span> <span class="p">)</span>
                      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nap</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">config_read_try</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                          <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;failed to read queue name from </span><span class="si">{</span><span class="n">queuefile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                          <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                      <span class="n">queue_file_read</span><span class="o">=</span><span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span> 
            <span class="c1"># only lead instance (0-foreground, 1-start, or none in the case of &#39;declare&#39;)</span>
            <span class="c1"># should write the state file.</span>

    
            <span class="c1"># lead instance shou</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">queuefile</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">queuefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="c1">#if the queuefile is corrupt, then will need to guess anyways.</span>
            <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="p">):</span>
                <span class="n">queueShare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queueShare</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;q_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">component</span><span class="p">,</span><span class="n">cfg</span><span class="p">,</span><span class="n">queueShare</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;default guessed queueName  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="p">)</span>
    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="s1">&#39;declare&#39;</span> <span class="p">]:</span>
                <span class="k">return</span>

            <span class="c1"># first make sure directory exists.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">queuefile</span><span class="p">)):</span>
                <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">queuefile</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">queuefile</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> 
                <span class="n">tmpQfile</span><span class="o">=</span><span class="n">queuefile</span><span class="o">+</span><span class="s1">&#39;.tmp&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tmpQfile</span><span class="p">):</span> 
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpQfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span> <span class="n">tmpQfile</span><span class="p">,</span> <span class="n">queuefile</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;Queue name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span><span class="si">}</span><span class="s1"> being persisted to </span><span class="si">{</span><span class="n">queuefile</span><span class="si">}</span><span class="s1"> by some other process, so ignoring it.&#39;</span> <span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;queue name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queueName</span><span class="si">}</span><span class="s1"> persisted to </span><span class="si">{</span><span class="n">queuefile</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>





<div class="viewcode-block" id="Config.finalize">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.finalize">[docs]</a>
    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">         Before final use, take the existing settings, and infer any missing needed defaults from what is provided.</span>
<span class="sd">         Should be called prior to using a configuration.</span>

<span class="sd">         There are default options that apply only if they are not overridden... </span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sum</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">component</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">:</span>
            <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;invalid action: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2"> must be one of: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nodupe_ttl&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodupe_ttl</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">isTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodupe_ttl</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodupe_ttl</span> <span class="o">=</span> <span class="mi">300</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodupe_ttl</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodupe_ttl</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodupe_ttl</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logLevel</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># double check to ensure duration options are properly parsed</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">duration_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;kbytes_ps&#39;</span><span class="p">):</span>
            <span class="n">bytes_ps</span> <span class="o">=</span> <span class="n">parse_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kbytes_ps</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbytes_ps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                <span class="n">bytes_ps</span> <span class="o">*=</span> <span class="mi">1024</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;byteRateMax&#39;</span><span class="p">,</span> <span class="n">bytes_ps</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">count_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">parse_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">size_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">chunksize_from_str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flag_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">isTrue</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">float_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">parse_float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logEvents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_flowcb_needed</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.log.Log&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="p">(</span><span class="s1">&#39;log&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="p">)</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_late</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;log&#39;</span> <span class="p">)</span>

        <span class="c1"># patch, as there is no &#39;none&#39; level in python logging module...</span>
        <span class="c1">#    mapping so as not to break v2 configs.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;logLevel&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logLevel</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logLevel</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nodupe_basis&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodupe_basis</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;nodupe.data&#39;</span> <span class="p">)</span>
                <span class="nb">delattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nodupe_basis&#39;</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodupe_basis</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_early</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s1">&#39;nodupe.name&#39;</span> <span class="p">)</span>
                <span class="nb">delattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nodupe_basis&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.conf&#39;</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_topicPrefix&#39;</span><span class="p">):</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">post_topicPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;retry_ttl&#39;</span> <span class="p">):</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">retry_ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expire</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_ttl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">retry_ttl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># FIXME: note that v2 *user_cache_dir* is, v3 called:  cfg_run_dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cfg_run_dir&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statehost</span><span class="p">:</span>
                <span class="n">hostdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostdir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hostdir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg_run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_user_cache_dir</span><span class="p">(</span><span class="n">hostdir</span><span class="p">),</span>
                                            <span class="n">component</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="s1">&#39;post_exchange&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span> <span class="o">=</span> <span class="s1">&#39;xs_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_exchangeSuffix&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exchangeSuffix</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;post_exchange&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_exchangeSplit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exchangeSplit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_exchangeSplit</span><span class="p">)):</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span> <span class="o">=</span> <span class="n">l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;poll&#39;</span> <span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;vip&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vip</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;exchange&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_exchange</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;broker&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceFromExchange</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_broker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="p">,</span><span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="p">,</span><span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_exchange</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolveQueueName</span><span class="p">(</span><span class="n">component</span><span class="p">,</span><span class="n">cfg</span><span class="p">)</span>

        <span class="n">valid_inlineEncodings</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;guess&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;inlineEncoding&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inlineEncoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_inlineEncodings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2"> invalid inlineEncoding: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inlineEncoding</span><span class="si">}</span><span class="s2"> must be one of: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_inlineEncodings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statehost</span><span class="p">:</span>
                <span class="n">hostdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostdir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hostdir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metricsFilename</span> <span class="o">=</span> <span class="n">get_metrics_filename</span><span class="p">(</span><span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid_filename</span> <span class="o">=</span> <span class="n">get_pid_filename</span><span class="p">(</span><span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pid&#39;</span><span class="p">,</span> <span class="s1">&#39;.retry&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">novipFilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pid&#39;</span><span class="p">,</span> <span class="s1">&#39;.noVip&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindings</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;#&#39;</span> <span class="p">])]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;documentRoot&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">realpathPost</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span> <span class="n">words0</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{component}</span><span class="s2">/</span><span class="si">{config}</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">words0</span><span class="p">,</span> <span class="n">words1</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;use of backslash ( </span><span class="se">\\</span><span class="s2"> ) is an escape character. For a path separator use forward slash ( / ).&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pollUrl&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;post_baseUrl&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span> <span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2"> defaulting post_baseUrl to match pollURl, since it isn&#39;t specified.&quot;</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pollUrl</span>
            
        <span class="c1"># verify post_baseDir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_documentRoot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_documentRoot</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;use post_baseDir instead of post_documentRoot&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;use post_baseDir instead of documentRoot&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;file:&#39;</span> <span class="p">]</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;sftp:&#39;</span> <span class="p">]</span> <span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span>  <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_baseUrl</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{component}</span><span class="s2">/</span><span class="si">{config}</span><span class="s2"> defaulting post_baseDir to same as baseDir&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">messageCountMax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">messageCountMax</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">messageCountMax</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s1"> overriding batch for consistency with messageCountMax: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;poll&#39;</span> <span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;scheduled_interval&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;scheduled_hour&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;scheduled_minute&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;scheduled_time&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runStateThreshold_hung</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">housekeeping</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2"> runStateThreshold_hung </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">runStateThreshold_hung</span><span class="si">}</span><span class="s2"> set lower than housekeeping </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">housekeeping</span><span class="si">}</span><span class="s2">. sr3 sanity might think this flow is hung and kill it too quickly.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vip</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vip&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2"> vip feature requested, but missing library: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;vip&#39;</span><span class="p">][</span><span class="s1">&#39;modules_needed&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">check_undeclared_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">alloptions</span> <span class="o">=</span> <span class="n">str_options</span> <span class="o">+</span> <span class="n">flag_options</span> <span class="o">+</span> <span class="n">float_options</span> <span class="o">+</span> <span class="n">list_options</span> <span class="o">+</span> <span class="n">set_options</span> <span class="o">+</span> <span class="n">count_options</span> <span class="o">+</span> <span class="n">size_options</span> <span class="o">+</span> <span class="n">duration_options</span>
        <span class="c1"># FIXME: confused about this...  commenting out for now...</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alloptions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2"> undeclared option: </span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">flag_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">isTrue</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">float_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">parse_float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">set_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_set_string</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">),</span><span class="nb">set</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">str_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">count_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span> <span class="p">]:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">parse_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">size_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span> <span class="p">]:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">parse_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">duration_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span> <span class="p">]:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">durationToSeconds</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">)))</span>
            <span class="c1"># list options are the default, so no need to regularize</span>

        <span class="n">no_defaults</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">alloptions</span><span class="p">:</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">):</span>
                <span class="n">no_defaults</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">u</span> <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;missing defaults: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">no_defaults</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      2020/05/26 FIXME here begins sheer terror.</span>
<span class="sd">      following routines are taken verbatim from v2. </span>
<span class="sd">      trying not to touch it... it is painful.</span>
<span class="sd">      setting new_ values for downloading etc...</span>
<span class="sd">      sundew_* ... </span>
<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Config._sundew_basename_parts">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config._sundew_basename_parts">[docs]</a>
    <span class="k">def</span> <span class="nf">_sundew_basename_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">basename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        modified from metpx SenderFTP</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">lst</span></div>


    <span class="c1"># from metpx SenderFTP</span>
<div class="viewcode-block" id="Config.sundew_dirPattern">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.sundew_dirPattern">[docs]</a>
    <span class="k">def</span> <span class="nf">sundew_dirPattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">destDir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        does substitutions for patterns in directories.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BN</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">EN</span> <span class="o">=</span> <span class="n">BN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

        <span class="n">BP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sundew_basename_parts</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">)</span>

        <span class="n">ndestDir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">DD</span> <span class="o">=</span> <span class="n">destDir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ddword</span> <span class="ow">in</span> <span class="n">DD</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ddword</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="k">continue</span>

            <span class="n">nddword</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">DW</span> <span class="o">=</span> <span class="n">ddword</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dwword</span> <span class="ow">in</span> <span class="n">DW</span><span class="p">:</span>
                <span class="n">nddword</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sundew_matchPattern</span><span class="p">(</span><span class="n">BN</span><span class="p">,</span> <span class="n">EN</span><span class="p">,</span> <span class="n">BP</span><span class="p">,</span> <span class="n">dwword</span><span class="p">,</span> <span class="n">dwword</span><span class="p">)</span>

            <span class="n">ndestDir</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">nddword</span>

        <span class="c1"># This code might add an unwanted &#39;/&#39; in front of ndestDir</span>
        <span class="c1"># if destDir does not start with a substitution $ and</span>
        <span class="c1"># if destDir does not start with a / ... it does not need one</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">destDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">destDir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">destDir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ndestDir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">ndestDir</span> <span class="o">=</span> <span class="n">ndestDir</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">ndestDir</span></div>


    <span class="c1"># modified from metpx SenderFTP</span>
    <span class="k">def</span> <span class="nf">sundew_matchPattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">BN</span><span class="p">,</span> <span class="n">EN</span><span class="p">,</span> <span class="n">BP</span><span class="p">,</span> <span class="n">keywd</span><span class="p">,</span> <span class="n">defval</span><span class="p">):</span>

        <span class="n">BN6</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">BN</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span> <span class="n">BN6</span> <span class="o">=</span> <span class="n">BN</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{T1}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{T2}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{A1}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{A2}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{ii}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{CCCC}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">EN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{YY}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{GG}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{Gg}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{BBB}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">EN</span><span class="p">[</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
            <span class="c1"># from pds&#39;datetime suffix... not sure</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{RYYYY}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BN6</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{RMM}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BN6</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{RDD}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BN6</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{RHH}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BN6</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{RMN}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BN6</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">keywd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">{RSS}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BN6</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>

        <span class="c1"># Matching with basename parts if given</span>

        <span class="k">if</span> <span class="n">BP</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">BP</span><span class="p">):</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>
                <span class="n">lkw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">keywd</span><span class="p">[:</span><span class="n">lkw</span><span class="p">]</span> <span class="o">==</span> <span class="n">kw</span><span class="p">:</span> <span class="k">return</span> <span class="n">v</span> <span class="o">+</span> <span class="n">keywd</span><span class="p">[</span><span class="n">lkw</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">defval</span>

<div class="viewcode-block" id="Config.variableExpansion">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.variableExpansion">[docs]</a>
    <span class="k">def</span> <span class="nf">variableExpansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            replace substitution patterns, variable substitutions as described in</span>
<span class="sd">            https://metpx.github.io/sarracenia/Reference/sr3_options.7.html#variables</span>

<span class="sd">            returns:  the given string with the substiturions done.</span>

<span class="sd">            examples:   ${YYYYMMDD-70m} becomes 20221107 assuming that was the current date 70 minutes ago.</span>
<span class="sd">                        environment variables, and built-in settings are replaced also.</span>

<span class="sd">           timeoffset -70m</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">cdir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cdir</span>

        <span class="n">new_dir</span> <span class="o">=</span> <span class="n">cdir</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{BD}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{BD}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="p">(</span> <span class="s1">&#39;$</span><span class="si">{BUP}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;baseUrl&#39;</span> <span class="ow">in</span> <span class="n">message</span> <span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{BUP}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

        <span class="k">while</span> <span class="p">(</span> <span class="s1">&#39;$</span><span class="si">{baseUrlPath}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;baseUrl&#39;</span> <span class="ow">in</span> <span class="n">message</span> <span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{baseUrlPath}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="p">(</span> <span class="s1">&#39;$</span><span class="si">{BUPL}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;baseUrl&#39;</span> <span class="ow">in</span> <span class="n">message</span> <span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{BUPL}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="mi">1</span> <span class="p">)</span>

        <span class="k">while</span> <span class="p">(</span> <span class="s1">&#39;$</span><span class="si">{baseUrlPathLast}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="p">)</span>  <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;baseUrl&#39;</span> <span class="ow">in</span> <span class="n">message</span> <span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{baseUrlPathLast}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="mi">1</span> <span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{PBD}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{PBD}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{DR}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;DR = documentRoot should be replaced by BD for base_dir&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{DR}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">documentRoot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{PDR}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;PDR = post_documentRoot should be replaced by PBD for post_baseDir&quot;</span>
            <span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{PDR}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_baseDir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#whenStamp = time.gmtime( time.time()+self.varTimeOffset )</span>

        <span class="n">whenStamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">varTimeOffset</span> <span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{YYYYMMDD}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">YYYYMMDD</span> <span class="o">=</span> <span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{YYYYMMDD}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">YYYYMMDD</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{SOURCE}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{SOURCE}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{DD}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">DD</span> <span class="o">=</span> <span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{DD}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">DD</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{HH}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">HH</span> <span class="o">=</span> <span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{HH}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">HH</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{YYYY}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">YYYY</span> <span class="o">=</span> <span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{YYYY}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">YYYY</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{MM}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">MM</span> <span class="o">=</span> <span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{MM}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">MM</span><span class="p">)</span>

        <span class="k">while</span> <span class="s1">&#39;$</span><span class="si">{JJJ}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">JJJ</span> <span class="o">=</span> <span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{JJJ}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">JJJ</span><span class="p">)</span>


        <span class="c1"># strftime compatible patterns.</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s1">&#39;${%&#39;</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fragment_list</span><span class="o">=</span><span class="p">[</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">close_brace</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
                <span class="n">frag_start</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">varTimeOffset</span>

                <span class="c1"># only support %o time offsets at the beginning of the string.</span>
                <span class="k">if</span> <span class="n">fragment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span>  <span class="p">]:</span>
                    <span class="n">end_of_offset</span><span class="o">=</span><span class="n">fragment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fragment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">fragment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span> <span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">fragment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span> <span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">seconds</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="n">fragment</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">end_of_offset</span><span class="p">])</span>
                    <span class="n">frag_start</span><span class="o">=</span><span class="n">end_of_offset</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">fragment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span> 
                        <span class="n">seconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">seconds</span>

                <span class="n">whenStamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">+</span><span class="n">seconds</span> <span class="p">)</span>
        
                <span class="k">if</span> <span class="n">close_brace</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">time_str</span><span class="o">=</span><span class="n">whenStamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span> <span class="s2">&quot;%&quot;</span><span class="o">+</span><span class="n">fragment</span><span class="p">[</span><span class="n">frag_start</span><span class="p">:</span><span class="n">close_brace</span><span class="p">]</span> <span class="p">)</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">[</span><span class="n">close_brace</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
            <span class="n">new_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fragment_list</span><span class="p">)</span>
        
        <span class="c1"># Parsing cdir to subtract time from it in the following formats</span>
        <span class="c1"># time unit can be: sec/mins/hours/days/weeks</span>

        <span class="c1"># ${YYYY-[number][time_unit]}</span>
        <span class="n">offset_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;\$\{YYYY-(\d+)(\D)\}&#39;</span><span class="p">,</span> <span class="n">cdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset_check</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;offset 0: </span><span class="si">{</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                             <span class="s1">&#39;s&#39;</span><span class="p">)</span>

            <span class="n">epoch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span> <span class="o">-</span> <span class="n">seconds</span>
            <span class="n">YYYY1D</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;\$\{YYYY-\d+\D\}&#39;</span><span class="p">,</span> <span class="n">YYYY1D</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>

        <span class="c1"># ${MM-[number][time_unit]}</span>
        <span class="n">offset_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;\$\{MM-(\d+)(\D)\}&#39;</span><span class="p">,</span> <span class="n">cdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset_check</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;offset 1: </span><span class="si">{</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                             <span class="s1">&#39;s&#39;</span><span class="p">)</span>

            <span class="n">epoch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span> <span class="o">-</span> <span class="n">seconds</span>
            <span class="n">MM1D</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;\$\{MM-\d+\D\}&#39;</span><span class="p">,</span> <span class="n">MM1D</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>

        <span class="c1"># ${JJJ-[number][time_unit]}</span>
        <span class="n">offset_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$\{JJJ-(\d+)(\D)\}&#39;</span><span class="p">,</span> <span class="n">cdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset_check</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;offset 2: </span><span class="si">{</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                             <span class="s1">&#39;s&#39;</span><span class="p">)</span>

            <span class="n">epoch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span> <span class="o">-</span> <span class="n">seconds</span>
            <span class="n">JJJ1D</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;\$\{JJJ-\d+\D\}&#39;</span><span class="p">,</span> <span class="n">JJJ1D</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>

        <span class="c1"># ${YYYYMMDD-[number][time_unit]}</span>
        <span class="n">offset_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$\{YYYYMMDD-(\d+)(\D)\}&#39;</span><span class="p">,</span> <span class="n">cdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset_check</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;offset 3: </span><span class="si">{</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">durationToSeconds</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">offset_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                             <span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span> <span class="o">-</span> <span class="n">seconds</span>
            <span class="n">YYYYMMDD</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;seconds: </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> YYYYMMDD </span><span class="si">{</span><span class="n">YYYYMMDD</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;\$\{YYYYMMDD-\d+\D\}&#39;</span><span class="p">,</span> <span class="n">YYYYMMDD</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>

        <span class="n">new_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varsub</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span>

        <span class="c1"># substitute positional fields from the regex accept (0,1,2,3...)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="s1">&#39;_matches&#39;</span> <span class="ow">in</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s1">&#39;${&#39;</span> <span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fragment_list</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="n">new_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s1">&#39;${&#39;</span> <span class="p">):</span>
                <span class="n">close_brace</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
                <span class="n">frag_start</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">close_brace</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">match_field</span><span class="o">=</span><span class="n">fragment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">close_brace</span><span class="p">]</span>
                <span class="n">matches</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;^[0-9]+$&#39;</span><span class="p">,</span> <span class="n">match_field</span><span class="p">)</span>
                <span class="c1"># non-numeric thing... variable or something.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;${&#39;</span> <span class="o">+</span> <span class="n">fragment</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">field</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">match_field</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sundew_compat_regex_first_match_is_zero</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;_matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;_matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">[</span><span class="n">close_brace</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;_matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span><span class="si">}</span><span class="s2"> groups in regex, group number too high: $</span><span class="se">{{</span><span class="si">{</span><span class="n">fragment</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="n">fragment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;${&#39;</span> <span class="o">+</span><span class="n">fragment</span><span class="p">)</span>

            <span class="n">new_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fragment_list</span><span class="p">)</span>

            <span class="c1">#del message[&#39;_matches&#39;]</span>
            <span class="c1">#message[&#39;_deleteOnPost&#39;] -= set([&#39;_matches&#39;])</span>
        <span class="k">return</span> <span class="n">new_dir</span></div>




<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       2020/05/26 PAS... FIXME: end of sheer terror. </span>

<span class="sd">       the parts below used be part of the sheer terror... but have been</span>
<span class="sd">       tamed a bit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Config.addBinding">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.addBinding">[docs]</a>
    <span class="k">class</span> <span class="nc">addBinding</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        called by argparse to deal with queue bindings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Config.addBinding.__call__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.config.Config.addBinding.__call__">[docs]</a>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">values</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">namespace</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">namespace</span><span class="o">.</span><span class="n">_resolve_exchange</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;broker&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;broker needed before subtopic&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;exchange needed before subtopic&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="s1">&#39;topicPrefix&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;topicPrefix needed before subtopic&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">namespace</span><span class="o">.</span><span class="n">topicPrefix</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">scheme</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;amq&#39;</span><span class="p">:</span>
                   <span class="n">topicPrefix</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">topicPrefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">topicPrefix</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">topicPrefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

            <span class="n">namespace</span><span class="o">.</span><span class="n">bindings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">namespace</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">topicPrefix</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span></div>
</div>


<div class="viewcode-block" id="Config.parse_args">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.Config.parse_args">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isPost</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        user information:</span>
<span class="sd">           accept a configuration, apply argParse library to augment the given configuration</span>
<span class="sd">           with command line settings.</span>

<span class="sd">           the post component has a different calling convention than others, so use that flag</span>
<span class="sd">           if called from post.</span>

<span class="sd">        development notes:</span>
<span class="sd">           Use argparse.parser to modify defaults.</span>
<span class="sd">           FIXME, many FIXME notes below. this is a currently unusable placeholder.</span>
<span class="sd">           have not figured this out yet. many issues.</span>

<span class="sd">           FIXME #1:</span>
<span class="sd">           parseArgs often sets the value of the variable, regardless of it&#39;s presence (normally a good thing.)</span>
<span class="sd">           ( if you have &#39;store_true&#39; then default needed, for broker, just a string, it ignores if not present.)</span>
<span class="sd">           This has the effect of overriding settings in the file parsed before the arguments.</span>
<span class="sd">           Therefore: often supply defaults... but... sigh...</span>
<span class="sd">           </span>
<span class="sd">           but there is another consideration stopping me from supplying defaults, wish I remembered what it was.</span>
<span class="sd">           I think it is:</span>
<span class="sd">           FIXME #2: </span>
<span class="sd">           arguments are parsed twice: once to get basic stuff (loglevel, component, action)</span>
<span class="sd">           and if the parsing fails there, the usage will print the wrong defaults... </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parser</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span> \
             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;version: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Sarracenia flexible tree copy ( https://MetPX.github.io/sarracenia ) &#39;</span> <span class="o">%</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">__version__</span> <span class="p">,</span>\
             <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;extend&#39;</span><span class="p">,</span> <span class="n">ExtendAction</span><span class="p">)</span>
        
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--acceptUnmatched&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptUnmatched</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;default selection, if nothing matches&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--action&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-a&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;action to take on the specified configurations&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--admin&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;amqp://user@host of peer to manage&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--attempts&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;how many times to try before queuing for retry&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--base_dir&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-bd&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to root of tree for relPaths in messages.&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch&#39;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;how many transfers per each connection&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--blockSize&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span>
            <span class="s1">&#39;size to partition files. 0-guess, 1-never, any other number: that size&#39;</span>
        <span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           FIXME:  Most of this is gobblygook place holder stuff, by copying from wmo-mesh example.</span>
<span class="sd">           Don&#39;t really need this to work right now, so just leaving it around as-is.  Challenges:</span>

<span class="sd">           -- sizing units,  K, M, G,  (should have humanfriendly based parsing.)</span>
<span class="sd">           -- time units s,h,m,d </span>
<span class="sd">           -- what to do with verbs.</span>
<span class="sd">           -- accept/reject whole mess requires extension deriving a class from argparse.Action.</span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--broker&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;amqp://user:pw@host of peer to subscribe to&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--config&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39; specifical configuration to select &#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dangerWillRobinson&#39;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Confirm you want to do something dangerous&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;print debugging output (very verbose)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--wololo&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wololo</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;force overwrite of converted configs&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dry_run&#39;</span><span class="p">,</span> <span class="s1">&#39;--simulate&#39;</span><span class="p">,</span> <span class="s1">&#39;--simulation&#39;</span><span class="p">,</span> 
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;simulation mode (perform no file transfers, just print what would happen)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--exchange&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;root of the topic tree to subscribe to&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--full&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayFull</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;fuller, more verbose display&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FIXME: header option not implemented in argparsing: should add to the fixed_header dictionary.</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FIXME: in previous parser, exchange is a modifier for bindings, can have several different values for different subtopic bindings.</span>
<span class="sd">           as currently coded, just a single value that over-writes previous setting, so only binding to a single exchange is possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--inline&#39;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inline</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;include file data in the message&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--inlineEncoding&#39;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;guess&#39;</span><span class="p">],</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inlineEncoding</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;encode payload in base64 (for binary) or text (utf-8)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--inlineByteMax&#39;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inlineByteMax</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum message size to inline&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--instances&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of processes to run per configuration&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--identity_method&#39;</span><span class="p">,</span> <span class="s1">&#39;--identity&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--sum&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_method</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;choose a different checksumming method for the files posted&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;bindings&#39;</span><span class="p">):</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">bindings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">)</span>


        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--logLevel&#39;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;notset&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span>
            <span class="p">],</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;encode payload in base64 (for binary) or text (utf-8)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--logReject&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logReject</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;print a log message explaining why each file is rejected&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--logStdout&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;disable logging, everything to standard output/error&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no&#39;</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;instance number of this process&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--queueName&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;name of AMQP consumer queue to create&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--post_broker&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;broker to post downloaded files to&#39;</span><span class="p">)</span>
        <span class="c1">#parser.add_argument(&#39;--post_baseUrl&#39;, help=&#39;base url of the files announced&#39;)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--post_exchange&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;root of the topic tree to announce&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--post_exchangeSplit&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;split output into different exchanges 00,01,...&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--post_topicPrefix&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span>
            <span class="s1">&#39;allows simultaneous use of multiple versions and types of messages&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--retry_refilter&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_refilter</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;repeat message processing when retrying transfers (default just resends as previous attempt.)&#39;</span><span class="p">)</span>
        <span class="c1">#FIXME: select/accept/reject in parser not implemented.</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--select&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;client-side filtering: accept/reject &lt;regexp&gt;&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--subtopic&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">addBinding</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span>
            <span class="s1">&#39;server-side filtering: MQTT subtopic, wilcards # to match rest, + to match one topic&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--topicPrefix&#39;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topicPrefix</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span>
            <span class="s1">&#39;allows simultaneous use of multiple versions and types of messages&#39;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--users&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;only for declare... declare users?&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--version&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-v&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span>
            <span class="s1">&#39;server-side filtering: MQTT subtopic, wilcards # to match rest, + to match one topic&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">isPost</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--path&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;-p&#39;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
                                <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to post or watch&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span>
                                <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;files to post&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s1">&#39;action&#39;</span><span class="p">,</span>
                <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;action to take on the specified configurations&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;configurations&#39;</span><span class="p">,</span>
                                <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;configurations to operate on&#39;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">print_usage</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">configurations</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayFull</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">full</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">default_config</span><span class="p">():</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">currentDir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">default_options</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;amqp&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;admin.conf&quot;</span><span class="p">,</span> <span class="s2">&quot;default.conf&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">get_user_config_dir</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">g</span><span class="p">):</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">get_user_config_dir</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cfg</span>

<div class="viewcode-block" id="no_file_config">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.no_file_config">[docs]</a>
<span class="k">def</span> <span class="nf">no_file_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      initialize a config that will not use Sarracenia configuration files at all.</span>
<span class="sd">      meant for use by people writing independent programs to start up instances</span>
<span class="sd">      with python API calls.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">currentDir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">default_options</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;amqp&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">cfg_run_dir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">retry_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="one_config">
<a class="viewcode-back" href="../../api-documentation.html#sarracenia.config.one_config">[docs]</a>
<span class="k">def</span> <span class="nf">one_config</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">isPost</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      single call return a fully parsed single configuration for a single component to run.</span>

<span class="sd">      read in admin.conf and default.conf</span>

<span class="sd">      apply component default overrides ( maps to: component/check ?)</span>
<span class="sd">      read in component/config.conf</span>
<span class="sd">      parse arguments from command line.</span>
<span class="sd">      return config instance item.</span>

<span class="sd">      </span>
<span class="sd">      appdir_stuff can be to override file locations for testing during development.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_cfg</span> <span class="o">=</span> <span class="n">default_config</span><span class="p">()</span>
    <span class="c1">#default_cfg.override(  { &#39;component&#39;:component, &#39;directory&#39;: os.getcwd(), &#39;acceptUnmatched&#39;:True, &#39;no&#39;:0 } )</span>
    <span class="n">default_cfg</span><span class="o">.</span><span class="n">override</span><span class="p">({</span>
        <span class="s1">&#39;component&#39;</span><span class="p">:</span> <span class="n">component</span><span class="p">,</span>
        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
        <span class="s1">&#39;acceptUnmatched&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">})</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_cfg</span><span class="p">)</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">applyComponentDefaults</span><span class="p">(</span> <span class="n">component</span> <span class="p">)</span>

    <span class="n">store_pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">get_user_config_dir</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.conf&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config</span> <span class="o">+</span> <span class="s1">&#39;.conf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
         <span class="n">cfg</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">component</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;config </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">fname</span> <span class="p">)</span>
         <span class="k">return</span> <span class="kc">None</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">store_pwd</span><span class="p">)</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">isPost</span><span class="p">)</span>

    <span class="c1">#logger.error( &#39;after args&#39; )</span>
    <span class="c1">#print( &#39;after args&#39; )</span>
    <span class="c1">#cfg.dump()</span>
    <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;poll&#39;</span> <span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="s1">&#39;broker&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">broker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
             <span class="n">cfg</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">post_broker</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">action</span><span class="o">=</span><span class="n">action</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;watch&#39;</span><span class="p">]:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">postpath</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">configurations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">postpath</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">postpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;path is : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;postpath is : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">postpath</span><span class="p">)</span>
        
    <span class="c1">#pp = pprint.PrettyPrinter(depth=6)</span>
    <span class="c1">#pp.pprint(cfg)</span>

    <span class="k">return</span> <span class="n">cfg</span></div>


<span class="k">def</span> <span class="nf">cfglogs</span><span class="p">(</span><span class="n">cfg_preparse</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">child_inst</span><span class="p">):</span>


    <span class="k">if</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">logRotateInterval</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
        <span class="n">logRotateInterval</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cfg_preparse</span><span class="o">.</span><span class="n">logRotateInterval</span><span class="p">)</span>
        <span class="n">lr_when</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logRotateInterval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg_preparse</span><span class="o">.</span><span class="n">logRotateInterval</span><span class="o">/</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>
        <span class="n">lr_when</span><span class="o">=</span><span class="s1">&#39;midnight&#39;</span>

    <span class="c1"># init logs here. need to know instance number and configuration and component before here.</span>

    <span class="k">if</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">logStdout</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">statehost</span><span class="p">:</span>
            <span class="n">hostdir</span> <span class="o">=</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">hostdir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hostdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">metricsfilename</span> <span class="o">=</span> <span class="n">get_metrics_filename</span><span class="p">(</span> <span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">child_inst</span><span class="p">)</span>

        <span class="n">dir_not_there</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">metricsfilename</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">dir_not_there</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">metricsfilename</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">dir_not_there</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="n">dir_not_there</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s2">&quot;makedirs </span><span class="si">{}</span><span class="s2"> failed err=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">metricsfilename</span><span class="p">),</span><span class="n">ex</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">metricsFilename</span> <span class="o">=</span> <span class="n">metricsfilename</span>

        <span class="n">logfilename</span> <span class="o">=</span> <span class="n">get_log_filename</span><span class="p">(</span> <span class="n">hostdir</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">child_inst</span><span class="p">)</span>

        <span class="n">dir_not_there</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logfilename</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">dir_not_there</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logfilename</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">dir_not_there</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="n">dir_not_there</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s2">&quot;makedirs </span><span class="si">{}</span><span class="s2"> failed err=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logfilename</span><span class="p">),</span><span class="n">ex</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1">#log_format = &#39;%(asctime)s [%(levelname)s] %(name)s %(funcName)s %(message)s&#39;</span>
        <span class="n">log_format</span> <span class="o">=</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">logFormat</span>
        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logLevel</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">RedirectedTimedRotatingFileHandler</span><span class="p">(</span>
            <span class="n">logfilename</span><span class="p">,</span>
            <span class="n">when</span><span class="o">=</span><span class="n">lr_when</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">logRotateInterval</span><span class="p">,</span>
            <span class="n">backupCount</span><span class="o">=</span><span class="n">cfg_preparse</span><span class="o">.</span><span class="n">logRotateCount</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">log_format</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg_preparse</span><span class="p">,</span> <span class="s1">&#39;permLog&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">logfilename</span><span class="p">,</span> <span class="n">cfg_preparse</span><span class="o">.</span><span class="n">permLog</span><span class="p">)</span>

        <span class="c1"># FIXME: https://docs.python.org/3/library/contextlib.html portable redirection...</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logLevel</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># add directory to python front of search path for plugins.</span>
<span class="n">plugin_dir</span> <span class="o">=</span> <span class="n">get_user_config_dir</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;plugins&quot;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plugin_dir</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">plugin_dir</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>