<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sarracenia.flow &mdash; Sarracenia 3.00.55rc1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="../../_static/sarra_horror_culture_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8b3d6455"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Sarracenia
              <img src="../../_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.00.55rc1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../How2Guides/index.html">HOWTOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fr/index.html">En fran√ßais</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../sarracenia.html">sarracenia</a></li>
      <li class="breadcrumb-item active">sarracenia.flow</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sarracenia.flow</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># v3 plugin architecture...</span>
<span class="kn">import</span> <span class="nn">sarracenia.flowcb</span>
<span class="kn">import</span> <span class="nn">sarracenia.identity</span>
<span class="kn">import</span> <span class="nn">sarracenia.transfer</span>

<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="kn">import</span> <span class="nn">sarracenia</span>

<span class="kn">import</span> <span class="nn">sarracenia.filemetadata</span>


<span class="c1"># for v2 subscriber routines...</span>
<span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">platform</span> <span class="k">as</span> <span class="n">_platform</span>

<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span><span class="p">,</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">mimetypes</span> <span class="kn">import</span> <span class="n">guess_type</span>

<span class="c1"># end v2 subscriber</span>

<span class="kn">from</span> <span class="nn">sarracenia.featuredetection</span> <span class="kn">import</span> <span class="n">features</span>

<span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;reassembly&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
    <span class="kn">import</span> <span class="nn">sarracenia.blockmanifest</span>

<span class="kn">from</span> <span class="nn">sarracenia</span> <span class="kn">import</span> <span class="n">nowflt</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">allFileEvents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="s1">&#39;modify&#39;</span><span class="p">,</span><span class="s1">&#39;rmdir&#39;</span><span class="p">])</span>

<span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;accelThreshold&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;acceptUnmatched&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;byteRateMax&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;discard&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;download&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;fileEvents&#39;</span><span class="p">:</span> <span class="n">allFileEvents</span><span class="p">,</span>
    <span class="s1">&#39;housekeeping&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
    <span class="s1">&#39;logReject&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;logLevel&#39;</span><span class="p">:</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mirror&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;permCopy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;timeCopy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;messageCountMax&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;messageRateMax&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;messageRateMin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;sleep&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;topicPrefix&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;v03&#39;</span><span class="p">],</span>
    <span class="s1">&#39;topicCopy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;vip&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;filetypes&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
    <span class="kn">import</span> <span class="nn">magic</span>

<span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vip&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
    <span class="kn">import</span> <span class="nn">netifaces</span>


<div class="viewcode-block" id="Flow">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow">[docs]</a>
<span class="k">class</span> <span class="nc">Flow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implement the General Algorithm from the Concepts Guide.</span>

<span class="sd">      All of the component types (e.g. poll, subscribe, sarra, winnow, shovel ) are implemented </span>
<span class="sd">      as sub-classes of Flow. The constructor/factory accept a configuration </span>
<span class="sd">      (sarracenia.config.Config class) with all the settings in it.</span>

<span class="sd">      This class takes care of starting up, running with callbacks, and clean shutdown.</span>

<span class="sd">      need to know whether to sleep between passes  </span>
<span class="sd">      o.sleep - an interval (floating point number of seconds)</span>
<span class="sd">      o.housekeeping - </span>

<span class="sd">      A flow processes worklists of messages</span>

<span class="sd">      worklist given to callbacks...</span>

<span class="sd">      * worklist.incoming --&gt; new messages to continue processing</span>
<span class="sd">      * worklist.ok       --&gt; successfully processed</span>
<span class="sd">      * worklist.rejected --&gt; messages to not be further processed.</span>
<span class="sd">      * worklist.failed   --&gt; messages for which processing failed.</span>
<span class="sd">      * worklist.dirrectories_ok --&gt; directories created.</span>

<span class="sd">      Initially all messages are placed in incoming.</span>
<span class="sd">      if a callback decides:</span>
<span class="sd">      </span>
<span class="sd">      - a message is not relevant, it is moved to rejected.</span>
<span class="sd">      - all processing has been done, it moves it to ok.</span>
<span class="sd">      - an operation failed and it should be retried later, move to retry</span>

<span class="sd">      callbacks must not remove messages from all worklists, re-classify them.</span>
<span class="sd">      it is necessary to put rejected messages in the appropriate worklist</span>
<span class="sd">      so they can be acknowledged as received.</span>

<span class="sd">      interesting data structure:</span>
<span class="sd">      self.plugins  -- dict of modular functionality metadata. </span>

<span class="sd">      * self.plugins[ &quot;load&quot; ] contains a list of (v3) flow_callbacks to load.</span>

<span class="sd">      * self.plugins[ entry_point ]  - one for each invocation times of callbacks. examples:</span>
<span class="sd">        &quot;on_start&quot;, &quot;after_accept&quot;, etc...  contains routines to run at each *entry_point*</span>
<span class="sd">     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">flowMain</span><span class="p">:</span>
              <span class="n">flowMain</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">flowMain</span>
        <span class="k">else</span><span class="p">:</span>
              <span class="n">flowMain</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">component</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">Flow</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">flowMain</span> <span class="o">==</span> <span class="n">sc</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">sc</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;flow&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Flow.__init__">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       The cfg is should be an sarra/config object.</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">me</span> <span class="o">=</span> <span class="s1">&#39;flow&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="nb">format</span><span class="o">=</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(funcName)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">cfg</span>

        <span class="k">if</span> <span class="s1">&#39;sarracenia.flow.Flow&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">settings</span> <span class="ow">and</span> <span class="s1">&#39;logLevel&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sarracenia.flow.Flow&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">logging</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sarracenia.flow.Flow&#39;</span><span class="p">][</span><span class="s1">&#39;logLevel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;post_topicPrefix&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_topicPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">topicPrefix</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logFormat</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">entry_points</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">entry_point</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># FIXME: open new worklist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># for poll only, mark if we are catching up on posted messages</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">poll_catching_up</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Witness the creation of this list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">plugins_early</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s1">&#39;sarracenia.flowcb.retry.Retry&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sarracenia.flowcb.housekeeping.resources.Resources&#39;</span>
        <span class="p">]</span>

        <span class="c1"># open cache, get masks.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">nodupe_ttl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">nodupe_driver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;redis&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.nodupe.redis.Redis&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.nodupe.disk.Disk&#39;</span><span class="p">)</span>
            

        <span class="k">if</span> <span class="p">((</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;delete_source&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">delete_source</span> <span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;delete_destination&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">delete_destination</span> <span class="p">))</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.work.delete.Delete&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">plugins_late</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">plugins_late</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.work.delete.Delete&#39;</span><span class="p">)</span>

        <span class="c1"># transport stuff.. for download, get, put, etc...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># initialize plugins.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;v2plugins&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">v2plugins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;sarracenia.flowcb.v2wrapper.V2Wrapper&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">plugins_late</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">destfn_scripts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">block_reassembly_active</span> <span class="o">=</span> <span class="s1">&#39;block_reassembly&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                 <span class="s1">&#39;sarracenia.flowcb.block_reassembly&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span>

        <span class="c1"># metrics - dictionary with names of plugins as the keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_lastWrite</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricsFlowReset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">had_vip</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">novipFilename</span> <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">metricsFlowReset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_metrics</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;flow&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;stop_requested&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;last_housekeeping&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  
              <span class="s1">&#39;transferConnected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;transferConnectStart&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transferConnectTime&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> 
              <span class="s1">&#39;transferRxBytes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transferTxBytes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transferRxFiles&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transferTxFiles&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s1">&#39;last_housekeeping_cpuTime&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;cpuTime&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span> <span class="p">}</span>

        <span class="c1"># carry over some metrics... that don&#39;t reset.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;metrics&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;transferRxLast&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_metrics</span><span class="p">[</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;transferTxLast&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_metrics</span><span class="p">[</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_metrics</span>

        <span class="c1"># removing old metrics files</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;looking for old metrics for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">old_metrics</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span><span class="o">+</span><span class="s1">&#39;.*&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logRotateCount</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">old_metrics</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;removing old metrics file: </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loadCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugins_to_load</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plugins_to_load</span><span class="p">:</span>
            <span class="n">plugins_to_load</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">imports</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;python module import </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> load failed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugins to load: </span><span class="si">{</span><span class="n">plugins_to_load</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">plugins_to_load</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plugin</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;flowCallback plugin </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> did not load: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1">#logger.debug( f&#39;flowCallback plugin loading: {c} an instance of: {plugin}&#39; )</span>
            <span class="k">for</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">entry_points</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">):</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                        <span class="c1">#logger.debug( f&#39;registering {c}/{entry_point}&#39; )</span>
                        <span class="k">if</span> <span class="n">entry_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">entry_point</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">entry_point</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fn</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s1">&#39;registered_as&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s1">&#39;registered_as&#39;</span><span class="p">))):</span>
                <span class="k">continue</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">check_undeclared_options</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_runCallbacksWorklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="nb">eval</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s2">(self.worklist)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">eval</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s2">(self.worklist)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flow </span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;plugins&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">entry_point</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                    <span class="n">p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">runCallbacksTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="nb">eval</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">eval</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flow </span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">entry_point</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="n">p</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">entry_point</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

<div class="viewcode-block" id="Flow._runCallbackMetrics">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow._runCallbackMetrics">[docs]</a>
    <span class="k">def</span> <span class="nf">_runCallbackMetrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect metrics from plugins with a ``metricsReport`` entry point.</span>

<span class="sd">        Expects the plugin to return a dictionary containing metrics, which is saved to ``self.metrics[plugin_name]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;metricsReport&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metricsReport</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metricsReport</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flow metricsReport() crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;transferConnected&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]:</span> 
            <span class="n">now</span><span class="o">=</span><span class="n">nowflt</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectTime&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">now</span>

        <span class="n">modules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s2">&quot;metricsReport&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;proto&#39;</span><span class="p">):</span> <span class="c1"># gets re-spawned every batch, so not a permanent thing...</span>
            <span class="k">for</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;metricsReport&#39;</span><span class="p">):</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;metricsReport&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                       <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fn</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">module_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sarracenia.flowcb.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/metricsReport crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">ost</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">times</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;cpuTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ost</span><span class="o">.</span><span class="n">user</span><span class="o">+</span><span class="n">ost</span><span class="o">.</span><span class="n">system</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;last_housekeeping_cpuTime&#39;</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_runCallbackPoll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Poll&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Poll</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Poll</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flow Poll crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;poll&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="n">new_incoming</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_incoming</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">plugin</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">plugin</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># just in case</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">plugin</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

<div class="viewcode-block" id="Flow._runHousekeeping">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow._runHousekeeping">[docs]</a>
    <span class="k">def</span> <span class="nf">_runHousekeeping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Run housekeeping callbacks</span>
<span class="sd">            Return the time when housekeeping should be run next</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;on_housekeeping pid: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1"> instance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">no</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;on_housekeeping&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_housekeeping</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_housekeeping</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flow on_housekeeping crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runCallbacksTime</span><span class="p">(</span><span class="s1">&#39;on_housekeeping&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricsFlowReset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;last_housekeeping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
        <span class="n">ost</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">times</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;last_housekeeping_cpuTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ost</span><span class="o">.</span><span class="n">user</span><span class="o">+</span><span class="n">ost</span><span class="o">.</span><span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;cpuTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ost</span><span class="o">.</span><span class="n">user</span><span class="o">+</span><span class="n">ost</span><span class="o">.</span><span class="n">system</span>

        <span class="n">next_housekeeping</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;next_housekeeping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_housekeeping</span>
        <span class="k">return</span> <span class="n">next_housekeeping</span></div>


<div class="viewcode-block" id="Flow.has_vip">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.has_vip">[docs]</a>
    <span class="k">def</span> <span class="nf">has_vip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            return list of vips which are active on the current machine, or an empty list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vip&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># no vip given... standalone always has vip.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">vip</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="s1">&#39;AnyAddressIsFine&#39;</span> <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">interfaces</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="n">a</span><span class="p">])):</span>
                        <span class="n">k</span><span class="o">=</span><span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="n">a</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;addr&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">vip</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">k</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;error while looking for interfaces to compare with vip </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">vip</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Flow.reject">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.reject">[docs]</a>
    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            reject a message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">please_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;ok, telling </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s2">&quot;please_stop&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> callbacks about it.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">][</span><span class="s1">&#39;stop_requested&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runCallbacksTime</span><span class="p">(</span><span class="s1">&#39;on_stop&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">novipFilename</span> <span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">novipFilename</span> <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;flow/close completed cleanly pid: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1"> instance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">no</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mlist</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;ack&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s2">&quot;ack&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span> <span class="p">:</span>
                    <span class="n">p</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">p</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/ack crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_vip_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">have_vip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_vip</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;poll&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_vip</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">had_vip</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;now passive on vips </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">vip</span> <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">novipFilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nowflt</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">had_vip</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">had_vip</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;now active on vip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_vip</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">had_vip</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">novipFilename</span> <span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">novipFilename</span> <span class="p">)</span>

<div class="viewcode-block" id="Flow.run">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          This is the core routine of the algorithm, with most important data driven</span>
<span class="sd">          loop in it. This implements the General Algorithm (as described in the Concepts Explanation Guide) </span>
<span class="sd">          check if stop_requested once in a while, but never return otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;metricsFilename&#39;</span> <span class="p">):</span>
            <span class="n">mdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDirDefault</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">pidfilename</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_pid_filename</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">hostdir</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">statehost</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">no</span><span class="p">)</span>
        <span class="n">pdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pidfilename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDirDefault</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]):</span>
           <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;working directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="n">next_housekeeping</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">housekeeping</span>

        <span class="n">current_rate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_messages</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span>
        <span class="n">now</span><span class="o">=</span><span class="n">start_time</span>
        <span class="n">current_sleep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">sleep</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;last_housekeeping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="n">ost</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">times</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;last_housekeeping_cpuTime&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ost</span><span class="o">.</span><span class="n">user</span><span class="o">+</span><span class="n">ost</span><span class="o">.</span><span class="n">system</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logLevel</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;options:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;callbacks loaded: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;pid: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1"> instance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">no</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">spamming</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">last_gather_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stopping</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stopping</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;clean stop from run loop&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s1">&#39;starting last pass (without gather) through loop for cleanup.&#39;</span><span class="p">)</span>
                    <span class="n">stopping</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_run_vip_update</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">next_housekeeping</span> <span class="ow">or</span> <span class="n">stopping</span><span class="p">:</span>
                <span class="n">next_housekeeping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runHousekeeping</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">now</span> <span class="o">==</span> <span class="n">start_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runCallbacksTime</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;on_start&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;poll&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_vip</span><span class="p">:</span>

                <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span> <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;current_rate (</span><span class="si">%.2f</span><span class="s2">) vs. messageRateMax(</span><span class="si">%.2f</span><span class="s2">)) &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">stopping</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span>

                <span class="n">last_gather_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last_gather_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">spamming</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_sleep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">sleep</span>
                    <span class="n">spamming</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>

                <span class="c1"># this for duplicate cache synchronization.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">poll_catching_up</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1"># normal processing, when you are active.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span>
            <span class="n">run_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">total_messages</span> <span class="o">+=</span> <span class="n">last_gather_len</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageCountMax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">total_messages</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageCountMax</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runCallbacksTime</span><span class="p">(</span><span class="s1">&#39;please_stop&#39;</span><span class="p">)</span>

            <span class="n">current_rate</span> <span class="o">=</span> <span class="n">total_messages</span> <span class="o">/</span> <span class="n">run_time</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_time</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;msgRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_rate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;msgRateCpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_messages</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;cpuTime&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;last_housekeeping_cpuTime&#39;</span><span class="p">]</span> <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">last_gather_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">sleep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">retryEmptyBeforeExit</span> <span class="ow">and</span> <span class="s2">&quot;retry&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;retry&#39;</span><span class="p">][</span><span class="s1">&#39;msgs_in_post_retry&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;retryEmptyBeforeExit=True and there are still &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;retry&#39;</span><span class="p">][</span><span class="s1">&#39;msgs_in_post_retry&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> messages in the post retry queue.&quot;</span><span class="p">)</span>
                    <span class="c1"># Sleep for a while. Messages can&#39;t be retried before housekeeping has run...</span>
                    <span class="c1"># how long to sleep is unclear... if there are a lot of retries, and a low batch... could take a long time.</span>
                    <span class="n">current_sleep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">batch</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">batch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">housekeeping</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">housekeeping</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">runCallbacksTime</span><span class="p">(</span><span class="s1">&#39;please_stop&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">spamming</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_sleep</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
                <span class="n">current_sleep</span> <span class="o">*=</span> <span class="mi">2</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;current_sleep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_sleep</span>

            <span class="c1"># Run housekeeping based on time, and before stopping to ensure it&#39;s run at least once</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">next_housekeeping</span> <span class="ow">or</span> <span class="n">stopping</span><span class="p">:</span>
                <span class="n">next_housekeeping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runHousekeeping</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMin</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;receiving below minimum message rate&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&gt;=</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span><span class="p">):</span>
                <span class="n">stime</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">current_rate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span><span class="p">)</span> <span class="o">/</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;current_rate/2 (</span><span class="si">%.2f</span><span class="s2">) above messageRateMax(</span><span class="si">%.2f</span><span class="s2">): throttling&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">current_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot; not throttling: limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageRateMax</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
                <span class="n">stime</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">current_sleep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">current_sleep</span><span class="p">:</span>
                    <span class="n">stime</span> <span class="o">+=</span> <span class="n">current_sleep</span> <span class="o">-</span> <span class="n">elapsed</span>
                    <span class="k">if</span> <span class="n">stime</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>  <span class="c1"># if sleeping for a long time, debug output is good...</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;sleeping for more than 60 seconds: </span><span class="si">%.2f</span><span class="s2"> seconds. Elapsed since wakeup: </span><span class="si">%.2f</span><span class="s2"> Sleep setting: </span><span class="si">%.2f</span><span class="s2"> &quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">stime</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">sleep</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;worked too long to sleep!&#39;</span><span class="p">)</span>
                    <span class="n">last_time</span> <span class="o">=</span> <span class="n">now</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># dividing into small sleeps so exit processing happens faster</span>
                <span class="c1"># bug #595, still relatively low cpu usage in increment sized chunks.</span>
                <span class="k">if</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="n">stime</span><span class="p">:</span>
                    <span class="n">increment</span><span class="o">=</span><span class="mi">5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">increment</span><span class="o">=</span><span class="n">stime</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">stime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;sleeping for </span><span class="si">{</span><span class="n">increment</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stime</span> <span class="o">-=</span> <span class="mi">5</span> 
                    <span class="c1"># Run housekeeping during long sleeps</span>
                    <span class="n">now_for_hk</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">now_for_hk</span> <span class="o">&gt;</span> <span class="n">next_housekeeping</span><span class="p">:</span>
                        <span class="n">next_housekeeping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runHousekeeping</span><span class="p">(</span><span class="n">now_for_hk</span><span class="p">)</span>

                <span class="n">last_time</span> <span class="o">=</span> <span class="n">now</span></div>



<div class="viewcode-block" id="Flow.sundew_getDestInfos">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.sundew_getDestInfos">[docs]</a>
    <span class="k">def</span> <span class="nf">sundew_getDestInfos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">currentFileOption</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        modified from sundew client</span>

<span class="sd">        WHATFN         -- First part (&#39;:&#39;) of filename </span>
<span class="sd">        HEADFN         -- Use first 2 fields of filename</span>
<span class="sd">        NONE           -- Use the entire filename</span>
<span class="sd">        TIME or TIME:  -- TIME stamp appended</span>
<span class="sd">        DESTFN=fname   -- Change the filename to fname</span>

<span class="sd">        ex: mask[2] = &#39;NONE:TIME&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">currentFileOption</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">currentFileOption</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">filename</span>

        <span class="n">timeSuffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">satnet</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">firstPart</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;sundew_extension&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;sundew_extension&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

        <span class="n">destFileName</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">currentFileOption</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;WHATFN&#39;</span><span class="p">:</span>
                <span class="n">destFileName</span> <span class="o">=</span> <span class="n">firstPart</span>
            <span class="k">elif</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;HEADFN&#39;</span><span class="p">:</span>
                <span class="n">headParts</span> <span class="o">=</span> <span class="n">firstPart</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">headParts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">destFileName</span> <span class="o">=</span> <span class="n">headParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">headParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">destFileName</span> <span class="o">=</span> <span class="n">headParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;SENDER&#39;</span> <span class="ow">and</span> <span class="s1">&#39;SENDER=&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SENDER=&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">destFileName</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">destFileName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span> <span class="n">destFileName</span> <span class="o">=</span> <span class="n">destFileName</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;SENDER=&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SENDER=&#39;</span><span class="p">)</span>
                    <span class="n">destFileName</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="c1"># PX default behavior : keep 6 first fields</span>
                        <span class="n">destFileName</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
                        <span class="c1">#  PDS default behavior  keep 5 first fields</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">destFileName</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
                <span class="c1"># extra trailing : removed if present</span>
                <span class="k">if</span> <span class="n">destFileName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span> <span class="n">destFileName</span> <span class="o">=</span> <span class="n">destFileName</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;NONESENDER&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;SENDER=&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SENDER=&#39;</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">destFileName</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="c1"># PX default behavior : keep 6 first fields</span>
                        <span class="n">destFileName</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
                        <span class="c1">#  PDS default behavior  keep 5 first fields</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">destFileName</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
                <span class="c1"># extra trailing : removed if present</span>
                <span class="k">if</span> <span class="n">destFileName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span> <span class="n">destFileName</span> <span class="o">=</span> <span class="n">destFileName</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;SATNET=.*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="n">satnet</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">spec</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;DESTFN=.*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="n">destFileName</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;DESTFNSCRIPT=.*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="n">scriptclass</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">dfm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;destfn&#39;</span><span class="p">]:</span>
                    <span class="n">classname</span> <span class="o">=</span>  <span class="n">dfm</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">scriptclass</span> <span class="o">==</span> <span class="n">classname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">scriptclass</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">==</span> <span class="n">classname</span><span class="p">):</span> 
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">destFileName</span> <span class="o">=</span> <span class="n">dfm</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;DESTFNSCRIPT plugin </span><span class="si">{</span><span class="n">dfm</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

                        <span class="k">if</span> <span class="n">destFileName</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">destFileName</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;DESTFNSCRIPT </span><span class="si">{</span><span class="n">dfm</span><span class="si">}</span><span class="s2"> return value must be the new file name as a string. This one returned </span><span class="si">{</span><span class="n">destFileName</span><span class="si">}</span><span class="s2">, ignoring&quot;</span><span class="p">)</span>
                             <span class="k">return</span> <span class="kc">None</span>

            <span class="k">elif</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span><span class="p">:</span>
                <span class="n">timeSuffix</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;pubTime&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="n">timeSuffix</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;pubTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;pubTime&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="n">timeSuffix</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;pubTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">timeSuffix</span> <span class="o">=</span> <span class="n">timeSuffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># check for PX or PDS behavior ...</span>
                <span class="c1"># if file already had a time extension keep his...</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">14</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
                    <span class="n">timeSuffix</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;invalid DESTFN parameter: </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">destFileName</span> <span class="o">+</span> <span class="n">satnet</span> <span class="o">+</span> <span class="n">timeSuffix</span></div>



    <span class="c1"># ==============================================</span>
    <span class="c1"># how will the download file land on this server</span>
    <span class="c1"># with all options, this is really tricky</span>
    <span class="c1"># ==============================================</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        to test changes to updateFieldsAccepted, run:  make test_shim in the SarraC package...</span>
<span class="sd">        because it tickles a lot of these settings, in addition to the flow_tests before</span>
<span class="sd">        trying to PR changes here.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Flow.updateFieldsAccepted">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.updateFieldsAccepted">[docs]</a>
    <span class="k">def</span> <span class="nf">updateFieldsAccepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">maskDir</span><span class="p">,</span>
                             <span class="n">maskFileOption</span><span class="p">,</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">path_strip_count</span><span class="p">,</span> <span class="n">pstrip</span><span class="p">,</span> <span class="n">flatten</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           Set new message fields according to values when the message is accepted.</span>
<span class="sd">           </span>
<span class="sd">           * urlstr: the urlstr being matched (baseUrl+relPath+sundew_extension)</span>
<span class="sd">           * pattern: the regex that was matched.</span>
<span class="sd">           * maskDir: the current directory to base the relPath from.</span>
<span class="sd">           * maskFileOption: filename option value (sundew compatibility options.)</span>
<span class="sd">           * strip: number of path entries to strip from the left side of the path.</span>
<span class="sd">           * pstrip: pattern strip regexp to apply instead of a count.</span>
<span class="sd">           * flatten: a character to replace path separators with toe change a multi-directory </span>
<span class="sd">             deep file name into a single long file name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># relative path by default mirror</span>

        <span class="n">relPath</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseUrl_relPath</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">])</span>
            <span class="n">relPath</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">relPath</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">download</span> <span class="ow">and</span> <span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span> 
            <span class="c1"># FIXME... why the % ? why not just assign it to copy the value?</span>
            <span class="n">relPath</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;rename&#39;</span><span class="p">]</span>

            <span class="c1"># after download we dont propagate renaming... once used, get rid of it</span>
            <span class="k">del</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;rename&#39;</span><span class="p">]</span>
            <span class="c1"># FIXME: worry about publishing after a rename.</span>
            <span class="c1"># the relpath should be replaced by rename value for downstream</span>
            <span class="c1"># because the file was written to rename.</span>
            <span class="c1"># not sure if this happens or not.</span>


        <span class="n">token</span> <span class="o">=</span> <span class="n">relPath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># resolve a current base directory to which the relative path will eventually be added.</span>
        <span class="c1">#  update fileOp fields to replace baseDir.</span>
        <span class="c1">#if self.o.currentDir : new_dir = self.o.currentDir</span>

        <span class="n">new_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">maskDir</span><span class="p">:</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="n">maskDir</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_baseDir</span><span class="p">:</span>
                <span class="n">new_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_baseDir</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">d</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_dir</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">new_dir</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_baseDir</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_baseDir</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># to get locally resolvable links and renames, need to mangle the pathnames.</span>
        <span class="c1"># to get something to restore for downstream consumers, need to put the original</span>
        <span class="c1"># names back.</span>

        <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;post_fileOp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span> <span class="s1">&#39;post_fileOp&#39;</span> <span class="p">]</span> <span class="p">)</span>

        <span class="c1"># if provided, strip (integer) ... strip N heading directories</span>
        <span class="c1">#         or  pstrip (pattern str) strip regexp pattern from relPath</span>
        <span class="c1"># cannot have both (see setting of option strip in sr_config)</span>

        <span class="k">if</span> <span class="n">path_strip_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;path_strip_count:</span><span class="si">{</span><span class="n">path_strip_count</span><span class="si">}</span><span class="s2">   &quot;</span><span class="p">)</span>
            <span class="n">strip</span><span class="o">=</span><span class="n">path_strip_count</span> 
            <span class="k">if</span> <span class="n">strip</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="n">strip</span><span class="p">:]</span>

            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                   files are written with cwd being the directory containing the file written.</span>
<span class="sd">                   when stripping the root of the tree off, the path must be rendered relative to the</span>
<span class="sd">                   directory containing the file: the values are modified to create relative paths.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;hlink&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                        <span class="n">fopv</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> 
                        <span class="c1"># an absolute path file posted is relative to &#39;/&#39; (in relPath) but the values in</span>
                        <span class="c1"># the link and rename fields may be absolute, requiring and adjustmeent when stripping</span>
                        <span class="k">if</span> <span class="n">fopv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">strip</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fopv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">toclimb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">toclimb</span><span class="p">)</span> <span class="o">+</span> <span class="n">fopv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fopv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">strip</span><span class="p">:</span>
                            <span class="n">rest</span><span class="o">=</span><span class="n">fopv</span><span class="p">[</span><span class="n">strip</span><span class="p">:]</span>
                            <span class="n">toclimb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">-</span><span class="n">rest</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">toclimb</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
                            
        <span class="c1"># strip using a pattern</span>
        <span class="k">elif</span> <span class="n">pstrip</span><span class="p">:</span>

            <span class="c1">#MG FIXME Peter&#39;s wish to have replacement in pstrip (ex.:${SOURCE}...)</span>

            <span class="n">relstrip</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pstrip</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">relPath</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">relstrip</span><span class="p">:</span> <span class="n">relstrip</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">relstrip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;hlink&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pstrip</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="p">)</span>
                            
        <span class="c1"># if flatten... we flatten relative path</span>
        <span class="c1"># strip taken into account</span>

        <span class="k">if</span> <span class="n">flatten</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">flatten</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>

            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;hlink&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
                            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">:</span>
            <span class="c1"># remove baseDir from relPath if present.</span>
            <span class="n">token_baseDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">remcnt</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_baseDir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">token_baseDir</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">token_baseDir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">token</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">remcnt</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">remcnt</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_baseDir</span><span class="p">):</span>
                    <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">[</span><span class="n">remcnt</span><span class="p">:]</span> 

            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;hlink&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="p">:</span>
                            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">):</span>
                                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]:</span>
                                <span class="n">toclimb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">toclimb</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>

        <span class="k">elif</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;hlink&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;/&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]:</span>
                            <span class="n">toclimb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">toclimb</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">mirror</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">token</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">new_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="c1"># resolution of sundew&#39;s dirPattern</span>

        <span class="n">tfname</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># when sr_sender did not derived from sr_subscribe it was always called</span>
        <span class="n">new_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">sundew_dirPattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">urlstr</span><span class="p">,</span> <span class="n">tfname</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">updatePaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">maskFileOption</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sundew_getDestInfos</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">maskFileOption</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span> <span class="p">]</span>  <span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;start len(incoming)=</span><span class="si">%d</span><span class="s1">, rejected=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="p">)))</span>
        <span class="n">filtered_worklist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">):</span>
            <span class="n">default_accept_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">directory</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;post_baseDir&#39;</span><span class="p">):</span>
            <span class="n">default_accept_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_baseDir</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;baseDir&#39;</span><span class="p">):</span>
            <span class="n">default_accept_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>
            <span class="n">then</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;pubTime&#39;</span><span class="p">])</span>
            <span class="n">lag</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">then</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageAgeMax</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">messageAgeMax</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                    <span class="n">m</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;message too old (high lag): </span><span class="si">{</span><span class="n">lag</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> sec. skipping: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">getIDStr</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="s1">&#39;mtime&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">age</span> <span class="o">=</span>  <span class="n">now</span><span class="o">-</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileAgeMax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileAgeMax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="mi">410</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;file too old: </span><span class="si">{</span><span class="n">age</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> sec. skipping: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">getIDStr</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileAgeMin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileAgeMin</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;file too young: queueing for retry.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">],</span>
                                             <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;sundew_extension&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">urlToMatch</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;sundew_extension&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">urlToMatch</span> <span class="o">=</span> <span class="n">url</span>
                <span class="n">oldname_matched</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                    <span class="n">pattern</span><span class="p">,</span> <span class="n">maskDir</span><span class="p">,</span> <span class="n">maskFileOption</span><span class="p">,</span> <span class="n">mask_regexp</span><span class="p">,</span> <span class="n">accepting</span><span class="p">,</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">pstrip</span><span class="p">,</span> <span class="n">flatten</span> <span class="o">=</span> <span class="n">mask</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pattern</span> <span class="o">==</span> <span class="s1">&#39;.*&#39;</span><span class="p">):</span>
                        <span class="n">oldname_matched</span> <span class="o">=</span> <span class="n">accepting</span>
                        <span class="k">break</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">mask_regexp</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">urlToMatch</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                            <span class="n">m</span><span class="p">[</span> <span class="s1">&#39;_matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span>
                            <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;_matches&#39;</span><span class="p">])</span>
                            <span class="n">oldname_matched</span> <span class="o">=</span> <span class="n">accepting</span>
                    <span class="k">break</span>

            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">],</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="n">url</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;sundew_extension&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">urlToMatch</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;sundew_extension&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">urlToMatch</span> <span class="o">=</span> <span class="n">url</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot; urlToMatch: </span><span class="si">{</span><span class="n">urlToMatch</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
            <span class="c1"># apply masks for accept/reject options.</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">pattern</span><span class="p">,</span> <span class="n">maskDir</span><span class="p">,</span> <span class="n">maskFileOption</span><span class="p">,</span> <span class="n">mask_regexp</span><span class="p">,</span> <span class="n">accepting</span><span class="p">,</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">pstrip</span><span class="p">,</span> <span class="n">flatten</span> <span class="o">=</span> <span class="n">mask</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pattern</span> <span class="o">!=</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">mask_regexp</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">urlToMatch</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">[</span> <span class="s1">&#39;_matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;_matches&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pattern</span> <span class="o">==</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">accepting</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">oldname_matched</span><span class="p">:</span>
                            <span class="c1"># deletion rename case... need to accept with an extra field...</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;renameUnlink&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;renameUnlink&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;renameUnlink&#39;</span><span class="p">])</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;rename deletion 1 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                         <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                                <span class="n">m</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="s2">&quot;mask=</span><span class="si">%s</span><span class="s2"> strip=</span><span class="si">%s</span><span class="s2"> url=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">strip</span><span class="p">,</span> <span class="n">urlToMatch</span><span class="p">))</span>
                        <span class="k">break</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">updateFieldsAccepted</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">maskDir</span><span class="p">,</span>
                                           <span class="n">maskFileOption</span><span class="p">,</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span>
                                           <span class="n">pstrip</span><span class="p">,</span> <span class="n">flatten</span><span class="p">)</span>

                    <span class="n">filtered_worklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">oldname_matched</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;renameUnlink&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;renameUnlink&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;renameUnlink&#39;</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;rename deletion 2 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">]))</span>
                    <span class="n">filtered_worklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updateFieldsAccepted</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                           <span class="n">default_accept_directory</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">mirror</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">pstrip</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">flatten</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">acceptUnmatched</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;accept: unmatched pattern=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">))</span>
                    <span class="c1"># FIXME... missing dir mapping with mirror, strip, etc...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updateFieldsAccepted</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                           <span class="n">default_accept_directory</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">mirror</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">pstrip</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">flatten</span><span class="p">)</span>
                    <span class="n">filtered_worklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="s2">&quot;unmatched pattern </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="n">filtered_worklist</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s1">&#39;end len(incoming)=</span><span class="si">%d</span><span class="s1">, rejected=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbacksWorklist</span><span class="p">(</span><span class="s1">&#39;after_accept&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s1">&#39;B filtered incoming: </span><span class="si">%d</span><span class="s1">, ok: </span><span class="si">%d</span><span class="s1"> (directories: </span><span class="si">%d</span><span class="s1">), rejected: </span><span class="si">%d</span><span class="s1">, failed: </span><span class="si">%d</span><span class="s1"> stop_requested: </span><span class="si">%s</span><span class="s1"> have_vip: </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span><span class="p">),</span>
               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_vip</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">gather</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">so_far</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">keep_going</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s2">&quot;gather&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">batch</span><span class="o">-</span><span class="n">so_far</span><span class="p">)</span>

                <span class="c1"># To avoid having to modify all existing gathers, support old API.</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">keep_going</span><span class="p">,</span> <span class="n">new_incoming</span> <span class="o">=</span> <span class="n">retval</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">new_incoming</span> <span class="o">=</span> <span class="n">retval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;flowCallback plugin gather routine </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> returned unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span><span class="si">}</span><span class="s2">. Expected tuple of boolean and list of new messages&quot;</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span>
                <span class="n">so_far</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_incoming</span><span class="p">)</span> 

            <span class="c1"># if we gathered enough with a subset of plugins then return.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_going</span> <span class="ow">or</span> <span class="p">(</span><span class="n">so_far</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">batch</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;poll&#39;</span> <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">poll_catching_up</span><span class="o">=</span><span class="kc">True</span>

                <span class="k">return</span>

        <span class="c1"># gather is an extended version of poll.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="s1">&#39;poll&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ingesting </span><span class="si">%d</span><span class="s1"> postings into duplicate suppression cache&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">poll_catching_up</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">poll_catching_up</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_vip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbackPoll</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_download</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mark all remaining messages as done.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;processing </span><span class="si">%d</span><span class="s1"> messages worked!&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do</span><span class="p">()</span>

        <span class="c1"># need to acknowledge here, because posting will delete message-id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>

        <span class="c1"># adjust message after action is done, but before &#39;after_work&#39; so adjustment is possible.</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;new_baseUrl&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="o">!=</span>
                                         <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_baseUrl&#39;</span><span class="p">]):</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;old_baseUrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;old_baseUrl&#39;</span><span class="p">])</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_baseUrl&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;new_retrievePath&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;old_retrievePath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;retrievePath&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;retrievePath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_retrievePath&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;old_retrievePath&#39;</span><span class="p">])</span>

            <span class="c1"># if new_file does not match relPath, then adjust relPath so it does.</span>
            <span class="k">if</span> <span class="s1">&#39;relPath&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;new_relPath&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span> <span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;new_relPath&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]):</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;old_relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;old_relPath&#39;</span><span class="p">])</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_relPath&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;old_subtopic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;subtopic&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;old_subtopic&#39;</span><span class="p">,</span><span class="s1">&#39;subtopic&#39;</span><span class="p">])</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;subtopic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;new_subtopic&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;_format&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;old_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_format&#39;</span><span class="p">]</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;old_format&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;post_format&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;post_format&#39;</span><span class="p">]</span>

            <span class="c1"># restore adjustment to fileOp</span>
            <span class="k">if</span> <span class="s1">&#39;post_fileOp&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">m</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;post_fileOp&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">download</span> <span class="ow">and</span> <span class="s1">&#39;retrievePath&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="c1"># retrieve paths do not propagate after download.</span>
                <span class="k">del</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;retrievePath&#39;</span><span class="p">]</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbacksWorklist</span><span class="p">(</span><span class="s1">&#39;after_work&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">now</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span><span class="s1">&#39;post_broker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">post_broker</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># work-around for python3.5 not being able to copy re.match issue: </span>
                <span class="c1"># https://github.com/MetPX/sarracenia/issues/857 </span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;_matches&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;_matches&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbacksWorklist</span><span class="p">(</span><span class="s1">&#39;after_post&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbacksWorklist</span><span class="p">(</span><span class="s1">&#39;report&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbackMetrics</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;metricsFilename&#39;</span> <span class="p">)</span> \
                <span class="ow">and</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_lastWrite</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metrics_writeInterval</span><span class="p">:</span>

            <span class="c1"># assume dir always exist... should check on startup, not here.</span>
            <span class="c1"># if os.path.isdir(os.path.dirname(self.o.metricsFilename)):</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mfn</span><span class="p">:</span>
                 <span class="n">mfn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">metrics</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_lastWrite</span><span class="o">=</span><span class="n">now</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logMetrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logRotateInterval</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
                    <span class="n">tslen</span><span class="o">=</span><span class="mi">8</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logRotateInterval</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                    <span class="n">tslen</span><span class="o">=</span><span class="mi">14</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tslen</span><span class="o">=</span><span class="mi">16</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">timestamp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">tslen</span><span class="p">],</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mfn</span><span class="p">:</span>
                    <span class="n">mfn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1"> : </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># removing old metrics files</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;looking for old metrics for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">old_metrics</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">metricsFilename</span><span class="o">+</span><span class="s1">&#39;.*&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">logRotateCount</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">old_metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;removing old metrics file: </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Flow.write_inline_file">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.write_inline_file">[docs]</a>
    <span class="k">def</span> <span class="nf">write_inline_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           write local file based on a message with inlined content.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure directory exists, create it if not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">])</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="mo">0o775</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed to make directory </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">ex</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;data inlined with message, no need to download&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>
        <span class="c1">#path = msg[&#39;new_relPath&#39;]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">),</span> <span class="s1">&#39;rb+&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;could not open </span><span class="si">%s</span><span class="s2"> to write: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;base64&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="s1">&#39;encoding&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">identity_method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cod,&#39;</span><span class="p">):</span>
            <span class="n">algo_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">identity_method</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cod&#39;</span><span class="p">:</span>
            <span class="n">algo_method</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">algo_method</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="n">onfly_algo</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">Identity</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">algo_method</span><span class="p">)</span>
        <span class="n">data_algo</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">Identity</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">algo_method</span><span class="p">)</span>
        <span class="n">onfly_algo</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">data_algo</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">algo_method</span> <span class="o">==</span> <span class="s1">&#39;arbitrary&#39;</span><span class="p">:</span>
            <span class="n">onfly_algo</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">data_algo</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="n">onfly_algo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;onfly_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">algo_method</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">onfly_algo</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">acceptSizeWrong</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;acceptSizeWrong data size is (</span><span class="si">%d</span><span class="s2"> bytes) vs. expected: (</span><span class="si">%d</span><span class="s2"> bytes)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;decoded data size (</span><span class="si">%d</span><span class="s2"> bytes) does not have expected size: (</span><span class="si">%d</span><span class="s2"> bytes)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">#try:</span>
        <span class="c1">#    for p in self.plugins[&#39;on_data&#39;]:</span>
        <span class="c1">#        data = p(data)</span>

        <span class="c1">#except Exception as ex:</span>
        <span class="c1">#    logger.warning(&quot;plugin failed: %s&quot; % (p, ex))</span>
        <span class="c1">#    return False</span>

        <span class="n">data_algo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1">#FIXME: If data is changed by plugins, need to update content header.</span>
        <span class="c1">#       current code will reproduce the upstream message without mofification.</span>
        <span class="c1">#       need to think about whether that is OK or not.</span>

        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">algo_method</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">data_algo</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span>

        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;onfly_checksum&#39;</span><span class="p">])</span>

        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;data_checksum&#39;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_local_file_attributes</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;failed writing and finalizing: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">compute_local_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">filemetadata</span><span class="o">.</span><span class="n">supports_extended_attributes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">filemetadata</span><span class="o">.</span><span class="n">FileMetadata</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;identity&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">metadata_cached_mtime</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mtime&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">metadata_cached_mtime</span> <span class="o">&gt;=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])):</span>
                        <span class="c1"># file has not been modified since checksum value was stored.</span>

                        <span class="k">if</span> <span class="p">((</span> <span class="s1">&#39;identity&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;method&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>  <span class="p">)</span> <span class="ow">and</span> \
                            <span class="p">(</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="p">))</span> <span class="ow">or</span>  \
                            <span class="p">(</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span>  <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">identity_method</span> <span class="p">)</span> <span class="p">:</span>
                            <span class="c1"># file</span>
                            <span class="c1"># cache good.</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;local_identity&#39;</span><span class="p">])</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocks&#39;</span><span class="p">)</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;local_blocks&#39;</span><span class="p">])</span>
                            <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">local_identity</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">Identity</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;arbitrary&#39;</span><span class="p">:</span>
            <span class="n">local_identity</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="n">local_identity</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">])</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">local_identity</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;local_identity&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Flow.file_should_be_downloaded">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.file_should_be_downloaded">[docs]</a>
    <span class="k">def</span> <span class="nf">file_should_be_downloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          determine whether a comparison of local_file and message metadata indicates that it is new enough</span>
<span class="sd">          that writing the file locally is warranted.</span>

<span class="sd">          return True to say downloading is warranted.</span>

<span class="sd">             False if the file in the message represents the same or an older version that what is corrently on disk.</span>

<span class="sd">          origin: refactor &amp; translation of v2: content_should_not_be downloaded</span>

<span class="sd">          Assumptions:</span>
<span class="sd">                 new_path exists... there is a file to compare against.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assert</span>

        <span class="n">lstat</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">])</span>
        <span class="n">fsiz</span> <span class="o">=</span> <span class="n">lstat</span><span class="o">.</span><span class="n">st_size</span>

        <span class="c1"># FIXME... local_offset... offset within the local file... partitioned... who knows?</span>
        <span class="c1">#   part of partitioning deferral.</span>
        <span class="c1">#end   = self.local_offset + self.length</span>
        <span class="k">if</span> <span class="s1">&#39;size&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            <span class="c1"># compare sizes... if (sr_subscribe is downloading partitions into taget file) and (target_file isn&#39;t fully done)</span>
            <span class="c1"># This check prevents random halting of subscriber (inplace on) if the messages come in non-sequential order</span>
            <span class="c1"># target_file is the same as new_file unless the file is partitioned.</span>
            <span class="c1"># FIXME If the file is partitioned, then it is the new_file with a partition suffix.</span>
            <span class="c1">#if (&#39;self.target_file == msg[&#39;new_file&#39;] ) and ( fsiz != msg[&#39;size&#39;] ):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fsiz</span> <span class="o">!=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> file size different, so cannot be the same&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]))</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># compare dates...</span>

        <span class="k">if</span> <span class="s1">&#39;mtime&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">new_mtime</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])</span>
            <span class="n">old_mtime</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">timeCopy</span><span class="p">:</span>
                <span class="n">old_mtime</span> <span class="o">=</span> <span class="n">lstat</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="k">elif</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">filemetadata</span><span class="o">.</span><span class="n">supports_extended_attributes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">filemetadata</span><span class="o">.</span><span class="n">FileMetadata</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">])</span>
                    <span class="n">old_mtime</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mtime&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">new_mtime</span> <span class="o">&lt;=</span> <span class="n">old_mtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span>
                            <span class="s2">&quot;mtime not newer </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> new version is </span><span class="si">{}</span><span class="s2"> newer (new: </span><span class="si">{}</span><span class="s2"> vs old: </span><span class="si">{}</span><span class="s2"> )&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">],</span> <span class="n">new_mtime</span> <span class="o">-</span> <span class="n">old_mtime</span><span class="p">,</span> <span class="n">new_mtime</span><span class="p">,</span>
                        <span class="n">old_mtime</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;identity&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;cod&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content_match </span><span class="si">%s</span><span class="s2"> sum 0/z never matches&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">fsiz</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;new file not big enough... considered different&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;identity&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span> 
            <span class="c1"># FIXME... should there be a setting to assume them the same? use cases may vary.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;no checksum available, assuming different&quot;</span> <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_checksum</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;something went wrong when computing local checksum... considered different&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;checksum in message: </span><span class="si">%s</span><span class="s2"> vs. local: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_identity&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_identity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="s2">&quot;same checksum </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Flow.removeOneFile">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.removeOneFile">[docs]</a>
    <span class="k">def</span> <span class="nf">removeOneFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          process an unlink event, returning boolean success.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;path to remove: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;removed </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;could not remove </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">ok</span></div>


<div class="viewcode-block" id="Flow.renameOneItem">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.renameOneItem">[docs]</a>
    <span class="k">def</span> <span class="nf">renameOneItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            for messages with an rename file operation, it is to rename a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;old file </span><span class="si">%s</span><span class="s2"> not found, if destination (</span><span class="si">%s</span><span class="s2">) missing, then fall back to copy&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="c1"># if the destination file exists, assume rename already happenned,</span>
            <span class="c1"># otherwis return false so that caller falls back to downloading/sending the file.</span>
            <span class="c1"># return os.path.isfile(path) </span>
            <span class="c1"># PAS 2022/12/01 ... only 1 message to interpret, will never be a previous rename.</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;renamed </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;sr_subscribe/doit_download: could not rename </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">ok</span></div>


<div class="viewcode-block" id="Flow.mkdir">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.mkdir">[docs]</a>
    <span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            perform an mkdir.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ok</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;message is to mkdir </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDirDefault</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;making </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">ex</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;no need to mkdir </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> as it exists&quot;</span> <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDirDefault</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">mode</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">ok</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> failed.&quot;</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span></div>


<div class="viewcode-block" id="Flow.link1file">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.link1file">[docs]</a>
    <span class="k">def</span> <span class="nf">link1file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">symbolic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">          perform a link of a single file, based on a message, returning boolean success</span>
<span class="sd">          if it&#39;s Symbolic, then do that. else do a hard link.</span>

<span class="sd">          imported from v2/subscribe/doit_download &quot;link event, try to link the local product given by message&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message is to link </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">]))</span>

        <span class="c1"># redundant, check is done in caller.</span>
        <span class="c1">#if not &#39;link&#39; in self.o.fileEvents:</span>
        <span class="c1">#    logger.info(&quot;message to link %s to %s ignored (events setting)&quot; %  \</span>
        <span class="c1">#                                    ( msg[&#39;new_file&#39;], msg[&#39;fileOp&#39;][ &#39;link&#39; ] ) )</span>
        <span class="c1">#    return False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">])</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDirDefault</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;making </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">ex</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c1">#if os.path.isdir(path): os.rmdir(path)</span>

            <span class="k">if</span> <span class="s1">&#39;hlink&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;hlink&#39;</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> hard-linked to </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;hlink&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> sym-linked to </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">]))</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;link of </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> failed.&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span></div>


<div class="viewcode-block" id="Flow.do_download">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.do_download">[docs]</a>
    <span class="k">def</span> <span class="nf">do_download</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           do download work for self.worklist.incoming, placing files:</span>
<span class="sd">                successfully downloaded in worklist.ok</span>
<span class="sd">                temporary failures in worklist.failed</span>
<span class="sd">                permanent failures (or files not to be downloaded) in worklist.rejected</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;newname&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                  revamped rename algorithm requires only 1 message, ignore newname.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;new_dir&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">422</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;new_dir message field missing, do not know which directory to put file in. skipping.&quot;</span> <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;new_file&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">422</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;new_file message field missing, do not know name of file to write. skipping.&quot;</span> <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">new_path</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>
            <span class="n">new_file</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;missing destination directories, makedirs: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">])</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="mo">0o775</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;making </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">ex</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;chdir </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="s1">&#39;renameUnlink&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">removeOneFile</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">])</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;old unlinked </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># actual rename...</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renameOneItem</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">],</span> <span class="n">new_path</span><span class="p">)</span>
                        <span class="c1"># if rename succeeds, fall through to download object to find if the file renamed</span>
                        <span class="c1"># actually matches the one advertised, and potentially download it.</span>
                        <span class="c1"># if rename fails, recover by falling through to download the data anyways.</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;renamed&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                            <span class="k">continue</span>

                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;remove&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="p">):</span> 
                    <span class="k">if</span>  <span class="s1">&#39;rmdir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping rmdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeOneFile</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;rmdired&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#FIXME: should this really be queued for retry? or just permanently failed?</span>
                        <span class="c1"># in rejected to avoid retry, but wondering if failed and deferred</span>
                        <span class="c1"># should be separate lists in worklist...</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;rmdir </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;remove&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="s1">&#39;delete&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping delete </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeOneFile</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#FIXME: should this really be queued for retry? or just permanently failed?</span>
                        <span class="c1"># in rejected to avoid retry, but wondering if failed and deferred</span>
                        <span class="c1"># should be separate lists in worklist...</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;remove </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># no elif because if rename fails and operation is an mkdir or a symlink..</span>
                <span class="c1"># need to retry as ordinary creation, similar to normal file copy case.</span>
                <span class="k">if</span> <span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;mkdir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping mkdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;made directory&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># as above...</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;mkdir </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">])</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="s1">&#39;link&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;hlink&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;link&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping link </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">link1file</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;linked&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># as above...</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;link </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span>
                    <span class="k">continue</span>

            <span class="c1"># establish new_inflight_path which is the file to download into initially.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">)):</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                    <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">new_file</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDirDefault</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span> <span class="o">+</span> <span class="n">new_file</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                    <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">new_file</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#inflight is interval: minimum the age of the source file, as per message.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;interval inflight setting: </span><span class="si">%s</span><span class="s1">, not appropriate for downloads.&#39;</span> <span class="o">%</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span>
                <span class="c1"># FIXME... what to do?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="s2">&quot;invalid inflight </span><span class="si">%s</span><span class="s2"> settings </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">,</span> <span class="n">new_path</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_inflight_path</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_path</span>

            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;new_path&#39;</span><span class="p">])</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">])</span>

            <span class="c1"># assert new_inflight_path is set.</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">]):</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span><span class="p">:</span>
                    <span class="n">how_old</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">])</span>
                    <span class="c1">#FIXME: if mtime &gt; 5 minutes, perhaps rm it, and continue? what if transfer crashed?</span>
                    <span class="c1">#       Added this with fixed value, should it be a setting?</span>
                    <span class="k">if</span> <span class="n">how_old</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">]</span> <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;inflight file is </span><span class="si">{</span><span class="n">how_old</span><span class="si">}</span><span class="s2">s old. Removed previous attempt </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;inflight file already exists. race condition, deferring transfer of </span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># overwriting existing file.</span>

            <span class="c1"># FIXME: decision of whether to download, goes here.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span>
                                <span class="s2">&quot;not overwriting existing file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_should_be_downloaded</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="k">continue</span>

            <span class="c1"># download content</span>
            <span class="k">if</span> <span class="s1">&#39;content&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_inline_file</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s2">&quot;Download successful (inline content)&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;failed to write inline content </span><span class="si">%s</span><span class="s2">, falling through to download&quot;</span>
                    <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>

            <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">attempts</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;downloading again, attempt </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;downloaded ok: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_path</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s2">&quot;Download successful&quot;</span> <span class="p">)</span>
                    <span class="c1"># if content is present, but downloaded anyways, then it is no good, and should not be forwarded.</span>
                    <span class="k">if</span> <span class="s1">&#39;content&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;attempt </span><span class="si">%d</span><span class="s2"> failed to download </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> \
                        <span class="o">%</span> <span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">],</span> <span class="n">new_path</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;gave up downloading for now, appending to retry queue&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1"># FIXME: file reassembly missing?</span>
            <span class="c1">#if self.inplace : file_reassemble(self)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span></div>


    <span class="c1"># v2 sr_util.py ... generic sr_transport imported here...</span>

    <span class="c1"># generalized download...</span>
<div class="viewcode-block" id="Flow.download">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.download">[docs]</a>
    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           download/transfer one file based on message, return True if successful, otherwise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">options</span>

        <span class="k">if</span> <span class="s1">&#39;retrievePath&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport download override retrievePath=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;retrievePath&#39;</span><span class="p">]))</span>
            <span class="n">remote_file</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;retrievePath&#39;</span><span class="p">]</span>
            <span class="n">cdir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="ow">or</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">urlstr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">urlstr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport download relPath=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]))</span>

            <span class="c1"># split the path to the file and the file</span>
            <span class="c1"># if relPath is just the file remote_path will return empty</span>
            <span class="n">remote_path</span><span class="p">,</span> <span class="n">remote_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">])</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">baseUrlParse</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">])</span> 
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;baseUrl.path= </span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="p">(</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">remote_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span> <span class="p">)</span> <span class="p">:</span>
                        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">remote_path</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="n">remote_path</span>

                <span class="n">cdir</span> <span class="o">=</span> <span class="n">remote_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                    <span class="n">cdir</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cdir</span><span class="o">=</span><span class="kc">None</span>

            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="ow">or</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">urlstr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">urlstr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>


        <span class="n">istr</span> <span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;identity&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">fostr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s1">&#39;identity: </span><span class="si">%s</span><span class="s1">, fileOp: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">istr</span><span class="p">,</span> <span class="n">fostr</span> <span class="p">)</span> <span class="p">)</span> 
        <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">new_dir</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span>
        <span class="n">new_file</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>
        <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;inplace&#39;</span> <span class="p">]:</span> <span class="c1"># download only a specific block from a file, not the whole thing.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;splitting 1 file into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;manifest&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> block messages.&quot;</span> <span class="p">)</span>
                <span class="n">blkno</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">]</span>
                <span class="n">blksz_l</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">naturalSize</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">blksz</span> <span class="o">=</span> <span class="n">blksz_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">blksz_l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;¬ßblock_&#39;</span> <span class="ow">in</span> <span class="n">new_file</span><span class="p">:</span>
                    <span class="n">new_file</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;¬ßblock_</span><span class="si">{</span><span class="n">blkno</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">blksz</span><span class="si">}</span><span class="s2">_¬ß&quot;</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_file</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">new_file</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">new_file</span>
            <span class="k">elif</span> <span class="p">(</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span> <span class="o">+</span> <span class="n">new_file</span>
            <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">new_file</span> <span class="o">+</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;inflight setting: </span><span class="si">%s</span><span class="s1">, not for downloads.&#39;</span> <span class="o">%</span>
                         <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_inflight_path</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_inflight_path</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;new_inflight_path&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;download&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> returned </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="si">}</span><span class="s2">. Should return boolean&quot;</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">plugin</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">curdir</span> <span class="o">=</span> <span class="n">new_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">curdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">curdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">curdir</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">:</span>
            <span class="c1"># make sure directory exists, create it if not</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">directories_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="mo">0o775</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;local cd to </span><span class="si">{</span><span class="n">new_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;making </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details:&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">sendTo</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;baseUrl&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">Transfer</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">check_is_connected</span><span class="p">():</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]:</span> 
                         <span class="n">now</span><span class="o">=</span><span class="n">nowflt</span><span class="p">()</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectTime&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport download connects&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">)</span>

            <span class="c1">#=================================</span>
            <span class="c1"># if parts, check that the protol supports it</span>
            <span class="c1">#=================================</span>

            <span class="c1">#if not hasattr(proto,&#39;seek&#39;) and (&#39;blocks&#39; in msg) and ( msg[&#39;blocks&#39;][&#39;method&#39;] == &#39;inplace&#39; ):</span>
            <span class="c1">#   logger.error(&quot;%s, inplace part file not supported&quot; % self.scheme)</span>
            <span class="c1">#   return False</span>

            <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
         
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;getcwd&#39;</span><span class="p">):</span>
                <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot; from proto getcwd: </span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cdir</span> <span class="ow">and</span> <span class="n">cwd</span> <span class="o">!=</span> <span class="n">cdir</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport remote cd to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cdir</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">cwd</span> <span class="o">=</span> <span class="n">cdir</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="n">cdir</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;chdir </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdir</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
                         <span class="k">return</span> <span class="kc">False</span>

            <span class="n">remote_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">exactLength</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">):</span>
                <span class="n">blkno</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">]</span>
                <span class="n">remote_offset</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">exactLength</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">while</span> <span class="n">blkno</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">blkno</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">remote_offset</span> <span class="o">+=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;manifest&#39;</span><span class="p">][</span><span class="n">blkno</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>

                <span class="n">block_length</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;manifest&#39;</span><span class="p">][</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">]][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;offset calculation:  start=</span><span class="si">{</span><span class="n">remote_offset</span><span class="si">}</span><span class="s2"> count=</span><span class="si">{</span><span class="n">block_length</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;size&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">block_length</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">block_length</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1">#download file</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Beginning fetch of </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1"> into </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">urlstr</span><span class="p">,</span> <span class="n">remote_offset</span><span class="p">,</span> <span class="n">block_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">],</span>
                 <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">block_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># FIXME  locking for i parts in temporary file ... should stay lock</span>
            <span class="c1"># and file_reassemble... take into account the locking</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">identity_method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cod,&#39;</span><span class="p">):</span>
                <span class="n">download_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">identity_method</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="s1">&#39;identity&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cod&#39;</span><span class="p">:</span>
                    <span class="n">download_algo</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">download_algo</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">download_algo</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">download_algo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">set_sumalgo</span><span class="p">(</span><span class="n">download_algo</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">download_algo</span> <span class="o">==</span> <span class="s1">&#39;arbitrary&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">set_sumArbitrary</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">):</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">permDirDefault</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;unable to make inflight directory </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;hasAccel=</span><span class="si">%s</span><span class="s2">, thresh=</span><span class="si">%d</span><span class="s2">, len=</span><span class="si">%d</span><span class="s2">, remote_off=</span><span class="si">%d</span><span class="s2">, local_off=</span><span class="si">%d</span><span class="s2"> inflight=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                <span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;getAccelerated&#39;</span> <span class="p">),</span>  \
                <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">accelThreshold</span><span class="p">,</span> <span class="n">block_length</span><span class="p">,</span> <span class="n">remote_offset</span><span class="p">,</span>  <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">],</span> <span class="n">new_inflight_path</span> <span class="p">)</span> <span class="p">)</span>

            <span class="n">accelerated</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;getAccelerated&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">accelThreshold</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">block_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">accelThreshold</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">remote_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                        <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">getAccelerated</span><span class="p">(</span>
                            <span class="n">msg</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">block_length</span><span class="p">,</span> <span class="n">remote_offset</span><span class="p">,</span> <span class="n">exactLength</span><span class="p">)</span>
                        <span class="c1">#FIXME: no onfly_checksum calculation during download.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">)</span>
                        <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">msg</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">remote_offset</span><span class="p">,</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">],</span> <span class="n">block_length</span><span class="p">,</span> <span class="n">exactLength</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not get </span><span class="si">{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">len_written</span> <span class="o">=</span> <span class="n">block_length</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">):</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;separate&#39;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">len_written</span> <span class="o">==</span> <span class="n">block_length</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">len_written</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed to download </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">acceptSizeWrong</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s1">&#39;AcceptSizeWrong </span><span class="si">%d</span><span class="s1"> of with no length given for </span><span class="si">%s</span><span class="s1"> assuming ok&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">len_written</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;downloaded </span><span class="si">%d</span><span class="s1"> of with no length given for </span><span class="si">%s</span><span class="s1"> assuming ok&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">len_written</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">acceptSizeWrong</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s1">&#39;AcceptSizeWrong download size mismatch, received </span><span class="si">%d</span><span class="s1"> of expected </span><span class="si">%d</span><span class="s1"> bytes for </span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">len_written</span><span class="p">,</span> <span class="n">block_length</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">len_written</span> <span class="o">&gt;</span> <span class="n">block_length</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;download more </span><span class="si">{</span><span class="n">len_written</span><span class="si">}</span><span class="s1"> than expected </span><span class="si">{</span><span class="n">block_length</span><span class="si">}</span><span class="s1"> bytes for </span><span class="si">{</span><span class="n">new_inflight_path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;incomplete download only </span><span class="si">{</span><span class="n">len_written</span><span class="si">}</span><span class="s1"> of expected </span><span class="si">{</span><span class="n">block_length</span><span class="si">}</span><span class="s1"> bytes for </span><span class="si">{</span><span class="n">new_inflight_path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">inflight</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="c1"># when len_written is different than block_length</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_written</span>

            <span class="c1"># if we haven&#39;t returned False by this point, assuming download was successful</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">new_inflight_path</span> <span class="o">!=</span> <span class="n">new_file</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
            
            <span class="c1"># older versions don&#39;t include the contentType, so patch it here.</span>
            <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;filetypes&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;contentType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;contentType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span><span class="n">mime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxBytes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">len_written</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferRxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">download_algo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;onfly_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">get_sumstr</span><span class="p">()</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;data_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">data_checksum</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">identity_method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cod,&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">accelerated</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;onfly_checksum&#39;</span><span class="p">]</span>

                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;onfly_checksum&#39;</span><span class="p">])</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;data_checksum&#39;</span><span class="p">])</span>

            <span class="c1"># fix message if no partflg (means file size unknown until now)</span>
            <span class="c1">#if not &#39;blocks&#39; in msg:</span>
            <span class="c1">#    #msg[&#39;size&#39;] = self.proto[self.scheme].fpos ... fpos not set when accelerated.</span>

            <span class="c1"># fix permission</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_local_file_attributes</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">remote_file</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;file deleted on remote site </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="n">remote_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;unable to delete remote file </span><span class="si">{</span><span class="n">remote_file</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">acceptSizeWrong</span> <span class="ow">or</span> <span class="p">(</span><span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">len_written</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">len_written</span> <span class="o">!=</span> <span class="n">block_length</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;failed to write </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>

            <span class="c1">#closing on problem</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;closing exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s2">&quot;transferConnected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;transferConnectLast&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectedTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectLast&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectedTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cdir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="c1"># generalized send...</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">options</span>
        <span class="n">sendTo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">sendTo</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">_transport sendTo: </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport send </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;send&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;send&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> returned </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="si">}</span><span class="s2">. Should return boolean&quot;</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;flowCallback plugin </span><span class="si">{</span><span class="n">plugin</span><span class="si">}</span><span class="s1"> crashed: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">variableExpansion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span>
                                                <span class="n">msg</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;relPath&#39;</span><span class="p">]</span>

        <span class="c1"># older versions don&#39;t include the contentType, so patch it here.</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;filetypes&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="s1">&#39;contentType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">):</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;contentType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span><span class="n">mime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">new_dir</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">new_file</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">curdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">curdir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">curdir</span> <span class="o">!=</span> <span class="n">local_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;could not chdir to </span><span class="si">%s</span><span class="s2"> to write: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">))</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">check_is_connected</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport send connects&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]:</span> 
                         <span class="n">now</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectTime&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">Transfer</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    
                    <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cdir</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 

            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dry_run </span><span class="si">%s</span><span class="s2">_transport send connects&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">Transfer</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cdir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 

            <span class="c1">#=================================</span>
            <span class="c1"># if parts, check that the protocol supports it</span>
            <span class="c1">#=================================</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span>
                           <span class="s1">&#39;seek&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                               <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, inplace part file not supported&quot;</span> <span class="o">%</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1">#=================================</span>
            <span class="c1"># if umask, check that the protocol supports it ...</span>
            <span class="c1">#=================================</span>

            <span class="n">inflight</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span>
                           <span class="s1">&#39;umask&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span> <span class="o">==</span> <span class="s1">&#39;umask&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, umask not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                <span class="n">inflight</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1">#=================================</span>
            <span class="c1"># if renaming used, check that the protocol supports it ...</span>
            <span class="c1">#=================================</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span>
                           <span class="s1">&#39;rename&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, rename not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                <span class="n">inflight</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1">#=================================</span>
            <span class="c1"># remote set to new_dir</span>
            <span class="c1">#=================================</span>

            <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;getcwd&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not getcwd on </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">cwd</span> <span class="o">!=</span> <span class="n">new_dir</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_transport send cd to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">cd_forced</span><span class="p">(</span><span class="mi">775</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not chdir to </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

            <span class="c1">#=================================</span>
            <span class="c1"># delete event</span>
            <span class="c1">#=================================</span>

            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;remove&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message is to remove </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span> 
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not rmdir </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                    <span class="k">return</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not delete </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                    <span class="k">return</span> <span class="kc">False</span>

                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;file or directory removed&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, delete not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="s1">&#39;rename&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;message is to rename </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">],</span> <span class="n">new_file</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not rename </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> (in </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;rename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>

                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;file renamed&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, delete not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;contentType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;contentType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/directory&#39;</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;mkdir&#39;</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;message is to mkdir </span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not mkdir </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;directory created&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, mkdir not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>


                <span class="c1">#=================================</span>
                <span class="c1"># link event</span>
                <span class="c1">#=================================</span>

                <span class="k">if</span> <span class="s1">&#39;hlink&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;contentType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;contentType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/link&#39;</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;link&#39;</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message is to link </span><span class="si">%s</span><span class="s2"> to: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;hlink&#39;</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;hlink&#39;</span><span class="p">],</span> <span class="n">new_file</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not link </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;hlink&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, hardlinks not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="s1">&#39;link&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;contentType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;contentType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/link&#39;</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;symlink&#39;</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message is to link </span><span class="si">%s</span><span class="s2"> to: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">],</span> <span class="n">new_file</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not symlink </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;file linked&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, symlink not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1">#=================================</span>
            <span class="c1"># send event</span>
            <span class="c1">#=================================</span>

            <span class="c1"># the file does not exist... warn, sleep and return false for the next attempt</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;product collision or base_dir not set, file </span><span class="si">%s</span><span class="s2"> does not exist&quot;</span>
                    <span class="o">%</span> <span class="n">local_file</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="s1">&#39;size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">):</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>

            <span class="n">new_offset</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;size&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">block_length</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                <span class="n">str_range</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">):</span>
                    <span class="n">block_length</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                    <span class="n">str_range</span> <span class="o">=</span> <span class="s1">&#39;bytes=</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">new_offset</span> <span class="o">+</span>
                                                 <span class="n">block_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">str_range</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">):</span>
                <span class="n">str_range</span> <span class="o">=</span> <span class="s1">&#39;bytes=</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1">#upload file</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;hasattr=</span><span class="si">%s</span><span class="s2">, thresh=</span><span class="si">%d</span><span class="s2">, len=</span><span class="si">%d</span><span class="s2">, remote_off=</span><span class="si">%d</span><span class="s2">, local_off=</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> \
                <span class="p">(</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;putAccelerated&#39;</span><span class="p">),</span>  \
                <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">accelThreshold</span><span class="p">,</span> <span class="n">block_length</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">,</span>  <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>

            <span class="n">accelerated</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="s1">&#39;putAccelerated&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">accelThreshold</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">block_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">accelThreshold</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">new_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;local_offset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inflight</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">((</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span>
                                    <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;inplace&#39;</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">putAccelerated</span><span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not send </span><span class="si">{</span><span class="n">local_dir</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> to inflight=None </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                
            <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inplace&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                            <span class="n">new_offset</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not send </span><span class="si">{</span><span class="n">local_dir</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> inplace </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

            <span class="k">elif</span> <span class="n">inflight</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">new_file</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">putAccelerated</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not send </span><span class="si">{</span><span class="n">local_dir</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not rename inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">len_written</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">inflight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">new_file</span> <span class="o">+</span> <span class="n">inflight</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">putAccelerated</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not send </span><span class="si">{</span><span class="n">local_dir</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not rename inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">cd_forced</span><span class="p">(</span>
                            <span class="mi">775</span><span class="p">,</span> <span class="n">new_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">cd_forced</span><span class="p">(</span><span class="mi">775</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">new_inflight_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">inflight</span> <span class="o">+</span> <span class="n">new_file</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">putAccelerated</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_inflight_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not send </span><span class="si">{</span><span class="n">local_dir</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not rename inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">len_written</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">inflight</span> <span class="o">==</span> <span class="s1">&#39;umask&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">umask</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">accelerated</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">putAccelerated</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">len_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not send </span><span class="si">{</span><span class="n">local_dir</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;could not rename inflight=</span><span class="si">{</span><span class="n">inflight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sendTo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">len_written</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>

            <span class="n">msg</span><span class="o">.</span><span class="n">setReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="s1">&#39;file sent&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxBytes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">len_written</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxFiles&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferTxLast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">][</span><span class="s1">&#39;timeCompleted&#39;</span><span class="p">]</span>

            <span class="c1"># fix permission</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_remote_file_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span> <span class="n">new_file</span><span class="p">,</span>
                                            <span class="n">msg</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sent: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> into </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">str_range</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">,</span> <span class="n">new_file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                         <span class="n">offset</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>

            <span class="c1">#removing lock if left over</span>
            <span class="k">if</span> <span class="n">new_inflight_path</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">],</span>
                                                     <span class="s1">&#39;delete&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">new_inflight_path</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c1">#closing on problem</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">nowflt</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectTime&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnectStart&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">][</span><span class="s1">&#39;transferConnected&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cdir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Delivery failed </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                         <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception details: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># set_local_file_attributes</span>
<div class="viewcode-block" id="Flow.set_local_file_attributes">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.set_local_file_attributes">[docs]</a>
    <span class="k">def</span> <span class="nf">set_local_file_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           after a file has been written, restore permissions and ownership if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">local_file</span><span class="p">)</span>

        <span class="c1"># if the file is not partitioned, the the onfly_checksum is for the whole file.</span>
        <span class="c1"># cache it here, along with the mtime, unless block_reassembly plugin is active...</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;blocks&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;reassembly&#39;</span><span class="p">][</span><span class="s1">&#39;present&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_reassembly_active</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">blockmanifest</span><span class="o">.</span><span class="n">BlockManifest</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">bm</span><span class="p">:</span>
                <span class="n">bm</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">filemetadata</span><span class="o">.</span><span class="n">FileMetadata</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>
        <span class="c1"># FIXME ... what to do when checksums don&#39;t match?</span>
        <span class="k">if</span> <span class="s1">&#39;onfly_checksum&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span> 
            <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;onfly_checksum&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;identity&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">timeCopy</span> <span class="ow">and</span> <span class="s1">&#39;mtime&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;mtime&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;mtime&#39;</span><span class="p">,</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timeflt2str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">local_file</span><span class="p">)))</span>

        <span class="n">x</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permCopy</span> <span class="ow">and</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDefault</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDefault</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">timeCopy</span> <span class="ow">and</span> <span class="s1">&#39;mtime&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])</span>
            <span class="n">atime</span> <span class="o">=</span> <span class="n">mtime</span>
            <span class="k">if</span> <span class="s1">&#39;atime&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;atime&#39;</span><span class="p">]:</span>
                <span class="n">atime</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;atime&#39;</span><span class="p">])</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span></div>


    <span class="c1"># set_remote_file_attributes</span>
    <span class="k">def</span> <span class="nf">set_remote_file_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1">#logger.debug(&quot;sr_transport set_remote_file_attributes %s&quot; % remote_file)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="s1">&#39;chmod&#39;</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permCopy</span> <span class="ow">and</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">proto</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDefault</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proto</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">permDefault</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="s1">&#39;utime&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">timeCopy</span> <span class="ow">and</span> <span class="s1">&#39;mtime&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]:</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">])</span>
                <span class="n">atime</span> <span class="o">=</span> <span class="n">mtime</span>
                <span class="k">if</span> <span class="s1">&#39;atime&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;atime&#39;</span><span class="p">]:</span>
                    <span class="n">atime</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">timestr2flt</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;atime&#39;</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proto</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">remote_file</span><span class="p">,</span> <span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="c1"># v2 sr_util sr_transport stuff. end.</span>

    <span class="c1"># imported from v2: sr_sender/doit_send</span>

<div class="viewcode-block" id="Flow.do_send">
<a class="viewcode-back" href="../../Reference/code.html#sarracenia.flow.Flow.do_send">[docs]</a>
    <span class="k">def</span> <span class="nf">do_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;new_dir&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">422</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;new_dir message field missing, do not know which directory to put file in. skipping.&quot;</span> <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;new_file&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">422</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;new_file message field missing, do not know name of file to write. skipping.&quot;</span> <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># weed out non-file transfer operations that are configured to not be done.</span>
            <span class="k">if</span> <span class="s1">&#39;fileOp&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;remove&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;rmdir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span> <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping rmdir here.&quot;</span> <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;remove&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;delete&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span> <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping delete here.&quot;</span> <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;mkdir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span> <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping mkdir here.&quot;</span> <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;hlink&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;link&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span> <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping hlink here.&quot;</span> <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;link&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;fileOp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;link&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">fileEvents</span> <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="s2">&quot;skipping link here.&quot;</span> <span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1">#=================================</span>
            <span class="c1"># proceed to send :  has to work</span>
            <span class="c1">#=================================</span>

            <span class="c1"># N attempts to send</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">attempts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;sending again, attempt </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="p">[]</span></div>
</div>



<span class="kn">import</span> <span class="nn">sarracenia.flow.poll</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.post</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.report</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.sarra</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.sender</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.shovel</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.subscribe</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.watch</span>
<span class="kn">import</span> <span class="nn">sarracenia.flow.winnow</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>