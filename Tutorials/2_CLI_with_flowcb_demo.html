<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customize File handling with Callbacks. &mdash; Sarracenia 3.00.54rc1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
        <script src="../_static/documentation_options.js?v=99fb584f"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="flow API Example" href="3_api_flow_demo.html" />
    <link rel="prev" title="Downloading Using the Command Line" href="1_CLI_introduction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Sarracenia
          </a>
              <div class="version">
                3.00.54rc1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1_CLI_introduction.html">Downloading Using the Command Line</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Customize File handling with Callbacks.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Config-File-Entries-and-Callbacks">Config File Entries and Callbacks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Writing-Your-Own-Callbacks">Writing Your Own Callbacks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Worklists">Worklists</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Logging">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Sample-Flow-Callback-Class">Sample Flow Callback Class</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Sample-Flowcb-Sub-Class">Sample Flowcb Sub-Class</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Plugins-That-Change-How-a-File-is-Downloaded">Plugins That Change How a File is Downloaded</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Plugins-that-Process-a-file-after-it-is-Downloaded">Plugins that Process a file after it is Downloaded</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Plugins-that-Rename-Files">Plugins that Rename Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Plugins-That-Create-New-Files">Plugins That Create New Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Other-Examples">Other Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="3_api_flow_demo.html">flow API Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_api_moth_sub_demo.html">A first Example using Sarracenia Moth API</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_api_moth_post_demo.html">Posting from Python Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="Install.html">MetPX-Sarracenia Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Setup_a_local_subscriber.html">Server Admin: A Local Subscriber</a></li>
<li class="toctree-l2"><a class="reference internal" href="Setup_a_remote_subscriber.html">How to setup a Remote Subscriber</a></li>
<li class="toctree-l2"><a class="reference internal" href="Windows.html">Windows user manual</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../How2Guides/index.html">HOWTOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fr/index.html">En français</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Tutorials</a> &raquo;</li>
      <li>Customize File handling with Callbacks.</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Tutorials/2_CLI_with_flowcb_demo.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Customize-File-handling-with-Callbacks.">
<h1>Customize File handling with Callbacks.<a class="headerlink" href="#Customize-File-handling-with-Callbacks." title="Link to this heading"></a></h1>
<p>All Sarracenia components implement <em>the Flow</em> algorithm, with different callbacks, in the Python programming language. Sarracenia’s main (Python) class is <a class="reference external" href="../Reference/code.html#module-sarracenia.flow">sarracenia.flow</a> and the a great deal of core functionality is implemented using the class created to add custom processing to a flow, the flowcb (flow callback) class.</p>
<p>For a detailed discussion of the flow algorithm itself, have a look at <a class="reference external" href="../Explanation/Concepts.html">Concepts</a> manual. For any flow, one can add custom processing at a variety of times during processing by sub-classing the <a class="reference external" href="../Reference/flowcb.html">sarracenia.flowcb</a> class.</p>
<p>Briefly, the algorithm has the following steps:</p>
<ul class="simple">
<li><p><strong>init(self, options)</strong> – when the import happens, traditional python initialization</p></li>
<li><p><strong>on_start</strong> – when an instance is started.</p></li>
<li><p>loop forever</p>
<ul>
<li><p><strong>gather</strong> – collect messages to be processed called: worklist.incoming</p></li>
<li><p><strong>poll</strong> – another way to collect messages, only in the poll component.</p></li>
<li><p><strong>filter</strong> – apply accept/reject regular expression matches to the message list. moves messages for files not to download from worklist.incoming to worklist.reject</p>
<ul>
<li><p><em>after_accept</em> callback entry point. process worklist.incoming, potentially rejecting some more.</p></li>
</ul>
</li>
<li><p><strong>ack</strong> – worklist.rejected messages are acknowledged to upstream source as processing is complete.</p></li>
<li><p><strong>work</strong> – perform a transfer or transformation on a file.</p></li>
<li><p><strong>ack</strong> – worklist.ok messages for successfully transferred files are acknowledged to upstream source.</p>
<ul>
<li><p><em>after_work</em> callback entry point</p></li>
</ul>
</li>
<li><p><strong>ack</strong> – worklist.failed messages for files which not successfully transferred are acknowledged.</p></li>
<li><p><strong>post</strong> – post the result of the work done for the next step.</p></li>
<li><p>occasionaly… **on_housekeeping – do periodic cleanups…</p></li>
</ul>
</li>
<li><p><strong>on_stop</strong> – shutdown processing.</p></li>
</ul>
<p>for more details about flowcb entry points available, have a look at the source code:</p>
<ul class="simple">
<li><p><a class="reference external" href="../Reference/flowcb.html">flowcb</a></p></li>
</ul>
<p>Lets look at using the class in a configuration:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>sr3<span class="w"> </span>remove<span class="w"> </span>subscribe/hpfx_amis.conf
<span class="o">!</span>sr3<span class="w"> </span>add<span class="w"> </span>subscribe/hpfx_amis.conf
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2024-01-12 15:51:55,713 127453 [INFO] sarracenia.config finalize overriding batch for consistency with messageCountMax: {self.batch}
2024-01-12 15:51:55,714 127453 [INFO] root remove removing subscribe/hpfx_amis

add: 2024-01-12 15:51:56,975 127456 [INFO] sarracenia.sr add copying: /home/peter/Sarracenia/sr3/sarracenia/examples/subscribe/hpfx_amis.conf to /home/peter/.config/sr3/subscribe/hpfx_amis.conf

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span><span class="nb">echo</span><span class="w"> </span>messageCountMax<span class="w"> </span><span class="m">10</span><span class="w"> </span>&gt;&gt;~/.config/sr3/subscribe/hpfx_amis.conf
</pre></div>
</div>
</div>
<p>have the flow stop after 10 messages are consumed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>sr3<span class="w"> </span>list<span class="w"> </span>fcb
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2024-01-12 15:52:22,624 127524 [INFO] sarracenia.config finalize overriding batch for consistency with messageCountMax: {self.batch}
Provided callback classes: ( /home/peter/Sarracenia/sr3/sarracenia )
flowcb/accept/auth_NASA_Earthdata.py flowcb/accept/auth_copernicus.py
flowcb/accept/auth_eumetsat.py   flowcb/accept/dateappend.py
flowcb/accept/delete.py          flowcb/accept/downloadbaseurl.py
flowcb/accept/hourtree.py        flowcb/accept/httptohttps.py
flowcb/accept/longflow.py        flowcb/accept/pathreplace.py
flowcb/accept/posthourtree.py    flowcb/accept/postoverride.py
flowcb/accept/printlag.py        flowcb/accept/rename4jicc.py
flowcb/accept/renamedmf.py       flowcb/accept/renamewhatfn.py
flowcb/accept/save.py            flowcb/accept/speedo.py
flowcb/accept/sundewpxroute.py   flowcb/accept/testretry.py
flowcb/accept/toclusters.py      flowcb/accept/tohttp.py
flowcb/accept/tolocal.py         flowcb/accept/tolocalfile.py
flowcb/accept/trim_legacy_fields.py flowcb/accept/wmotypesuffix.py
flowcb/amserver.py               flowcb/block_reassembly.py
flowcb/clamav.py                 flowcb/destfn/replace.py
flowcb/destfn/sample.py          flowcb/download/mail_ingest.py
flowcb/filter/deleteflowfiles.py flowcb/filter/fdelay.py
flowcb/filter/pclean_f90.py      flowcb/filter/pclean_f92.py
flowcb/filter/wmo2msc.py         flowcb/gather/file.py
flowcb/gather/message.py         flowcb/housekeeping/resources.py
flowcb/log.py                    flowcb/mdelaylatest.py
flowcb/nodupe/data.py            flowcb/nodupe/disk.py
flowcb/nodupe/name.py            flowcb/nodupe/redis.py
flowcb/pclean.py                 flowcb/poll/airnow.py
flowcb/poll/eumetsat.py          flowcb/poll/mail.py
flowcb/poll/nasa_mls_nrt.py      flowcb/poll/nexrad.py
flowcb/poll/noaa_hydrometric.py  flowcb/poll/odata.py
flowcb/poll/poll_NASA_CMR.py     flowcb/poll/rate_limit.py
flowcb/poll/s3bucket.py          flowcb/poll/usgs.py
flowcb/post/message.py           flowcb/report.py
flowcb/retry.py                  flowcb/rootchown.py
flowcb/run.py                    flowcb/rxqueue_gzip.py
flowcb/sample.py                 flowcb/scheduled/wiski.py
flowcb/send/am.py                flowcb/send/email.py
flowcb/shiftdir2baseurl.py       flowcb/trace_on_stop.py
flowcb/v2wrapper.py              flowcb/wistree.py
flowcb/work/age.py               flowcb/work/check.py
flowcb/work/citypage_check.py    flowcb/work/delete.py
flowcb/work/rxpipe.py            flowcb/work/send_egc_les.py
</pre></div></div>
</div>
<p>Adding that line to the configuration means that the wistree flowcb subclass (source above) will be added to the flow, changing processing by having its routines called… the main one being <em>after_accept</em></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span><span class="nb">echo</span><span class="w"> </span>callback<span class="w"> </span>accept.posthourtree<span class="w"> </span>&gt;&gt;~/.config/sr3/subscribe/hpfx_amis.conf
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>sr3<span class="w"> </span>foreground<span class="w"> </span>subscribe/hpfx_amis.conf
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2024-01-12 15:52:39,635 127558 [INFO] sarracenia.config finalize overriding batch for consistency with messageCountMax: {self.batch}
.2024-01-12 15:52:40,036 [INFO] 127562 sarracenia.config finalize overriding batch for consistency with messageCountMax: {self.batch}
2024-01-12 15:52:40,038 [INFO] 127562 sarracenia.config finalize overriding batch for consistency with messageCountMax: {self.batch}
2024-01-12 15:52:40,038 [INFO] 127562 sarracenia.flow loadCallbacks flowCallback plugins to load: [&#39;sarracenia.flowcb.gather.message.Message&#39;, &#39;sarracenia.flowcb.retry.Retry&#39;, &#39;sarracenia.flowcb.housekeeping.resources.Resources&#39;, &#39;accept.posthourtree&#39;, &#39;log&#39;]
2024-01-12 15:52:40,041 [INFO] 127562 sarracenia.flowcb.log __init__ subscribe initialized with: logEvents: {&#39;after_accept&#39;, &#39;on_housekeeping&#39;, &#39;after_work&#39;, &#39;after_post&#39;, &#39;post&#39;},  logMessageDump: False
2024-01-12 15:52:40,042 [INFO] 127562 sarracenia.flow run callbacks loaded: [&#39;sarracenia.flowcb.gather.message.Message&#39;, &#39;sarracenia.flowcb.retry.Retry&#39;, &#39;sarracenia.flowcb.housekeeping.resources.Resources&#39;, &#39;accept.posthourtree&#39;, &#39;log&#39;]
2024-01-12 15:52:40,042 [INFO] 127562 sarracenia.flow run pid: 127562 subscribe/hpfx_amis instance: 0
2024-01-12 15:52:40,441 [INFO] 127562 sarracenia.moth.amqp _queueDeclare queue declared q_anonymous_subscribe.hpfx_amis.68942404.82515581 (as: amqps://anonymous@hpfx.collab.science.gc.ca/), (messages waiting: 0)
2024-01-12 15:52:40,441 [INFO] 127562 sarracenia.moth.amqp getSetup binding q_anonymous_subscribe.hpfx_amis.68942404.82515581 with v02.post.*.WXO-DD.bulletins.alphanumeric.# to xpublic (as: amqps://anonymous@hpfx.collab.science.gc.ca/)
2024-01-12 15:52:40,487 [INFO] 127562 sarracenia.flow run now active on vip [&#39;AnyAddressIsFine&#39;]
2024-01-12 15:52:44,644 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:44,644 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:44,644 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:44,644 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 2.82 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SR/KWAL/20/SRCN40_KWAL_122052___32878
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 6.28 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SO/KWNB/20/SOVD83_KWNB_121900_RRX__26978
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 6.27 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SM/KWNB/20/SMVD20_KWNB_121800_RRX__52297
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 6.27 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SM/KWNB/20/SMVD20_KWNB_121800_RRX__48301
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 3.97 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SR/KWAL/20/SRCN40_KWAL_122052___22701
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 3.97 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SN/KWNB/20/SNVD20_KWNB_121900_RRX__17918
2024-01-12 15:52:44,645 [INFO] 127562 sarracenia.flow do_download missing destination directories, makedirs: /tmp/hpfx_amis/20
2024-01-12 15:52:45,153 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SRCN40_KWAL_122052___32878
2024-01-12 15:52:45,153 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SOVD83_KWNB_121900_RRX__26978
2024-01-12 15:52:45,153 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SMVD20_KWNB_121800_RRX__52297
2024-01-12 15:52:45,153 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SMVD20_KWNB_121800_RRX__48301
2024-01-12 15:52:45,153 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SRCN40_KWAL_122052___22701
2024-01-12 15:52:45,153 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SNVD20_KWNB_121900_RRX__17918
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.accept.posthourtree after_accept post_hour_tree: new_dir: /tmp/hpfx_amis/20
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 1.53 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SR/KWAL/20/SRMN70_KWAL_122052___39567
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 1.53 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SR/KWAL/20/SRCN40_KWAL_122052___5395
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 0.52 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SR/KWAL/20/SRWA20_KWAL_122052___2278
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 2.14 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SX/KWAL/20/SXCN40_KWAL_122052___60928
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 2.14 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SR/KWAL/20/SRME20_KWAL_122052___58721
2024-01-12 15:52:45,263 [INFO] 127562 sarracenia.flowcb.log after_accept accepted: (lag: 2.14 ) https://hpfx.collab.science.gc.ca /20240112/WXO-DD/bulletins/alphanumeric/20240112/SN/KWNB/20/SNVD22_KWNB_121900_RRX__60599
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SRMN70_KWAL_122052___39567
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SRCN40_KWAL_122052___5395
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SRWA20_KWAL_122052___2278
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SXCN40_KWAL_122052___60928
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SRME20_KWAL_122052___58721
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flowcb.log after_work downloaded ok: /tmp/hpfx_amis/20/SNVD22_KWNB_121900_RRX__60599
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flow please_stop ok, telling 5 callbacks about it.
2024-01-12 15:52:45,735 [INFO] 127562 sarracenia.flow run starting last pass (without gather) through loop for cleanup.
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.flow please_stop ok, telling 5 callbacks about it.
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.flow run on_housekeeping pid: 127562 subscribe/hpfx_amis instance: 0
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.flowcb.gather.message on_housekeeping messages: good: 12 bad: 0 bytes: 1.6 KiB average: 140 Bytes
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.flowcb.retry on_housekeeping on_housekeeping
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.diskqueue on_housekeeping work_retry_00 on_housekeeping
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.diskqueue on_housekeeping No retry in list
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.diskqueue on_housekeeping on_housekeeping elapse 0.000168
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.diskqueue on_housekeeping post_retry_000 on_housekeeping
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.diskqueue on_housekeeping No retry in list
2024-01-12 15:52:45,741 [INFO] 127562 sarracenia.diskqueue on_housekeeping on_housekeeping elapse 0.000106
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.housekeeping.resources on_housekeeping Current Memory cpu_times: user=0.44 system=0.07
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.housekeeping.resources on_housekeeping Current mem usage: 92.3 MiB, accumulating count (12 or 12/100 so far) before self-setting threshold
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.log stats version: 3.00.51rc5, started: 5 seconds ago, last_housekeeping:  5.7 seconds ago
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.log stats messages received: 12, accepted: 12, rejected: 0   rate accepted: 100.0% or 2.1 m/s
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.log stats files transferred: 12 bytes: 2.2 KiB rate: 386 Bytes/sec
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.log stats lag: average: 3.30, maximum: 6.28
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flowcb.log on_housekeeping housekeeping
2024-01-12 15:52:45,742 [INFO] 127562 sarracenia.flow run clean stop from run loop
2024-01-12 15:52:45,763 [INFO] 127562 sarracenia.flowcb.gather.message on_stop closing
2024-01-12 15:52:45,764 [INFO] 127562 sarracenia.flow close flow/close completed cleanly pid: 127562 subscribe/hpfx_amis instance: 0

</pre></div></div>
</div>
<p>Without the plugin, the download would put all files directly the reception directory. with the addition of the wistree callback, it puts places the file in /tmp/hpfx_amis. With the change it puts it in the WIS tree of directories, and adds a file type suffix.</p>
<section id="Config-File-Entries-and-Callbacks">
<h2>Config File Entries and Callbacks<a class="headerlink" href="#Config-File-Entries-and-Callbacks" title="Link to this heading"></a></h2>
<p><a class="reference external" href="../Reference/flowcb.html#module-sarracenia.flowcb.log">flowcb.log</a></p>
<p>To add a callback to a a flow, a line is added to the flows’s configuration file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>flowcb sarracenia.flowcb.log.Log
</pre></div>
</div>
<p>If you follow the convention, and the name of the class is a capitalized version (Log) of the file name (log), then a shorthand is available:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>callback log
</pre></div>
</div>
<p>Either way it is done, it will cause Sarracenia to import the class and then look for entry points in the class to call at appropriate times.</p>
<p>The class constructor accepts a sarracenia.config.Config class object, called options, that stores all the settings to be used by the running flow. Options is used to override default behaviour of both flows and callbacks. The argument to the flowcb is a standard python class that needs to be in the normal python path for python <em>import</em>, and the last element is the name of the class in within the file that needs to be instantiated as a flowcb instance.</p>
<p>a setting for a callback is declared as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>set sarracenia.flowcb.filter.log.Log.logLevel debug
</pre></div>
</div>
<p>(the prefix for the setting matches the type hierarchy in flowCallback)</p>
<p>when the constructor for the callback is called, it’s options argument will contain:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>options.logLevel = &#39;debug&#39;
</pre></div>
</div>
<p>If no module specific override is present, then the more global setting is used.</p>
<p>So usage of callbacks can be made without much python knowledge at all, just the ability to create configuration files.</p>
<p>Beyond this point, we find advice for people who want to write their own callbacks in Python. Callbacks are ordinary Python, with a few wrinkles:</p>
</section>
<section id="Writing-Your-Own-Callbacks">
<h2>Writing Your Own Callbacks<a class="headerlink" href="#Writing-Your-Own-Callbacks" title="Link to this heading"></a></h2>
<p>A flow callback, is a python class built with routines named to indicate when the programmer wants them to be called. To do that, create a routine which subclasses <em>sarracenia.flowcb.FlowCB</em> so the class will normally have:</p>
<p>from sarracenia.flowcb import FlowCB</p>
<p>in among the imports near the top of the file. In the main part of the file, there will be the custom callback classes:</p>
<p>class Myclass(FlowCB):</p>
<p>declared as a subclass as FlowCB. The main routines in the class are entry points that will be called at the time their name implies. If you a class is missing a given entry point, it will just not be called. The <strong>init</strong>() class is used to initialize things for the callback class:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>def __init__(self, options):

    self.o = options

    logging.basicConfig(format=self.o.logFormat,
                        level=getattr(logging, self.o.logLevel.upper()))
    logger.setLevel(getattr(logging, self.o.logLevel.upper()))

    self.o.add_option( &#39;myoption&#39;, &#39;str&#39;, &#39;usuallyThis&#39;)
</pre></div>
</div>
<p>The logging setup lines in <strong>init</strong> allow setting a specific logging level for this flowCallback class. Once the logging boiler-plate is done, the add_option routine to define settings to for the class. users can include them in configuration files, just like built-in options:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>myoption IsReallyNeeded
</pre></div>
</div>
<p>The result of such a setting is that the <em>self.o.myoption = ‘IsReallyNeeded’</em>. If no value is set in the configuration, <em>self.o.myoption</em> will default to <em>‘usuallyThis’</em> There are various <em>kinds</em> of options, where the declared type modifies the parsing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;count&#39;    integer count type.
&#39;duration&#39; a floating point number indicating a quantity of seconds (0.001 is 1 milisecond)
           modified by a unit suffix ( m-minute, h-hour, w-week )
&#39;flag&#39;     boolean (True/False) option.
&#39;list&#39;     a list of string values, each succeeding occurrence catenates to the total.
           all v2 plugin options are declared of type list.
&#39;size&#39;     integer size. Suffixes k, m, and g for kilo, mega, and giga (base 2) multipliers.
&#39;str&#39;      an arbitrary string value, as will all of the above types, each
           succeeding occurrence overrides the previous one.
</pre></div>
</div>
</section>
<section id="Worklists">
<h2>Worklists<a class="headerlink" href="#Worklists" title="Link to this heading"></a></h2>
<p>Besides <em>options</em>, the other main argument to after_accept and after_work callback routines is the worklist. The worklist is given to entry points occurring during message processing, and is a number of worklists of messages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>worklist.incoming --&gt; messages to process (either new or retries.)
worklist.ok       --&gt; successfully processed
worklist.rejected --&gt; messages to not be further processed.
worklist.failed   --&gt; messages for which processing failed.
                      failed messages will be retried.
worklist.directories_ok --&gt; list of directories created during processing.
</pre></div>
</div>
<p>Initially, all messages are placed in worklists.incoming. if a plugin decides:</p>
<ul class="simple">
<li><p>a message is not relevant, moved it to the rejected worklist.</p></li>
<li><p>a no further processing of the message is needed, move it to ok worklist.</p></li>
<li><p>an operation failed and it should be retried later, move to failed worklist.</p></li>
</ul>
<p>Do not remove from all lists, only move messages between the worklists. it is necessary to put rejected messages in the appropriate worklist so that they are acknowledged as received. Messages can only removed after the acknowledgement has been taken care of.</p>
</section>
<section id="Logging">
<h2>Logging<a class="headerlink" href="#Logging" title="Link to this heading"></a></h2>
<p>Python has great built-in logging, and once has to just use the module in a normal, pythonic way, with:</p>
<p>import logging</p>
<p>After all imports in your python source file, then define a logger for the source file:</p>
<p>logger = logging.getLogger(_<em>name_</em>)</p>
<p>As is normal with the Python logging module, messages can then be posted to the log:</p>
<p>logger.debug(‘got here’)</p>
<p>Each message in the log will be prefixed with the class and routine emitting the log message, as well as the date/time.</p>
</section>
<section id="Sample-Flow-Callback-Class">
<h2>Sample Flow Callback Class<a class="headerlink" href="#Sample-Flow-Callback-Class" title="Link to this heading"></a></h2>
<p>With the above information about option handling, worklists, and logging, we are ready to understand the wistree module we just used. As a very simple example, here is the source code of the callback used above is given below:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plugin posthourtree.py:</span>
<span class="sd">    When posting a file, insert an hourly directory into the delivery path hierarchy.</span>

<span class="sd">Example:</span>
<span class="sd">    input A/B/c.gif  --&gt; output A/B/&lt;hour&gt;/c.gif</span>

<span class="sd">Usage:</span>
<span class="sd">    callback accept.posthourtree</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">stat</span>
<span class="kn">from</span> <span class="nn">sarracenia.flowcb</span> <span class="kn">import</span> <span class="n">FlowCB</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Posthourtree</span><span class="p">(</span><span class="n">FlowCB</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">after_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>
            <span class="n">datestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>  <span class="c1"># pick the hour</span>
            <span class="c1"># insert the hour into the rename header of the message to be posted.</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">datestr</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>  <span class="sa">f</span><span class="s2">&quot;post_hour_tree: new_dir: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Sample-Flowcb-Sub-Class">
<h2>Sample Flowcb Sub-Class<a class="headerlink" href="#Sample-Flowcb-Sub-Class" title="Link to this heading"></a></h2>
<p>This wistree.py class, shows more aspects of the callback API, with an <strong>init</strong>.py as well as bringing in an externam python module, as well as adding fields to the messages. The Wistree class accepts files whose names begin with AHL’s (World Meteorological Organization Abbreviated Header Lines for meteorological products), and renames the directory tree to a different standard, the evolving one for the WMO WIS 2.0 (for more information on that module: <a class="reference external" href="https://github.com/wmo-im/GTStoWIS2">https://github.com/wmo-im/GTStoWIS2</a>)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>  <span class="kn">from</span> <span class="nn">sarracenia.flowcb</span> <span class="kn">import</span> <span class="n">FlowCB</span>
  <span class="kn">import</span> <span class="nn">logging</span>
  <span class="kn">import</span> <span class="nn">GTStoWIS2</span>

  <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


  <span class="k">class</span> <span class="nc">Wistree</span><span class="p">(</span><span class="n">FlowCB</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;logLevel&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic_builder</span><span class="o">=</span><span class="n">GTStoWIS2</span><span class="o">.</span><span class="n">GTStoWIS2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">options</span>


    <span class="k">def</span> <span class="nf">after_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>

        <span class="n">new_incoming</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>

            <span class="c1"># fix file name suffix.</span>
            <span class="n">type_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_builder</span><span class="o">.</span><span class="n">mapAHLtoExtension</span><span class="p">(</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">tpfx</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subtopic&#39;</span><span class="p">]</span>

            <span class="c1"># input has relpath=/YYYYMMDDTHHMM/... + pubTime</span>
            <span class="c1"># need to move the date from relPath to BaseDir, adding the T hour from pubTime.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_baseSubDir</span><span class="o">=</span><span class="n">tpfx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;pubTime&#39;</span><span class="p">][</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
                <span class="n">t</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpfx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">new_baseSubDir</span>
                <span class="n">new_baseDir</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">new_baseSubDir</span>
                <span class="n">new_relDir</span> <span class="o">=</span> <span class="s1">&#39;WIS&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_builder</span><span class="o">.</span><span class="n">mapAHLtoTopic</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">])</span>
                <span class="n">new_dir</span> <span class="o">=</span> <span class="n">new_baseDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">new_relDir</span>

                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">][</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">type_suffix</span><span class="p">):]</span> <span class="o">!=</span> <span class="n">type_suffix</span><span class="p">:</span>
                    <span class="n">new_file</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">type_suffix</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_file</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">]</span>

                <span class="n">msg</span><span class="o">.</span><span class="n">updatePaths</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">new_baseDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">new_relDir</span><span class="p">,</span> <span class="n">new_file</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s2">&quot;skipped&quot;</span> <span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
                <span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;_deleteOnPost&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span> <span class="s1">&#39;from_cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;to_clusters&#39;</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">new_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="o">=</span><span class="n">new_incoming</span>


</pre></div>
</div>
</div>
</section>
<section id="Plugins-That-Change-How-a-File-is-Downloaded">
<h2>Plugins That Change How a File is Downloaded<a class="headerlink" href="#Plugins-That-Change-How-a-File-is-Downloaded" title="Link to this heading"></a></h2>
<p>The <em>after_accept</em> routine is one of the two most common ones in use. It is used to change processing prior to a file being downloaded or sent. To process the file after it has been downloaded, the <em>after_work</em> entry point is used to process the worklist.ok (files that were successfully downloaded) list.</p>
<p>The after_accept routine has an outer loop that cycles through the entire list of incoming messages. It builds a new list of incoming messages from the ones it accepts, while appending all the rejected ones to <em>worklist.failed.</em> The list is just a list of messages, where each message is a python dictionary with all the fields stored in a v03 format message. In the message there are, for example, <em>baseURL</em> and <em>relPath</em> fields:</p>
<ul class="simple">
<li><p>baseURL - the baseURL of the resource from which a file would be obtained.</p></li>
<li><p>relPath - the relative path to append to the baseURL to get the complete download URL.</p></li>
</ul>
<p>This is happenning before transfer (download or sent, or processing) of the file has occurred, so one can change the behaviour by modifying fields in the message. Normally, the download paths (called new_dir, and new_file) will reflect the intent to mirror the original source tree. so if you have <em>a/b/c.txt</em> on the source tree, and are downloading in to directory <em>mine</em> on the local system, the new_dir would be <em>mine/a/b</em> and new_file would be <em>c.txt</em>.</p>
</section>
<section id="Plugins-that-Process-a-file-after-it-is-Downloaded">
<h2>Plugins that Process a file after it is Downloaded<a class="headerlink" href="#Plugins-that-Process-a-file-after-it-is-Downloaded" title="Link to this heading"></a></h2>
<p>A common use case is for plugins with an <em>after_work</em> entry point to read the file after it is downloaded and transform it into some derived product with a different name. So the new file is created as in the previous section. The message for the downloaded file still needs to be moved onto a list to ensure that it is acknowledged to the broker. Such an entry point would look like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span>    <span class="k">def</span> <span class="nf">after_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>

        <span class="n">new_ok</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
             <span class="n">success</span><span class="o">=</span><span class="n">do_something</span><span class="p">()</span>
             <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                   <span class="n">new_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
             <span class="c1"># since it is already acknowledged, we can just drop it from ok.</span>


        <span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="n">new_ok</span>
        <span class="c1"># the messages on worklist.ok will get posted in the next algorithm phase.</span>
</pre></div>
</div>
</div>
</section>
<section id="Plugins-that-Rename-Files">
<h2>Plugins that Rename Files<a class="headerlink" href="#Plugins-that-Rename-Files" title="Link to this heading"></a></h2>
<p>The plugin above changes the layout of the files that are to be downloaded, based on the <a class="reference external" href="https://github.com/wmo-im/GTStoWIS">GTStoWIS</a> class, which prescribes a different directory tree on output. There are a lot of fields to update when changing file placement, so best to use:</p>
<p>msg.updatePaths( self.o, new_dir, new_file )</p>
<p>to update all necessary fields in the message properly. It will update ‘new_baseURL’, ‘new_relPath’, ‘new_subtopic’ for use when posting.</p>
<p>The try/except part of the routine deals with the case that, should a file arrive with a name from which a topic tree cannot be built, then a python exception may occur, and the message is added to the failed worklist, and will not be processed by later plugins.</p>
</section>
<section id="Plugins-That-Create-New-Files">
<h2>Plugins That Create New Files<a class="headerlink" href="#Plugins-That-Create-New-Files" title="Link to this heading"></a></h2>
<p>The routine above is perfect when a file is just renamed. If a plugin needs to create new files only vaguely derived from the input file, then you want to create new messages for these files from scratch:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>import sarracenia

m = sarracenia.Message.fromFileData(sample_fileName, self.o, os.stat(sample_fileName) )
</pre></div>
</div>
<p>The msg_fromFileData routine will use self.o to apply the appropriate posting settings. no knowledge of message formats, or construction of fields is needed. If the file is not local, such as when writing a poll callback, an alternate routing can be used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>m = sarracenia.Message.fromFileInfo(sample_fileName, self.o, fake_stat_info )
</pre></div>
</div>
<p>the fake stat record (as per the stat(2) man page or python os.stat() ) can be built from other fields, starting with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>import paramiko

fake_stat = paramiko.SFTPAttributes()
fake_stat.st_mtime = ... something else... perhaps an http header?
fake_stat.st_size = ... again will vary by context.
</pre></div>
</div>
<p>Either way, once you have the message, it can be appended to the incoming list.</p>
</section>
<section id="Other-Examples">
<h2>Other Examples<a class="headerlink" href="#Other-Examples" title="Link to this heading"></a></h2>
<p>Subclassing of <a class="reference external" href="../Reference/flowcb.html">Sarracenia.flowcb</a> is used internally to do a lot of core work. It’s a good idea to look at the sarracenia source code itself. For example:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/MetPX/Sarracenia/blob/development/sarracenia/flowcb/__init__.py">sarracenia.flowcb</a> have a look at the <strong>init</strong>.py file in there, which provides this information on a more programmatically succinct format.</p></li>
<li><p><a class="reference external" href="https://github.com/MetPX/Sarracenia/blob/development/sarracenia/flowcb/gather/file.py">sarracenia.flowcb.gather.file</a> is a class that implements file posting and directory watching, in the sense of a callback that implements the <em>gather</em> entry point, by reading a file system and building a list of messages for processing.</p></li>
<li><p><a class="reference external" href="https://github.com/MetPX/Sarracenia/blob/development/sarracenia/flowcb/gather/message.py">sarracenia.flowcb.gather.message</a> is a class that implements reception of messages from message queue protocol flows.</p></li>
<li><p><a class="reference external" href="https://github.com/MetPX/Sarracenia/blob/development/sarracenia/flowcb/nodupe">sarracenia.flowcb.gather.nodupe</a> This modules removes duplicates from message flows based on Identity checksums.</p></li>
<li><p><a class="reference external" href="https://github.com/MetPX/Sarracenia/blob/development/sarracenia/flowcb/post/message.py">sarracenia.flowcb.post.message</a> is a class that implements posting messages to Message queue protocol flows</p></li>
<li><p><a class="reference external" href="https://github.com/MetPX/Sarracenia/blob/development/sarracenia/flowcb/retry.py">sarracenia.flowcb.retry</a> when the transfer of a file fails. Sarracenia needs to persist the relevant message to a state file for a later time when it can be tried again.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="1_CLI_introduction.html" class="btn btn-neutral float-left" title="Downloading Using the Command Line" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="3_api_flow_demo.html" class="btn btn-neutral float-right" title="flow API Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>