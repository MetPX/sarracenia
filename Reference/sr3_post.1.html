<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sr3_Post &mdash; Sarracenia 3.00.54rc1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="../_static/sarra_horror_culture_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=99fb584f"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SR_CPUMP" href="sr3_cpump.1.html" />
    <link rel="prev" title="SR3" href="sr3.1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sarracenia
              <img src="../_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.00.54rc1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../How2Guides/index.html">HOWTOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="sr3_options.7.html">SR3 OPTIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr3_credentials.7.html">SR3 CREDENTIALS</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr3.1.html">SR3</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">sr3_post CLI poster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#publish-the-availability-of-files">Publish the Availability of Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#synopsis">SYNOPSIS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#description">DESCRIPTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arguments-and-options">ARGUMENTS AND OPTIONS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shim-library-usage">SHIM LIBRARY USAGE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#environment-variables">ENVIRONMENT VARIABLES</a></li>
<li class="toctree-l4"><a class="reference internal" href="#see-also">SEE ALSO</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sr3_cpump.1.html">Sr3_cpump C Manual Page</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr_post.7.html">Posting Message Format Man page</a></li>
<li class="toctree-l2"><a class="reference internal" href="flowcb.html">FlowCallback Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="code.html">Code Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fr/index.html">En français</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Reference</a></li>
      <li class="breadcrumb-item active">Sr3_Post</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Reference/sr3_post.1.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sr3-post">
<h1>Sr3_Post<a class="headerlink" href="#sr3-post" title="Link to this heading"></a></h1>
<section id="publish-the-availability-of-files">
<h2>Publish the Availability of Files<a class="headerlink" href="#publish-the-availability-of-files" title="Link to this heading"></a></h2>
<dl class="field-list simple">
<dt class="field-odd">Manual section<span class="colon">:</span></dt>
<dd class="field-odd"><p>1</p>
</dd>
<dt class="field-even">Date<span class="colon">:</span></dt>
<dd class="field-even"><p>Jun 13, 2024</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>3.00.54rc1</p>
</dd>
<dt class="field-even">Manual group<span class="colon">:</span></dt>
<dd class="field-even"><p>MetPx Sarracenia Suite</p>
</dd>
</dl>
<section id="synopsis">
<h3>SYNOPSIS<a class="headerlink" href="#synopsis" title="Link to this heading"></a></h3>
<p><strong>sr3_post|sr3_cpost</strong> [ <em>OPTIONS</em> ][ <em>-pb|–post_broker broker</em> ][ <em>-pbu|–post_baseUrl url[,url]…*</em> ]
[ <em>-p|–path ] path1 path2…pathN</em> ]</p>
<p>( also <strong>libsrshim.so</strong> )</p>
</section>
<section id="description">
<h3>DESCRIPTION<a class="headerlink" href="#description" title="Link to this heading"></a></h3>
<p><strong>sr3_post</strong> posts the availability of a file by creating an notification message.
In contrast to most other sarracenia components that act as daemons,
sr3_post is a one shot invocation which posts and exits.
To make files
available to subscribers, <strong>sr3_post</strong> sends the notification messages
to an AMQP server, also called a broker.</p>
<p>This manual page is primarily concerned with the python implementation,
but there is also an implementation in C, which works nearly identically.
Differences:</p>
<blockquote>
<div><ul class="simple">
<li><p>plugins are not supported in the C implementation.</p></li>
<li><p>C implementation uses POSIX regular expressions, python3 grammar is slightly different.</p></li>
<li><p>when the <em>sleep</em> option ( used only in the C implementation) is set to &gt; 0,
it transforms sr_cpost into a daemon that works like the <em>watch</em> component
of <a class="reference external" href="sr3.1.html">sr3(1)</a>.</p></li>
</ul>
</div></blockquote>
<section id="mandatory-settings">
<h4>Mandatory Settings<a class="headerlink" href="#mandatory-settings" title="Link to this heading"></a></h4>
<p>The <em>post_base_url url,url,…</em> option specifies the location
subscribers will download the file from.  There is usually one post per file.
Format of argument to the <em>post_base_url</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ftp</span><span class="o">|</span><span class="n">http</span><span class="o">|</span><span class="n">sftp</span><span class="p">]:</span><span class="o">//</span><span class="p">[</span><span class="n">user</span><span class="p">[:</span><span class="n">password</span><span class="p">]</span><span class="o">@</span><span class="p">]</span><span class="n">host</span><span class="p">[:</span><span class="n">port</span><span class="p">]</span><span class="o">/</span>
<span class="ow">or</span>
<span class="n">file</span><span class="p">:</span>
</pre></div>
</div>
<p>When several urls are given as a comma separated list to <em>post_base_url</em>, the
url´s provided are used round-robin style, to provide a coarse form of load balancing.</p>
<p>The [<em>-p|–path path1 path2 .. pathN</em>] option specifies the path of the files
to be announced. There is usually one post per file.
Format of argument to the <em>path</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">absolute_path_to_the</span><span class="o">/</span><span class="n">filename</span>
<span class="ow">or</span>
<span class="n">relative_path_to_the</span><span class="o">/</span><span class="n">filename</span>
</pre></div>
</div>
<p>The <em>-pipe</em> option can be specified to have sr3_post read path names from standard
input as well.</p>
<p>An example invocation of <em>sr3_post</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_post</span> <span class="o">--</span><span class="n">post_broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">post_baseUrl</span> <span class="n">sftp</span><span class="p">:</span><span class="o">//</span><span class="n">stanley</span><span class="nd">@mysftpserver</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">foo</span>
</pre></div>
</div>
<p>By default, sr3_post reads the file /data/shared/products/foo and calculates its checksum.
It then builds a post message, logs into broker.com as user ‘guest’ (default credentials)
and sends the post  to defaults vhost ‘/’ and default exchange. The default exchange
is the prefix <em>xs_</em> followed by the broker username, hence defaulting to ‘xs_guest’.
A subscriber can download the file /data/shared/products/foo by authenticating as user stanley
on mysftpserver.com using the sftp protocol to broker.com assuming he has proper credentials.
The output of the command is as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Published</span> <span class="n">xs_guest</span> <span class="n">v02</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">foo</span> <span class="s1">&#39;20150813161959.854 sftp://stanley@mysftpserver.com/ /data/shared/products/foo&#39;</span> <span class="nb">sum</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="mi">82</span><span class="n">edc8eb735fd99598a1fe04541f558d</span> <span class="n">parts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4574</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
</pre></div>
</div>
<p>In MetPX-Sarracenia, each post is published under a certain topic.
The log line starts with ‘[INFO]’, followed by the <strong>topic</strong> of the
post. Topics in <em>AMQP</em> are fields separated by dot. The complete topic starts with
a topicPrefix (see option), version <em>V02</em>, an action <em>post</em>,
followed by a subtopic (see option) here the default, the file path separated with dots
<em>data.shared.products.foo</em>.</p>
<p>The second field in the log line is the message notice.  It consists of a time
stamp <em>20150813161959.854</em>, and the source URL of the file in the last 2 fields.</p>
<p>The rest of the information is stored in AMQP message headers, consisting of key=value pairs.
The <em>sum=d,82edc8eb735fd99598a1fe04541f558d</em> header gives file fingerprint (or checksum
) information.  Here, <em>d</em> means md5 checksum performed on the data, and <em>82edc8eb735fd99598a1fe04541f558d</em>
is the checksum value. The <em>parts=1,4574,1,0,0</em> state that the file is available in 1 part of 4574 bytes
(the filesize.)  The remaining <em>1,0,0</em> is not used for transfers of files with only one part.</p>
<p>Another example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_post</span> <span class="o">--</span><span class="n">post_broker</span> <span class="n">mqtt</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">post_baseDir</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">public_data</span> <span class="o">--</span><span class="n">postBaseUrl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="o">--</span><span class="n">path</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span><span class="o">/</span><span class="n">SACN32_CWAO_123456</span>
</pre></div>
</div>
<p>By default, sr3_post reads the file /data/web/public_data/bulletins/alphanumeric/SACN32_CWAO_123456
(concatenating the post_base_dir and relative path of the source url to obtain the local file path)
and calculates its checksum. It then builds a post message, logs into broker.com as user ‘guest’
(default credentials) and sends the post to defaults vhost ‘/’ and exchange ‘xs_guest’, resulting
in publication to the MQTT broker under the topic: <em>xs_guest/v03/bulletins/alphanumeric/SACN32_CWAO_123456</em></p>
<p>A subscriber can download the file <a class="reference external" href="http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456">http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456</a> using http
without authentication on dd.weather.gc.ca.</p>
</section>
</section>
<section id="arguments-and-options">
<h3>ARGUMENTS AND OPTIONS<a class="headerlink" href="#arguments-and-options" title="Link to this heading"></a></h3>
<p>Please refer to the <a class="reference external" href="sr3_options.7.html">sr3_options(7)</a> manual page for a detailed description of
all settings, and methods of specifying them.</p>
<section id="path-path1-path2-pathn">
<h4>path path1 path2 … pathN<a class="headerlink" href="#path-path1-path2-pathn" title="Link to this heading"></a></h4>
<blockquote>
<div><p><strong>sr3_post</strong> evaluates the filesystem paths from the <strong>path</strong> option
and possibly the <strong>baseDir</strong> if the option is used.</p>
<p>If a path defines a file, this file is announced.</p>
<p>If a path defines a directory, then all files in that directory are
announced…</p>
</div></blockquote>
</section>
<section id="post-broker-broker">
<h4>post_broker &lt;broker&gt;<a class="headerlink" href="#post-broker-broker" title="Link to this heading"></a></h4>
<blockquote>
<div><p>the broker to which the post is sent.</p>
</div></blockquote>
</section>
<section id="post-basedir-path">
<h4>post_baseDir &lt;path&gt;<a class="headerlink" href="#post-basedir-path" title="Link to this heading"></a></h4>
<blockquote>
<div><p>The <em>base_dir</em> option supplies the directory path that,
when combined (or found) in the given <em>path</em>,
gives the local absolute path to the data file to be posted.
The document root part of the local path will be removed from the posted notification message.
For sftp URLs: it can be appropriate to specify a path relative to a user account.
Example of that usage would be:  -dr ~user  -post_base_url sftp:user&#64;host
For file URLs: base_dir is usually not appropriate.  To post an absolute path,
omit the -dr setting, and just specify the complete path as an argument.</p>
</div></blockquote>
</section>
<section id="post-exchange-exchange">
<h4>post_exchange &lt;exchange&gt;<a class="headerlink" href="#post-exchange-exchange" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Sr_post publishes to an exchange named <em>xs_</em>”broker_username” by default.
Use the <em>post_exchange</em> option to override that default.</p>
</div></blockquote>
</section>
<section id="h-help">
<h4>-h|–help<a class="headerlink" href="#h-help" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Display program options.</p>
</div></blockquote>
</section>
<section id="blocksize-value">
<h4>blocksize &lt;value&gt;<a class="headerlink" href="#blocksize-value" title="Link to this heading"></a></h4>
<p><strong>Not currently useful, will re-instate post v3</strong></p>
<p>This option controls the partitioning strategy used to post files.
The value should be one of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">-</span> <span class="n">autocompute</span> <span class="n">an</span> <span class="n">appropriate</span> <span class="n">partitioning</span> <span class="n">strategy</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="mi">1</span> <span class="o">-</span> <span class="n">always</span> <span class="n">send</span> <span class="n">entire</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">single</span> <span class="n">part</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">blocksize</span><span class="o">&gt;</span> <span class="o">-</span> <span class="n">used</span> <span class="n">a</span> <span class="n">fixed</span> <span class="n">partition</span> <span class="n">size</span> <span class="p">(</span><span class="n">example</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span><span class="n">M</span> <span class="p">)</span>
</pre></div>
</div>
<p>Files can be announced as multiple parts.  Each part has a separate checksum.
The parts and their checksums are stored in the cache. Partitions can traverse
the network separately, and in parallel.  When files change, transfers are
optimized by only sending parts which have changed.</p>
<p>The value of the <em>blocksize</em>  is an integer that may be followed by  letter designator <em>[B|K|M|G|T]</em> meaning:
for Bytes, Kilobytes, Megabytes, Gigabytes, Terabytes respectively.  All these references are powers of 2.
Files bigger than this value will get announced with <em>blocksize</em> sized parts.</p>
<p>The autocomputation algorithm determines a blocksize that encourages a reasonable number of parts
for files of various sizes.  As the file size varies, the automatic computation will give different
results.  This will result in resending information which has not changed as partitions of a different
size will have different sums, and therefore be tagged as different.</p>
<p>By default, <strong>sr3_post</strong> computes a reasonable blocksize that depends on the file size.
The user can set a fixed <em>blocksize</em> if it is better for its products or if he wants to
take advantage of the <strong>cache</strong> mechanism.  In cases where large files are being appended to, for example,
it make sense to specify a fixed partition size so that the blocks in the cache will be the
same blocks as those generated when the file is larger, and so avoid re-transmission.  So use
of ‘10M’ would make sense in that case.</p>
<p>In cases where a custom downloader is used which does not understand partitioning, it is necessary
to avoid having the file split into parts, so one would specify ‘1’ to force all files to be sent
as a single part.</p>
</section>
<section id="post-baseurl-url">
<h4>post_baseUrl &lt;url&gt;<a class="headerlink" href="#post-baseurl-url" title="Link to this heading"></a></h4>
<p>The <strong>url</strong> option sets the protocol, credentials, host and port under
which the product can be fetched.</p>
<p>The AMQP announcememet is made of the three fields, the notification message time,
this <strong>url</strong> value and the given <strong>path</strong> to which was withdrawn from the <em>base_dir</em>
if necessary.</p>
<p>The concatenation of the two last fields of the notification message defines
what the subscribers will use to download the product.</p>
</section>
<section id="reset">
<h4>reset<a class="headerlink" href="#reset" title="Link to this heading"></a></h4>
<p>When one has used <strong>–suppress_duplicates|–cache</strong>, this option empties the cache.</p>
</section>
<section id="rename-path">
<h4>rename &lt;path&gt;<a class="headerlink" href="#rename-path" title="Link to this heading"></a></h4>
<p>With the <em>rename</em>  option, the user can suggest a destination path to its files. If the given
path ends with ‘/’ it suggests a directory path…  If it doesn’t, the option specifies a file renaming.</p>
<p><em>sr3_post</em>, and <em>sr_watch</em> use a file based model based on a process and a disk cache,
whose design is single threaded. The shim library is typically used by many processes
at once, and would have resource contention and/or corruption issues with the cache.
The shim library therefore has a purely memory-based cache, tunable with
the following shim_ options.</p>
</section>
<section id="shim-defer-posting-to-exit-experimental">
<h4>shim_defer_posting_to_exit EXPERIMENTAL<a class="headerlink" href="#shim-defer-posting-to-exit-experimental" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Postpones file posting until the process exits.
In cases where the same file is repeatedly opened and appended to, this
setting can avoid redundant notification messages.  (default: False)</p>
</div></blockquote>
</section>
<section id="shim-post-minterval-interval-experimental">
<h4>shim_post_minterval <em>interval</em> EXPERIMENTAL<a class="headerlink" href="#shim-post-minterval-interval-experimental" title="Link to this heading"></a></h4>
<blockquote>
<div><p>If a file is opened for writing and closed multiple times within the interval,
it will only be posted once. When a file is written to many times, particularly
in a shell script, it makes for many notification messages, and shell script affects performance.
subscribers will not be able to make copies quickly enough in any event, so
there is little benefit, in say, 100 notification messages of the same file in the same second.
It is wise set an upper limit on the frequency of posting a given file. (default: 5s)
Note: if a file is still open, or has been closed after its previous post, then
during process exit processing it will be posted again, even if the interval
is not respected, in order to provide the most accurate final post.</p>
</div></blockquote>
</section>
<section id="shim-skip-parent-open-files-experimental">
<h4>shim_skip_parent_open_files EXPERIMENTAL<a class="headerlink" href="#shim-skip-parent-open-files-experimental" title="Link to this heading"></a></h4>
<blockquote>
<div><p>The shim_skip_ppid_open_files option means that a process checks
whether the parent process has the same file open, and does not
post if that is the case. (default: True)</p>
</div></blockquote>
</section>
<section id="sleep-time">
<h4>sleep <em>time</em><a class="headerlink" href="#sleep-time" title="Link to this heading"></a></h4>
<blockquote>
<div><p><strong>This option is only available in the c implementation (sr_cpost)</strong></p>
<p>When the option is set, it transforms cpost into a sr_watch, with <em>sleep</em> being the time to wait between
generating events.  When files are written frequently, it is counter productive to produce a post for
every change, as it can produce a continuous stream of changes where the transfers cannot be done quickly
enough to keep up.  In such circumstances, one can group all changes made to a file
in <em>sleep</em> time, and produce a single post.</p>
<dl class="simple">
<dt>NOTE::</dt><dd><p>in sr_cpost, when combined with force_polling (see <a class="reference external" href="sr3.1.html#watch">sr_watch(1)</a> ) the sleep
interval should not be less than about five seconds, as it may miss posting some files.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="subtopic-key">
<h4>subtopic &lt;key&gt;<a class="headerlink" href="#subtopic-key" title="Link to this heading"></a></h4>
<blockquote>
<div><p>The subtopic default can be overwritten with the <em>subtopic</em> option.</p>
</div></blockquote>
</section>
<section id="nodupe-ttl-on-off-999">
<h4>nodupe_ttl on|off|999<a class="headerlink" href="#nodupe-ttl-on-off-999" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Avoid posting duplicates by comparing each file to those seen during the
<em>suppress_duplicates</em> interval. When posting directories, will cause
<em>sr3_post</em> post only files (or parts of files) that were new when invoked again.</p>
<p>Over time, the number of files in the cache can grow too large, and so it is cleaned out of
old entries. The default lifetime of a cache entry is five minutes (300 seconds). This
lifetime can be overridden with a time interval as argument ( the 999 above ).</p>
<p>If duplicate suppression is in use,  one should ensure that a fixed <strong>blocksize</strong> is
used ( set to a value other than 0 ) as otherwise blocksize will vary as files grow,
and much duplicate data transfer will result.</p>
</div></blockquote>
</section>
<section id="identity-method-value">
<h4>identity &lt;method&gt;[,&lt;value&gt;]<a class="headerlink" href="#identity-method-value" title="Link to this heading"></a></h4>
<p>All file notification messages include a checksum. The <em>sum</em> option specifies how to calculate the it.
It is a comma separated string. Valid Identity methods are</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cod</span><span class="p">,</span><span class="n">x</span>      <span class="o">-</span> <span class="n">Calculate</span> <span class="n">On</span> <span class="n">Download</span> <span class="n">applying</span> <span class="n">x</span>
<span class="n">sha512</span>     <span class="o">-</span> <span class="n">do</span> <span class="n">SHA512</span> <span class="n">on</span> <span class="n">file</span> <span class="n">content</span>  <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="n">md5</span>        <span class="o">-</span> <span class="n">do</span> <span class="n">md5sum</span> <span class="n">on</span> <span class="n">file</span> <span class="n">content</span>
<span class="n">random</span>     <span class="o">-</span> <span class="n">invent</span> <span class="n">a</span> <span class="n">random</span> <span class="n">value</span> <span class="k">for</span> <span class="n">each</span> <span class="n">post</span><span class="o">.</span>
<span class="n">arbitrary</span>  <span class="o">-</span> <span class="n">apply</span> <span class="n">the</span> <span class="n">literal</span> <span class="n">fixed</span> <span class="n">value</span><span class="o">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The checksums are stored in extended file attributes (or Alternate Data Streams on Windows).
This is necessary for the <em>arbitrary</em> method to work, since we have no means of calculating it.</p>
</div>
</section>
<section id="topicprefix-key">
<h4>topicPrefix &lt;key&gt;<a class="headerlink" href="#topicprefix-key" title="Link to this heading"></a></h4>
<p><em>Not usually used</em>
By default, the topic is made of the default topicPrefix : version <em>V03</em>
followed by the default subtopic: the file path separated with dots (dot being the topic separator for amqp).
You can overwrite the topicPrefix by setting this option.</p>
</section>
<section id="header-name-value">
<h4>header &lt;name&gt;=&lt;value&gt;<a class="headerlink" href="#header-name-value" title="Link to this heading"></a></h4>
<p>Add a &lt;name&gt; header with the given value to notification messages. Used to pass strings as metadata.</p>
</section>
</section>
<section id="shim-library-usage">
<h3>SHIM LIBRARY USAGE<a class="headerlink" href="#shim-library-usage" title="Link to this heading"></a></h3>
<p>Rather than invoking a sr3_post to post each file to publish, one can have processes automatically
post the files they right by having them use a shim library intercepting certain file i/o calls to libc
and the kernel. To activate the shim library, in the shell environment add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SR_POST_CONFIG</span><span class="o">=</span><span class="n">shimpost</span><span class="o">.</span><span class="n">conf</span>
<span class="n">export</span> <span class="n">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;libsrshim.so.1&quot;</span>
</pre></div>
</div>
<p>where <em>shimpost.conf</em> is an sr_cpost configuration file in
the ~/.config/sarra/post/ directory. An sr_cpost configuration file is the same
as an sr3_post one, except that plugins are not supported.  With the shim
library in place, whenever a file is written, the <em>accept/reject</em> clauses of
the shimpost.conf file are consulted, and if accepted, the file is posted just
as it would be by sr3_post. If using with ssh, where one wants files which are
scp’d to be posted, one needs to include the activation in the .bashrc and pass
it the configuration to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expoert</span> <span class="n">LC_SRSHIM</span><span class="o">=</span><span class="n">shimpost</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Then in the ~/.bashrc on the server running the remote command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if [ &quot;$LC_SRSHIM&quot; ]; then
    export SR_POST_CONFIG=$LC_SRSHIM
    export LD_PRELOAD=&quot;libsrshim.so.1&quot;
fi
</pre></div>
</div>
<p>SSH will only pass environment variables that start with LC_ (locale) so to get it
passed with minimal effort, we use that prefix.</p>
<section id="shim-usage-tips">
<h4>Shim Usage Tips<a class="headerlink" href="#shim-usage-tips" title="Link to this heading"></a></h4>
<p>This method of notification does require some user environment setup.
The user environment needs to the LD_PRELOAD environment variable set
prior to launch of the process. Complications that remain as we have
been testing for two years since the shim library was first implemented:</p>
<ul class="simple">
<li><p>if we want to notice files created by remote scp processes (which create non-login shells)
then the environment hook must be in .bashrc. and using an environment
variable that starts with <em>LC_</em> to have ssh transmit the configuration value without
having to modify sshd configuration in typical linux distributions.
( full discussion: <a class="reference external" href="https://github.com/MetPX/sarrac/issues/66">https://github.com/MetPX/sarrac/issues/66</a> )</p></li>
<li><p>code that has certain weaknesses, such as in FORTRAN a lack of IMPLICIT NONE
<a class="reference external" href="https://github.com/MetPX/sarracenia/issues/69">https://github.com/MetPX/sarracenia/issues/69</a> may crash when the shim library
is introduced. The correction needed in those cases has so far been to correct
the application, and not the library.
( also: <a class="reference external" href="https://github.com/MetPX/sarrac/issues/12">https://github.com/MetPX/sarrac/issues/12</a> )</p></li>
<li><p>codes using the <em>exec</em> call ot <a class="reference external" href="www.tcl.tk">tcl/tk</a>, by default considers any
output to file descriptor 2 (standard error) as an error condition.
these messages can be labelled as INFO, or WARNING priority, but it will
cause the tcl caller to indicate a fatal error has occurred.  Adding
<em>-ignorestderr</em>  to invocations of <em>exec</em> avoids such unwarranted aborts.</p></li>
<li><p>Complex shell scripts can experience an inordinate performance impact.
Since <em>high performance shell scripts</em> is an oxymoron, the best solution,
performance-wise is to re-write the scripts in a more efficient scripting
language such as python  ( <a class="reference external" href="https://github.com/MetPX/sarrac/issues/15">https://github.com/MetPX/sarrac/issues/15</a> )</p></li>
<li><p>Code bases that move large file hierarchies (e.g. <em>mv tree_with_thousands_of_files new_tree</em> )
will see a much higher cost for this operation, as it is implemented as
a renaming of each file in the tree, rather than a single operation on the root.
This is currently considered necessary because the accept/reject pattern matching
may result in a very different tree on the destination, rather than just the
same tree mirrored. See <a class="reference internal" href="#rename-processing">Rename Processing</a> below for details.</p></li>
<li><p><em>export SR_SHIMDEBUG=1</em> will get your more output than you want. use with care.</p></li>
</ul>
</section>
<section id="rename-processing">
<h4>Rename Processing<a class="headerlink" href="#rename-processing" title="Link to this heading"></a></h4>
<p>It should be noted that file renaming is not as simple in the mirroring case as in the underlying
operating system. While the operation is a single atomic one in an operating system, when
using notifications, there are accept/reject cases that create four possible effects.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td></td>
<td colspan="2"><p>old name is:</p></td>
</tr>
<tr class="row-even"><td><p>New name is:</p></td>
<td><p><em>Accepted</em></p></td>
<td><p><em>Rejected</em></p></td>
</tr>
<tr class="row-odd"><td><p><em>Accepted</em></p></td>
<td><p>rename</p></td>
<td><p>copy</p></td>
</tr>
<tr class="row-even"><td><p><em>Rejected</em></p></td>
<td><p>remove</p></td>
<td><p>nothing</p></td>
</tr>
</tbody>
</table>
<p>When a file is moved, two notifications are created:</p>
<ul class="simple">
<li><p>One notification has the new name in the <em>relpath</em>, while containing and <em>oldname</em>
field pointing at the old name.  This will trigger activities in the top half of
the table, either a rename, using the oldname field, or a copy if it is not present
at the destination.</p></li>
<li><p>A second notification with the oldname in <em>relpath</em> which will be accepted
again, but this time it has the <em>newname</em> field, and process the remove action.</p></li>
</ul>
<p>While the renaming of a directory at the root of a large tree is a cheap atomic operation
in Linux/Unix, mirroring that operation requires creating a rename posting for each file
in the tree, and thus is far more expensive.</p>
</section>
</section>
<section id="environment-variables">
<h3>ENVIRONMENT VARIABLES<a class="headerlink" href="#environment-variables" title="Link to this heading"></a></h3>
<p>In the C implementation (sr_cpost), if the SR_CONFIG_EXAMPLES variable is set, then the <em>add</em> directive can be used
to copy examples into the user’s directory for use and/or customization.</p>
<p>An entry in the ~/.config/sarra/default.conf (created via sr_subscribe edit default.conf )
could be used to set the variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">declare</span> <span class="n">env</span> <span class="n">SR_CONFIG_EXAMPLES</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">/</span><span class="n">dist</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">examples</span>
</pre></div>
</div>
<p>the value should be available from the output of a list command from the python
implementation.</p>
</section>
<section id="see-also">
<h3>SEE ALSO<a class="headerlink" href="#see-also" title="Link to this heading"></a></h3>
<p><a class="reference external" href="sr3.1.html">sr3(1)</a> - Sarracenia main command line interface.</p>
<p><a class="reference external" href="sr3_post.1.html">sr3_post(1)</a> - post file notification messages (python implementation.)</p>
<p><a class="reference external" href="sr3_cpost.1.html">sr3_cpost(1)</a> - post file announcemensts (C implementation.)</p>
<p><a class="reference external" href="sr3_cpump.1.html">sr3_cpump(1)</a> - C implementation of the shovel component. (copy messages)</p>
<p><strong>Formats:</strong></p>
<p><a class="reference external" href="sr3_credentials.7.html">sr3_credentials(7)</a> - Convert logfile lines to .save Format for reload/resend.</p>
<p><a class="reference external" href="sr3_options.7.html">sr3_options(7)</a> - the configuration options</p>
<p><a class="reference external" href="sr_post.7.html">sr_post(7)</a> - the format of notification messages.</p>
<p><strong>Home Page:</strong></p>
<p><a class="reference external" href="https://metpx.github.io/sarracenia">https://metpx.github.io/sarracenia</a> - Sarracenia: a real-time pub/sub data sharing management toolkit</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="sr3.1.html" class="btn btn-neutral float-left" title="SR3" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sr3_cpump.1.html" class="btn btn-neutral float-right" title="SR_CPUMP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>