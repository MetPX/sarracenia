

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR_post &mdash; Sarracenia 3.00.56rc2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../_static/sarra_horror_culture_favicon.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8b8faa11"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FlowCallback Reference" href="flowcb.html" />
    <link rel="prev" title="SR_CPUMP" href="sr3_cpump.1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sarracenia
              <img src="../_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../How2Guides/index.html">HOWTOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="sr3_options.7.html">SR3 OPTIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr3_credentials.7.html">SR3 CREDENTIALS</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr3.1.html">SR3</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr3_post.1.html">sr3_post CLI poster</a></li>
<li class="toctree-l2"><a class="reference internal" href="sr3_cpump.1.html">Sr3_cpump C Manual Page</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Posting Message Format Man page</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sarracenia-v03-notification-message-format-protocol">Sarracenia v03 Notification Message Format/Protocol</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#status-stable-default">STATUS: Stable/Default</a></li>
<li class="toctree-l4"><a class="reference internal" href="#synopsis">SYNOPSIS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#description">DESCRIPTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="#topic">TOPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-fixed-headers">THE FIXED HEADERS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#report-messages">Report Messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-headers">Optional Headers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">EXAMPLE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#another-example">Another example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#standards">Standards</a></li>
<li class="toctree-l4"><a class="reference internal" href="#see-also">SEE ALSO</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="flowcb.html">FlowCallback Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="code.html">Code Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fr/index.html">En français</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Reference</a></li>
      <li class="breadcrumb-item active">SR_post</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Reference/sr_post.7.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sr-post">
<h1>SR_post<a class="headerlink" href="#sr-post" title="Link to this heading"></a></h1>
<section id="sarracenia-v03-notification-message-format-protocol">
<h2>Sarracenia v03 Notification Message Format/Protocol<a class="headerlink" href="#sarracenia-v03-notification-message-format-protocol" title="Link to this heading"></a></h2>
<dl class="field-list simple">
<dt class="field-odd">Manual section<span class="colon">:</span></dt>
<dd class="field-odd"><p>7</p>
</dd>
<dt class="field-even">Date<span class="colon">:</span></dt>
<dd class="field-even"><p>Oct 11, 2024</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>3.00.56rc2</p>
</dd>
<dt class="field-even">Manual group<span class="colon">:</span></dt>
<dd class="field-even"><p>MetPX-Sarracenia</p>
</dd>
</dl>
<section id="status-stable-default">
<h3>STATUS: Stable/Default<a class="headerlink" href="#status-stable-default" title="Link to this heading"></a></h3>
<p>Sarracenia version 2 notification messages are the previous standard, used for terabytes
and millions of files per day of transfers. Version 3 is a proposal for a next
iteration of Sarracenia notification messages.</p>
<p>Most fields and their meaning is the same in version 3 as it was in version 2.
Some fields are changing as the protocol is exposed to wider review than previously.</p>
<p>The change in payload protocol is targetted at simplifying future implementations
and enabling use by messaging protocols other than pre-1.0 AMQP.
See <a class="reference external" href="../Explanations/History/messages_v03.html">v03 Changes</a> for more details.</p>
<p>To generate notification messages in v03 format, use following setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">post_topicPrefix</span> <span class="n">v03</span>
</pre></div>
</div>
<p>To select notification messages to consume in that format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">topicPrefix</span> <span class="n">v03</span>
</pre></div>
</div>
</section>
<section id="synopsis">
<h3>SYNOPSIS<a class="headerlink" href="#synopsis" title="Link to this heading"></a></h3>
<p>Version 03 format of file change notification messages for sr_post.</p>
<p>An sr3_post notification message consists of a topic, and the <em>BODY</em></p>
<section id="amqp-topic-version-dir">
<h4><strong>AMQP Topic:</strong> <em>&lt;version&gt;.{&lt;dir&gt;.}</em><a class="headerlink" href="#amqp-topic-version-dir" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&quot;v03&quot;</span> <span class="n">the</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">protocol</span> <span class="ow">or</span> <span class="nb">format</span><span class="o">.</span>
<span class="s2">&quot;post&quot;</span> <span class="o">=</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">notification</span> <span class="n">message</span> <span class="n">within</span> <span class="n">the</span> <span class="n">protocol</span><span class="o">.</span>
<span class="o">&lt;</span><span class="nb">dir</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">a</span> <span class="n">sub</span><span class="o">-</span><span class="n">directory</span> <span class="n">leading</span> <span class="n">to</span> <span class="n">the</span> <span class="n">file</span> <span class="p">(</span><span class="n">perhaps</span> <span class="n">many</span> <span class="n">directories</span> <span class="n">deep</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="body-headers-json-encoding">
<h4><strong>BODY:</strong> <em>{ &lt;headers&gt; }</em> (JSON encoding.)<a class="headerlink" href="#body-headers-json-encoding" title="Link to this heading"></a></h4>
<p>The headers are an array of name:value pairs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>MANDATORY:

        &quot;pubTime&quot;       - YYYYMMDDTHHMMSS.ss - UTC date/timestamp.
        &quot;baseUrl&quot;       - root of the url to download.
        &quot;relPath&quot;       - relative path can be catenated to &lt;base_url&gt;

   one of:

        &quot;identity&quot;     - for changes in file contents, an identifier for de-duplication purposes.
        {
           &quot;method&quot; : &quot;md5&quot; | &quot;sha512&quot; | &quot;cod&quot; | &quot;random&quot; ,
           &quot;value&quot;  : &quot;base64 encoded checksum value&quot;
        }
  or:
        &quot;fileOp&quot;   - to describe non-data file update operations.
        {
           &quot;link&quot; : &quot;symbolic link value (target) string&quot;
           &quot;remove&quot; : &quot;&quot;     - flag present when removing a file (argument ignored.)
           &quot;hlink&quot; : &quot;hardlink value string (file being linked to.)&quot;
           &quot;rename&quot; : &quot;name of file before rename.&quot;
           &quot;directory&quot;: &quot;&quot;  - flag presend for directory creation and remove events.
        }
  or:
       nothing... If neither of these is present, then duplication
       suppression will rely on supplied meta data, such as the modification
       time, the size, and the publication Time to prevent loops.
       It is strongly recommended that all data services provide identity
       checksums. Failure to do so results in a data service than cannot
       be reliably replicated.

  both may be present in cases where file content is being updated, as
  well as metadata.

OPTIONAL:

        for GeoJSON compatibility:

        &quot;type&quot;: &quot;Feature&quot;,
        &quot;geometry&quot;: RFC 7946 (geoJSON) compatible geographic specification.

        &quot;size&quot;          - the number of bytes being advertised.
        &quot;blocks&quot;        - if the file being advertised is partitioned, then:
        {
            &quot;method&quot;    : &quot;inplace&quot; | &quot;partitioned&quot; , - is the file already in parts?
            &quot;size&quot;      : &quot;9999&quot;, - nominal number of bytes in each block.
            &quot;number&quot;    : &quot;9999&quot;, - which block is this.
            &quot;manifest&quot;   - metadata for each block in the file.
            {
                0: {                 - size and checksum of each block in the file.
                    &quot;size&quot;: 9999,    - may not match blocksize (e.g. last block of file.)
                    &quot;identity&quot;: encoded checksum of block (same format as identity value)
                },
                .
                .
                .
            }
        }
        &quot;atime&quot; : date string - last access time of a file (optional)
        &quot;mtime&quot; : date string - last modification time of a file (optional)
        &quot;mode&quot;  : mode string - permission bits (optional)
        &quot;rename&quot;        - name to write file locally.
        &quot;retrievePath&quot;       - relative retrieval path can be catenated to &lt;base_url&gt; to override relPath
                          used for API cases.
        &quot;topic&quot;         - copy of topic from AMQP header (in the envelope in protocol messages)
        &quot;source&quot;        - the originating entity of the notification message.
        &quot;from_cluster&quot;  - the originating cluster of a notification message.
        &quot;to_clusters&quot;   - a destination specification.

        &quot;content&quot;       - for smaller files, the content may be embedded.
        {
            &quot;encoding&quot; : &quot;utf-8&quot; | &quot;base64&quot; | &quot;iso-8859-1&quot; ,
            &quot;value&quot;    &quot; &quot;encoded file content&quot;
        }
        Note that the iso-8859-1 encoding is only an allowance for legacy data flows.
        Should normally not be used.

        &quot;contentType&quot; : &quot;string&quot; - MIME-type information referring to the data.

        For &quot;v03.report&quot; topic notification messages the following addtional
        headers will be present:

        &quot;report&quot; { &quot;code&quot;: 999  - HTTP style response code.
                   &quot;timeCompleted&quot;: &quot;YYYYMMDDTHHMMSS.ss&quot; - UTC date/timestamp.
                   &quot;message&quot; :  - status report message documented in `Report Messages`_
                 }

        additional user defined name:value pairs are permitted.
</pre></div>
</div>
<dl class="simple">
<dt>NOTE:</dt><dd><p>The <strong>parts</strong> header has not yet been reviewed by others. We started on the discussion of <em>size</em>,
but there was no conclusion.</p>
</dd>
</dl>
</section>
</section>
<section id="description">
<h3>DESCRIPTION<a class="headerlink" href="#description" title="Link to this heading"></a></h3>
<p>Sources create notification messages in the <em>sr_post</em> format to announce file changes. Subscribers
read the post to decide whether a download of the content being announced is warranted.  This
manual page completely describes the format of those notification messages.  The notification messages are payloads
for an Advanced Message Queuing Protocol (AMQP) message bus, but file data transport
is separate, using more common protocols such as SFTP, HTTP, HTTPS, or FTP (or other?).
Files are transported as pure byte streams, no metadata beyond the file contents is
transported (permission bits, extended attributes, etc…). Permissions of files
on the destination system are upto the receiver to decide.</p>
<p>With this method, AMQP messages provide a ‘control plane’ for data transfers.  While each notification message
is essentially point to point, data pumps can be transitively linked together to make arbitrary
networks.  Each posting is consumed by the next hop in the chain. Each hop re-advertises
(creates a new post for) the data for later hops.  The notification messages flow in the same direction as the
data.  If consumers permit it, report messages also flow through the control path,
but in the opposite direction, allowing sources to know the entire disposition of their
files through a network.</p>
<p>The minimal layer over raw AMQP provides more complete file transfer functionality:</p>
<dl>
<dt>Source Filtering (use of <a class="reference internal" href="#topic">TOPIC</a> exchanges)</dt><dd><p>The notification messages make use of <em>topic exchanges</em> from AMQP, where topics are hierarchies
meant to represent subjects of interest to a consumer. A consumer may upload the
selection criteria to the broker so that only a small subset of postings
are forwarded to the client.  When there are many users interested in only
small subsets of data, the savings in traffic are large.</p>
</dd>
<dt>Fingerprint Winnowing (use of the <a class="reference internal" href="#identity">identity</a> header)</dt><dd><p>Each product has an identity fingerprint and size intended to identify it uniquely,
referred to as a <em>fingerprint</em>. If two files have the same fingerprint, they
are considered equivalent. In cases where multiple sources of equivalent data are
available but downstream consumers would prefer to receive single notification messages
of files, intermediate processes may elect to publish notifications of the first
product with a given fingerprint, and ignore subsequent ones.
Propagating only the first occurrence of a datum received downstream, based on
its fingerprint, is termed: <em>Fingerprint Winnowing</em>.</p>
<p><em>Fingerprint Winnowing</em> is the basis for a robust strategy for high availability: setting up
multiple sources for the same data, consumers accept notification messages from all of them, but only
forwarding the first one received downstream. In normal operation, one source may be faster
than the others, and so the other sources’ files are usually ‘winnowed’. When one source
disappears, the other sources’ data is automatically selected, as the fingerprints
are now <em>fresh</em> and used, until a faster source becomes available.</p>
<p>The advantage of this method for high availability is that no A/B decision is required.
The time to <em>switchover</em> is zero. Other strategies are subject to considerable delays
in making the decision to switchover, and pathologies one could summarize as flapping,
and/or deadlocks.</p>
<p><em>Fingerprint Winnowing</em> also permits <em>mesh-like</em>, or <em>any to any</em> networks, where one simply
interconnects a node with others, and notification messages propagate. Their specific path through the
network is not defined, but each participant will download each new datum from the first
node that makes it available to them. Keeping the notification messages small and separate from data
is optimal for this usage.</p>
</dd>
<dt>Partitioning (use of the <a class="reference internal" href="#parts">parts</a> Header)</dt><dd><p>In any store and forward data pumping network that transports entire files limits the maximum
file size to the minimum available on any intervening node. To avoid defining a maximum
file size, a segmentation standard is specified, allowing intervening nodes to hold
only segments of the file, and forward them as they are received, rather than being
forced to hold the entire file.</p>
<p>Partitioning also permits multiple streams to transfer portions of the file in parallel.
Multiple streams can provide an effective optimization over long links.</p>
</dd>
</dl>
</section>
<section id="topic">
<h3>TOPIC<a class="headerlink" href="#topic" title="Link to this heading"></a></h3>
<p>In topic based AMQP exchanges, every notification message has a topic header. AMQP defines the ‘.’ character
as a hierarchical separator (like ‘' in a windows path name, or ‘/’ on linux) there is also a
pair of wildcards defined by the standard:  ‘*’ matches a single topic, ‘#’ matches the rest of
the topic string. To allow for changes in the notification message body in the future, topic trees begin with
the version number of the protocol.</p>
<p>AMQP allows server side topic filtering using wildcards. Subscribers specify topics of
interest (which correspond to directories on the server), allowing them to pare down the
number of notifications sent from server to client.</p>
<p>The root of the topic tree is the version specifier: “v03”.  Next comes the notification message type specifier.
These two fields define the protocol that is in use for the rest of the notification message.
The notification message type for notification messages is “post”.  After the fixed topic prefix,
the remaining sub-topics are the path elements of the file on the web server.
For example, if a file is placed on <a class="reference external" href="http://www.example.com/a/b/c/d/foo.txt">http://www.example.com/a/b/c/d/foo.txt</a>,
then the complete topic of the notification message will be:  <em>v03.a.b.c.d</em>
AMQP fields are limited to 255 characters, and the characters in the field are utf8
encoded, so actual length limit may be less than that.</p>
<p>note:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sarracenia</span> <span class="n">relies</span> <span class="n">on</span> <span class="n">brokers</span> <span class="n">to</span> <span class="n">interpret</span> <span class="n">the</span> <span class="n">topic</span> <span class="n">header</span><span class="o">.</span> <span class="n">Brokers</span> <span class="n">interpret</span> <span class="n">protocol</span>
<span class="n">specific</span> <span class="n">headers</span> <span class="o">*</span><span class="n">AMQP</span><span class="p">),</span> <span class="ow">and</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">efficiently</span> <span class="n">decode</span> <span class="n">the</span> <span class="n">payload</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">headers</span><span class="o">.</span>
<span class="n">Therefore</span> <span class="n">the</span> <span class="n">topic</span> <span class="n">header</span> <span class="ow">is</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">AMQP</span> <span class="n">header</span><span class="p">,</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">the</span> <span class="n">payload</span> <span class="n">to</span> <span class="n">permit</span>
<span class="n">server</span><span class="o">-</span><span class="n">side</span> <span class="n">filtering</span><span class="o">.</span> <span class="n">To</span> <span class="n">avoid</span> <span class="n">sending</span> <span class="n">the</span> <span class="n">same</span> <span class="n">information</span> <span class="n">twice</span><span class="p">,</span> <span class="n">this</span> <span class="n">header</span> <span class="ow">is</span>
<span class="n">omitted</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">JSON</span> <span class="n">payload</span><span class="o">.</span>

<span class="n">Many</span> <span class="n">client</span><span class="o">-</span><span class="n">side</span> <span class="n">implementation</span> <span class="n">will</span><span class="p">,</span> <span class="n">once</span> <span class="n">the</span> <span class="n">notification</span> <span class="n">message</span> <span class="ow">is</span> <span class="n">loaded</span><span class="p">,</span> <span class="nb">set</span> <span class="n">the</span> <span class="o">*</span><span class="n">topic</span><span class="o">*</span> <span class="n">header</span>
<span class="ow">in</span> <span class="n">the</span> <span class="ow">in</span><span class="o">-</span><span class="n">memory</span> <span class="n">structure</span><span class="p">,</span> <span class="n">so</span> <span class="n">it</span> <span class="n">would</span> <span class="n">be</span> <span class="n">very</span> <span class="n">unwise</span> <span class="n">to</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="o">*</span><span class="n">topic</span><span class="o">*</span> <span class="n">header</span>
<span class="ow">in</span> <span class="n">an</span> <span class="n">application</span> <span class="n">even</span> <span class="n">though</span> <span class="n">it</span> <span class="n">isn</span><span class="s1">&#39;t visible in the on-wire payload.</span>
</pre></div>
</div>
<section id="mapping-to-mqtt">
<h4>Mapping to MQTT<a class="headerlink" href="#mapping-to-mqtt" title="Link to this heading"></a></h4>
<p>One goal of v03 format is to have a payload format that works with more than just AMQP.
Message Queing Telemetry Transport (MQTT v3.11) is an iso standard ( <a class="reference external" href="https://www.iso.org/standard/69466.html">https://www.iso.org/standard/69466.html</a>
protocol that can easily support the same pub/sub messaging pattern, but a few details
differ, so a mapping is needed.</p>
<p>Firstly, the topic separate in MQTT is a forward slash (/), instead of the period (.) used in AMQP.</p>
<p>Second, with AMQP, one can establish separate topic hierarchies using <em>topic-based exchanges</em>.
MQTT has no similar concept, there is simply one hierarchy, so when mapping, place the exchange
name at the root of the topic hierarchy to achieve the same effect:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AMQP</span><span class="p">:</span>   <span class="n">Exchange</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">exchange</span> <span class="n">name</span><span class="o">&gt;</span>
           <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.&lt;</span><span class="n">directory</span><span class="o">&gt;...</span>

<span class="n">MQTT</span><span class="p">:</span>   <span class="n">topic</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">exchange</span> <span class="n">name</span><span class="o">&gt;/</span><span class="n">v03</span><span class="o">/&lt;</span><span class="n">directory</span><span class="o">&gt;...</span>
</pre></div>
</div>
</section>
</section>
<section id="the-fixed-headers">
<h3>THE FIXED HEADERS<a class="headerlink" href="#the-fixed-headers" title="Link to this heading"></a></h3>
<p>The notification message is a single JSON encoded array, with a mandatory set of fields, while allowing
for use of arbitrary other fields.  Mandatory fields must be present in every notification message, and</p>
<blockquote>
<div><ul class="simple">
<li><p>“pubTime” : “<em>&lt;date stamp&gt;</em>” : the publication date the posting was emitted.  Format: YYYYMMDDTHHMMSS. <em>&lt;decimalseconds&gt;</em></p></li>
</ul>
<p>Note: The datestamp is always in the UTC timezone.</p>
<ul class="simple">
<li><p>“baseUrl” : “&lt;<em>base_url</em>&gt;” – the base URL used to retrieve the data.</p></li>
<li><p>“relPath” : “&lt;<em>relativepath</em>&gt;” –  the variable part of the URL, usually appended to <em>baseUrl</em>.</p></li>
</ul>
</div></blockquote>
<p>The URL consumers will use to download the data. Example of a complete URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sftp</span><span class="p">:</span><span class="o">//</span><span class="n">afsiext</span><span class="nd">@cmcdataserver</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">NRPDS</span><span class="o">/</span><span class="n">outputs</span><span class="o">/</span><span class="n">NRPDS_HiRes_000</span><span class="o">.</span><span class="n">gif</span>
</pre></div>
</div>
<p>Additional fields:</p>
<section id="from-cluster-cluster-name">
<h4><strong>from_cluster=&lt;cluster_name&gt;</strong><a class="headerlink" href="#from-cluster-cluster-name" title="Link to this heading"></a></h4>
<blockquote>
<div><p>The from_cluster header defines the name of the source cluster where the
data was introduced into the network. It is used to return the logs back
to the cluster whenever its products are used.</p>
</div></blockquote>
</section>
<section id="fileop-link-value-of-symbolic-link">
<h4><strong>fileOp { ‘link’: &lt;value of symbolic link&gt;</strong><a class="headerlink" href="#fileop-link-value-of-symbolic-link" title="Link to this heading"></a></h4>
<blockquote>
<div><p>When file to transfer is a symbolic link, the ‘link’ header is created to
contain its value.</p>
</div></blockquote>
</section>
<section id="size-and-blocks">
<h4><strong>size and blocks</strong><a class="headerlink" href="#size-and-blocks" title="Link to this heading"></a></h4>
<blockquote id="parts">
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">sz</span><span class="o">&gt;</span> <span class="p">,</span>

<span class="s2">&quot;blocks&quot;</span> <span class="p">:</span>
<span class="p">{</span>
       <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;inplace&quot;</span> <span class="ow">or</span> <span class="s2">&quot;partitioned&quot;</span><span class="p">,</span>
       <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bsz</span><span class="o">&gt;</span><span class="p">,</span>
       <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">blktot</span><span class="o">&gt;</span><span class="p">,</span>
       <span class="s2">&quot;remainder&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">brem</span><span class="o">&gt;</span><span class="p">,</span>
       <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">bno</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>header indicating the method and parameters for partitioning applied for the file.
Partitioning is used to send a single file as a collection of segments, rather than as
a single entity.  Partitioning is used to accelerate transfers of large data sets by using
multiple streams, and/or to reduce storage use for extremely large files.</p>
<p>When transferring partitioned files, each partition is advertised and potentially transported
independently across a data pumping network.</p>
<blockquote>
<div><p><em>&lt;method&gt;</em></p>
<p>Indicates what partitioning method, if any, was used in transmission.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Method</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>p - partitioned</p></td>
<td><p>File is partitioned, individual part files are created.</p></td>
</tr>
<tr class="row-odd"><td><p>i - inplace</p></td>
<td><p>File is partitioned, but blocks are read from a single file,
rather than parts.</p></td>
</tr>
<tr class="row-even"><td><p>1 - &lt;sizeonly&gt;</p></td>
<td><p>File is in a single part (no partitioning).
in v03, only <em>size</em> header will be present. <em>blocks</em> is omitted</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>analogous to rsync options: –inplace, –partial,</p></li>
</ul>
<p><em>&lt;blocksize in bytes&gt;: bsz</em></p>
</div></blockquote>
<p>The number of bytes in a block.  When using method 1, the size of the block is the size of the file.
Remaining fields only useful for partitioned files.</p>
<blockquote>
<div><p><em>&lt;blocks in total&gt;: blktot</em>
the integer total number of blocks in the file (last block may be partial)</p>
<p><em>&lt;remainder&gt;: brem</em>
normally 0, on the last block, remaining bytes in the file
to transfer.</p>
<blockquote>
<div><dl class="simple">
<dt>– if (fzb=1 and brem=0)</dt><dd><p>then bsz=fsz in bytes in bytes.
– entire files replaced.
– this is the same as rsync’s –whole-file mode.</p>
</dd>
</dl>
</div></blockquote>
<p><em>&lt;block#&gt;: bno</em>
0 origin, the block number covered by this posting.</p>
</div></blockquote>
</section>
<section id="rename-relpath">
<h4><strong>rename=&lt;relpath&gt;</strong><a class="headerlink" href="#rename-relpath" title="Link to this heading"></a></h4>
<blockquote>
<div><p>The relative path from the current directory in which to place the file.</p>
</div></blockquote>
</section>
<section id="fileop-rename-path">
<h4><strong>fileOp { ‘rename’:&lt;path&gt; … }</strong><a class="headerlink" href="#fileop-rename-path" title="Link to this heading"></a></h4>
<blockquote>
<div><p>when a file is renamed at the source, to send it to subscribers, two notification messages
result: one notification message is announced with the new name as the base_url,
and the oldname header set to the previous file name.
Another notification message is sent with the old name as the src path, and the <em>newname</em>
as a header.  This ensures that <em>accept/reject</em> clauses are correctly
interpreted, as a <em>rename</em> may result in a download if the former name
matches a <em>reject</em>  clause, or a file removal if the new name
matches a <em>reject</em> clause.</p>
<p>Hard links are also handled as an ordinary post of the file with a <em>hlink</em>
header set.</p>
<p>Note that directories and links can be renamed not just regular files. The fileOp field
will have ‘rename’ and ‘link’ or ‘directory’ elements in that case.</p>
</div></blockquote>
</section>
<section id="identity">
<h4><strong>identity</strong><a class="headerlink" href="#identity" title="Link to this heading"></a></h4>
<p>The identity field gives a checksum useful for identifying the contents
of a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;identity&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;method&quot;</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">method</span><span class="o">&gt;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The identity field is a signature computed to allow receivers to determine
if they have already downloaded the product from elsewhere.</p>
<blockquote>
<div><blockquote>
<div><p><em>&lt;method&gt;</em> - string field indicating the checksum method used.</p>
</div></blockquote>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Method</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>random</p></td>
<td><p>No checksums (unconditional copy.) Skips reading file (faster)</p></td>
</tr>
<tr class="row-odd"><td><p>arbitrary</p></td>
<td><p>arbitrary, application defined value which cannot be calculated</p></td>
</tr>
<tr class="row-even"><td><p>md5</p></td>
<td><p>Checksum the entire data (MD-5 as per IETF RFC 1321)</p></td>
</tr>
<tr class="row-odd"><td><p>sha512</p></td>
<td><p>Checksum the entire data (SHA512 as per IETF RFC 6234)</p></td>
</tr>
<tr class="row-even"><td><p>cod</p></td>
<td><p>Checksum on download, with algorithm as argument
Example:  cod,sha512 means download, applying SHA512 checksum, and
advertise with that calculated checksum when propagating further.</p></td>
</tr>
<tr class="row-odd"><td><p><em>&lt;name&gt;</em></p></td>
<td><p>Checksum with some other algorithm, named <em>&lt;name&gt;</em>
<em>&lt;name&gt;</em> should be <em>registered</em> in the data pumping network.
Registered means that all downstream subscribers can obtain the
algorithm to validate the checksum.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<dl class="simple">
<dt><em>&lt;value&gt;</em> The value is computed by applying the given method to the partition being transferred.</dt><dd><p>for algorithms for which no value makes sense, a random integer is generated to support
checksum based load balancing.</p>
</dd>
</dl>
</section>
</section>
<section id="report-messages">
<h3>Report Messages<a class="headerlink" href="#report-messages" title="Link to this heading"></a></h3>
<p>Some clients may return telemetry to the origin of downloaded data for troubleshooting
and statistical purposes. Such notification messages, have the <em>v03.report</em> topic, and have a <em>report</em>
header which is a JSON <em>object</em> with four fields:</p>
<blockquote>
<div><p>{ “elapsedTime”: &lt;report_time&gt;, “resultCode”: &lt;report_code&gt;, “host”: &lt;report_host&gt;, “user”: &lt;report_user&gt;* }</p>
<ul class="simple">
<li><p><em>&lt;report_code&gt;</em>  result codes describe in the next session</p></li>
<li><p><em>&lt;report_time&gt;</em>  time the report was generated.</p></li>
<li><p><em>&lt;report_host&gt;</em>  hostname from which the retrieval was initiated.</p></li>
<li><p><em>&lt;report_user&gt;</em>  broker username from which the retrieval was initiated.</p></li>
</ul>
</div></blockquote>
<p>Report messages should never include the <em>content</em> header (no file embedding in reports.)</p>
<section id="report-code">
<h4>Report_Code<a class="headerlink" href="#report-code" title="Link to this heading"></a></h4>
<p>The report code is a three digit status code, adopted from the HTTP protocol (w3.org/IETF RFC 2616)
encoded as text.  As per the RFC, any code returned should be interpreted as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>2xx indicates successful completion,</p></li>
<li><p>3xx indicates further action is required to complete the operation.</p></li>
<li><p>4xx indicates a permanent error on the client prevented a successful operation.</p></li>
<li><p>5xx indicates a problem on the server prevented successful operation.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FIXME: need to validate whether our use of error codes co-incides with the general intent
expressed above… does a 3xx mean we expect the client to do something? does 5xx mean
that the failure was on the broker/server side?</p>
</div>
<p>The specific error codes returned, and their meanings are implementation-dependent.
For the sarracenia implementation, the following codes are defined:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Corresponding text and meaning for sarracenia implementation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>201</p></td>
<td><p>Download successful. (variations: Downloaded, Inserted, Published, Copied, or Linked)</p></td>
</tr>
<tr class="row-odd"><td><p>203</p></td>
<td><p>Non-Authoritative Information: transformed during download.</p></td>
</tr>
<tr class="row-even"><td><p>205</p></td>
<td><p>Reset Content: truncated. File is shorter than originally expected (changed length
during transfer) This only arises during multi-part transfers.</p></td>
</tr>
<tr class="row-odd"><td><p>205</p></td>
<td><p>Reset Content: checksum recalculated on receipt.</p></td>
</tr>
<tr class="row-even"><td><p>304</p></td>
<td><p>Not modified (Checksum validated, unchanged, so no download resulted.)</p></td>
</tr>
<tr class="row-odd"><td><p>307</p></td>
<td><p>Insertion deferred (writing to temporary part file for the moment.)</p></td>
</tr>
<tr class="row-even"><td><p>417</p></td>
<td><p>Expectation Failed: invalid message (corrupt headers)</p></td>
</tr>
<tr class="row-odd"><td><p>496</p></td>
<td><p>failure: During send, other protocol failure.</p></td>
</tr>
<tr class="row-even"><td><p>497</p></td>
<td><p>failure: During send, other protocol failure.</p></td>
</tr>
<tr class="row-odd"><td><p>499</p></td>
<td><p>Failure: Not Copied. SFTP/FTP/HTTP download problem</p></td>
</tr>
<tr class="row-even"><td><p>499</p></td>
<td><p>Failure: Not Copied. SFTP/FTP/HTTP download problem</p></td>
</tr>
<tr class="row-odd"><td><p>503</p></td>
<td><p>Service unavailable. delete (File removal not currently supported.)</p></td>
</tr>
<tr class="row-even"><td><p>503</p></td>
<td><p>Unable to process: Service unavailable</p></td>
</tr>
<tr class="row-odd"><td><p>503</p></td>
<td><p>Unsupported transport protocol specified in posting.</p></td>
</tr>
<tr class="row-even"><td><p>xxx</p></td>
<td><p>Message and file validation status codes are script dependent</p></td>
</tr>
</tbody>
</table>
</section>
<section id="other-report-fields">
<h4>Other Report Fields<a class="headerlink" href="#other-report-fields" title="Link to this heading"></a></h4>
<p><em>&lt;report_message&gt;</em> a string.</p>
</section>
</section>
<section id="optional-headers">
<h3>Optional Headers<a class="headerlink" href="#optional-headers" title="Link to this heading"></a></h3>
<p>for the file mirroring use case, additional headers will be present:</p>
<section id="atime-mtime-mode">
<h4><strong>atime,mtime,mode</strong><a class="headerlink" href="#atime-mtime-mode" title="Link to this heading"></a></h4>
<blockquote>
<div><p>man 2 stat - the linux/unix standard file metadata:
access time, modification time, and permission (mode bits)
the times are in the same date format as the pubTime field.
the permission string is four characters intended to be interpreted as
traditional octal linux/unix permissions.</p>
</div></blockquote>
<p><strong>Headers which are unknown to a given broker MUST be forwarded without modification.</strong></p>
<p>Sarracenia provides a mechanism for users to include arbitrary other headers in
notification messages, to amplify metadata for more detailed decision making about downloading data.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;PRINTER&quot;</span> <span class="p">:</span> <span class="s2">&quot;name_of_corporate_printer&quot;</span><span class="p">,</span>

<span class="s2">&quot;GeograpicBoundingBox&quot;</span> <span class="p">:</span>
 <span class="p">{</span>
         <span class="s2">&quot;top_left&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">40.73</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">74.1</span> <span class="p">}</span> <span class="p">,</span>
         <span class="s2">&quot;bottom_right&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">40.01</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">71.12</span> <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>would permit the client to apply more elaborate and precise client side filtering,
and/or processing. Intervening implementation may know nothing about the header,
but they should not be stripped, as some consumers may understand and process them.</p>
</section>
</section>
<section id="example">
<h3>EXAMPLE<a class="headerlink" href="#example" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AMQP</span> <span class="n">TOPIC</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">NRDPS</span><span class="o">.</span><span class="n">GIF</span>
<span class="n">MQTT</span> <span class="n">TOPIC</span><span class="p">:</span> <span class="n">exchange</span><span class="o">/</span><span class="n">v03</span><span class="o">/</span><span class="n">NRDPS</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span>
<span class="n">Body</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;pubTime&quot;</span><span class="p">:</span> <span class="s2">&quot;201506011357.345&quot;</span><span class="p">,</span> <span class="s2">&quot;baseUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;sftp://afsiext@cmcdataserver&quot;</span><span class="p">,</span> <span class="s2">&quot;relPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/NRPDS/outputs/NRDPS_HiRes_000.gif&quot;</span><span class="p">,</span>
   <span class="s2">&quot;rename&quot;</span><span class="p">:</span> <span class="s2">&quot;NRDPS/GIF/&quot;</span><span class="p">,</span> <span class="s2">&quot;parts&quot;</span><span class="p">:</span><span class="s2">&quot;p,457,1,0,0&quot;</span><span class="p">,</span> <span class="s2">&quot;identity&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;md5&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;&lt;md5sum-base64&gt;&quot;</span> <span class="p">},</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ec_cmc&quot;</span> <span class="p">}</span>

       <span class="o">-</span> <span class="n">v03</span> <span class="o">-</span> <span class="n">version</span> <span class="n">of</span> <span class="n">protocol</span>
       <span class="o">-</span> <span class="n">post</span> <span class="o">-</span> <span class="n">indicates</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">notification</span> <span class="n">message</span>
       <span class="o">-</span> <span class="n">version</span> <span class="ow">and</span> <span class="nb">type</span> <span class="n">together</span> <span class="n">determine</span> <span class="nb">format</span> <span class="n">of</span> <span class="n">following</span> <span class="n">topics</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">notification</span> <span class="n">message</span> <span class="n">body</span><span class="o">.</span>

       <span class="o">-</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="mi">457</span>  <span class="p">(</span><span class="o">==</span> <span class="n">file</span> <span class="n">size</span><span class="p">)</span>
       <span class="o">-</span> <span class="n">block</span> <span class="n">count</span> <span class="ow">is</span> <span class="mi">1</span>
       <span class="o">-</span> <span class="n">remainder</span> <span class="ow">is</span> <span class="mf">0.</span>
       <span class="o">-</span> <span class="n">block</span> <span class="n">number</span> <span class="ow">is</span> <span class="mf">0.</span>
       <span class="o">-</span> <span class="n">d</span> <span class="o">-</span> <span class="n">checksum</span> <span class="n">was</span> <span class="n">calculated</span> <span class="n">on</span> <span class="n">the</span> <span class="n">body</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span><span class="o">.</span>
       <span class="o">-</span> <span class="n">complete</span> <span class="n">source</span> <span class="n">URL</span> <span class="n">specified</span> <span class="p">(</span><span class="n">does</span> <span class="ow">not</span> <span class="n">end</span> <span class="ow">in</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
       <span class="o">-</span> <span class="n">relative</span> <span class="n">path</span> <span class="n">specified</span> <span class="k">for</span>

       <span class="n">pull</span> <span class="n">from</span><span class="p">:</span>
               <span class="n">sftp</span><span class="p">:</span><span class="o">//</span><span class="n">afsiext</span><span class="nd">@cmcdataserver</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">NRPDS</span><span class="o">/</span><span class="n">outputs</span><span class="o">/</span><span class="n">NRDPS_HiRes_000</span><span class="o">.</span><span class="n">gif</span>

       <span class="n">complete</span> <span class="n">relative</span> <span class="n">download</span> <span class="n">path</span><span class="p">:</span>
               <span class="n">NRDPS</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">NRDPS_HiRes_000</span><span class="o">.</span><span class="n">gif</span>

               <span class="o">--</span> <span class="n">takes</span> <span class="n">file</span> <span class="n">name</span> <span class="kn">from</span> <span class="nn">base_url.</span>
               <span class="o">--</span> <span class="n">may</span> <span class="n">be</span> <span class="n">modified</span> <span class="n">by</span> <span class="n">validation</span> <span class="n">process</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="another-example">
<h3>Another example<a class="headerlink" href="#another-example" title="Link to this heading"></a></h3>
<p>The post resulting from the following sr3 watch command, noticing creation of the file ‘foo’:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_post</span> <span class="o">--</span><span class="n">sleep</span> <span class="mi">10</span> <span class="o">--</span><span class="n">pbu</span> <span class="n">sftp</span><span class="p">:</span><span class="o">//</span><span class="n">stanley</span><span class="nd">@mysftpserver</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">foo</span> <span class="o">--</span><span class="n">pb</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>Here, <em>sr_watch</em> checks if the file /data/shared/products/foo is modified.
When it happens, <em>sr_watch</em>  reads the file /data/shared/products/foo and calculates its checksum.
It then builds a notification message, logs into broker.com as user ‘guest’ (default credentials)
and sends the post to defaults vhost ‘/’ and exchange ‘sx_guest’ (default exchange).</p>
<p>A subscriber can download the file /data/shared/products/foo  by logging in as user stanley
on mysftpserver.com using the sftp protocol to  broker.com assuming he has proper credentials.</p>
<p>The output of the command is as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AMQP</span> <span class="n">Topic</span><span class="p">:</span> <span class="n">v03</span><span class="mf">.20150813</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">products</span>
<span class="n">MQTT</span> <span class="n">Topic</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">exchange</span><span class="o">&gt;/</span><span class="n">v03</span><span class="o">/</span><span class="mi">20150813</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">products</span>
<span class="n">Body</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;pubTime&quot;</span><span class="p">:</span><span class="s2">&quot;20150813T161959.854&quot;</span><span class="p">,</span> <span class="s2">&quot;baseUrl&quot;</span><span class="p">:</span><span class="s2">&quot;sftp://stanley@mysftpserver.com/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;relPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/shared/products/foo&quot;</span><span class="p">,</span> <span class="s2">&quot;parts&quot;</span><span class="p">:</span><span class="s2">&quot;1,256,1,0,0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="s2">&quot;d,25d231ec0ae3c569ba27ab7a74dd72ce&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span><span class="s2">&quot;guest&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Posts are published on AMQP topic exchanges, meaning every notification message has a topic header.
The body consists of a time <em>20150813T161959.854</em>, followed by the two parts of the
retrieval URL. The headers follow with first the <em>parts</em>, a size in bytes <em>256</em>,
the number of block of that size <em>1</em>, the remaining bytes <em>0</em>, the
current block <em>0</em>, a flag <em>d</em> meaning the md5 checksum is
performed on the data, and the checksum <em>25d231ec0ae3c569ba27ab7a74dd72ce</em>.</p>
<section id="optimization-possibilities">
<h4>Optimization Possibilities<a class="headerlink" href="#optimization-possibilities" title="Link to this heading"></a></h4>
<p>optimization goal is for readabilty and ease of implementation, much more
than efficiency or performance. There are many optimizations to reduce
overheads of various sorts, all of which will increase implementation
complexity. examples: gzip the payload would save perhaps 50% size,
also grouping fixed headers together, (‘body’ header could contain
all fixed fields: “pubtime, baseurl, relpath, sum, parts”, and another
field ‘meta’ could contain: atime, mtime, mode so there would be fewer
named fields and save perhaps 40 bytes of overhead per notice. But
all the changes increase complexity, make notification messages more involved to parse.</p>
</section>
</section>
<section id="standards">
<h3>Standards<a class="headerlink" href="#standards" title="Link to this heading"></a></h3>
<blockquote>
<div><ul class="simple">
<li><p>Sarracenia relies on <a class="reference external" href="https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf">AMQP pre 1.0</a>
as the 1.0 standard eliminated concepts: broker, exchange, queue, and
binding.  The 1.0 feature set is below the minimum needed to support
Sarracenia’s pub-sub architecture.</p></li>
<li><p>MQTT refers to <a class="reference external" href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.pdf">MQTT v5.0</a>
and <a class="reference external" href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html">MQTT v3.1.1</a>,
MQTT v5 has important extension: shared subscriptions (heavily used in Sarracenia.)
so v5 is highly recommended. v3.1 support is only for legacy support reasons.</p></li>
<li><p>JSON is defined by <a class="reference external" href="https://www.rfc-editor.org/info/rfc7159">IETF RFC 7159</a>.
JSON standard includes mandatory use of UNICODE character set (ISO 10646)
JSON default character set is UTF-8, but allows multiple character
encodings (UTF-8, UTF-16, UTF-32), but also prohibits presence of
byte order markings (BOM.)</p></li>
<li><p>the same as Sarracenia v02, UTF-8 is mandatory. Sarracenia restricts JSON format
by requiring of UTF-8 encoding, (IETF RFC 3629) which does not need/use BOM.
No other encoding is permitted.</p></li>
<li><p>URL encoding, as per IETF RFC 1738, is used to escape unsafe characters
where appropriate.</p></li>
</ul>
</div></blockquote>
</section>
<section id="see-also">
<h3>SEE ALSO<a class="headerlink" href="#see-also" title="Link to this heading"></a></h3>
<p><a class="reference external" href="sr3.1.html">sr3(1)</a> - Sarracenia main command line interface.</p>
<p><a class="reference external" href="sr3_post.1.html">sr3_post(1)</a> - post file notification messages (python implementation.)</p>
<p><a class="reference external" href="sr3_cpost.1.html">sr3_cpost(1)</a> - post file announcemensts (C implementation.)</p>
<p><a class="reference external" href="sr3_cpump.1.html">sr3_cpump(1)</a> - C implementation of the shovel component. (copy notification messages)</p>
<p><strong>Formats:</strong></p>
<p><a class="reference external" href="sr3_credentials.7.html">sr3_credentials(7)</a> - Convert logfile lines to .save Format for reload/resend.</p>
<p><a class="reference external" href="sr_options.7.html">sr3_options(7)</a> - the configuration options</p>
<p><strong>Home Page:</strong></p>
<p><a class="reference external" href="https://metpx.github.io/sarracenia">https://metpx.github.io/sarracenia</a> - Sarracenia: a real-time pub/sub data sharing management toolkit</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="sr3_cpump.1.html" class="btn btn-neutral float-left" title="SR_CPUMP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="flowcb.html" class="btn btn-neutral float-right" title="FlowCallback Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>