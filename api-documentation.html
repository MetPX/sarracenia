<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Documentation &mdash; Sarracenia 3.00.55rc1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="_static/sarra_horror_culture_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=8b3d6455"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="S´abonner et répliquer" href="fr/index.html" />
    <link rel="prev" title="CAP Theorem Applied" href="Contribution/Philosophy/CAP_Theorem_Applied.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Sarracenia
              <img src="_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.00.55rc1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="How2Guides/index.html">HOWTOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="Explanation/index.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contribution/index.html">Contributing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#config">Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sarracenia">Sarracenia</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sarracenia-flowcb">Sarracenia.FlowCB</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sarracenia-moth">Sarracenia.Moth</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fr/index.html">En français</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">API Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/api-documentation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="api-documentation">
<span id="id1"></span><h1>API Documentation<a class="headerlink" href="#api-documentation" title="Link to this heading"></a></h1>
<section id="config">
<h2>Config<a class="headerlink" href="#config" title="Link to this heading"></a></h2>
<p>Second version configuration parser</p>
<p>FIXME: pas 2023/02/05…  missing options from v2: max_queue_size, outlet, pipe</p>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">Config</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>The option parser to produce a single configuration.</p>
<p>it can be instantiated with one of:</p>
<ul class="simple">
<li><p>one_config(component, config, action, isPost=False) – read the options  for
a given component an configuration,  (all in one call.)</p></li>
</ul>
<p>On the other hand, a configu can be built up from the following constructors:</p>
<ul class="simple">
<li><p>default_config() – returns an empty configuration, given a config file tree.</p></li>
<li><p>no_file_config() – returns an empty config without any config file tree.</p></li>
</ul>
<p>Then just add settings manually:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">no_file_config</span><span class="p">()</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">Credential</span><span class="p">(</span><span class="s1">&#39;amqps://anonymous:anonymous@hpfx.collab.science.gc.ca&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">topicPrefix</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;v02&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">component</span> <span class="o">=</span> <span class="s1">&#39;subscribe&#39;</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="s1">&#39;flow_demo&#39;</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;xpublic&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;v02&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;WXO-DD&#39;</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">,</span> <span class="s1">&#39;swob-ml&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="p">])</span> <span class="p">]</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">queueName</span><span class="o">=</span><span class="s1">&#39;q_anonymous.subscriber_test2&#39;</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">batch</span><span class="o">=</span><span class="mi">1</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">messageCountMax</span><span class="o">=</span><span class="mi">5</span>

<span class="c1"># set the instance number for the flow class.</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">no</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p># and at the end call finalize</p>
<p>cfg.finalize()</p>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">addBinding</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">option_strings</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dest</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nargs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">const</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">choices</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">required</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">help</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metavar</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.addBinding"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>called by argparse to deal with queue bindings.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">add_option</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">option</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kind</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'list'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default_value</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">all_values</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.add_option"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>options can be declared in any plugin. There are various <em>kind</em> of options, where the declared type modifies the parsing.</p>
<ul class="simple">
<li><p>‘count’      integer count type.</p></li>
<li><p>‘octal’      base-8 (octal) integer type.</p></li>
<li><dl class="simple">
<dt>‘duration’   a floating point number indicating a quantity of seconds (0.001 is 1 milisecond)</dt><dd><p>modified by a unit suffix ( m-minute, h-hour, w-week )</p>
</dd>
</dl>
</li>
<li><p>‘flag’       boolean (True/False) option.</p></li>
<li><p>‘float’      a simple floating point number.</p></li>
<li><dl class="simple">
<dt>‘list’       a list of string values, each succeeding occurrence catenates to the total.</dt><dd><p>all v2 plugin options are declared of type list.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>‘set’        a set of string values, each succeeding occurrence is unioned to the total.</dt><dd><p>if all_values is provided, then constrain set to that.</p>
</dd>
</dl>
</li>
<li><p>‘size’       integer size. Suffixes k, m, and g for kilo, mega, and giga (base 2) multipliers.</p></li>
<li><dl class="simple">
<dt>‘str’        an arbitrary string value, as will all of the above types, each</dt><dd><p>succeeding occurrence overrides the previous one.</p>
</dd>
</dl>
</li>
</ul>
<p>If a value is set to None, that could mean that it has not been set.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">applyComponentDefaults</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">component</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.applyComponentDefaults"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>overlay defaults options for the given component to the given configuration.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">dictify</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.dictify"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>return a dict version of the cfg…</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">dump</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.dump"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>print out what the configuration looks like.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">finalize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">component</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.finalize"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Before final use, take the existing settings, and infer any missing needed defaults from what is provided.
Should be called prior to using a configuration.</p>
<p>There are default options that apply only if they are not overridden…</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">mask_ppstr</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mask</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.mask_ppstr"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>return a pretty print string version of the given mask, easier for humans to read.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">merge</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">oth</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.merge"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>merge to lists of options.</p>
<p>merge two lists of options if one is cumulative then merge,
otherwise if not None, then take value from oth</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">override</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">oth</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.override"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>override a value in a set of options.</p>
<p>why override() method and not just assign values to the dictionary?
in the configuration file, there are various ways to have variable substituion.
override invokes those, so that they are properly interpreted.  Otherwise,
you just end up with a literal value.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">parse_args</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">isPost</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.parse_args"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><dl>
<dt>user information:</dt><dd><p>accept a configuration, apply argParse library to augment the given configuration
with command line settings.</p>
<p>the post component has a different calling convention than others, so use that flag
if called from post.</p>
</dd>
<dt>development notes:</dt><dd><p>Use argparse.parser to modify defaults.
FIXME, many FIXME notes below. this is a currently unusable placeholder.
have not figured this out yet. many issues.</p>
<p>FIXME #1:
parseArgs often sets the value of the variable, regardless of it’s presence (normally a good thing.)
( if you have ‘store_true’ then default needed, for broker, just a string, it ignores if not present.)
This has the effect of overriding settings in the file parsed before the arguments.
Therefore: often supply defaults… but… sigh…</p>
<p>but there is another consideration stopping me from supplying defaults, wish I remembered what it was.
I think it is:
FIXME #2:
arguments are parsed twice: once to get basic stuff (loglevel, component, action)
and if the parsing fails there, the usage will print the wrong defaults…</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">parse_file</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cfg</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">component</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.parse_file"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>add settings from a given config file to self</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">sundew_dirPattern</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pattern</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">urlstr</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">basename</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destDir</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#Config.sundew_dirPattern"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>does substitutions for patterns in directories.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">variableExpansion</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cdir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">message</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">str</span></span></span><a class="reference internal" href="_modules/sarracenia/config.html#Config.variableExpansion"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><blockquote>
<div><p>replace substitution patterns, variable substitutions as described in
<a class="reference external" href="https://metpx.github.io/sarracenia/Reference/sr3_options.7.html#variables">https://metpx.github.io/sarracenia/Reference/sr3_options.7.html#variables</a></p>
<p>returns:  the given string with the substiturions done.</p>
<dl class="simple">
<dt>examples:   ${YYYYMMDD-70m} becomes 20221107 assuming that was the current date 70 minutes ago.</dt><dd><p>environment variables, and built-in settings are replaced also.</p>
</dd>
</dl>
</div></blockquote>
<p>timeoffset -70m</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">config_path</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">subdir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mandatory</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ctype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'conf'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#config_path"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Given a subdir/config look for file in configish places.</p>
<p>return Tuple:   Found (True/False), path_of_file_found|config_that_was_not_found</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">get_log_filename</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hostdir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">component</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">configuration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">no</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#get_log_filename"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>return the name of a single logfile for a single instance.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">get_metrics_filename</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hostdir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">component</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">configuration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">no</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#get_metrics_filename"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>return the name of a single logfile for a single instance.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">get_pid_filename</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hostdir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">component</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">configuration</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">no</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#get_pid_filename"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>return the file name for the pid file for the specified instance.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">get_user_cache_dir</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hostdir</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#get_user_cache_dir"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>hostdir = None if statehost is false,</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">logger</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">&lt;Logger</span> <span class="pre">sarracenia.config</span> <span class="pre">(WARNING)&gt;</span></em></dt>
<dd><p>respect appdir stuff using an environment variable.
for not just hard coded as a class variable appdir_stuff</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>FIXME</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">no_file_config</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#no_file_config"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>initialize a config that will not use Sarracenia configuration files at all.
meant for use by people writing independent programs to start up instances
with python API calls.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">octal_number</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#octal_number"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">one_config</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">component</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">action</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">isPost</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#one_config"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>single call return a fully parsed single configuration for a single component to run.</p>
<p>read in admin.conf and default.conf</p>
<p>apply component default overrides ( maps to: component/check ?)
read in component/config.conf
parse arguments from command line.
return config instance item.</p>
<p>appdir_stuff can be to override file locations for testing during development.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">parse_count</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cstr</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#parse_count"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>number argument accepts k,m,g suffix with i and b to use base 2 ) and +-
return value is integer.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">parse_float</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cstr</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/config.html#parse_float"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>like parse_count, numeric argument accepts k,m,g suffix and +-.
below 1000, return a decimal number with 3 digits max.</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.config.</span></span><span class="sig-name descname"><span class="pre">str_options</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">['action',</span> <span class="pre">'admin',</span> <span class="pre">'baseDir',</span> <span class="pre">'broker',</span> <span class="pre">'cluster',</span> <span class="pre">'directory',</span> <span class="pre">'exchange',</span> <span class="pre">'exchange_suffix',</span> <span class="pre">'feeder',</span> <span class="pre">'filename',</span> <span class="pre">'flatten',</span> <span class="pre">'flowMain',</span> <span class="pre">'header',</span> <span class="pre">'hostname',</span> <span class="pre">'identity',</span> <span class="pre">'inlineEncoding',</span> <span class="pre">'logFormat',</span> <span class="pre">'logLevel',</span> <span class="pre">'pollUrl',</span> <span class="pre">'post_baseUrl',</span> <span class="pre">'post_baseDir',</span> <span class="pre">'post_broker',</span> <span class="pre">'post_exchange',</span> <span class="pre">'post_exchangeSuffix',</span> <span class="pre">'post_format',</span> <span class="pre">'post_topic',</span> <span class="pre">'queueName',</span> <span class="pre">'queueShare',</span> <span class="pre">'sendTo',</span> <span class="pre">'rename',</span> <span class="pre">'report_exchange',</span> <span class="pre">'source',</span> <span class="pre">'strip',</span> <span class="pre">'timezone',</span> <span class="pre">'nodupe_ttl',</span> <span class="pre">'nodupe_driver',</span> <span class="pre">'nodupe_basis',</span> <span class="pre">'tlsRigour',</span> <span class="pre">'topic']</span></em></dt>
<dd><p>for backward compatibility,</p>
<p>convert some old plugins that are hard to get working with
v2wrapper, into v3 plugin.</p>
<p>the fdelay ones makes in depth use of sr_replay function, and
that has changed in v3 too much.</p>
<p>accelerators and rate limiting are now built-in, no plugin required.</p>
</dd></dl>

</section>
<section id="sarracenia">
<h2>Sarracenia<a class="headerlink" href="#sarracenia" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">Message</span></span><a class="reference internal" href="_modules/sarracenia.html#Message"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>A notification message in Sarracenia is stored as a python dictionary, with a few extra management functions.</p>
<p>The internal representation is very close to the v03 format defined here: <a class="reference external" href="https://metpx.github.io/sarracenia/Reference/sr_post.7.html">https://metpx.github.io/sarracenia/Reference/sr_post.7.html</a></p>
<p>Unfortunately, sub-classing of dict means that to copy it from a dict will mean losing the type,
and hence the need for the copyDict member.</p>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">computeIdentity</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">o</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">offset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="reference internal" href="_modules/sarracenia.html#Message.computeIdentity"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>check extended attributes for a cached identity sum calculation.
if extended attributes are present, and
* the file mtime is not too new, and
* the cached sum us using the same method
then use the cached value.</p>
<p>otherwise, calculate a checksum.
If the data is provided, use that as the file content, otherwise
read the file form the file system.</p>
<p>Once the checksum is determined,
set the file’s extended attributes for the new value.
the method of checksum calculation is from options.identity.</p>
<p>sets the message ‘identity’ field if appropriate.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">copyDict</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">d</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.copyDict"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>copy dictionary into message.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">deriveSource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">o</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.deriveSource"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>set msg[‘source’] field as appropriate for given message and options (o)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">deriveTopics</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">o</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">topic</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">separator</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'.'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.deriveTopics"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>derive subtopic, topicPrefix, and topic fields based on message and options.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">dumps</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">str</span></span></span><a class="reference internal" href="_modules/sarracenia.html#Message.dumps"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>FIXME: used to be msg_dumps.
print a message in a compact but relatively compact way.
msg is a python dictionary. if there is a field longer than maximum_field_length,
truncate.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">fromFileData</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">o</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lstat</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.fromFileData"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>create a message based on a given file, calculating the checksum.
returns a well-formed message, or none.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">fromFileInfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">o</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lstat</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.fromFileInfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>based on the fiven information about the file (it’s name and a stat record if available)
and a configuration options object (sarracenia.config.Config)
return an sarracenia.Message suitable for placement on a worklist.</p>
<p>A message is a specialized python dictionary with a certain set of fields in it.
The message returned will have the necessary fields for processing and posting.</p>
<p>The message is built for a file is based on the given path, options (o), and lstat (output of os.stat)</p>
<p>The lstat record is used to build ‘atime’, ‘mtime’ and ‘mode’ fields if
timeCopy and permCopy options are set.</p>
<p>if no lstat record is supplied, then those fields will not be set.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">fromStream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">o</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.fromStream"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Create a file and message for the given path.
The file will be created or overwritten with the provided data.
then invoke fromFileData() for the resulting file.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">getContent</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">options</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.getContent"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Retrieve the data referred to by a message.  The data may be embedded
in the messate, or this routine may resolve a link to an external server
and download the data.</p>
<p>does not handle authentication.
This routine is meant to be used with small files. using it to download
large files may be very inefficient. Untested in that use-case.</p>
<p>Return value is the data.</p>
<p>often on server where one is publishing data, the file is available as
a local file, and one can avoid the network usage by using a options.baseDir setting.
this behaviour can be disabled by not providing the options or not setting baseDir.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">getIDStr</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">str</span></span></span><a class="reference internal" href="_modules/sarracenia.html#Message.getIDStr"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>return some descriptive tag string to identify the message being processed.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">new_pathWrite</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">options</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.new_pathWrite"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>expects: msg[‘new_dir’] and msg[‘new_file’] to be set.
given the byte stream of data.</p>
<p>write the local file based on the given message, options and data.
update the message to match same (recalculating checksum.)</p>
<p>in future:
If the data field is a file, then that is taken as an open file object
which can be read sequentially, and the bytes write to the path indicated
by other message fields.</p>
<p>currently, if data is a buffer, then it’s contents is written to the file.</p>
<p>if data is None, then look for the ‘content’ header in the message.
and use the data from that.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">setReport</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">code</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">text</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.setReport"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>FIXME: used to be msg_set_report
set message fields to indicate result of action so reports can be generated.</p>
<p>set is supposed to indicate final message dispositions, so in the case
of putting a message on worklist.failed… no report is generated, since
it will be retried later.  FIXME: should we publish an interim failure report?</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">updatePaths</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">options</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_dir</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.updatePaths"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>set the new_* fields in the message based on changed file placement.
if new_* options are ommitted updaste the rest of the fields in
the message based on their current values.</p>
<p>If you change file placement in a flow callback, for example.
One would change new_dir and new_file in the message.
This routines updates other fields in the message (e.g. relPath,
baseUrl, topic ) to match new_dir/new_file.</p>
<p>msg[‘post_baseUrl’] defaults to msg[‘baseUrl’]</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">validate</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#Message.validate"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>FIXME: used to be msg_validate
return True if message format seems ok, return True, else return False, log some reasons.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">Sarracenia</span></span><a class="reference internal" href="_modules/sarracenia.html#Sarracenia"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Core utilities of Sarracenia. The main class here is sarracenia.Message.
a Sarracenia.Message is subclassed from a dict, so for most uses, it works like the
python built-in, but also we have a few major entry points some factoryies:</p>
<p><strong>Building a message from a file</strong></p>
<p>m = sarracenia.Message.fromFileData( path, options, lstat )</p>
<p>builds a notification message from a given existing file, consulting <em>options</em>, a parsed
in memory version of the configuration settings that are applicable</p>
<p><strong>Options</strong></p>
<p>see the sarracenia.config.Config class for functions to parse configuration files
and create corresponding python option dictionaries. One can supply small
dictionaries for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;topicPrefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;v02&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span> <span class="p">]</span>
<span class="n">options</span><span class="p">[</span><span class="s1">&#39;bindings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;xpublic&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;v02&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;#&#39;</span> <span class="p">]</span> <span class="p">)]</span>
<span class="n">options</span><span class="p">[</span><span class="s1">&#39;queueName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;q_anonymous_&#39;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_SomethingHelpfulToYou&#39;</span>
</pre></div>
</div>
<p>Above is an example of a minimal options dictionary taken from the tutorial
example called moth_api_consumer.py. often</p>
<p><strong>If you don’t have a file</strong></p>
<p>If you don’t have a local file, then build your notification message with:</p>
<p>m = sarracenia.Message.fromFileInfo( path, options, lstat )</p>
<p>where you can make up the lstat values to fill in some fields in the message.
You can make a fake lstat structure to provide these values using sarracenia.filemetadata
class which is either an alias for paramiko.SFTPAttributes
( <a class="reference external" href="https://docs.paramiko.org/en/latest/api/sftp.html#paramiko.sftp_attr.SFTPAttributes">https://docs.paramiko.org/en/latest/api/sftp.html#paramiko.sftp_attr.SFTPAttributes</a> )
if paramiko is installed, or a simple emulation if not.</p>
<p>from  sarracenia.filemetadata import FmdStat</p>
<p>lstat = FmdStat()
lstat.st_mtime= utcinteger second count in UTC (numeric version of a Sarracenia timestamp.)
lstat.st_atime=
lstat.st_mode=0o644
lstat.st_size= size_in_bytes</p>
<p>optional fields that may be of interest:
lstat.filename= “nameOfTheFile”
lstat.longname= ‘lrwxrwxrwx    1 peter    peter          20 Oct 11 20:28 nameOfTheFile’</p>
<p>that you can then provide as an <em>lstat</em> argument to the above <em>fromFileInfo()</em>
call. However the notification message returned will lack an identity checksum field.
once you get the file, you can add the Identity field with:</p>
<p>m.computeIdentity(path, o):</p>
<p>In terms of consuming notification messages, the fields in the dictionary provide metadata
for the announced resource. The anounced data could be embedded in the notification message itself,
or available by a URL.</p>
<p>Messages are generally gathered from a source such as the Message Queueing Protocol wrapper
class: moth… sarracenia.moth.</p>
<p>data = m.getContent()</p>
<p>will return the content of the announced resource as raw data.</p>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">TimeConversions</span></span><a class="reference internal" href="_modules/sarracenia.html#TimeConversions"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Time conversion routines.</p>
<ul class="simple">
<li><p>os.stat, and time.now() return floating point</p></li>
<li><p>The floating point representation is a count of seconds since the beginning of the epoch.</p></li>
<li><p>beginning of epoch is platform dependent, and conversion to actual date is fraught (leap seconds, etc…)</p></li>
<li><p>Entire SR_* formats are text, no floats are sent over the protocol
(avoids byte order issues, null byte / encoding issues, and enhances readability.)</p></li>
<li><p>str format: YYYYMMDDHHMMSS.msec goal of this representation is that a naive
conversion to floats yields comparable numbers.</p></li>
<li><p>but the number that results is not useful for anything else, so need these
special routines to get a proper epochal time.</p></li>
<li><p>also OK for year 2032 or whatever (rollover of time_t on 32 bits.)</p></li>
<li><p>string representation is forced to UTC timezone to avoid having to communicate timezone.</p></li>
</ul>
<p>timestr2flt() - accepts a string and returns a float.</p>
<p>caveat</p>
<p>FIXME: this encoding will break in the year 10000 (assumes four digit year)
and requires leading zeroes prior to 1000. One will have to add detection of
the decimal point, and change the offsets at that point.</p>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">durationToSeconds</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">str_value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">float</span></span></span><a class="reference internal" href="_modules/sarracenia.html#durationToSeconds"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>this function converts duration to seconds.
str_value should be a number followed by a unit [s,m,h,d,w] ex. 1w, 4d, 12h
return 0.0 for invalid string.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">durationToString</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">d</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">str</span></span></span><a class="reference internal" href="_modules/sarracenia.html#durationToString"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>given a numbner of seconds, return a short, human readable string.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">stat</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">SFTPAttributes</span></span></span><a class="reference internal" href="_modules/sarracenia.html#stat"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>os.stat call replacement which improves on it by returning
and SFTPAttributes structure, in place of the OS stat one,
featuring:</p>
<ul class="simple">
<li><p>mtime and ctime with subsecond accuracy</p></li>
<li><p>fields that can be overridden (not immutable.)</p></li>
</ul>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.</span></span><span class="sig-name descname"><span class="pre">timeflt2str</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">f</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia.html#timeflt2str"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>timeflt2str - accepts a float and returns a string.</p>
<p>flow is a floating point number such as returned by time.now()
(number of seconds since beginning of epoch.)</p>
<p>the str is YYYYMMDDTHHMMSS.sssss</p>
<p>20210921T011331.0123</p>
<p>translates to: Sept. 21st, 2021 at 01:13 and 31.0123 seconds.
always UTC timezone.</p>
</dd></dl>

</section>
<section id="sarracenia-flowcb">
<h2>Sarracenia.FlowCB<a class="headerlink" href="#sarracenia-flowcb" title="Link to this heading"></a></h2>
<p>Callbacks from running Sarracenia.Flows</p>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.flowcb.</span></span><span class="sig-name descname"><span class="pre">FlowCB</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">options</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">class_logger</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/flowcb.html#FlowCB"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Flow Callback is the main class for implementing plugin customization to flows.</p>
<p>sample activation in a configuration file:</p>
<p>flowCallback sarracenia.flowcb.name.Name</p>
<p>will instantiate an object of that type whose appropriately name methods
will be called at the right time.</p>
<p>__init__ accepts options as an argument.</p>
<p>options is a sarracenia.config.Config object, used to override default behaviour</p>
<p>a setting is declared in a configuration file like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">level</span> <span class="n">debug</span>
</pre></div>
</div>
<p>(the prefix for the setting matches the type hierarchy in flowCallback)
the plugin should get the setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
</pre></div>
</div>
<p>worklist given to on_plugins…</p>
<ul class="simple">
<li><p>worklist.incoming –&gt; new messages to continue processing</p></li>
<li><p>worklist.ok       –&gt; successfully processed</p></li>
<li><p>worklist.rejected –&gt; messages to not be further processed.</p></li>
<li><p>worklist.failed   –&gt; messages for which processing failed. Failed messages will be retried.</p></li>
<li><p>worklist.directories_ok –&gt; list of directories created during processing.</p></li>
</ul>
<p>Initially, all messages are placed in incoming.
if a plugin entry_point decides:</p>
<ul class="simple">
<li><p>a message is not relevant, it is moved to the rejected worklist.</p></li>
<li><p>all processing has been done, it moves it to the ok worklist</p></li>
<li><p>an operation failed and it should be retried later, append it to the failed
worklist</p></li>
</ul>
<p>Do not remove any message from all lists, only move messages between them.
it is necessary to put rejected messages in the appropriate worklist
so they can be acknowledged as received. Messages can only removed after ack.</p>
<p>def __init__(self,options) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">initialization</span> <span class="n">of</span> <span class="n">the</span> <span class="n">flowCallback</span> <span class="n">at</span> <span class="n">instantiation</span> <span class="n">time</span><span class="o">.</span>

<span class="n">usually</span> <span class="n">contains</span><span class="p">:</span>

<span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">options</span>
</pre></div>
</div>
<p>def ack(self,messagelist) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">acknowledge</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">gather</span> <span class="n">source</span><span class="o">.</span>
</pre></div>
</div>
<p>def gather(self, messageCountMax) -&gt; (gather_more, messages)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">gather</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">source</span><span class="o">...</span> <span class="k">return</span> <span class="n">a</span> <span class="nb">tuple</span><span class="p">:</span>

      <span class="o">*</span> <span class="n">gather_more</span> <span class="o">...</span> <span class="nb">bool</span> <span class="n">whether</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">gathering</span>
      <span class="o">*</span> <span class="n">messages</span> <span class="o">...</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">messages</span>

      <span class="ow">or</span> <span class="n">just</span> <span class="k">return</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">messages</span><span class="o">.</span>

      <span class="n">In</span> <span class="n">a</span> <span class="n">poll</span><span class="p">,</span> <span class="n">gather</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">called</span><span class="p">,</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">vip</span> <span class="n">posession</span><span class="o">.</span>

      <span class="n">In</span> <span class="nb">all</span> <span class="n">other</span> <span class="n">components</span><span class="p">,</span> <span class="n">gather</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">called</span> <span class="n">when</span> <span class="ow">in</span> <span class="n">posession</span>
      <span class="n">of</span> <span class="n">the</span> <span class="n">vip</span><span class="o">.</span>

<span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
 <span class="n">OR</span>
<span class="k">return</span> <span class="nb">list</span>
</pre></div>
</div>
<p>def after_accept(self,worklist) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">just</span> <span class="n">after</span> <span class="n">messages</span> <span class="n">go</span> <span class="n">through</span> <span class="n">accept</span><span class="o">/</span><span class="n">reject</span> <span class="n">masks</span><span class="p">,</span>
      <span class="n">operate</span> <span class="n">on</span> <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="n">to</span> <span class="n">help</span> <span class="n">decide</span> <span class="n">which</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">process</span> <span class="n">further</span><span class="o">.</span>
      <span class="ow">and</span> <span class="n">move</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span> <span class="n">to</span> <span class="n">prevent</span> <span class="n">further</span> <span class="n">processing</span><span class="o">.</span>
      <span class="n">do</span> <span class="ow">not</span> <span class="n">delete</span> <span class="nb">any</span> <span class="n">messages</span><span class="p">,</span> <span class="n">only</span> <span class="n">move</span> <span class="n">between</span> <span class="n">worklists</span><span class="o">.</span>
</pre></div>
</div>
<p>def after_work(self,worklist) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">operate</span> <span class="n">on</span> <span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="p">(</span><span class="n">files</span> <span class="n">which</span> <span class="n">have</span> <span class="n">arrived</span><span class="o">.</span><span class="p">)</span>

<span class="n">All</span> <span class="n">messages</span> <span class="n">on</span> <span class="n">the</span> <span class="n">worklist</span><span class="o">.</span><span class="n">ok</span> <span class="nb">list</span> <span class="n">have</span> <span class="n">been</span> <span class="n">acknowledged</span><span class="p">,</span> <span class="n">so</span> <span class="n">to</span> <span class="n">suppress</span> <span class="n">posting</span>
<span class="n">of</span> <span class="n">them</span><span class="p">,</span> <span class="ow">or</span> <span class="n">futher</span> <span class="n">processing</span><span class="p">,</span> <span class="n">the</span> <span class="n">messages</span> <span class="n">must</span> <span class="n">be</span> <span class="n">removed</span> <span class="kn">from</span> <span class="nn">worklist.ok.</span>

<span class="n">worklist</span><span class="o">.</span><span class="n">failed</span> <span class="n">processing</span> <span class="n">should</span> <span class="n">occur</span> <span class="ow">in</span> <span class="n">here</span> <span class="k">as</span> <span class="n">it</span> <span class="n">will</span> <span class="n">be</span> <span class="n">zeroed</span> <span class="n">out</span> <span class="n">after</span> <span class="n">this</span> <span class="n">step</span><span class="o">.</span>
<span class="n">The</span> <span class="n">flowcb</span><span class="o">/</span><span class="n">retry</span><span class="o">.</span><span class="n">py</span> <span class="n">plugin</span><span class="p">,</span> <span class="k">for</span> <span class="n">example</span><span class="p">,</span> <span class="n">processes</span> <span class="n">failed</span> <span class="n">messages</span><span class="o">.</span>
</pre></div>
</div>
<p>def destfn(self,msg) -&gt; str:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Destination</span> <span class="n">File</span> <span class="n">Name</span> <span class="p">(</span><span class="n">DESTFNSCRIPT</span><span class="p">)</span>  <span class="n">routines</span><span class="o">.</span>

<span class="n">Task</span><span class="p">:</span> <span class="n">look</span> <span class="n">at</span> <span class="n">the</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">message</span><span class="p">,</span> <span class="ow">and</span> <span class="n">perhaps</span> <span class="n">settings</span> <span class="ow">and</span>
      <span class="k">return</span> <span class="n">a</span> <span class="n">new</span> <span class="n">file</span> <span class="n">name</span> <span class="k">for</span> <span class="n">the</span> <span class="n">target</span> <span class="n">of</span> <span class="n">the</span> <span class="n">send</span> <span class="ow">or</span> <span class="n">download</span><span class="o">.</span>

<span class="n">kind</span> <span class="n">of</span> <span class="n">a</span> <span class="n">last</span> <span class="n">resort</span> <span class="n">function</span><span class="p">,</span> <span class="n">exists</span> <span class="n">mostly</span> <span class="k">for</span> <span class="n">sundew</span> <span class="n">compatibility</span><span class="o">.</span>
<span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span> <span class="n">selective</span> <span class="n">renaming</span> <span class="n">using</span> <span class="n">accept</span> <span class="n">clauses</span><span class="o">.</span>
</pre></div>
</div>
<p>def download(self,msg) -&gt; bool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_inflight_file&#39;</span><span class="p">]</span>
      <span class="ow">and</span> <span class="n">the</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="n">options</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">download</span> <span class="n">of</span> <span class="n">a</span> <span class="n">single</span> <span class="n">file</span><span class="o">.</span>
      <span class="k">return</span> <span class="kc">True</span> <span class="n">on</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">transfer</span><span class="p">,</span> <span class="kc">False</span> <span class="n">otherwise</span><span class="o">.</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">simulate</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">a</span> <span class="n">download</span> <span class="n">without</span>
      <span class="n">performing</span> <span class="n">it</span><span class="o">.</span>

<span class="n">This</span> <span class="n">replaces</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">download</span> <span class="n">functionality</span><span class="p">,</span> <span class="n">providing</span> <span class="n">an</span> <span class="n">override</span><span class="o">.</span>
<span class="k">for</span> <span class="n">individual</span> <span class="n">file</span> <span class="n">transfers</span><span class="o">.</span> <span class="n">ideally</span> <span class="n">you</span> <span class="nb">set</span> <span class="n">checksums</span> <span class="k">as</span> <span class="n">you</span> <span class="n">download</span><span class="o">.</span>
</pre></div>
</div>
<p>def metricsReport(self) -&gt; dict:</p>
<blockquote>
<div><p>Return a dictionary of metrics. Example: number of messages remaining in retry queues.</p>
</div></blockquote>
<dl class="simple">
<dt>def on_cleanup(self) -&gt; None::</dt><dd><p>allow plugins to perform additional work after broker resources are eliminated.
local state files are still present when this runs.</p>
</dd>
<dt>def on_declare(self) -&gt; None::</dt><dd><p>local state files are still already present when this runs.
allow plugins to perform additional work besides broker resource setup.</p>
</dd>
</dl>
<p>def on_housekeeping(self) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">do</span> <span class="n">periodic</span> <span class="n">processing</span><span class="o">.</span>
</pre></div>
</div>
<p>def on_start(self) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">After</span> <span class="n">the</span> <span class="n">connection</span> <span class="ow">is</span> <span class="n">established</span> <span class="k">with</span> <span class="n">the</span> <span class="n">broker</span> <span class="ow">and</span> <span class="n">things</span> <span class="n">are</span> <span class="n">instantiated</span><span class="p">,</span> <span class="n">but</span>
<span class="n">before</span> <span class="nb">any</span> <span class="n">message</span> <span class="n">transfer</span> <span class="n">occurs</span><span class="o">.</span>
</pre></div>
</div>
<p>def on_stop(self) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">what</span> <span class="n">it</span> <span class="n">says</span> <span class="n">on</span> <span class="n">the</span> <span class="n">tin</span><span class="o">...</span> <span class="n">clean</span> <span class="n">up</span> <span class="n">processing</span> <span class="n">when</span> <span class="n">stopping</span><span class="o">.</span>
</pre></div>
</div>
<p>def poll(self) -&gt; list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">gather</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">destination</span><span class="o">...</span> <span class="k">return</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">messages</span><span class="o">.</span>
      <span class="n">works</span> <span class="n">like</span> <span class="n">a</span> <span class="n">gather</span><span class="p">,</span> <span class="n">but</span><span class="o">...</span>

      <span class="n">When</span> <span class="n">specified</span><span class="p">,</span> <span class="n">poll</span> <span class="n">replaces</span> <span class="n">the</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">poll</span> <span class="n">of</span> <span class="n">the</span> <span class="n">poll</span> <span class="n">component</span><span class="o">.</span>
      <span class="n">it</span> <span class="n">runs</span> <span class="n">only</span> <span class="n">when</span> <span class="n">the</span> <span class="n">machine</span> <span class="n">running</span> <span class="n">the</span> <span class="n">poll</span> <span class="n">has</span> <span class="n">the</span> <span class="n">vip</span><span class="o">.</span>
      <span class="ow">in</span> <span class="n">components</span> <span class="n">other</span> <span class="n">than</span> <span class="n">poll</span><span class="p">,</span> <span class="n">poll</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">called</span><span class="o">.</span>
<span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
<p>def post(self,worklist) -&gt; None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">operate</span> <span class="n">on</span> <span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="ow">and</span> <span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span> <span class="n">modifies</span> <span class="n">them</span> <span class="n">appropriately</span><span class="o">.</span>
      <span class="n">message</span> <span class="n">acknowledgement</span> <span class="n">has</span> <span class="n">already</span> <span class="n">occurred</span> <span class="n">before</span> <span class="n">they</span> <span class="n">are</span> <span class="n">called</span><span class="o">.</span>

<span class="n">to</span> <span class="n">indicate</span> <span class="n">failure</span> <span class="n">to</span> <span class="n">process</span> <span class="n">a</span> <span class="n">message</span><span class="p">,</span> <span class="n">append</span> <span class="n">to</span> <span class="n">worklist</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span>
<span class="n">worklist</span><span class="o">.</span><span class="n">failed</span> <span class="n">processing</span> <span class="n">should</span> <span class="n">occur</span> <span class="ow">in</span> <span class="n">here</span> <span class="k">as</span> <span class="n">it</span> <span class="n">will</span> <span class="n">be</span> <span class="n">zeroed</span> <span class="n">out</span> <span class="n">after</span> <span class="n">this</span> <span class="n">step</span><span class="o">.</span>
</pre></div>
</div>
<p>def send(self,msg) -&gt; bool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Task</span><span class="p">:</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_dir&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;new_file&#39;</span><span class="p">],</span> <span class="ow">and</span> <span class="n">the</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="n">options</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">transfer</span>
      <span class="n">of</span> <span class="n">a</span> <span class="n">single</span> <span class="n">file</span><span class="o">.</span>
      <span class="k">return</span> <span class="kc">True</span> <span class="n">on</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">transfer</span><span class="p">,</span> <span class="kc">False</span> <span class="n">otherwise</span><span class="o">.</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">simulate</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">a</span> <span class="n">send</span> <span class="n">without</span>
      <span class="n">performing</span> <span class="n">it</span><span class="o">.</span>

<span class="n">This</span> <span class="n">replaces</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">send</span> <span class="n">functionality</span> <span class="k">for</span> <span class="n">individual</span> <span class="n">files</span><span class="o">.</span>
</pre></div>
</div>
<dl class="simple">
<dt>def please_stop(self):</dt><dd><p>Pre-warn a flowcb that a stop has been requested, allowing processing to wrap up
before the full stop happens.</p>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">options</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">class_logger</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/flowcb.html#FlowCB.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">please_stop</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/flowcb.html#FlowCB.please_stop"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>flow callbacks should not time.sleep for long periods, but only nap and check
between naps if a stop has been requested.</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.flowcb.</span></span><span class="sig-name descname"><span class="pre">load_library</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">factory_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/flowcb.html#load_library"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Loading the entry points for a python module. It searches
the normal python module path using the importlib module.</p>
<p>the factory_path is a combined file specification with a dot separator
with a special last entry being the name of the class within the file.</p>
<p>factory_path  a.b.c.C</p>
<p>means import the module named a.b.c and instantiate an object of type
C. In that class-C object, look for the known callback entry points.</p>
<p>or C might be guessed by the last class in the path not following
python convention by not starting with a capital letter, in which case,
it will just guess.</p>
<p>re
note that the ~/.config/sr3/plugins will also be in the python library
path, so modules placed there will be found, in addition to those in the
package itself in the <em>sarracenia/flowcb</em>  directory</p>
<dl class="simple">
<dt>callback foo  -&gt; foo.Foo</dt><dd><p>sarracenia.flowcb.foo.Foo</p>
</dd>
<dt>callback foo.bar -&gt; foo.bar.Bar</dt><dd><p>sarracenia.flowcb.foo.bar.Bar
foo.bar
sarracenia.flowcb.foo.bar</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="sarracenia-moth">
<h2>Sarracenia.Moth<a class="headerlink" href="#sarracenia-moth" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.moth.</span></span><span class="sig-name descname"><span class="pre">Moth</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">props</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_subscriber</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<blockquote>
<div><p>Moth … Messages Organized by Topic Headers
(en français: Messages organisés par thème hierarchique. )</p>
<p>A multi-protocol library for use by hierarchical message passing implementations,
(messages which have a ‘topic’ header that is used for routing by brokers.)</p>
<ul class="simple">
<li><p>regardless of protocol, the message format returned should be the same.</p></li>
<li><p>the message is turned into a sarracenia.Message object, which acts like a python
dictionary, corresponding to key-value pairs in the message body, and properties.</p></li>
<li><p>topic is a special key that may end up in the message body, or some sort of property
or metadata.</p></li>
<li><p>the protocol should support acknowledgement under user control. Such control indicated
by the presence of an entry_point called “ack”. The entry point accepts “ack_id” as
a message identifier to be passed to the broker. Whatever protocol symbol is used
by the protocol, it is passed through this message property. Examples:
in rabbitmq/amqp ack takes a “delivery_tag” as an argument, in MQTT, it takes a “message-id”
so when receiving an AMQP message, the m[‘ack_id’] is assigned the delivery_tag from the message.</p></li>
<li><p>There is a special dict item:  “_DeleteOnPost”,
to identify keys which are added only for local use.
they will be removed from the message when publishing.
examples:  topic (sent outside body), message-id (used for acknowledgements.)
new_basedir, ack_id, new_… (settings…)</p></li>
</ul>
<p>Intent is to be specialized for topic based data distribution (MQTT style.)
API to allow pass-through of protocol specific properties, but apply templates for genericity.</p>
<p>Target protocols (and corresponding libraries.): AMQP, MQTT, ?</p>
<p>Things to specify:</p>
<ul class="simple">
<li><p>broker</p></li>
<li><p>topicPrefix</p></li>
<li><p>subTopic</p></li>
<li><p>queueName   (for amqp, used as client-id for mqtt)</p></li>
</ul>
<p>this library knows nothing about Sarracenia, the only code used from sarracenia is to interpret
duration properties, from the root sarracenia/__init__.py, the broker argument from sarracenia.credentials</p>
<p>usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sarracenia.moth</span>
<span class="kn">import</span> <span class="nn">sarracenia.credentials</span>


<span class="n">props</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">default_options</span>
<span class="n">props</span><span class="p">[</span><span class="s1">&#39;broker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">Credential</span><span class="p">(</span><span class="s1">&#39;amqps://anonymous:anonymous@hpfx.collab.science.gc.ca&#39;</span><span class="p">)</span>
<span class="n">props</span><span class="p">[</span><span class="s1">&#39;expire&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">props</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">is_subscriber</span><span class="o">=</span><span class="kc">True</span>

<span class="n">c</span><span class="o">=</span> <span class="n">Moth</span><span class="p">(</span> <span class="n">props</span><span class="p">,</span> <span class="n">is_subscriber</span>  <span class="p">)</span>

<span class="n">messages</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">newMessages</span><span class="p">()</span>

<span class="c1"># if there are new messages from a publisher, return them, otherwise return</span>
<span class="c1"># an empty list []].</span>

<span class="n">p</span><span class="o">=</span><span class="n">Moth</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;batch&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="p">},</span> <span class="kc">False</span> <span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">putNewMessage</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># tear down connection.</span>
</pre></div>
</div>
<p>Initialize a broker connection. Connections are unidirectional.
either for subscribing (with subFactory) or publishing (with pubFactory.)</p>
<p>The factories return objects subclassed to match the protocol required
by the broker argument.</p>
<p>arguments to the factories are:</p>
<ul class="simple">
<li><p>broker … the url of the broker to connect to.</p></li>
<li><p>props is a dictionary or properties/parameters.</p></li>
<li><p>supplied as overrides to the default properties listed above.</p></li>
</ul>
<p>Some may vary among protocols:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Protocol</span>     <span class="n">library</span> <span class="n">implementing</span>    <span class="n">URL</span> <span class="n">to</span> <span class="n">select</span>
<span class="o">--------</span>     <span class="o">--------------------</span>    <span class="o">-------------</span>

<span class="n">AMQPv0</span><span class="mf">.9</span> <span class="o">--&gt;</span> <span class="n">amqplib</span> <span class="kn">from</span> <span class="nn">Celery</span> <span class="o">--&gt;</span> <span class="n">amqp</span><span class="p">,</span> <span class="n">amqps</span>

<span class="n">AMQPv0</span><span class="mf">.9</span> <span class="o">--&gt;</span> <span class="n">pika</span>                <span class="o">--&gt;</span> <span class="n">pika</span><span class="p">,</span> <span class="n">pikas</span>

<span class="n">MQTTv3</span>   <span class="o">--&gt;</span> <span class="n">paho</span>                <span class="o">--&gt;</span> <span class="n">mqtt</span><span class="p">,</span> <span class="n">mqtts</span>

<span class="n">AMQPv1</span><span class="mf">.0</span> <span class="o">--&gt;</span> <span class="n">qpid</span><span class="o">-</span><span class="n">proton</span>         <span class="o">--&gt;</span> <span class="n">amq1</span><span class="p">,</span> <span class="n">amq1s</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>messaging_strategy</strong></p>
<p>how to manage the connection. Covers whether to treat the connection
as new or assume it is set up. Also, If something goes wrong.
What should be done.</p>
<ul class="simple">
<li><p>reset: on startup… erase any state, and re-initialize.</p></li>
<li><p>stubborn: If set to True, loop forever if something bad happens.
Never give up. This sort of setting is desired in operations, especially unattended.
if set to False, may give up more easily.</p></li>
<li><p>failure_duration is to advise library how to structure connection service level.</p>
<ul>
<li><p>5m - make a connection that will recover from transient errors of a few minutes,
but not tax the broker too much for prolonged outages.</p></li>
<li><p>5d - duration outage to striving to survive connection for five days.</p></li>
</ul>
</li>
</ul>
<p>Changing recovery_strategy setting, might result in having to destroy and re-create
consumer queues (AMQP.)</p>
<p><strong>Options</strong></p>
<p><strong>both</strong></p>
<ul class="simple">
<li><p>‘topicPrefix’ : [ ‘v03’ ]</p></li>
<li><p>‘messageDebugDump’: False, –&gt; enable printing of raw messages.</p></li>
<li><p>‘inline’: False,  - Are we inlining content within messages?</p></li>
<li><p>‘inlineEncoding’: ‘guess’, - what encoding should we use for inlined content?</p></li>
<li><p>‘inlineByteMax’: 4096,  - Maximum size of messages to inline.</p></li>
</ul>
<p><strong>for get</strong></p>
<ul class="simple">
<li><p>‘batch’  : 100  # how many messages to get at once</p></li>
<li><p>‘broker’ : an sr_broker ?</p></li>
<li><p>‘queueName’  : Mandatory, name of a queue. (only in AMQP… hmm…)</p></li>
<li><p>‘bindings’ : [ list of bindings ]</p></li>
<li><p>‘loop’</p></li>
</ul>
<p><strong>optional:</strong></p>
<ul class="simple">
<li><p>‘message_ttl’</p></li>
</ul>
<p><strong>for put:</strong></p>
<ul class="simple">
<li><p>‘exchange’ (only in AMQP… hmm…)</p></li>
</ul>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">props</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_subscriber</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>If is_subscriber=True, then this is a consuming instance.
expect calls to get* routines.</p>
<p>if is_subscriber=False, then expect/permit only calls to put*</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">ack</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">message</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="Reference/code.html#sarracenia.Message" title="sarracenia.Message"><span class="pre">Message</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.ack"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>tell broker that a given message has been received.</p>
<p>ack uses the ‘ack_id’ property to send an acknowledgement back to the broker.
If there’s no ‘ack_id’ in the message, you should return True.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">cleanup</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.cleanup"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>get rid of server-side resources associated with a client. (queues/id’s, etc…)</p>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">default_options</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">dict</span></em></dt>
<dd><p>get default properties to override, used by client for validation.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">findAllSubclasses</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cls</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">set</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.findAllSubclasses"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Recursively finds all subclasses of a class. __subclasses__() only gives direct subclasses.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">getNewMessage</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="Reference/code.html#sarracenia.Message" title="sarracenia.Message"><span class="pre">Message</span></a></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.getNewMessage"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>If there is one new message available, return it. Otherwise return None. Do not block.</p>
<dl class="simple">
<dt>side effects:</dt><dd><p>metrics.
self.metrics[‘RxByteCount’] should be incremented by size of payload.
self.metrics[‘RxGoodCount’] should be incremented by 1 if a good message is received.
self.metrics[‘RxBadCount’] should be incremented by 1 if an invalid message is received (&amp;discarded.)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">metricsDisconnect</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.metricsDisconnect"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>tear down an existing connection.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">newMessages</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">list</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.newMessages"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>If there are new messages available from the broker, return them, otherwise return None.</p>
<p>On Success, this routine returns immediately (non-blocking) with either None, or a list of messages.</p>
<p>On failure, this routine blocks, and loops reconnecting to broker, until interaction with broker is successful.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">please_stop</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.please_stop"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>register a request to cleanly stop. Any long running processes should check for _stop_requested and
stop if it becomes True.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">putNewMessage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">message</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="Reference/code.html#sarracenia.Message" title="sarracenia.Message"><span class="pre">Message</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">content_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'application/json'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exchange</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="reference internal" href="_modules/sarracenia/moth.html#Moth.putNewMessage"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>publish a message as set up to the given topic.</p>
<p>return True is succeeded, False otherwise.</p>
<dl class="simple">
<dt>side effect</dt><dd><p>self.metrics[‘TxByteCount’] should be incremented by size of payload.
self.metrics[‘TxGoodCount’] should be incremented by 1 if a good message is received.
self.metrics[‘TxBadCount’] should be incremented by 1 if an invalid message is received (&amp;discarded.)</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py exception">
<dt class="sig sig-object py">
<em class="property"><span class="pre">exception</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.transfer.</span></span><span class="sig-name descname"><span class="pre">TimeoutException</span></span><a class="reference internal" href="_modules/sarracenia/transfer.html#TimeoutException"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Exception</span></code></p>
<p>timeout exception</p>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.transfer.</span></span><span class="sig-name descname"><span class="pre">Transfer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">proto</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/transfer.html#Transfer"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>This is a sort of abstract base class for implementing transfer protocols.
Implemented subclasses include support for: local files, https, sftp, and ftp.</p>
<p>This class has routines that do i/o given descriptors opened by the sub-classes,
so that each one does not need to re-implement copying, for example.</p>
<p>Each subclass needs to implement the following routines:</p>
<p>if downloading:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get</span>    <span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">local_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
<span class="n">getAccellerated</span><span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">length</span> <span class="p">)</span>
<span class="n">ls</span>     <span class="p">()</span>
<span class="n">cd</span>     <span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
<span class="n">delete</span> <span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>if sending:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">put</span>    <span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">local_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
<span class="n">putAccelerated</span> <span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
<span class="n">cd</span>     <span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
<span class="n">mkdir</span>  <span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
<span class="n">umask</span>  <span class="p">()</span>
<span class="n">chmod</span>  <span class="p">(</span><span class="n">perm</span><span class="p">)</span>
<span class="n">rename</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the ls() call returns are polymorphic. One of:</p>
<ul class="simple">
<li><p>a dictionary where the key is the name of the file in the directory,
and the value is an SFTPAttributes structure for if (from paramiko.)
(sftp.py as an example)</p></li>
<li><p>a dictionary where the key is the name of the file, and the value is a string
that looks like the output of a linux ls command.
(ftp.py as an example.)</p></li>
<li><p>a sequence of bytes… will be parsed as an html page.
(https.py as an example)</p></li>
</ul>
<p>The first format is the vastly preferred one. The others are fallbacks when the first
is not available.
The flowcb/poll/__init__.py lsdir() routing will turn ls tries to transform any of
these return values into the first form (a dictionary of SFTPAttributes)
Each SFTPAttributes structure needs st_mode set, and folders need stat.S_IFDIR set.</p>
<p>if the lsdir() routine gets a sequence of bytes, the on_html_page() and on_html_parser_init(,
or perhaps handle_starttag(..) and handle_data() routines) will be used to turn them into
the first form.</p>
<p>web services with different such formats can be accommodated by subclassing and overriding
the handle_* entry points.</p>
<p>uses options (on Sarracenia.config data structure passed to constructor/factory.)
* credentials - used to authentication information.
* sendTo  - server to connect to.
* batch   - how many files to transfer before a connection is torn down and re-established.
* permDefault - what permissions to set on files transferred.
* permDirDefault - what permission to set on directories created.
* timeout  - how long to wait for operations to complete.
* byteRateMax - maximum transfer rate (throttle to avoid exceeding)
* bufSize - size of buffers for file transfers.</p>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">proto</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/transfer.html#Transfer.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">logProgress</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sz</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/transfer.html#Transfer.logProgress"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>if there hasn’t been a log message in at least logMinumumInterval,
then put out a message, so sanity does not think it is dead.</p>
<p>this should print out a message once in a while for long file transfers.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">on_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">chunk</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bytes</span></span></span><a class="reference internal" href="_modules/sarracenia/transfer.html#Transfer.on_data"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>transform data as it is being read.
Given a buffer, return the transformed buffer.
Checksum calculation is based on pre transformation… likely need
a post transformation value as well.</p>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sarracenia.transfer.</span></span><span class="sig-name descname"><span class="pre">alarm_set</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">time</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/transfer.html#alarm_set"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>FIXME: replace with set itimer for &gt; 1 second resolution… currently rouding to nearest second.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">sarracenia.identity.</span></span><span class="sig-name descname"><span class="pre">Identity</span></span><a class="reference internal" href="_modules/sarracenia/identity.html#Identity"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>A class for algorithms to get a fingerprint for a file being announced.
Appropriate fingerprinting algorithms vary according to file type.</p>
<p>required methods in subclasses:</p>
<dl class="simple">
<dt>def registered_as(self):</dt><dd><p>return a one letter string identifying the algorithm (mostly for v2.)
in v3, the registration comes from the identity sub-class name in lower case.</p>
</dd>
<dt>def set_path(self,path):</dt><dd><p>start a checksum for the given path… initialize.</p>
</dd>
<dt>def update(self,chunk):</dt><dd><p>update the checksum based on the given bytes from the file (sequential access assumed.)</p>
</dd>
</dl>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">__weakref__</span></span></dt>
<dd><p>list of weak references to the object (if defined)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">update_file</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sarracenia/identity.html#Identity.update_file"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>read the entire file, check sum it.
this is kind of last resort as it cost an extra file read.
It is better to call update( as the file is being read for other reasons.</p>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">value</span></span></dt>
<dd><p>return the current value of the checksum calculation.</p>
</dd></dl>

</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Contribution/Philosophy/CAP_Theorem_Applied.html" class="btn btn-neutral float-left" title="CAP Theorem Applied" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fr/index.html" class="btn btn-neutral float-right" title="S´abonner et répliquer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>