

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administering AMQP Data Pumps &mdash; Sarracenia 3.00.56rc1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=7ab3649f" />

  
    <link rel="shortcut icon" href="../_static/sarra_horror_culture_favicon.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=bc77207b"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Administering Rabbitmq Adddendum" href="Admin_Rabbit_Addendum.html" />
    <link rel="prev" title="Writing FlowCallback Plugins" href="FlowCallbacks.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sarracenia
              <img src="../_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">HOWTOS</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="subscriber.html">Subscribing to Data Feeds</a></li>
<li class="toctree-l2"><a class="reference internal" href="source.html">Data Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="source.html#quickly-announcing-very-large-trees-on-linux">Quickly Announcing Very Large Trees On Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="FlowCallbacks.html">Using Flow Callback Plugins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Administering AMQP Data Pumps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pre-requisites">Pre-Requisites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#minimum-requirements">Minimum Requirements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#operations">Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#housekeeping-sr3-sanity">Housekeeping - sr3 sanity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#excess-queueing-performance">Excess Queueing/Performance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#routing">Routing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-is-going-on">What is Going On?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#init-integration">Init Integration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq-setup">Rabbitmq Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#webui">WebUI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tls">TLS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#change-defaults">Change Defaults</a></li>
<li class="toctree-l4"><a class="reference internal" href="#managing-users-on-a-pump-using-sr-audit">Managing Users on a Pump Using Sr_audit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#first-subscribe">First Subscribe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sarra-from-another-pump">Sarra from Another Pump</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reports">Reports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sarra-from-a-source">Sarra From a Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleanup">Cleanup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ensuring-things-are-up">Ensuring Things are Up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#startup">Startup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sr-poll">Sr_Poll</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sr-winnow">Sr_winnow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sr-sender">Sr_sender</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manually-adding-users">Manually Adding Users</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-installations">Advanced Installations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clustered-broker-keepalived-setup">Clustered Broker Keepalived Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ldap-integration">LDAP Integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requires-rabbitmq-3-3-x">Requires RABBITMQ &gt; 3.3.x</a></li>
<li class="toctree-l4"><a class="reference internal" href="#support">Support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#hooks-from-sundew">Hooks from Sundew</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#notifications-on-dd">Notifications on DD</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Admin_Rabbit_Addendum.html">Administering Rabbitmq Adddendum</a></li>
<li class="toctree-l2"><a class="reference internal" href="UPGRADING.html">Release Notes (Advice on Upgrades)</a></li>
<li class="toctree-l2"><a class="reference internal" href="v2ToSr3.html">Porting V2 Plugins to Sr3</a></li>
<li class="toctree-l2"><a class="reference internal" href="Email_Ingesting_With_Sarracenia.html">Email Ingesting with Sarracenia (v2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Hydro_Examples.html">Using Plugins to Grab Hydrometric Data (v2)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fr/index.html">En français</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">HOWTOS</a></li>
      <li class="breadcrumb-item active">Administering AMQP Data Pumps</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/How2Guides/Admin.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="administering-amqp-data-pumps">
<h1>Administering AMQP Data Pumps<a class="headerlink" href="#administering-amqp-data-pumps" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>FIXME</strong>: Missing sections are highlighted by <strong>FIXME</strong>. What is here is accurate.</p>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Describes setup and operations of a MetPX-Sarracenia Data Pump using
Rabbitmq as the message queueing protocol broker. For administration,
most tasks are different, depending on the broker used. If using
another broker, there needs to be another admin guide.</p>
</section>
<section id="pre-requisites">
<h2>Pre-Requisites<a class="headerlink" href="#pre-requisites" title="Link to this heading"></a></h2>
<p>Ideally, one should be familiar with user-level access to existing pumps
as either a <a class="reference internal" href="subscriber.html"><span class="doc">subscriber</span></a> or a <a class="reference internal" href="source.html"><span class="doc">source</span></a>  before proceeding to administration.
This manual aims to be prescriptive, rather than explanatory.  For the reasons why things are
built as they are see <a class="reference internal" href="../Explanation/Concepts.html"><span class="doc">Concepts.rst</span></a></p>
<section id="minimum-requirements">
<h3>Minimum Requirements<a class="headerlink" href="#minimum-requirements" title="Link to this heading"></a></h3>
<p>The AMQP broker is extremely light on today’s servers. The examples in
this manual were implemented on a commercial virtual private server (VPS)
with 256 MB of RAM, and 700MB of swap taken from a 20 GByte disk. Such
a tiny configuration is able to keep up with almost a full feed
from dd.weather.gc.ca (which includes, all public facing weather and
environmental data from Environment and Climate Change Canada). The
large numerical prediction files (GRIB and multiple GRIB’s in tar files)
were excluded to reduce bandwidth usage, but in terms of performance
in message passing, it kept up with one client quite well.</p>
<p>Each Sarra process is around 80 mb of virtual memory, but only about 3 mb
is resident, and you need to run enough of them to keep up (on the small VPS,
ran 10 of them.) so about 30 mbytes of RAM actually used. The broker’s RAM
usage is what determines the number of clients which can be served. Slower
clients require more RAM for their queues. So running brokerage tasks and
aggressive cleaning can reduce the overall memory footprint. The broker was
configured to use 128 MB of RAM in the examples in this manual. The rest
of the RAM was used by the apache processes for the web transport engine.</p>
<p>While the above was adequate for proof of concept, it would be impractical to
be clearing out data from disk after only an hour, and the number of clients
supportable is likely quite limited. 1GB of RAM for all the sarra related
activities should be ample for many useful cases.</p>
</section>
</section>
<section id="operations">
<h2>Operations<a class="headerlink" href="#operations" title="Link to this heading"></a></h2>
<p>To operate a pump, there needs to be a user designated as the pump administrator.
The administrator is different from the others mostly in the permission granted
to create arbitrary exchanges, and the ability to run processes that address the common
exchanges (xpublic, xreport, etc…) All other users are limited to being able to
access only their own resources (exchange and queues).</p>
<p>The administrative user name is an installation choice, and exactly as for any other
user, the configuration files are placed under ~/.config/sarra/, with the
defaults under admin.conf, and the configurations for components under
directories named after each component. In the component directories,
configuration files have the .conf suffix.</p>
<p>The administrative processes perform validation of postings from sources. Once
they are validated, forward the postings to the public exchanges for subscribers to access.
The processes that are typically run on a broker:</p>
<ul class="simple">
<li><p>poll   - for sources without notification messages, revert to explicit polling for initial injection.</p></li>
<li><p>sarra  - various configurations to pull data from other pumps to make it available from the local pump.</p></li>
<li><p>sender - send data to clients or other pumps that cannot pull data (usually because of firewalls.)</p></li>
<li><p>winnow - when there are multiple redundant sources of data, select the first one to arrive, and feed sarra.</p></li>
<li><p>shovel - copy notification messages from pump to another, usually to feed winnow.</p></li>
<li><p>flow   - for gathering from different sorts of sources.</p></li>
</ul>
<p>As for any other user, there may be any number of configurations
to set up, and all of them may need to run at once. To do so easily, one can invoke:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="n">start</span>
</pre></div>
</div>
<p>to start all the files with named configurations of each component (sarra, subscribe, winnow, log, etc…)
There are two users/roles that need to be set to use a pump. They are the admin and feeder options.
They are set in ~/.config/sarra/admin.conf like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feeder</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">pumpUser</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">admin</span>  <span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">adminUser</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
</pre></div>
</div>
<p>Then the report and audit components are started as well. It is standard practice to use a different
AMQP user for administrative tasks, such as exchange or user creation, which are performed by the admin
user, from data flow tasks, such as pulling and posting data, performed by the feeder user.
Normally one would place credentials in ~/.config/sarra/credentials.conf
for each account, and the various configuration files would use the appropriate account.</p>
<section id="housekeeping-sr3-sanity">
<h3>Housekeeping - sr3 sanity<a class="headerlink" href="#housekeeping-sr3-sanity" title="Link to this heading"></a></h3>
<p>When a client connects to a broker, it creates a queue which is then bound to an exchange. The user
can choose to have the client self-destruct when disconnected (<em>auto-delete</em>), or it can make
it <em>durable</em> which means it should remain, waiting for the client to connect again, even across
reboots. Clients often want to pick up where they left off, so the queues need to stay around.</p>
<p>The rabbitmq broker will never destroy a queue that is not in auto-delete (or durable).  This means
they will build up over time. We have a script that looks for unused queues, and cleans them out.
Currently, the default is set that any unused queue having more than 25000 notification messages will be deleted.
One can change this limit by having option <em>max_queue_size 50000</em> in default.conf.</p>
</section>
<section id="excess-queueing-performance">
<h3>Excess Queueing/Performance<a class="headerlink" href="#excess-queueing-performance" title="Link to this heading"></a></h3>
<p>When rabbitmq has hundreds of thousands of notification messages queued, broker performance can suffer. Such
accumulations can occur when the destination of a sender is down for a prolonged period, or a
subscriber is unavailable for some reason. In many cases, one can simply shutdown the sender,
and delete the queue on the broker. While that solves the broker performance issue, the user
will not receive the notifications.</p>
<p>On the other hand, one can just let leave it alone, and let Sarracenia take care of it using it’s
disk based retry queues. Essentially it will store records related to failed transfers on disk,
and try them again at reasonable intervals, without getting stuck on any particular item.</p>
<p>When a destination returns to service, current data is a higher priority, and it will sent
retry data, that is already late, only when there is room to do soe in the current data feed.
( <a class="reference external" href="https://github.com/MetPX/sarracenia/issues/620">https://github.com/MetPX/sarracenia/issues/620</a> )</p>
<p>If one gets to the point where traffic through a queue is excessive (several hundred notification messages
per second to a single queue), especially if there are many instances sharing the same queue
(if more than 40 instances to service a single queue) then one can run into a point where
adding instances gives no improvement in the overall throughput. For example, rabbitmq uses
only a single cpu to serve a queue. In such cases, creating multiple configurations,
(each with their own queue) dividing the traffic among them will allow further improvements
in throughput.</p>
<p>winnow is used to suppress duplicates.
<strong>Note that the duplicate suppresion cache is local to each instance</strong>. When N instances share a queue, the
first time a posting is received, it could be picked by one instance, and if a duplicate one is received
it would likely be picked up by another instance. <strong>For effective duplicate suppression with instances</strong>,
one must <strong>deploy two layers of subscribers</strong>. Use a <strong>first layer of subscribers (shovels)</strong> with duplicate
suppression turned off and output with <em>post_exchangeSplit</em>, which route posts by checksum to
a <strong>second layer of subscribers (sr_winnow) whose duplicate suppression caches are active.</strong></p>
</section>
</section>
<section id="routing">
<h2>Routing<a class="headerlink" href="#routing" title="Link to this heading"></a></h2>
<p>The inter-connection of multiple pumps is done, on the data side, by daisy-chaining
sarra and/or sender configurations from one pump to the next.</p>
<p>The <em>to_clusters</em>, and <em>source</em>  headers are used for routing decisions
implemented in the <em>msg_to_clusters</em>, and <em>msg_by_source</em> plugins respectively
to be user by sender or sarra components to limit data transfers between pumps.</p>
<p>For report routing, the <em>from_cluster</em> header is interpreted by the
<em>msg_from_cluster</em> plugin. Report messages are defined in the report(7) man
page. They are emitted by <em>consumers</em> at the end, as well as <em>feeders</em> as the
notification messages traverse pumps. Report messages are posted to the xs_&lt;user&gt; exchange,
and after validation sent to the xreport exchange by the shovel component
configurations created by <em>sr3 declare.</em></p>
<p>Messages in xreports destined for other clusters are routed to destinations by
manually configured shovels. See the <a class="reference internal" href="#reports">Reports</a> section for more details.</p>
</section>
<section id="what-is-going-on">
<h2>What is Going On?<a class="headerlink" href="#what-is-going-on" title="Link to this heading"></a></h2>
<p>The sr3 declare report command can be invoked to bind to ‘xreport’ instead of the
default user exchange to get report information for an entire broker.</p>
<p>Canned report configuration with an <em>on_message</em> action can be configured to
gather statisical information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>FIXME:</strong> first canned sr_report configuration would be speedo…
speedo: total rate of posts/second, total rate of logs/second.
question: should posts go to the log as well?
before operations, we need to figure out how Nagios will monitor it.</p>
<p>Is any of this needed, or is the rabbit GUI enough on it’s own?</p>
</div>
<section id="init-integration">
<h3>Init Integration<a class="headerlink" href="#init-integration" title="Link to this heading"></a></h3>
<p>By default, when sarracenia is installed, it is done as a user tool and not a system-wide resource.
The tools/ sub-directory directory allows for integration with tools for different usage scenarios.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>tools/sr.init – a sample init script suitable for sysv-init or upstart based systems.
tools/sarra_system.service – for systemd base systems for a ‘daemon’ style deployment.
tools/sarra_user.service – for systemd as a per user service.</p>
</div>
<p>Systemd installation process, by administrator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">groupadd</span> <span class="n">sarra</span>
<span class="n">useradd</span> <span class="n">sarra</span>
<span class="n">cp</span> <span class="n">tools</span><span class="o">/</span><span class="n">sarra_system</span><span class="o">.</span><span class="n">service</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">sarra</span><span class="o">.</span><span class="n">service</span>  <span class="p">(</span><span class="k">if</span> <span class="n">a</span> <span class="n">package</span> <span class="n">installs</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span> <span class="n">should</span> <span class="n">go</span> <span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span> <span class="p">)</span>
<span class="n">cp</span> <span class="n">tools</span><span class="o">/</span><span class="n">sarra_user</span><span class="o">.</span><span class="n">service</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">sarra</span><span class="o">.</span><span class="n">service</span> <span class="p">(</span><span class="ow">or</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">user</span><span class="p">,</span> <span class="k">if</span> <span class="n">installed</span> <span class="n">by</span> <span class="n">a</span> <span class="n">package</span> <span class="p">)</span>
<span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
</pre></div>
</div>
<p>It is then assumed that one uses the ‘sarra’ account to store the daemon oriented (or system-wide) sarra configuration.
Users can also run their personal configuration in sessions via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="o">--</span><span class="n">user</span> <span class="n">enable</span> <span class="n">sarra</span>
<span class="n">systemctl</span> <span class="o">--</span><span class="n">user</span> <span class="n">start</span> <span class="n">sarra</span>
</pre></div>
</div>
<p>On an upstart or sysv-init based system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">tools</span><span class="o">/</span><span class="n">sr</span><span class="o">.</span><span class="n">init</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">sr</span>
<span class="o">&lt;</span><span class="n">insert</span> <span class="n">magic</span> <span class="n">here</span> <span class="n">to</span> <span class="n">get</span> <span class="n">that</span> <span class="n">activated</span><span class="o">.&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="rabbitmq-setup">
<h2>Rabbitmq Setup<a class="headerlink" href="#rabbitmq-setup" title="Link to this heading"></a></h2>
<p>Sample information on setting up a rabbitmq broker for sarracenia to use. The broker does not have to
be on the same host as anything else, but there has to be one reachable from at least one of the
transport engines.</p>
<section id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Link to this heading"></a></h3>
<p>Generally speaking, we want to stay above 3.x version.</p>
<p><a class="reference external" href="https://www.rabbitmq.com/install-debian.html">https://www.rabbitmq.com/install-debian.html</a></p>
<p>Briefly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">erlang</span><span class="o">-</span><span class="n">nox</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>In upto-date distros, you likely can just take the distro version.</p>
</section>
<section id="webui">
<h3>WebUI<a class="headerlink" href="#webui" title="Link to this heading"></a></h3>
<p>Basically, from a root shell one must:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_management</span>
</pre></div>
</div>
<p>which will enable the webUI for the broker. To prevent access to the management
interface for undesirables, use of firewalls, or listening only to localhost
interface for the management ui is suggested.</p>
</section>
<section id="tls">
<h3>TLS<a class="headerlink" href="#tls" title="Link to this heading"></a></h3>
<p>One should encrypt broker traffic. Obtaining certificates is outside the scope
of these instructions, so it is not discussed in detail. For the purposes of
the example, one method is to obtain certificates from <a class="reference external" href="http://www.letsencrypt.org">letsencrypt</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@boule:~# git clone https://github.com/letsencrypt/letsencrypt
Cloning into &#39;letsencrypt&#39;...
remote: Counting objects: 33423, done.
remote: Total 33423 (delta 0), reused 0 (delta 0), pack-reused 33423
Receiving objects: 100% (33423/33423), 8.80 MiB | 5.74 MiB/s, done.
Resolving deltas: 100% (23745/23745), done.
Checking connectivity... done.
root@boule:~# cd letsencrypt
root@boule:~/letsencrypt#
root@boule:~/letsencrypt# ./letsencrypt-auto certonly --standalone -d boule.example.com
Checking for new version...
Requesting root privileges to run letsencrypt...
   /root/.local/share/letsencrypt/bin/letsencrypt certonly --standalone -d boule.example.com
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/boule.example.com/fullchain.pem. Your
   cert will expire on 2016-06-26. To obtain a new version of the
   certificate in the future, simply run Let&#39;s Encrypt again.
 - If you like Let&#39;s Encrypt, please consider supporting our work by:

   Donating to ISRG / Let&#39;s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le

root@boule:~# ls /etc/letsencrypt/live/boule.example.com/
cert.pem  chain.pem  fullchain.pem  privkey.pem
root@boule:~#
</pre></div>
</div>
<p>This process produces key files readable only by root. To make the files
readable by the broker (which runs under the rabbitmq user’s name) one will have
to adjust the permissions to allow the broker to read the files.
probably the simplest way to do this is to copy them elsewhere:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># cd /etc/letsencrypt/live/boule*</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">archive</span><span class="c1"># mkdir /etc/rabbitmq/boule.example.com</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">archive</span><span class="c1"># cp -r * /etc/rabbitmq/boule.example.com</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># cd /etc/rabbitmq</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># chown -R rabbitmq.rabbitmq boule*</span>
</pre></div>
</div>
<p>Now that we have proper certificate chain, configure rabbitmq to disable
tcp, and use only the <a class="reference external" href="https://www.rabbitmq.com/ssl.rst">RabbitMQ TLS Support</a> (see
also <a class="reference external" href="https://www.rabbitmq.com/management.rst">RabbitMQ Management</a> ):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1">#  cat &gt;/etc/rabbitmq/rabbitmq.config &lt;&lt;EOT</span>

<span class="p">[</span>
  <span class="p">{</span><span class="n">rabbit</span><span class="p">,</span> <span class="p">[</span>
     <span class="p">{</span><span class="n">tcp_listeners</span><span class="p">,</span> <span class="p">[{</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">5672</span><span class="p">}]},</span>
     <span class="p">{</span><span class="n">ssl_listeners</span><span class="p">,</span> <span class="p">[</span><span class="mi">5671</span><span class="p">]},</span>
     <span class="p">{</span><span class="n">ssl_options</span><span class="p">,</span> <span class="p">[{</span><span class="n">cacertfile</span><span class="p">,</span><span class="s2">&quot;/etc/rabbitmq/boule.example.com/fullchain.pem&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="n">certfile</span><span class="p">,</span><span class="s2">&quot;/etc/rabbitmq/boule.example.com/cert.pem&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="n">keyfile</span><span class="p">,</span><span class="s2">&quot;/etc/rabbitmq/boule.example.com/privkey.pem&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="n">verify</span><span class="p">,</span><span class="n">verify_peer</span><span class="p">},</span>
                    <span class="p">{</span><span class="n">fail_if_no_peer_cert</span><span class="p">,</span><span class="n">false</span><span class="p">}]}</span>
   <span class="p">]}</span>
  <span class="p">{</span><span class="n">rabbitmq_management</span><span class="p">,</span> <span class="p">[{</span><span class="n">listener</span><span class="p">,</span>
     <span class="p">[{</span><span class="n">port</span><span class="p">,</span>     <span class="mi">15671</span><span class="p">},</span>
           <span class="p">{</span><span class="n">ssl</span><span class="p">,</span>      <span class="n">true</span><span class="p">},</span>
           <span class="p">{</span><span class="n">ssl_opts</span><span class="p">,</span> <span class="p">[{</span><span class="n">cacertfile</span><span class="p">,</span><span class="s2">&quot;/etc/rabbitmq/boule.example.com/fullchain.pem&quot;</span><span class="p">},</span>
                          <span class="p">{</span><span class="n">certfile</span><span class="p">,</span><span class="s2">&quot;/etc/rabbitmq/boule.example.com/cert.pem&quot;</span><span class="p">},</span>
                          <span class="p">{</span><span class="n">keyfile</span><span class="p">,</span><span class="s2">&quot;/etc/rabbitmq/boule.example.com/privkey.pem&quot;</span><span class="p">}</span> <span class="p">]}</span>
     <span class="p">]}</span>
  <span class="p">]}</span>
<span class="p">]</span><span class="o">.</span>

<span class="n">EOT</span>
</pre></div>
</div>
<p>Now the broker and management interface are both configured to encrypt all traffic
passed between client and broker. An unencrypted listener was configured for localhost,
where encryption on the local machine is useless, and adds cpu load. But management only
has a single encrypted listener configured.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, sr_audit expects the Management interface to be on port 15671 if encrypted,
15672 otherwise. Sarra has no configuration setting to tell it otherwise. Choosing another
port will break sr_audit. <strong>FIXME</strong>.</p>
</div>
</section>
<section id="change-defaults">
<h3>Change Defaults<a class="headerlink" href="#change-defaults" title="Link to this heading"></a></h3>
<p>In order to perform any configuration changes the broker needs to be running.
One needs to start up the rabbitmq broker. On older ubuntu systems, that would be done by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">start</span>
</pre></div>
</div>
<p>On newer systems with systemd, the best method is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>By default, an installation of a rabbitmq-server makes user guest the administrator… with password guest.
With a running rabbitmq server, one can now change that for an operational implementation…
To void the guest user we suggest:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmqctl</span> <span class="n">delete_user</span> <span class="n">guest</span>
</pre></div>
</div>
<p>Some other administrator must be defined… let’s call it <em>bunnymaster</em>, setting the password to <em>MaestroDelConejito</em> …:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># rabbitmqctl add_user bunnymaster MaestroDelConejito</span>
<span class="n">Creating</span> <span class="n">user</span> <span class="s2">&quot;bunnymaster&quot;</span> <span class="o">...</span>
<span class="o">...</span><span class="n">done</span><span class="o">.</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>

<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># rabbitmqctl set_user_tags bunnymaster administrator</span>
<span class="n">Setting</span> <span class="n">tags</span> <span class="k">for</span> <span class="n">user</span> <span class="s2">&quot;bunnymaster&quot;</span> <span class="n">to</span> <span class="p">[</span><span class="n">administrator</span><span class="p">]</span> <span class="o">...</span>
<span class="o">...</span><span class="n">done</span><span class="o">.</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># rabbitmqctl set_permissions bunnymaster &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span>
<span class="n">Setting</span> <span class="n">permissions</span> <span class="k">for</span> <span class="n">user</span> <span class="s2">&quot;bunnymaster&quot;</span> <span class="ow">in</span> <span class="n">vhost</span> <span class="s2">&quot;/&quot;</span> <span class="o">...</span>
<span class="o">...</span><span class="n">done</span><span class="o">.</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p>Create a local linux account under which sarra administrative tasks will run (say Sarra).
This is where credentials and configuration for pump level activities will be stored.
As the configuration is maintained with this user, it is expected to be actively used
by humans, and so should have a proper interactive shell environment. Some administrative
access is needed, so the user is added to the sudo group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># useradd -m sarra</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># usermod -a -G sudo sarra</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># mkdir ~sarra/.config</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># mkdir ~sarra/.config/sarra</span>
</pre></div>
</div>
<p>You would first need entries in the credentials.conf and admin.conf files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># echo &quot;amqps://bunnymaster:MaestroDelConejito@boule.example.com/&quot; &gt;~sarra/.config/sarra/credentials.conf</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># echo &quot;admin amqps://bunnymaster@boule.example.com/&quot; &gt;~sarra/.config/sarra/admin.conf</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># chown -R sarra.sarra ~sarra/.config</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># passwd sarra</span>
<span class="n">Enter</span> <span class="n">new</span> <span class="n">UNIX</span> <span class="n">password</span><span class="p">:</span>
<span class="n">Retype</span> <span class="n">new</span> <span class="n">UNIX</span> <span class="n">password</span><span class="p">:</span>
<span class="n">passwd</span><span class="p">:</span> <span class="n">password</span> <span class="n">updated</span> <span class="n">successfully</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
<span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">~</span><span class="c1"># chsh -s /bin/bash sarra  # for comfort</span>
</pre></div>
</div>
<p>When Using TLS (aka amqps), verification prevents the use of <em>localhost</em>.
Even for access on the local machine, the fully qualified hostname must be used.
Next:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@boule:~#  cd /usr/local/bin
root@boule:/usr/local/bin# wget https://boule.example.com:15671/cli/rabbitmqadmin
--2016-03-27 23:13:07--  https://boule.example.com:15671/cli/rabbitmqadmin
Resolving boule.example.com (boule.example.com)... 192.184.92.216
Connecting to boule.example.com (boule.example.com)|192.184.92.216|:15671... connected.
HTTP request sent, awaiting response... 200 OK
Length: 32406 (32K) [text/plain]
Saving to: ‘rabbitmqadmin’

rabbitmqadmin              100%[=======================================&gt;]  31.65K  --.-KB/s   in 0.04s

2016-03-27 23:13:07 (863 KB/s) - ‘rabbitmqadmin’ saved [32406/32406]

root@boule:/usr/local/bin#
root@boule:/usr/local/bin# chmod 755 rabbitmqadmin
</pre></div>
</div>
<p>It is necessary to download <em>rabbitmqadmin</em>, a helper command that is included in RabbitMQ, but not installed automatically.
One must download it from the management interface, and place it in a reasonable location in the path, so
that it will be found when it is called by sr_admin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1">#  su - sarra</span>
</pre></div>
</div>
<p>From this point root will not usually be needed, as all configuration can be done from the
un-privileged <em>sarra</em> account.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Out of scope of this discussion, but aside from file system permissions,
it is convenient to provide the sarra user sudo access to rabbitmqctl.
With that, the entire system can be administered without system administrative access.</p>
</div>
</section>
<section id="managing-users-on-a-pump-using-sr-audit">
<h3>Managing Users on a Pump Using Sr_audit<a class="headerlink" href="#managing-users-on-a-pump-using-sr-audit" title="Link to this heading"></a></h3>
<p>To set up a pump, one needs a broker administrative user (in the examples: sarra)
and a feeder user (in the examples: feeder). Management of other users is done with
the sr3 program.</p>
<p>First, write the correct credentials for the admin and feeder users in
the credentials file .config/sarra/credentials.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">bunnymaster</span><span class="p">:</span><span class="n">MaestroDelConejito</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
<span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">feeder</span><span class="p">:</span><span class="n">NoHayPanDuro</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">feeder</span><span class="p">:</span><span class="n">NoHayPanDuro</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
<span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">anonymous</span><span class="p">:</span><span class="n">anonyomous</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
<span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">peter</span><span class="p">:</span><span class="n">piper</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
</pre></div>
</div>
<p>Note that the feeder credentials are presented twice, once to allow un-encrypted access via
localhost, and a second time to permit access over TLS, potentially from other hosts (necessary
when a broker is operating in a cluster, with feeder processes running on multiple transport
engine nodes.) Next step is to put roles in .config/sarra/admin.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">admin</span>  <span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">root</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
<span class="n">feeder</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">feeder</span><span class="nd">@localhost</span><span class="o">/</span>
</pre></div>
</div>
<p>Specify all known users that you want to implement with their roles
in the file  .config/sarra/admin.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">declare</span> <span class="n">subscriber</span> <span class="n">anonymous</span>
<span class="n">declare</span> <span class="n">source</span> <span class="n">peter</span>
</pre></div>
</div>
<p>Now to configure the pump, execute the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="o">--</span><span class="n">users</span> <span class="n">declare</span>
</pre></div>
</div>
<p>Sample run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fractal</span><span class="o">%</span> <span class="n">sr3</span> <span class="o">--</span><span class="n">users</span> <span class="n">declare</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">211</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">rabbitmq_admin</span> <span class="n">add_user</span> <span class="n">permission</span> <span class="n">user</span> <span class="s1">&#39;ender&#39;</span> <span class="n">role</span> <span class="n">source</span>  <span class="n">configure</span><span class="o">=</span><span class="s1">&#39;^q_ender.*|^xs_ender.*&#39;</span> <span class="n">write</span><span class="o">=</span><span class="s1">&#39;^q_ender.*|^xs_ender.*&#39;</span> <span class="n">read</span><span class="o">=</span><span class="s1">&#39;^q_ender.*|^x[lrs]_ender.*|^x.*public$&#39;</span>
<span class="o">...</span>
<span class="mi">020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">903</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">cpost</span><span class="o">/</span><span class="n">pelle_dd1_f04</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">907</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__putSetup</span> <span class="n">exchange</span> <span class="n">declared</span><span class="p">:</span> <span class="n">xcvan00</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">908</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__putSetup</span> <span class="n">exchange</span> <span class="n">declared</span><span class="p">:</span> <span class="n">xcvan01</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">908</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">cpost</span><span class="o">/</span><span class="n">veille_f34</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">912</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__putSetup</span> <span class="n">exchange</span> <span class="n">declared</span><span class="p">:</span> <span class="n">xcpublic</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">912</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">cpost</span><span class="o">/</span><span class="n">pelle_dd2_f05</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">916</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__putSetup</span> <span class="n">exchange</span> <span class="n">declared</span><span class="p">:</span> <span class="n">xcvan00</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
<span class="o">...</span>
<span class="mi">020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">973</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">post</span><span class="o">/</span><span class="n">shim_f63</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">973</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">post</span><span class="o">/</span><span class="n">test2_f61</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">973</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">report</span><span class="o">/</span><span class="n">tsarra_f20</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">978</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__getSetup</span> <span class="n">queue</span> <span class="n">declared</span> <span class="n">q_tfeed</span><span class="o">.</span><span class="n">sr_report</span><span class="o">.</span><span class="n">tsarra_f20</span><span class="mf">.76069129.80068939</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">978</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__getSetup</span> <span class="n">binding</span> <span class="n">q_tfeed</span><span class="o">.</span><span class="n">sr_report</span><span class="o">.</span><span class="n">tsarra_f20</span><span class="mf">.76069129.80068939</span> <span class="k">with</span> <span class="n">v02</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="c1"># to xsarra (as: amqp://tfeed@localhost/)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">978</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">sarra</span><span class="o">/</span><span class="n">download_f20</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">982</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__getSetup</span> <span class="n">queue</span> <span class="n">declared</span> <span class="n">q_tfeed</span><span class="o">.</span><span class="n">sr_sarra</span><span class="o">.</span><span class="n">download_f20</span><span class="mf">.01191787.94585787</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">982</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__getSetup</span> <span class="n">binding</span> <span class="n">q_tfeed</span><span class="o">.</span><span class="n">sr_sarra</span><span class="o">.</span><span class="n">download_f20</span><span class="mf">.01191787.94585787</span> <span class="k">with</span> <span class="n">v03</span><span class="o">.</span><span class="c1"># to xsarra (as: amqp://tfeed@localhost/)</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">982</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">root</span> <span class="n">declare</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">sender</span><span class="o">/</span><span class="n">tsource2send_f50</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">06</span> <span class="mi">23</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">987</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sarra</span><span class="o">.</span><span class="n">moth</span><span class="o">.</span><span class="n">amqp</span> <span class="n">__getSetup</span> <span class="n">queue</span> <span class="n">declared</span> <span class="n">q_tsource</span><span class="o">.</span><span class="n">sr_sender</span><span class="o">.</span><span class="n">tsource2send_f50</span><span class="mf">.60675197.29220410</span> <span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tsource</span><span class="nd">@localhost</span><span class="o">/</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>sr3</em> program:</p>
<ul>
<li><p>uses the <em>admin</em> account from .config/sarra/admin.conf to authenticate to broker.</p></li>
<li><p>creates exchanges <em>xpublic</em> and <em>xreport</em> if they don’t exist.</p></li>
<li><p>reads roles from .config/sarra/admin.conf</p></li>
<li><p>obtains a list of users and exchanges on the pump</p></li>
<li><p>for each user in a <em>declare</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">declare</span> <span class="n">the</span> <span class="n">user</span> <span class="n">on</span> <span class="n">the</span> <span class="n">broker</span> <span class="k">if</span> <span class="n">missing</span><span class="o">.</span>
<span class="nb">set</span>    <span class="n">user</span> <span class="n">permissions</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">its</span> <span class="n">role</span> <span class="p">(</span><span class="n">on</span> <span class="n">creation</span><span class="p">)</span>
<span class="n">create</span> <span class="n">user</span> <span class="n">exchanges</span>   <span class="n">corresponding</span> <span class="n">to</span> <span class="n">its</span> <span class="n">role</span>
</pre></div>
</div>
</li>
<li><p>users which have no declared role are deleted.</p></li>
<li><p>user exchanges which do not correspond to users’ roles are deleted (‘xl_*,xs_*’)</p></li>
<li><p>exchanges which do not start with ‘x’ (aside from builtin ones) are deleted.</p></li>
</ul>
<p>One can inspect whether the sr3 command did all it should using either the Management GUI
or the command line tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~$ sudo rabbitmqctl  list_exchanges
Listing exchanges ...
      direct
amq.direct    direct
amq.fanout    fanout
amq.headers   headers
amq.match     headers
amq.rabbitmq.log      topic
amq.rabbitmq.trace    topic
amq.topic     topic
xl_peter      topic
xreport       topic
xpublic       topic
xs_anonymous  topic
xs_peter      topic
...done.
sarra@boule:~$
sarra@boule:~$ sudo rabbitmqctl  list_users
Listing users ...
anonymous     []
bunnymaster   [administrator]
feeder        []
peter []
...done.
sarra@boule:~$ sudo rabbitmqctl  list_permissions
Listing permissions in vhost &quot;/&quot; ...
anonymous     ^q_anonymous.*  ^q_anonymous.*|^xs_anonymous$   ^q_anonymous.*|^xpublic$
bunnymaster   .*      .*      .*
feeder        .*      .*      .*
peter ^q_peter.*      ^q_peter.*|^xs_peter$   ^q_peter.*|^xl_peter$|^xpublic$
...done.
sarra@boule:~$
</pre></div>
</div>
<p>The above looks like <em>sr3</em> did its job.
In short, here are the permissions and exchanges <em>sr_audit</em> manages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">admin</span> <span class="n">user</span>        <span class="p">:</span> <span class="n">the</span> <span class="n">only</span> <span class="n">one</span> <span class="n">creating</span> <span class="n">users</span><span class="o">...</span>
<span class="n">admin</span><span class="o">/</span><span class="n">feeder</span> <span class="n">users</span><span class="p">:</span> <span class="n">have</span> <span class="nb">all</span> <span class="n">permission</span> <span class="n">over</span> <span class="n">queues</span> <span class="ow">and</span> <span class="n">exchanges</span>

<span class="n">subscribe</span> <span class="n">user</span>    <span class="p">:</span> <span class="n">can</span> <span class="n">write</span> <span class="n">report</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">exchanged</span> <span class="n">beginning</span> <span class="k">with</span>  <span class="n">xs_</span><span class="o">&lt;</span><span class="n">brokerUser</span><span class="o">&gt;</span>
                    <span class="n">can</span> <span class="n">read</span> <span class="n">notification</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">exchange</span> <span class="n">xpublic</span>
                    <span class="n">have</span> <span class="nb">all</span> <span class="n">permissions</span> <span class="n">on</span> <span class="n">queue</span> <span class="n">named</span>  <span class="n">q_</span><span class="o">&lt;</span><span class="n">brokerUser</span><span class="o">&gt;*</span>

<span class="n">source</span> <span class="n">user</span>       <span class="p">:</span> <span class="n">can</span> <span class="n">write</span> <span class="n">notification</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">exchanges</span> <span class="n">beginning</span> <span class="k">with</span> <span class="n">xs_</span><span class="o">&lt;</span><span class="n">brokerUser</span><span class="o">&gt;</span>
                    <span class="n">can</span> <span class="n">read</span> <span class="n">post</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">exchange</span>  <span class="n">xpublic</span>
                    <span class="n">can</span> <span class="n">read</span>  <span class="n">report</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">exchange</span>  <span class="n">xl_</span><span class="o">&lt;</span><span class="n">brokerUser</span><span class="o">&gt;</span> <span class="n">created</span> <span class="k">for</span> <span class="n">him</span>
                    <span class="n">have</span> <span class="nb">all</span> <span class="n">permissions</span> <span class="n">on</span> <span class="n">queue</span> <span class="n">named</span>   <span class="n">q_</span><span class="o">&lt;</span><span class="n">brokerUser</span><span class="o">&gt;*</span>
</pre></div>
</div>
<p>To add Alice using sr_audit, one would add the following to ~/.config/sarra/admin.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">declare</span> <span class="n">source</span> <span class="n">Alice</span>
</pre></div>
</div>
<p>then add an appropriate amqp entry in ~/.config/sarra/credentials.conf to set the password,
then run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="o">--</span><span class="n">users</span> <span class="n">declare</span>
</pre></div>
</div>
<p>To remove users, just remove <em>declare source Alice</em> from the admin.conf file, and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># FIXME: functionality not present.</span>
</pre></div>
</div>
<p>again. To delete users, one can use the existing rabbitmq management interfaces directly.
The creation is automated because the read/write/configure patterns are cumbersome to do manually.</p>
<ul class="simple">
<li><p>Note: By default, all users are declared. However, flows can be specified on the command line to constrain
the declared users to only those in the given flow. For example:</p>
<ul>
<li><p><em>sr3 --users declare</em> will declare all users</p></li>
<li><p><em>sr3 --users declare subscribe/dd_amis</em> will only declare users specified in <em>subscribe/dd_amis</em></p></li>
</ul>
</li>
</ul>
</section>
<section id="first-subscribe">
<h3>First Subscribe<a class="headerlink" href="#first-subscribe" title="Link to this heading"></a></h3>
<p>When setting up a pump, normally the purpose is to connect it to some other pump. To set
the parameters setting up a subscription helps us set parameters for sarra later. So first
try a subscription to an upstream pump:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~$ ls
sarra@boule:~$ cd ~/.config/sarra/
sarra@boule:~/.config/sarra$ mkdir subscribe
sarra@boule:~/.config/sarra$ cd subscribe
sarra@boule:~/.config/sarra/subscribe$ sr_subscribe edit dd.conf
broker amqps://anonymous@dd.weather.gc.ca/

mirror True
directory /var/www/html

# numerical weather model files will overwhelm a small server.
reject .*/\.tar
reject .*/model_giops/.*
reject .*/grib2/.*

accept .*
</pre></div>
</div>
<p>add the password for the upstream pump to credentials.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~/.config/sarra$ echo &quot;amqps://anonymous:anonymous@dd.weather.gc.ca/&quot; &gt;&gt;../credentials.conf
</pre></div>
</div>
<p>then do a short foreground run, to see if it is working. Hit Ctrl-C to stop it after a few notification messages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~/.config/sarra$ sr_subscribe foreground dd
2016-03-28 09:21:27,708 [INFO] sr_subscribe start
2016-03-28 09:21:27,708 [INFO] sr_subscribe run
2016-03-28 09:21:27,708 [INFO] AMQP  broker(dd.weather.gc.ca) user(anonymous) vhost(/)
2016-03-28 09:21:28,375 [INFO] Binding queue q_anonymous.sr_subscribe.dd.78321126.82151209 with key v02.post.# from exchange xpublic on broker amqps://anonymous@dd.weather.gc.ca/
2016-03-28 09:21:28,933 [INFO] Received notice  20160328130240.645 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CWRM/2016-03-28-1300-CWRM-AUTO-swob.xml
2016-03-28 09:21:29,297 [INFO] 201 Downloaded : v02.report.observations.swob-ml.20160328.CWRM 20160328130240.645 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CWRM/2016-03-28-1300-CWRM-AUTO-swob.xml 201 boule.example.com anonymous 1128.560235 parts=1,6451,1,0,0 sum=d,f17299b2afd78ae8d894fe85d3236488 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM rename=/var/www/html/observations/swob-ml/20160328/CWRM/2016-03-28-1300-CWRM-AUTO-swob.xml message=Downloaded
2016-03-28 09:21:29,389 [INFO] Received notice  20160328130240.646 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CWSK/2016-03-28-1300-CWSK-AUTO-swob.xml
2016-03-28 09:21:29,662 [INFO] 201 Downloaded : v02.report.observations.swob-ml.20160328.CWSK 20160328130240.646 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CWSK/2016-03-28-1300-CWSK-AUTO-swob.xml 201 boule.example.com anonymous 1128.924688 parts=1,7041,1,0,0 sum=d,8cdc3420109c25910577af888ae6b617 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM rename=/var/www/html/observations/swob-ml/20160328/CWSK/2016-03-28-1300-CWSK-AUTO-swob.xml message=Downloaded
2016-03-28 09:21:29,765 [INFO] Received notice  20160328130240.647 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CWWA/2016-03-28-1300-CWWA-AUTO-swob.xml
2016-03-28 09:21:30,045 [INFO] 201 Downloaded : v02.report.observations.swob-ml.20160328.CWWA 20160328130240.647 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CWWA/2016-03-28-1300-CWWA-AUTO-swob.xml 201 boule.example.com anonymous 1129.306662 parts=1,7027,1,0,0 sum=d,aabb00e0403ebc9caa57022285ff0e18 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM rename=/var/www/html/observations/swob-ml/20160328/CWWA/2016-03-28-1300-CWWA-AUTO-swob.xml message=Downloaded
2016-03-28 09:21:30,138 [INFO] Received notice  20160328130240.649 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CXVG/2016-03-28-1300-CXVG-AUTO-swob.xml
2016-03-28 09:21:30,431 [INFO] 201 Downloaded : v02.report.observations.swob-ml.20160328.CXVG 20160328130240.649 http://dd2.weather.gc.ca/ observations/swob-ml/20160328/CXVG/2016-03-28-1300-CXVG-AUTO-swob.xml 201 boule.example.com anonymous 1129.690082 parts=1,7046,1,0,0 sum=d,186fa9627e844a089c79764feda781a7 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM rename=/var/www/html/observations/swob-ml/20160328/CXVG/2016-03-28-1300-CXVG-AUTO-swob.xml message=Downloaded
2016-03-28 09:21:30,524 [INFO] Received notice  20160328130240.964 http://dd2.weather.gc.ca/ bulletins/alphanumeric/20160328/CA/CWAO/13/CACN00_CWAO_281300__TBO_05037
^C2016-03-28 09:21:30,692 [INFO] signal stop
2016-03-28 09:21:30,693 [INFO] sr_subscribe stop
sarra@boule:~/.config/sarra/subscribe$
</pre></div>
</div>
<p>So the connection to upstream is functional. Connecting to the server means a queue is allocated on the server,
and it will continue to accumulate notification messages, waiting for the client to connect again. This was just a test, so we
want the server to discard the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~/.config/sarra/subscribe$ sr_subscribe cleanup dd
</pre></div>
</div>
<p>now let’s make sure the subscription does not start automatically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~/.config/sarra/subscribe$ mv dd.conf dd.off
</pre></div>
</div>
<p>and turn to a sarra set up.</p>
</section>
<section id="sarra-from-another-pump">
<h3>Sarra from Another Pump<a class="headerlink" href="#sarra-from-another-pump" title="Link to this heading"></a></h3>
<p>Sarra works by having a downstream pump re-advertise products from an upstream one. Sarra needs all the configuration of a subscription,
but also needs the configuration to post to the downstream broker. The feeder account on the broker is used for this sort
of work, and is a semi-administrative user, able to publish data to any exchange. Assume apache is set up (not covered here) with a
document root of /var/www/html. The linux account we have created to run all the sr3 processes is ‘<em>sarra</em>’, so we make sure
the document root is writable to those processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~$ cd ~/.config/sarra/sarra
sarra@boule:~/.config/sarra/sarra$ sudo chown sarra.sarra /var/www/html
</pre></div>
</div>
<p>Then we create a configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~$ cat &gt;&gt;dd.off &lt;&lt;EOT

broker amqps://anonymous@dd.weather.gc.ca/
exchange xpublic

msg_to_clusters DD
on_message msg_to_clusters

mirror False  # usually True, except for this server!

# Numerical Weather Model files will overwhelm a small server.
reject .*/\.tar
reject .*/model_giops/.*
reject .*/grib2/.*

directory /var/www/html
accept .*

url http://boule.example.com/
document_root /var/www/html
post_broker amqps://feeder@boule.example.com/

EOT
</pre></div>
</div>
<p>Compared to the subscription example provided in the previous example, We have added:</p>
<dl class="simple">
<dt>exchange xpublic</dt><dd><p>sarra is often used for specialized transfers, so the xpublic exchange is not assumed, as it is with subscribe.</p>
</dd>
</dl>
<p>msg_to_clusters DD</p>
<p>on_message msg_to_clusters</p>
<blockquote>
<div><p>sarra implements routing by cluster, so if data is not destined for this cluster, it will skip (not download) a product.
Inspection of the sr_subscribe output above reveals that products are destined for the DD cluster, so let’s pretend to route
for that, so that downloading happens.</p>
</div></blockquote>
<dl class="simple">
<dt>url and document_root</dt><dd><p>these are needed to build the local posts that will be posted to the …</p>
</dd>
<dt>post_broker</dt><dd><p>where we will re-announce the files we have downloaded.</p>
</dd>
<dt>mirror False</dt><dd><p>This is usually unnecessary, when copying between pumps, it is normal to just make direct copies.
However, the dd.weather.gc.ca pump predates the day/source prefix standard, so it is necessary for
ease of cleanup.</p>
</dd>
</dl>
<p>So then try it out:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~/.config/sarra/sarra$ sr_sarra foreground dd.off
2016-03-28 10:38:16,999 [INFO] sr_sarra start
2016-03-28 10:38:16,999 [INFO] sr_sarra run
2016-03-28 10:38:17,000 [INFO] AMQP  broker(dd.weather.gc.ca) user(anonymous) vhost(/)
2016-03-28 10:38:17,604 [INFO] Binding queue q_anonymous.sr_sarra.dd.off with key v02.post.# from exchange xpublic on broker amqps://anonymous@dd.weather.gc.ca/
2016-03-28 10:38:19,172 [INFO] Received v02.post.bulletins.alphanumeric.20160328.UA.CWAO.14 &#39;20160328143820.166 http://dd2.weather.gc.ca/ bulletins/alphanumeric/20160328/UA/CWAO/14/UANT01_CWAO_281438___22422&#39; parts=1,124,1,0,0 sum=d,cfbcb85aac0460038babc0c5a8ec0513 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM
2016-03-28 10:38:19,172 [INFO] downloading/copying into /var/www/html/bulletins/alphanumeric/20160328/UA/CWAO/14/UANT01_CWAO_281438___22422
2016-03-28 10:38:19,515 [INFO] 201 Downloaded : v02.report.bulletins.alphanumeric.20160328.UA.CWAO.14 20160328143820.166 http://dd2.weather.gc.ca/ bulletins/alphanumeric/20160328/UA/CWAO/14/UANT01_CWAO_281438___22422 201 boule.bsqt.example.com anonymous -0.736602 parts=1,124,1,0,0 sum=d,cfbcb85aac0460038babc0c5a8ec0513 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM message=Downloaded
2016-03-28 10:38:19,517 [INFO] Published: &#39;20160328143820.166 http://boule.bsqt.example.com/ bulletins/alphanumeric/20160328/UA/CWAO/14/UANT01_CWAO_281438___22422&#39; parts=1,124,1,0,0 sum=d,cfbcb85aac0460038babc0c5a8ec0513 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM
2016-03-28 10:38:19,602 [INFO] 201 Published : v02.report.bulletins.alphanumeric.20160328.UA.CWAO.14.UANT01_CWAO_281438___22422 20160328143820.166 http://boule.bsqt.example.com/ bulletins/alphanumeric/20160328/UA/CWAO/14/UANT01_CWAO_281438___22422 201 boule.bsqt.example.com anonymous -0.648599 parts=1,124,1,0,0 sum=d,cfbcb85aac0460038babc0c5a8ec0513 from_cluster=DD source=metpx to_clusters=DD,DDI.CMC,DDI.EDM message=Published
^C2016-03-28 10:38:20,328 [INFO] signal stop
2016-03-28 10:38:20,328 [INFO] sr_sarra stop
sarra@boule:~/.config/sarra/sarra$
</pre></div>
</div>
<p>The file has the suffix ‘off’ so that it will not be invoked by default when the entire sarra configuration is started.
One can still start the file when it is in the off setting, by specifying the path (in this case, it is in the current directory).
So initially have ‘off’ files while debugging the settings.
As the configuration is working properly, rename it to so that it will be used on startup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sarra@boule:~/.config/sarra/sarra$ mv dd.off dd.conf
sarra@boule:~/.config/sarra/sarra$
</pre></div>
</div>
</section>
<section id="reports">
<h3>Reports<a class="headerlink" href="#reports" title="Link to this heading"></a></h3>
<p>Now that data is flowing, we need to take a look at the flow of report messages, which essentially are used by each pump to tell
upstream that data has been downloaded. Sr_audit helps with routing by creating the following configurations:</p>
<blockquote>
<div><ul class="simple">
<li><p>for each subscriber, a shovel configuration named rr_&lt;user&gt;2xreport.conf is created</p></li>
<li><p>for each source, a shovel configuration named rr_xreport2&lt;user&gt;user.conf is created</p></li>
</ul>
</div></blockquote>
<p>The <em>2xreport</em> shovels subscribes to notification messages posted in each user’s xs_ exchange and posts them to the common xreport exchange.
Sample configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial report routing configuration created by sr_audit, tune to taste.</span>
<span class="c1">#     To get original back, just remove this file, and run sr_audit (or wait a few minutes)</span>
<span class="c1">#     To suppress report routing, rename this file to rr_anonymous2xreport.conf.off</span>

<span class="n">broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">exchange</span> <span class="n">xs_anonymous</span>
<span class="n">topicPrefix</span> <span class="n">v02</span><span class="o">.</span><span class="n">report</span>
<span class="n">subtopic</span> <span class="c1">#</span>
<span class="n">accept_unmatch</span> <span class="kc">True</span>
<span class="n">on_message</span> <span class="kc">None</span>
<span class="n">on_post</span> <span class="kc">None</span>
<span class="n">report</span> <span class="kc">False</span>
<span class="n">post_broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">post_exchange</span> <span class="n">xreport</span>
</pre></div>
</div>
<dl class="simple">
<dt>Explanations:</dt><dd><ul class="simple">
<li><p>report routing shovels are administrative functions, and therefore the feeder user is used.</p></li>
<li><p>this configuration is to route the reports submitted by the ‘anonymous’ user.</p></li>
<li><p>on_message None, on_post None,  reduce unwanted logging on the local system.</p></li>
<li><p>report False  reduce unwanted reports (do sources want to understand shovel traffic?)</p></li>
<li><p>post to the xreport exchange.</p></li>
</ul>
</dd>
</dl>
<p>The <em>2&lt;user&gt;</em> shovels look at all the notification messages in the xreport exchange, and copy them to the users xr_ exchange.
Sample:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial report routing to sources configuration, by sr_audit, tune to taste.</span>
<span class="c1">#     To get original back, just remove this file, and run sr_audit (or wait a few minutes)</span>
<span class="c1">#     To suppress report routing, rename this file to rr_xreport2tsource2.conf.off</span>

<span class="n">broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">exchange</span> <span class="n">xreport</span>
<span class="n">topicPrefix</span> <span class="n">v02</span><span class="o">.</span><span class="n">report</span>
<span class="n">subtopic</span> <span class="c1">#</span>
<span class="n">accept_unmatch</span> <span class="kc">True</span>
<span class="n">msg_by_source</span> <span class="n">tsource2</span>
<span class="n">on_message</span> <span class="n">msg_by_source</span>
<span class="n">on_post</span> <span class="kc">None</span>
<span class="n">report</span> <span class="kc">False</span>
<span class="n">post_broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">post_exchange</span> <span class="n">xr_tsource2</span>
</pre></div>
</div>
<dl class="simple">
<dt>Explanations:</dt><dd><ul class="simple">
<li><p>msg_by_source tsource2 selects that only the reports for data injected by the tsource2 user should be
selected.</p></li>
<li><p>the selected reports should be copied to the user’s xr_ exchange, where that user invoking sr_report will find them.</p></li>
</ul>
</dd>
</dl>
<p>When a source invokes the sr_report component, the default exchange will be xr_ (eXchange for Reporting). All reports received
from subscribers to data from this source will be routed to this exchange.</p>
<p>If an administrator invokes sr_report, it will default to the xreport exchange, and show reports from all subscribers on the cluster.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">blacklab</span><span class="o">%</span> <span class="n">more</span> <span class="n">boulelog</span><span class="o">.</span><span class="n">conf</span>

<span class="n">broker</span> <span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">feeder</span><span class="nd">@boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
<span class="n">exchange</span> <span class="n">xreport</span>
<span class="n">accept</span> <span class="o">.*</span>

<span class="n">blacklab</span><span class="o">%</span>

<span class="n">blacklab</span><span class="o">%</span> <span class="n">sr_report</span> <span class="n">foreground</span> <span class="n">boulelog</span><span class="o">.</span><span class="n">conf</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">53</span><span class="p">,</span><span class="mi">721</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_report</span> <span class="n">start</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">53</span><span class="p">,</span><span class="mi">721</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_report</span> <span class="n">run</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">53</span><span class="p">,</span><span class="mi">722</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">AMQP</span>  <span class="n">broker</span><span class="p">(</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">)</span> <span class="n">user</span><span class="p">(</span><span class="n">feeder</span><span class="p">)</span> <span class="n">vhost</span><span class="p">(</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">484</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Binding</span> <span class="n">queue</span> <span class="n">q_feeder</span><span class="o">.</span><span class="n">sr_report</span><span class="o">.</span><span class="n">boulelog</span><span class="mf">.06413933.71328785</span> <span class="k">with</span> <span class="n">key</span> <span class="n">v02</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="c1"># from exchange xreport on broker amqps://feeder@boule.example.com/</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">55</span><span class="p">,</span><span class="mi">732</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202955.139</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">radar</span><span class="o">/</span><span class="n">CAPPI</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">XLA</span><span class="o">/</span><span class="mi">201603282030</span><span class="n">_XLA_CAPPI_1</span><span class="mf">.5</span><span class="n">_RAIN</span><span class="o">.</span><span class="n">gif</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.040751</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">393</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202956.212</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">radar</span><span class="o">/</span><span class="n">CAPPI</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">XMB</span><span class="o">/</span><span class="mi">201603282030</span><span class="n">_XMB_CAPPI_1</span><span class="mf">.5</span><span class="n">_RAIN</span><span class="o">.</span><span class="n">gif</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.159043</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">479</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202956.179</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">radar</span><span class="o">/</span><span class="n">CAPPI</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">XLA</span><span class="o">/</span><span class="mi">201603282030</span><span class="n">_XLA_CAPPI_1</span><span class="mf">.0</span><span class="n">_SNOW</span><span class="o">.</span><span class="n">gif</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="mf">0.143819</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">56</span><span class="p">,</span><span class="mi">561</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202956.528</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">radar</span><span class="o">/</span><span class="n">CAPPI</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">XMB</span><span class="o">/</span><span class="mi">201603282030</span><span class="n">_XMB_CAPPI_1</span><span class="mf">.0</span><span class="n">_SNOW</span><span class="o">.</span><span class="n">gif</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.119164</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">557</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202957.405</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span><span class="o">/</span><span class="mi">20160328</span><span class="o">/</span><span class="n">SN</span><span class="o">/</span><span class="n">CWVR</span><span class="o">/</span><span class="mi">20</span><span class="o">/</span><span class="n">SNVD17_CWVR_282000___01910</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.161522</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">642</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202957.406</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span><span class="o">/</span><span class="mi">20160328</span><span class="o">/</span><span class="n">SN</span><span class="o">/</span><span class="n">CWVR</span><span class="o">/</span><span class="mi">20</span><span class="o">/</span><span class="n">SNVD17_CWVR_282000___01911</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.089808</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">729</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202957.408</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span><span class="o">/</span><span class="mi">20160328</span><span class="o">/</span><span class="n">SN</span><span class="o">/</span><span class="n">CWVR</span><span class="o">/</span><span class="mi">20</span><span class="o">/</span><span class="n">SNVD17_CWVR_282000___01912</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.043441</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span><span class="mi">723</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20160328202958.471</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">radar</span><span class="o">/</span><span class="n">CAPPI</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">WKR</span><span class="o">/</span><span class="mi">201603282030</span><span class="n">_WKR_CAPPI_1</span><span class="mf">.5</span><span class="n">_RAIN</span><span class="o">.</span><span class="n">gif</span> <span class="mi">201</span> <span class="n">blacklab</span> <span class="n">anonymous</span> <span class="o">-</span><span class="mf">0.131236</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">400</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">signal</span> <span class="n">stop</span>
<span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">400</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_report</span> <span class="n">stop</span>
<span class="n">blacklab</span><span class="o">%</span>
</pre></div>
</div>
<p>From this listing, we can see that a subscriber on blacklab is actively downloading from the new pump on boule.
Basically, the two sorts of shovels built automatically by sr_audit will do all the routing needed within a cluster.
When there are volume issues, these configurations can be tweaked to increase the number of instances or use
post_exchangeSplit where appropriate.</p>
<p>Manual shovel configuration is also required to route notification messages between clusters. It is just a variation
of intra-cluster report routing.</p>
</section>
<section id="sarra-from-a-source">
<h3>Sarra From a Source<a class="headerlink" href="#sarra-from-a-source" title="Link to this heading"></a></h3>
<p>When reading posts directly from a source, one needs to turn on validation.
FIXME: example of how user posts are handled.</p>
<blockquote>
<div><ul class="simple">
<li><p>set sourceFromExchange</p></li>
<li><p>set mirror False to get date/source tree prepended</p></li>
<li><p>validate that the checksum works…</p></li>
</ul>
</div></blockquote>
<p>anything else?</p>
</section>
<section id="cleanup">
<h3>Cleanup<a class="headerlink" href="#cleanup" title="Link to this heading"></a></h3>
<p>These are examples, the implementation of cleanup is not covered by
sarracenia. Given a reasonably small tree as given above, it can be
practical to scan the tree and prune the old files from it. A cron
job like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="o">.</span><span class="n">d</span><span class="c1"># more sarra_clean</span>
<span class="c1"># remove files one hour after they show up.</span>
<span class="c1"># for weather production, 37 minutes passed the hour is a good time.</span>
<span class="c1"># remove directories the day after the last time they were touched.</span>
<span class="mi">37</span> <span class="mi">4</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>  <span class="n">root</span> <span class="n">find</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span> <span class="o">-</span><span class="n">mindepth</span> <span class="mi">1</span> <span class="o">-</span><span class="n">maxdepth</span> <span class="mi">1</span> <span class="o">-</span><span class="nb">type</span> <span class="n">d</span> <span class="o">-</span><span class="n">mtime</span> <span class="o">+</span><span class="mi">0</span>  <span class="o">|</span> <span class="n">xargs</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span>
</pre></div>
</div>
<p>This might see a bit aggressive, but this file was on a very small virtual server that was only
intended for real-time data transfer so keeping data around for extended periods would have
filled the disk and stopped all transfers. In large scale transfers, there is always a trade
off between the practicality of keeping the data around forever, and the need for performance,
which requires us to prune directory trees regularly. File system performance is optimal with
reasonably sized trees, and when the trees get too large, the ‘find’ process to traverse it, can
become too onerous.</p>
<p>One can more easily maintain smaller directory trees by having them roll over regularly. If you
have enough disk space to last one or more days, then a single logical cron job that would operate
on the daily trees without incurring the penalty of a find is a good approach.</p>
<p>Replace the contents above with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">34</span> <span class="mi">4</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">root</span> <span class="n">find</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span> <span class="o">-</span><span class="n">mindepth</span> <span class="mi">1</span> <span class="o">-</span><span class="n">maxdepth</span> <span class="mi">1</span>  <span class="o">-</span><span class="nb">type</span> <span class="n">d</span> <span class="o">-</span><span class="n">regex</span> <span class="s1">&#39;/var/www/html/[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]&#39;</span> <span class="o">-</span><span class="n">mtime</span> <span class="o">+</span><span class="mi">1</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span>
</pre></div>
</div>
<p>where the +1 can be replaced by the number of days to retain. ( Would have preferred to
use [0-9]{8}, but it would appear that find’s regex syntax does not include repetitions. )</p>
<p>Note that the logs will clean up themselves. By default after 5 retention the oldest log will be
remove at midnight if you have always use the same default config since the first rotation.
It can be shorten to a single retention by adding <em>logRotateCount 1</em> to default.conf.</p>
</section>
<section id="ensuring-things-are-up">
<h3>Ensuring Things are Up<a class="headerlink" href="#ensuring-things-are-up" title="Link to this heading"></a></h3>
<p>Processes can crash. One can have automated restart by running <em>sr3 sanity</em> periodically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@boule</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="o">.</span><span class="n">d</span><span class="c1"># more sanity</span>
<span class="c1"># remove files one hour after they show up.</span>
<span class="c1"># for weather production, 37 minutes passed the hour is a good time.</span>
<span class="c1"># remove directories the day after the last time they were touched.</span>
<span class="mi">7</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">56</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">sr3</span> <span class="n">sanity</span>
</pre></div>
</div>
</section>
<section id="startup">
<h3>Startup<a class="headerlink" href="#startup" title="Link to this heading"></a></h3>
<p>The Debian package installs a systemd unit, but python3 installation does not take
care of that.</p>
</section>
<section id="sr-poll">
<h3>Sr_Poll<a class="headerlink" href="#sr-poll" title="Link to this heading"></a></h3>
<p>FIXME: feed the sarra from source configured with an sr_poll. set up.</p>
</section>
<section id="sr-winnow">
<h3>Sr_winnow<a class="headerlink" href="#sr-winnow" title="Link to this heading"></a></h3>
<p>FIXME: sample sr_winnow configuration explained, with some shovels also.</p>
</section>
<section id="sr-sender">
<h3>Sr_sender<a class="headerlink" href="#sr-sender" title="Link to this heading"></a></h3>
<p>Where firewalls prevent use of sarra to pull from a pump like a subscriber would, one can reverse the feed by having the
upstream pump explicitly feed the downstream one.</p>
<p>FIXME: elaborate sample sr_sender configuration.</p>
</section>
<section id="manually-adding-users">
<h3>Manually Adding Users<a class="headerlink" href="#manually-adding-users" title="Link to this heading"></a></h3>
<p>To avoid the use of sr_admin, or work around issues, one can adjust user settings manually:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">boule</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">15671</span><span class="o">/</span><span class="n">cli</span><span class="o">/</span><span class="n">rabbitmqadmin</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="n">rabbitmqadmin</span>

<span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="n">Alice</span> <span class="o">&lt;</span><span class="n">password</span><span class="o">&gt;</span>
<span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="n">Alice</span>   <span class="s2">&quot;^q_Alice.*$&quot;</span> <span class="s2">&quot;^q_Alice.*$|^xs_Alice$&quot;</span> <span class="s2">&quot;^q_Alice.*$|^xl_Alice$|^xpublic$&quot;</span>

<span class="n">rabbitmqadmin</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">*****</span> <span class="n">declare</span> <span class="n">exchange</span> <span class="n">name</span><span class="o">=</span><span class="n">xs_Alice</span> <span class="nb">type</span><span class="o">=</span><span class="n">topic</span> <span class="n">auto_delete</span><span class="o">=</span><span class="n">false</span> <span class="n">durable</span><span class="o">=</span><span class="n">true</span>
<span class="n">rabbitmqadmin</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">*****</span> <span class="n">declare</span> <span class="n">exchange</span> <span class="n">name</span><span class="o">=</span><span class="n">xl_Alice</span> <span class="nb">type</span><span class="o">=</span><span class="n">topic</span> <span class="n">auto_delete</span><span class="o">=</span><span class="n">false</span> <span class="n">durable</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>or, parametrized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>u=Alice
rabbitmqctl add_user ${u} &lt;password&gt;
rabbitmqctl set_permissions -p / ${u} &quot;^q_${u}.$&quot; &quot;^q_${u}.*$|^xs_${u}$&quot; &quot;^q_${u}.*$|^xl_${u}$|^xpublic$&quot;

rabbitmqadmin -u root -p ***** declare exchange name=xs_${u} type=topic auto_delete=false durable=true
rabbitmqadmin -u root -p ***** declare exchange name=xl_${u} type=topic auto_delete=false durable=true
</pre></div>
</div>
<p>Then you need to do the same work for sftp and or apache servers as required, as
authentication needed by the payload transport protocol (SFTP, FTP, or HTTP(S))
is managed separately.</p>
</section>
</section>
<section id="advanced-installations">
<h2>Advanced Installations<a class="headerlink" href="#advanced-installations" title="Link to this heading"></a></h2>
<p>On some configurations (we usually call them <em>bunny</em>), we use a clustered rabbitmq, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/.</span><span class="n">erlang</span><span class="o">.</span><span class="n">cookie</span>  <span class="n">same</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">nodes</span>

<span class="n">on</span> <span class="n">each</span> <span class="n">node</span> <span class="n">restart</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">stop</span><span class="o">/</span><span class="n">start</span>

<span class="n">on</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">node</span>

<span class="n">rabbitmqctl</span> <span class="n">stop_app</span>
<span class="n">rabbitmqctl</span> <span class="n">join_cluster</span> <span class="n">rabbit</span><span class="o">@</span><span class="s2">&quot;other node&quot;</span>
<span class="n">rabbitmqctl</span> <span class="n">start_app</span>
<span class="n">rabbitmqctl</span> <span class="n">cluster_status</span>


<span class="c1"># having high availability queue...</span>
<span class="c1"># here all queues that starts with &quot;cmc.&quot; will be highly available on all the cluster nodes</span>

<span class="n">rabbitmqctl</span> <span class="n">set_policy</span> <span class="n">ha</span><span class="o">-</span><span class="nb">all</span> <span class="s2">&quot;^(cmc|q_)\.*&quot;</span> <span class="s1">&#39;{&quot;ha-mode&quot;:&quot;all&quot;}&#39;</span>
</pre></div>
</div>
<section id="clustered-broker-keepalived-setup">
<h3>Clustered Broker Keepalived Setup<a class="headerlink" href="#clustered-broker-keepalived-setup" title="Link to this heading"></a></h3>
<p>In this example, bunny-op is a vip that migrates between bunny1-op and bunny2-op.
Keepalived moves the vip between the two:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#=============================================</span>
<span class="c1"># vip bunny-op 192.101.12.59 port 5672</span>
<span class="c1">#=============================================</span>

<span class="n">vrrp_script</span> <span class="n">chk_rabbitmq</span> <span class="p">{</span>
        <span class="n">script</span> <span class="s2">&quot;killall -0 rabbitmq-server&quot;</span>
        <span class="n">interval</span> <span class="mi">2</span>
<span class="p">}</span>

<span class="n">vrrp_instance</span> <span class="n">bunny</span><span class="o">-</span><span class="n">op</span> <span class="p">{</span>
        <span class="n">state</span> <span class="n">BACKUP</span>
        <span class="n">interface</span> <span class="n">eth0</span>
        <span class="n">virtual_router_id</span> <span class="mi">247</span>
        <span class="n">priority</span> <span class="mi">150</span>
        <span class="n">track_interface</span> <span class="p">{</span>
                <span class="n">eth0</span>
        <span class="p">}</span>
        <span class="n">advert_int</span> <span class="mi">1</span>
        <span class="n">preempt_delay</span> <span class="mi">5</span>
        <span class="n">authentication</span> <span class="p">{</span>
                <span class="n">auth_type</span> <span class="n">PASS</span>
                <span class="n">auth_pass</span> <span class="n">bunop</span>
        <span class="p">}</span>
        <span class="n">virtual_ipaddress</span> <span class="p">{</span>
<span class="c1"># bunny-op</span>
                <span class="mf">192.101.12.59</span> <span class="n">dev</span> <span class="n">eth0</span>
        <span class="p">}</span>
        <span class="n">track_script</span> <span class="p">{</span>
                <span class="n">chk_rabbitmq</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ldap-integration">
<h3>LDAP Integration<a class="headerlink" href="#ldap-integration" title="Link to this heading"></a></h3>
<p>To enable LDAP authentication for rabbitmq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_auth_backend_ldap</span>

<span class="c1"># replace username by ldap username</span>
<span class="c1"># clear password (will be verified through the ldap one)</span>
<span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="n">username</span> <span class="n">aaa</span>
<span class="n">rabbitmqctl</span> <span class="n">clear_password</span> <span class="n">username</span>
<span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="n">username</span> <span class="s2">&quot;^xpublic|^amq.gen.*$|^cmc.*$&quot;</span> <span class="s2">&quot;^amq.gen.*$|^cmc.*$&quot;</span> <span class="s2">&quot;^xpublic|^amq.gen.*$|^cmc.*$&quot;</span>
</pre></div>
</div>
<p>And you need to set up LDAP parameters in the broker configuration file:
(this sample ldap-dev test config worked when we tested it…):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">config</span>
<span class="p">[</span> <span class="p">{</span><span class="n">rabbit</span><span class="p">,</span> <span class="p">[{</span><span class="n">auth_backends</span><span class="p">,</span> <span class="p">[</span> <span class="p">{</span><span class="n">rabbit_auth_backend_ldap</span><span class="p">,</span><span class="n">rabbit_auth_backend_internal</span><span class="p">},</span> <span class="n">rabbit_auth_backend_internal</span><span class="p">]}]},</span>
  <span class="p">{</span><span class="n">rabbitmq_auth_backend_ldap</span><span class="p">,</span>
   <span class="p">[</span> <span class="p">{</span><span class="n">servers</span><span class="p">,</span>               <span class="p">[</span><span class="s2">&quot;ldap-dev.cmc.ec.gc.ca&quot;</span><span class="p">]},</span>
     <span class="p">{</span><span class="n">user_dn_pattern</span><span class="p">,</span>       <span class="s2">&quot;uid=$</span><span class="si">{username}</span><span class="s2">,ou=People,ou=depot,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">},</span>
     <span class="p">{</span><span class="n">use_ssl</span><span class="p">,</span>               <span class="n">false</span><span class="p">},</span>
     <span class="p">{</span><span class="n">port</span><span class="p">,</span>                  <span class="mi">389</span><span class="p">},</span>
     <span class="p">{</span><span class="n">log</span><span class="p">,</span>                   <span class="n">true</span><span class="p">},</span>
     <span class="p">{</span><span class="n">network</span><span class="p">,</span>               <span class="n">true</span><span class="p">},</span>
    <span class="p">{</span><span class="n">vhost_access_query</span><span class="p">,</span>    <span class="p">{</span><span class="n">in_group</span><span class="p">,</span>
                             <span class="s2">&quot;ou=$</span><span class="si">{vhost}</span><span class="s2">-users,ou=vhosts,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">resource_access_query</span><span class="p">,</span>
     <span class="p">{</span><span class="k">for</span><span class="p">,</span> <span class="p">[{</span><span class="n">permission</span><span class="p">,</span> <span class="n">configure</span><span class="p">,</span> <span class="p">{</span><span class="n">in_group</span><span class="p">,</span> <span class="s2">&quot;cn=admin,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
            <span class="p">{</span><span class="n">permission</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span>
             <span class="p">{</span><span class="k">for</span><span class="p">,</span> <span class="p">[{</span><span class="n">resource</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>    <span class="p">{</span><span class="n">in_group</span><span class="p">,</span> <span class="s2">&quot;cn=admin,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
                    <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">true</span><span class="p">}}]}},</span>
            <span class="p">{</span><span class="n">permission</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span>
             <span class="p">{</span><span class="k">for</span><span class="p">,</span> <span class="p">[{</span><span class="n">resource</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="p">{</span><span class="n">in_group</span><span class="p">,</span> <span class="s2">&quot;cn=admin,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
                    <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>    <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">true</span><span class="p">}}]}}</span>
           <span class="p">]</span>
     <span class="p">}},</span>
  <span class="p">{</span><span class="n">tag_queries</span><span class="p">,</span>           <span class="p">[{</span><span class="n">administrator</span><span class="p">,</span> <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">false</span><span class="p">}},</span>
                           <span class="p">{</span><span class="n">management</span><span class="p">,</span>    <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">true</span><span class="p">}}]}</span>
 <span class="p">]</span>
<span class="p">}</span>
<span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="requires-rabbitmq-3-3-x">
<h3>Requires RABBITMQ &gt; 3.3.x<a class="headerlink" href="#requires-rabbitmq-3-3-x" title="Link to this heading"></a></h3>
<p>Was searching on how to use LDAP strictly for password authentication
The answer I got from the Rabbitmq gurus</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>On 07/08/14 20:51, michel.grenier@ec.gc.ca wrote:
&gt; I am trying to find a way to use our ldap server  only for
&gt; authentification...
&gt; The user&#39;s  permissions, vhost ... etc  would already be set directly
&gt; on the server
&gt; with rabbitmqctl...  The only thing ldap would be used for would be
&gt; logging.
&gt; Is that possible... ?   I am asking because our ldap schema is quite
&gt; different from
&gt; what rabbitmq-server requieres.

Yes (as long as you&#39;re using at least 3.3.x).

You need something like:

{rabbit,[{auth_backends,
           [{rabbit_auth_backend_ldap, rabbit_auth_backend_internal}]}]}

See http://www.rabbitmq.com/ldap.html and in particular:

&quot;The list can contain names of modules (in which case the same module is used for both authentication and authorisation), *or 2-tuples like {ModN, ModZ} in which case ModN is used for authentication and ModZ is used for authorisation*.&quot;

Here ModN is rabbit_auth_backend_ldap and ModZ is rabbit_auth_backend_internal.

Cheers, Simon
</pre></div>
</div>
</section>
<section id="support">
<h3>Support<a class="headerlink" href="#support" title="Link to this heading"></a></h3>
<p>It is now possible to enable MQTT in Sarracenia through the RabbitMQ MQTT plugin. Here is a minimal howto guide for our RabbitMQTT support:</p>
<ul>
<li><p>After any other MQTT service listening to port 1883 got disabled, enable RabbitMQ MQTT plugin.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_mqtt</span>
<span class="n">cat</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">config</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span>
<span class="p">[{</span><span class="n">rabbitmq_mqtt</span><span class="p">,</span> <span class="p">[{</span><span class="n">default_user</span><span class="p">,</span>     <span class="o">&lt;&lt;</span><span class="s2">&quot;anonymous&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                  <span class="p">{</span><span class="n">default_pass</span><span class="p">,</span>     <span class="o">&lt;&lt;</span><span class="s2">&quot;anonymous&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                  <span class="p">{</span><span class="n">allow_anonymous</span><span class="p">,</span>  <span class="n">true</span><span class="p">},</span>
                  <span class="p">{</span><span class="n">vhost</span><span class="p">,</span>            <span class="o">&lt;&lt;</span><span class="s2">&quot;/&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                  <span class="p">{</span><span class="n">exchange</span><span class="p">,</span>         <span class="o">&lt;&lt;</span><span class="s2">&quot;xmqtt_public&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
                  <span class="p">{</span><span class="n">ssl_listeners</span><span class="p">,</span>    <span class="p">[]},</span>
                  <span class="p">{</span><span class="n">tcp_listeners</span><span class="p">,</span>    <span class="p">[</span><span class="mi">1883</span><span class="p">]},</span>
                  <span class="p">{</span><span class="n">tcp_listen_options</span><span class="p">,</span> <span class="p">[{</span><span class="n">backlog</span><span class="p">,</span> <span class="mi">4096</span><span class="p">},</span>
                                        <span class="p">{</span><span class="n">nodelay</span><span class="p">,</span> <span class="n">true</span><span class="p">}]}]}</span>
<span class="p">]</span><span class="o">.</span>
<span class="n">EOF</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><p>Change anonymous user (rabbit_mqtt.default_user) permissions to allow partner user to subscribe to your mqtt feed (ie. using mosquitto_sub):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="n">anonymous</span> <span class="s2">&quot;^q_anonymous.*|^mqtt-subscription&quot;</span> <span class="s2">&quot;^q_anonymous.*|^xs_anonymous$|^mqtt-subscription&quot;</span> <span class="s2">&quot;^q_anonymous.*|^x[lrs]_anonymous.*|^x.*public$&quot;</span>
</pre></div>
</div>
</li>
<li><p>Write your configurations that will publish to rabbitmqtt exchange:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Here is a minimal shovel/myshovel.conf
# Subscribe from a source amqp exchange
broker amqp://${afeeder}@${abroker}
exchange ${from_exchange}

# posting to rabbitmqtt exchange
post_broker amqp://${afeeder}@${abroker}
post_exchange xmqtt_public
post_topicPrefix  v03.${from_exchange}
report False
</pre></div>
</div>
<p>or consume from rabbitmqtt exchange:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Here is a minimal subscribe/mysub.conf
broker amqp://${asub}@${abroker}/
exchange xmqtt_public
topicPrefix v03.${from_exchange}

# Print out all msg received
accept .*
on_message msg_rawlog
download off
</pre></div>
</div>
<p>Note that we use <em>xmqtt_public</em> as the (post_)exchange which is defined as the <em>rabbitmq_mqtt.exchange</em>
in the rabbitmq.config file. We also append the source exchange to the (post_)topicPrefix, which will
map the source exchange and could be useful if we map multiple exchanges to mqtt.</p>
</li>
<li><p>Start and test your configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr_shovel</span> <span class="n">start</span> <span class="n">myshovel</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sr_subscribe</span> <span class="n">foreground</span> <span class="n">mysub</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>On another machine you may now run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mosquitto_sub -h ${abroker} -t &#39;#&#39; -d
</pre></div>
</div>
<p>Messages received from both sr_subscribe and mosquitto_sub should be the same.</p>
</li>
</ul>
</section>
</section>
<section id="hooks-from-sundew">
<h2>Hooks from Sundew<a class="headerlink" href="#hooks-from-sundew" title="Link to this heading"></a></h2>
<p>This information is very likely irrelevant to almost all users. Sundew is another module of MetPX which is essentially being
replaced by Sarracenia. This information is only useful to those with an installed based of Sundew wishing to bridge
to sarracenia. The early work on Sarracenia used only the subscribe client as a downloader, and the existing WMO switch module
from MetPX as the data source. There was no concept of multiple users, as the switch operates as a single dissemination
and routing tool. This section describes the kinds of <em>glue</em> used to feed Sarracenia subscribers from a Sundew source.
It assumes a deep understanding of MetPX-Sundew. Currently, the dd_notify.py script creates notification messages for the
protocol exp., v00. and v02 (latest sarracenia protocol version).</p>
<section id="notifications-on-dd">
<h3>Notifications on DD<a class="headerlink" href="#notifications-on-dd" title="Link to this heading"></a></h3>
<p>As a higher performance replacement for Atom/RSS feeds which tell subscribers when new data is available, we put a broker
on our data dissemination server (dd.weather.gc.ca). Clients can subscribe to it. To create the notifications, we have
one Sundew Sender (named wxo-b1-oper-dd.conf) with a send script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">script</span>
<span class="n">send_script</span> <span class="n">sftp_amqp</span><span class="o">.</span><span class="n">py</span>

<span class="c1"># connection info</span>
<span class="n">protocol</span>    <span class="n">ftp</span>
<span class="n">host</span>        <span class="n">wxo</span><span class="o">-</span><span class="n">b1</span><span class="o">.</span><span class="n">cmc</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span>
<span class="n">user</span>        <span class="n">wxofeed</span>
<span class="n">password</span>    <span class="o">**********</span>
<span class="n">ftp_mode</span>    <span class="n">active</span>

<span class="n">noduplicates</span> <span class="n">false</span>

<span class="c1"># no filename validation (pds format)</span>
<span class="n">validation</span>  <span class="kc">False</span>

<span class="c1"># delivery method</span>
<span class="n">lock</span>  <span class="n">umask</span>
<span class="n">chmod</span> <span class="mi">775</span>
<span class="n">batch</span> <span class="mi">100</span>
</pre></div>
</div>
<p>We see all the configuration information for a single-file sender, but the send_script overrides the
normal sender with something that builds AMQP messages as well. This Sundew sender config
invokes <em>sftp_amqp.py</em> as a script to do the actual send, but also to place the payload of an
AMQP message in the /apps/px/txq/dd-notify-wxo-b1/, queuing it up for a Sundew AMQP sender.
That sender´s config is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>type amqp

validation False
noduplicates False

protocol amqp
host wxo-b1.cmc.ec.gc.ca
user feeder
password ********

exchange_name cmc
exchange_key  v02.post.${0}
exchange_type topic

reject ^ensemble.naefs.grib2.raw.*

accept ^(.*)\+\+.*
</pre></div>
</div>
<p>The key for the topic includes a substitution. The <em>${0}</em> contains the directory tree where the
file has been placed on dd (with the / replaced by .)  For example, here is a log file entry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2013</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">06</span> <span class="mi">14</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">368</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">(</span><span class="mi">86</span> <span class="n">Bytes</span><span class="p">)</span> <span class="n">Message</span> <span class="n">radar</span><span class="mf">.24</span><span class="n">_HR_ACCUM</span><span class="o">.</span><span class="n">GIF</span><span class="o">.</span><span class="n">XSS</span><span class="o">++</span><span class="mi">201306061440</span><span class="n">_XSS_24_HR_ACCUM_MM</span><span class="o">.</span><span class="n">gif</span><span class="p">:</span><span class="n">URP</span><span class="p">:</span><span class="n">XSS</span><span class="p">:</span><span class="n">RADAR</span><span class="p">:</span><span class="n">GIF</span><span class="p">::</span><span class="mi">20130606144709</span>  <span class="n">delivered</span> <span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">1.368449</span><span class="p">,</span><span class="n">speed</span><span class="o">=</span><span class="mf">168950.887119</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>So the key is: v02.post.radar.24_HR_ACCUM.GIF.XSS</p></li>
<li><p>the file is placed under: <a class="reference external" href="http://dd1.weather.gc.ca/radar/24_HR_ACCUM/GIF/XSS">http://dd1.weather.gc.ca/radar/24_HR_ACCUM/GIF/XSS</a></p></li>
<li><p>the complete URL for the product is: <a class="reference external" href="http://dd1.weather.gc.ca/radar/24_HR_ACCUM/GIF/XSS/201306061440_XSS_24_HR_ACCUM_MM.gif">http://dd1.weather.gc.ca/radar/24_HR_ACCUM/GIF/XSS/201306061440_XSS_24_HR_ACCUM_MM.gif</a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="FlowCallbacks.html" class="btn btn-neutral float-left" title="Writing FlowCallback Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Admin_Rabbit_Addendum.html" class="btn btn-neutral float-right" title="Administering Rabbitmq Adddendum" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>