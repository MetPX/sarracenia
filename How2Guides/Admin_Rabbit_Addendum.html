

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administering Rabbitmq Adddendum &mdash; Sarracenia 3.00.56rc2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../_static/sarra_horror_culture_favicon.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8b8faa11"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="UPGRADE GUIDE" href="UPGRADING.html" />
    <link rel="prev" title="Administering AMQP Data Pumps" href="Admin.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sarracenia
              <img src="../_static/sarra_horror_culture_w200.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Explanation/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">HOWTOS</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="subscriber.html">Subscribing to Data Feeds</a></li>
<li class="toctree-l2"><a class="reference internal" href="source.html">Data Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="source.html#quickly-announcing-very-large-trees-on-linux">Quickly Announcing Very Large Trees On Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="FlowCallbacks.html">Using Flow Callback Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="Admin.html">Administering AMQP Data Pumps</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Administering Rabbitmq Adddendum</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq-server-installation">RABBITMQ-SERVER installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq-server-cluster-installation">RABBITMQ-SERVER cluster installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq-server-ldap-installation">RABBITMQ-SERVER ldap installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-of-amqp-on-dd-ddi-dd-beta">Use of AMQP on DD (DDI, DD.BETA)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#notifications-for-dd">Notifications for DD</a></li>
<li class="toctree-l4"><a class="reference internal" href="#utilities-installed-on-dd-servers">Utilities installed on DD servers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-amqp-with-urp-bunny-pds-op">Using AMQP with URP, BUNNY, PDS-OP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#from-urp-1-2-announce-to-bunny-op-that-a-product-is-ready">From URP-1/2 announce to BUNNY-OP that a product is ready</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bunny-op-and-dd-dispatcher-py">BUNNY-OP and dd_dispatcher.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pds-op-receptions-of-dispatch-notification-messages-wget-of-radar-products">PDS-OP receptions of dispatch notification messages, wget of radar products</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-troubleshooting">Verification / Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="UPGRADING.html">Release Notes (Advice on Upgrades)</a></li>
<li class="toctree-l2"><a class="reference internal" href="v2ToSr3.html">Porting V2 Plugins to Sr3</a></li>
<li class="toctree-l2"><a class="reference internal" href="Email_Ingesting_With_Sarracenia.html">Email Ingesting with Sarracenia (v2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Hydro_Examples.html">Using Plugins to Grab Hydrometric Data (v2)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Explanation/index.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contribution/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-documentation.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fr/index.html">En français</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sarracenia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">HOWTOS</a></li>
      <li class="breadcrumb-item active">Administering Rabbitmq Adddendum</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/How2Guides/Admin_Rabbit_Addendum.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="administering-rabbitmq-adddendum">
<h1>Administering Rabbitmq Adddendum<a class="headerlink" href="#administering-rabbitmq-adddendum" title="Link to this heading"></a></h1>
<p>Old edits people wanted to keep?</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>AMQP stands for Advanced Message Queuing Protocol.
It is the definition of a protocol that comes from the need to standardize an asynchronous message change system.
In AMQP jargon we will talk about message producers, message consumers and broker.</p>
</section>
<section id="rabbitmq-server-installation">
<h2>RABBITMQ-SERVER installation<a class="headerlink" href="#rabbitmq-server-installation" title="Link to this heading"></a></h2>
<p>On our machines that need to process AMQP messages,
we install the broker, by installing the package rabbitmq-server_3.3.5-1_all.deb.
The basic installation is done as follows on all our machines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># installing package taken on the rabbitmq homepage</span>
<span class="c1"># rabbitmq-server version &gt; 3.3.x  required to use ldap for passwords verification only</span>

<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">erlang</span><span class="o">-</span><span class="n">nox</span>
<span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server_3</span><span class="mf">.3.5</span><span class="o">-</span><span class="mi">1</span><span class="n">_all</span><span class="o">.</span><span class="n">deb</span>

<span class="c1"># create anonymous user</span>
<span class="c1"># password ********* provided in potato</span>
<span class="c1">#                                          conf write read</span>
<span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="n">anonymous</span> <span class="o">*********</span>
<span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="n">anonymous</span>   <span class="s2">&quot;^xpublic|^amq.gen.*$|^cmc.*$&quot;</span>     <span class="s2">&quot;^amq.gen.*$|^cmc.*$&quot;</span>    <span class="s2">&quot;^xpublic|^amq.gen.*$|^cmc.*$&quot;</span>
<span class="n">rabbitmqctl</span> <span class="n">list_user_permissions</span> <span class="n">anonymous</span>

<span class="c1"># create feeder user</span>
<span class="c1"># password ********* provided in potato</span>
<span class="c1">#                                       conf write read</span>
<span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="n">feeder</span> <span class="o">********</span>
<span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="n">feeder</span>  <span class="s2">&quot;.*&quot;</span>  <span class="s2">&quot;.*&quot;</span>  <span class="s2">&quot;.*&quot;</span>
<span class="n">rabbitmqctl</span> <span class="n">list_user_permissions</span> <span class="n">feeder</span>

<span class="c1"># create administrator user</span>
<span class="c1"># password ********* provided in potato</span>

<span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="n">root</span>   <span class="o">*********</span>
<span class="n">rabbitmqctl</span> <span class="n">set_user_tags</span> <span class="n">root</span> <span class="n">administrator</span>

<span class="c1"># takeaway administrator privileges from guest</span>
<span class="n">rabbitmqctl</span> <span class="n">set_user_tags</span> <span class="n">guest</span>
<span class="n">rabbitmqctl</span> <span class="n">list_user_permissions</span> <span class="n">guest</span>
<span class="n">rabbitmqctl</span> <span class="n">change_password</span> <span class="n">guest</span> <span class="o">*************</span>

<span class="c1"># list users</span>
<span class="n">rabbitmqctl</span> <span class="n">list_users</span>


<span class="c1"># enabling management web application</span>
<span class="c1"># this is important since sr_rabbit uses this management facility/port access</span>
<span class="c1"># to retrieve some important info</span>

<span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_management</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">restart</span>
</pre></div>
</div>
</section>
<section id="rabbitmq-server-cluster-installation">
<h2>RABBITMQ-SERVER cluster installation<a class="headerlink" href="#rabbitmq-server-cluster-installation" title="Link to this heading"></a></h2>
<p>On the bunny we have opted for a cluster installation. To do this we follow the following instructions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Stop</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">nodes</span><span class="o">....</span>

<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/.</span><span class="n">erlang</span><span class="o">.</span><span class="n">cookie</span>  <span class="n">same</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">nodes</span>

<span class="n">on</span> <span class="n">each</span> <span class="n">node</span> <span class="n">restart</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">stop</span><span class="o">/</span><span class="n">start</span>

<span class="n">on</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">node</span>

<span class="n">rabbitmqctl</span> <span class="n">stop_app</span>
<span class="n">rabbitmqctl</span> <span class="n">join_cluster</span> <span class="n">rabbit</span><span class="o">@</span><span class="s2">&quot;other node&quot;</span>
<span class="n">rabbitmqctl</span> <span class="n">start_app</span>
<span class="n">rabbitmqctl</span> <span class="n">cluster_status</span>


<span class="c1"># having high availability queue...</span>
<span class="c1"># here all queues that starts with &quot;cmc.&quot; will be highly available on all the cluster nodes</span>

<span class="n">rabbitmqctl</span> <span class="n">set_policy</span> <span class="n">ha</span><span class="o">-</span><span class="nb">all</span> <span class="s2">&quot;^cmc\.&quot;</span> <span class="s1">&#39;{&quot;ha-mode&quot;:&quot;all&quot;}&#39;</span>
</pre></div>
</div>
</section>
<section id="rabbitmq-server-ldap-installation">
<h2>RABBITMQ-SERVER ldap installation<a class="headerlink" href="#rabbitmq-server-ldap-installation" title="Link to this heading"></a></h2>
<p>On the servers where we want to have an authentication using the following instructions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_auth_backend_ldap</span>

<span class="c1"># replace username by ldap username</span>
<span class="c1"># clear password (will be verified through the ldap one)</span>
<span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="n">username</span> <span class="n">aaa</span>
<span class="n">rabbitmqctl</span> <span class="n">clear_password</span> <span class="n">username</span>
<span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="n">username</span> <span class="s2">&quot;^xpublic|^amq.gen.*$|^cmc.*$&quot;</span> <span class="s2">&quot;^amq.gen.*$|^cmc.*$&quot;</span> <span class="s2">&quot;^xpublic|^amq.gen.*$|^cmc.*$&quot;</span>
</pre></div>
</div>
<p>And we configure the LDAP services in the rabbitmq-server configuration file
(old test configuration of ldap-dev which worked only…):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">config</span>
<span class="p">[</span>
<span class="p">{</span><span class="n">rabbit</span><span class="p">,</span> <span class="p">[{</span><span class="n">auth_backends</span><span class="p">,</span> <span class="p">[</span> <span class="p">{</span><span class="n">rabbit_auth_backend_ldap</span><span class="p">,</span><span class="n">rabbit_auth_backend_internal</span><span class="p">},</span> <span class="n">rabbit_auth_backend_internal</span><span class="p">]}]},</span>
<span class="p">{</span><span class="n">rabbitmq_auth_backend_ldap</span><span class="p">,</span>
    <span class="p">[</span>
    <span class="p">{</span><span class="n">servers</span><span class="p">,</span>               <span class="p">[</span><span class="s2">&quot;ldap-dev.cmc.ec.gc.ca&quot;</span><span class="p">]},</span>
    <span class="p">{</span><span class="n">user_dn_pattern</span><span class="p">,</span>       <span class="s2">&quot;uid=$</span><span class="si">{username}</span><span class="s2">,ou=People,ou=depot,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">use_ssl</span><span class="p">,</span>               <span class="n">false</span><span class="p">},</span>
    <span class="p">{</span><span class="n">port</span><span class="p">,</span>                  <span class="mi">389</span><span class="p">},</span>
    <span class="p">{</span><span class="n">log</span><span class="p">,</span>                   <span class="n">true</span><span class="p">},</span>
    <span class="p">{</span><span class="n">network</span><span class="p">,</span>               <span class="n">true</span><span class="p">},</span>
    <span class="p">{</span><span class="n">vhost_access_query</span><span class="p">,</span>    <span class="p">{</span><span class="n">in_group</span><span class="p">,</span>
                            <span class="s2">&quot;ou=$</span><span class="si">{vhost}</span><span class="s2">-users,ou=vhosts,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">resource_access_query</span><span class="p">,</span>
    <span class="p">{</span><span class="k">for</span><span class="p">,</span> <span class="p">[{</span><span class="n">permission</span><span class="p">,</span> <span class="n">configure</span><span class="p">,</span> <span class="p">{</span><span class="n">in_group</span><span class="p">,</span> <span class="s2">&quot;cn=admin,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
            <span class="p">{</span><span class="n">permission</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span>
            <span class="p">{</span><span class="k">for</span><span class="p">,</span> <span class="p">[{</span><span class="n">resource</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>    <span class="p">{</span><span class="n">in_group</span><span class="p">,</span> <span class="s2">&quot;cn=admin,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
                    <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">true</span><span class="p">}}]}},</span>
            <span class="p">{</span><span class="n">permission</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span>
            <span class="p">{</span><span class="k">for</span><span class="p">,</span> <span class="p">[{</span><span class="n">resource</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="p">{</span><span class="n">in_group</span><span class="p">,</span> <span class="s2">&quot;cn=admin,dc=ec,dc=gc,dc=ca&quot;</span><span class="p">}},</span>
                    <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span>    <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">true</span><span class="p">}}]}}</span>
            <span class="p">]</span>
    <span class="p">}},</span>
    <span class="p">{</span><span class="n">tag_queries</span><span class="p">,</span>           <span class="p">[{</span><span class="n">administrator</span><span class="p">,</span> <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">false</span><span class="p">}},</span>
                            <span class="p">{</span><span class="n">management</span><span class="p">,</span>    <span class="p">{</span><span class="n">constant</span><span class="p">,</span> <span class="n">true</span><span class="p">}}]}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="use-of-amqp-on-dd-ddi-dd-beta">
<h2>Use of AMQP on DD (DDI, DD.BETA)<a class="headerlink" href="#use-of-amqp-on-dd-ddi-dd-beta" title="Link to this heading"></a></h2>
<p>We (Peter) wanted to do an implementation of AMQP in METPX.
To do this, we use the python-amqplib library which implements the necessary functionality of AMQP in python.
We have thus developped a pxSender of type amqp which is the producer of notification messages as well as a pxReceiver of type amqp which serves as a consumer of notification messages.
As a broker, we use rabbitmq-server which is a standard debian package of an AMQP broker.</p>
<p>A pxSender of type amqp, reads the content of a file in its queue, makes a message to which it attaches a “topic” and sends it to the broker.
A pxReceiver of type amqp will announce to the broker the “topic” for which it is interested to receive notification messages, and the broker will send it each message corresponding to its choice.</p>
<p>As a message can be anything, at the level of the pxSender, we have also attached the name of the file from which the message comes.
Thus in our pxReceiver, we can insure the content of the message in the corresponding file name.
This trick is useless only for amqp changes between a sender and an amqp receiver…</p>
<section id="notifications-for-dd">
<h3>Notifications for DD<a class="headerlink" href="#notifications-for-dd" title="Link to this heading"></a></h3>
<p>We found in AMQP an opportunity to announce products when they arrive on DD.
So a user instead of constantly verifying if a product is present on DD.
To change it, he could subscribe (AMQP topic) to receive a message (the url of the product) that would be omitted only at the delivery of the product on DD.
We wouldn’t do this exercise for newsletters… but for other products (grib,images… etc)</p>
<p>To implement this, we used a possibility of pxSender, the sender_script.
We have written a script sftp_amqp.py that makes the deliveries to DD and for each product, it creates a file containing the URL under which the product will be present.
Here is the beginning of the configuration of wxo-b1-oper-dd.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">script</span>
<span class="n">send_script</span> <span class="n">sftp_amqp</span><span class="o">.</span><span class="n">py</span>

<span class="c1"># connection info</span>
<span class="n">protocol</span>    <span class="n">ftp</span>
<span class="n">host</span>        <span class="n">wxo</span><span class="o">-</span><span class="n">b1</span><span class="o">.</span><span class="n">cmc</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span>
<span class="n">user</span>        <span class="n">wxofeed</span>
<span class="n">password</span>    <span class="o">**********</span>
<span class="n">ftp_mode</span>    <span class="n">active</span>

<span class="n">noduplicates</span> <span class="n">false</span>

<span class="c1"># no filename validation (pds format)</span>
<span class="n">validation</span>  <span class="kc">False</span>

<span class="c1"># delivery method</span>
<span class="n">lock</span>  <span class="n">umask</span>
<span class="n">chmod</span> <span class="mi">775</span>
<span class="n">batch</span> <span class="mi">100</span>
</pre></div>
</div>
<p>We see in this config that all the information for a single-file sender is there.
But because the type is script… and the send_script sftp_amqp.py is provided, we are able to instruct our sender to do more…</p>
<p>The file containing the URL is placed under the txq of an AMQP sender /apps/px/txq/dd-notify-wxo-b1 for the AMQP notification to be done.
To send the files in this queue, a sender has to have written dd-notify-wxo-b1.conf which is configured as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>type amqp

validation False
noduplicates False

protocol amqp
host wxo-b1.cmc.ec.gc.ca
user feeder
password ********

exchange_name cmc
exchange_key  exp.dd.notify.${0}
exchange_type topic

reject ^ensemble.naefs.grib2.raw.*

accept ^(.*)\+\+.*
</pre></div>
</div>
<p>Again, the cl for the topic contains a programmed part.
The ${0} part contains the tree structure where the product is placed on dd… For example, here is a log line from dd-notify-wxo-b1.log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2013</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">06</span> <span class="mi">14</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">368</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">(</span><span class="mi">86</span> <span class="n">Bytes</span><span class="p">)</span> <span class="n">Message</span> <span class="n">radar</span><span class="mf">.24</span><span class="n">_HR_ACCUM</span><span class="o">.</span><span class="n">GIF</span><span class="o">.</span><span class="n">XSS</span><span class="o">++</span><span class="mi">201306061440</span><span class="n">_XSS_24_HR_ACCUM_MM</span><span class="o">.</span><span class="n">gif</span><span class="p">:</span><span class="n">URP</span><span class="p">:</span><span class="n">XSS</span><span class="p">:</span><span class="n">RADAR</span><span class="p">:</span><span class="n">GIF</span><span class="p">::</span><span class="mi">20130606144709</span>  <span class="n">delivered</span> <span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">1.368449</span><span class="p">,</span><span class="n">speed</span><span class="o">=</span><span class="mf">168950.887119</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>And so the cl would be.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exp.dd.notify.radar.24_HR_ACCUM.GIF.XSS</span></code></p></td>
</tr>
<tr class="row-even"><td><p>And the location of the file</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">http://dd1.weather.gc.ca/radar/24_HR_ACCUM/GIF/XSS</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>And the complete URL in the message</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">http://dd1.weather.gc.ca/radar/24_HR_ACCUM/GIF/XSS/201306061440_XSS_24_HR_ACCUM_MM.gif</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="utilities-installed-on-dd-servers">
<h3>Utilities installed on DD servers<a class="headerlink" href="#utilities-installed-on-dd-servers" title="Link to this heading"></a></h3>
<p>When a client connects to the broker (rabbitmq-server) it must create a queue and attach it to an exchange.
We can give this queue the option that it self-destructs when it is no longer in use or that it is preserved and continues to stack products if the client is offline.
In general, we would like the queue to be preserved and thus the connection resumption restarts the product collection without loss.</p>
<dl>
<dt>queue_manager.py</dt><dd><p>The rabbitmq-server will never destroy a queue that has been created by a client if it is not in auto-delete mode (let alone if it is created with durability).
This can cause a problem for example, a client that develops a process, can change IDEs several times and crams on the server a multitude of queues that will never be used.
So we created a queue_manager.py script that verifies if the unused queues have more than X products waiting or take more than Y Mbytes…
If so, they are destroyed by the script.</p>
<p>At the time of writing this document, the limits are : <code class="docutils literal notranslate"><span class="pre">25000</span> <span class="pre">messages</span> <span class="pre">and</span> <span class="pre">50Mb.</span></code></p>
</dd>
<dt>dd-xml-inotify.py</dt><dd><p>On our public datamart, there are products that do not come directly from pds/px/pxatx.
As our notifications are made from the product delivery, we don’t have notification messages for them.
This is the case for the XML products under the directories: <code class="docutils literal notranslate"><span class="pre">citypage_weather</span></code> and <code class="docutils literal notranslate"><span class="pre">marine_weather</span></code>.
To overcome this situation, the daemon dd-xml-inotify.py has been created and installed.
This python script uses inotify to monitor the modification of products under their directories.
If a product is modified or added, an amqp notification is sent to the server.
Thus all products in the datamart are covered by the message sending.</p>
</dd>
</dl>
</section>
</section>
<section id="using-amqp-with-urp-bunny-pds-op">
<h2>Using AMQP with URP, BUNNY, PDS-OP<a class="headerlink" href="#using-amqp-with-urp-bunny-pds-op" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>also applies to dev…</p>
</div>
<section id="from-urp-1-2-announce-to-bunny-op-that-a-product-is-ready">
<h3>From URP-1/2 announce to BUNNY-OP that a product is ready<a class="headerlink" href="#from-urp-1-2-announce-to-bunny-op-that-a-product-is-ready" title="Link to this heading"></a></h3>
<p>On urp-1/2 a metpx rolls the sender amqp_expose_db.conf which announces that a product has just arrived in the db of metpx with a message of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Md5sum</span> <span class="n">of</span> <span class="n">product</span> <span class="n">name</span>           <span class="n">file</span><span class="o">-</span><span class="n">size</span>  <span class="n">url</span>                        <span class="n">dbname</span>
<span class="n">a985c32cbdee8af2ab5d7b8f6022e781</span> <span class="mi">498081</span>     <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">urp</span><span class="o">-</span><span class="mf">1.</span><span class="n">cmc</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="n">db</span><span class="o">/</span><span class="mi">20150120</span><span class="o">/</span><span class="n">RADAR</span><span class="o">/</span><span class="n">URP</span><span class="o">/</span><span class="n">IWA</span><span class="o">/</span><span class="mi">201501201810</span><span class="o">~~</span><span class="n">PA</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">PA_PRECIPET</span><span class="p">,</span><span class="n">MM_HR</span><span class="p">,</span><span class="n">MM</span><span class="p">:</span><span class="n">URP</span><span class="p">:</span><span class="n">IWA</span><span class="p">:</span><span class="n">RADAR</span><span class="p">:</span><span class="n">META</span><span class="p">::</span><span class="mi">20150120180902</span>
</pre></div>
</div>
<p>These AMQP messages are sent to the rabbitmq server on bunny-op with an exchange key that starts with <code class="docutils literal notranslate"><span class="pre">v00.urp.input</span></code> followed by convention by the path from db with the ‘/’ replaced with ‘.’.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>that urp-1/2 runs apache and that the product annonce is in the db of metpx and is visible from the URL of the message.</p>
</div>
</section>
<section id="bunny-op-and-dd-dispatcher-py">
<h3>BUNNY-OP and dd_dispatcher.py<a class="headerlink" href="#bunny-op-and-dd-dispatcher-py" title="Link to this heading"></a></h3>
<p>bunny-op is a vip that lives on bunny1-op or bunny2-op.
It is with keepalived that we make sure that this vip resides on one of the bunny-op.
We also test that rabbitmq-server is running on the same server.
The configuration part of keepalived that deals with the vip is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vip</span> <span class="n">bunny</span><span class="o">-</span><span class="n">op</span> <span class="mf">142.135.12.59</span> <span class="n">port</span> <span class="mi">5672</span>

<span class="n">vrrp_script</span> <span class="n">chk_rabbitmq</span> <span class="p">{</span>
        <span class="n">script</span> <span class="s2">&quot;killall -0 rabbitmq-server&quot;</span>
        <span class="n">interval</span> <span class="mi">2</span>
<span class="p">}</span>

<span class="n">vrrp_instance</span> <span class="n">bunny</span><span class="o">-</span><span class="n">op</span> <span class="p">{</span>
        <span class="n">state</span> <span class="n">BACKUP</span>
        <span class="n">interface</span> <span class="n">eth0</span>
        <span class="n">virtual_router_id</span> <span class="mi">247</span>
        <span class="n">priority</span> <span class="mi">150</span>
        <span class="n">track_interface</span> <span class="p">{</span>
                <span class="n">eth0</span>
        <span class="p">}</span>
        <span class="n">advert_int</span> <span class="mi">1</span>
        <span class="n">preempt_delay</span> <span class="mi">5</span>
        <span class="n">authentication</span> <span class="p">{</span>
                <span class="n">auth_type</span> <span class="n">PASS</span>
                <span class="n">auth_pass</span> <span class="n">bunop</span>
        <span class="p">}</span>
        <span class="n">virtual_ipaddress</span> <span class="p">{</span>
<span class="c1"># bunny-op</span>
                <span class="mf">142.135.12.59</span> <span class="n">dev</span> <span class="n">eth0</span>
        <span class="p">}</span>
        <span class="n">track_script</span> <span class="p">{</span>
                <span class="n">chk_rabbitmq</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The rabbitmq-servers on these machines are installed in a cluster.
We put high availability on the queues beginnig with <code class="docutils literal notranslate"><span class="pre">cmc.*</span></code>.
On each of the machines run the utility <code class="docutils literal notranslate"><span class="pre">dd_dispatcher.py</span></code>.
This program verifies whether the vip bunny-op and proc�dera has its work only on the server where the vip lives.
(If there is a switch, auto detection in 5 seconds and the queues remain unchanged)</p>
<p>The utility dd_dispatcher.py subscribes to the notification messages <code class="docutils literal notranslate"><span class="pre">v00.urp.input.#</span></code> and thus redirects the notification messages from the 2 URP operative servers.
Upon reception of a first product, the product’s md5dum is placed in a cache and the message is r�exp�di� but this time with <code class="docutils literal notranslate"><span class="pre">v00.urp.notify</span></code> as the exchange key.
If another message arrives from <code class="docutils literal notranslate"><span class="pre">v00.urp.input</span></code> with the same md5sum as the first one, it is ignored, so the products announced from the exchange key <code class="docutils literal notranslate"><span class="pre">v00.urp.notify</span></code> are unique and represent the first arrival of the 2 operative URPs.</p>
</section>
<section id="pds-op-receptions-of-dispatch-notification-messages-wget-of-radar-products">
<h3>PDS-OP receptions of dispatch notification messages, wget of radar products<a class="headerlink" href="#pds-op-receptions-of-dispatch-notification-messages-wget-of-radar-products" title="Link to this heading"></a></h3>
<p>On pds-op, a pull_urp receiver, execute the fx_script pull_amqp_wget.py.
In this script, the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># shared queue : each pull receive 1 message (prefetch_count=1)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_qos</span><span class="p">(</span><span class="n">prefetch_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">prefetch_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">a_global</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>makes that the distribution of notification messages <code class="docutils literal notranslate"><span class="pre">v00.urp.notify</span></code> will be distributed equally across the 5 servers under pds-op.
We therefore guarantee a distributed pull.
For each message of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a985c32cbdee8af2ab5d7b8f6022e781</span> <span class="mi">498081</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">urp</span><span class="o">-</span><span class="mf">1.</span><span class="n">cmc</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="n">db</span><span class="o">/</span><span class="mi">20150120</span><span class="o">/</span><span class="n">RADAR</span><span class="o">/</span><span class="n">URP</span><span class="o">/</span><span class="n">IWA</span><span class="o">/</span><span class="mi">201501201810</span><span class="o">~~</span><span class="n">PA</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">PA_PRECIPET</span><span class="p">,</span><span class="n">MM_HR</span><span class="p">,</span><span class="n">MM</span><span class="p">:</span><span class="n">URP</span><span class="p">:</span><span class="n">IWA</span><span class="p">:</span><span class="n">RADAR</span><span class="p">:</span><span class="n">META</span><span class="p">::</span><span class="mi">20150120180902</span>
</pre></div>
</div>
<p>the url is reb�ted from the last 2 fields of the message and a wget of the product is made and placed in the receiver queue which is then ignored/routed in an ordinary way.</p>
</section>
<section id="verification-troubleshooting">
<h3>Verification / Troubleshooting<a class="headerlink" href="#verification-troubleshooting" title="Link to this heading"></a></h3>
<p>In order of production</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>On <code class="docutils literal notranslate"><span class="pre">urp-1/2</span></code>:</dt><dd><ul class="simple">
<li><p>Verify that the radar products are generated on urp-1/2.</p></li>
<li><p>Verify that notifications are generated on urp-1/2 /apps/px/log/tx_amqp_expose_db.log</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>On <code class="docutils literal notranslate"><span class="pre">bunny1/2-op</span></code></dt><dd><ul class="simple">
<li><p>Check where bunny-op resides</p></li>
<li><p>Verify the logs of dd_dispatcher.py <code class="docutils literal notranslate"><span class="pre">/var/log/dd_dispatcher_xxxx.log</span></code> where xxxx is the process pid</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>On <code class="docutils literal notranslate"><span class="pre">pds-op</span></code></dt><dd><ul class="simple">
<li><p>Check the pull_urp</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>Repairing the processes that are not working properly should fix the problems in general.
More details will be added here as problems are encountered and corrected.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Admin.html" class="btn btn-neutral float-left" title="Administering AMQP Data Pumps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="UPGRADING.html" class="btn btn-neutral float-right" title="UPGRADE GUIDE" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Shared Services Canada, Government of Canada, GPLv2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>